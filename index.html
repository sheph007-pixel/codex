<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RelateFlow — AI-Driven CRM</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- MSAL loaded dynamically in initMSAL() with CDN fallbacks -->
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f1117;--surface:#181a20;--surface2:#1e2028;--border:#2a2d37;
  --text:#e4e5e9;--text2:#9ca0ab;--accent:#6c5ce7;--accent2:#a29bfe;
  --green:#00cec9;--green-bg:rgba(0,206,201,.12);
  --red:#ff7675;--red-bg:rgba(255,118,117,.12);
  --orange:#fdcb6e;--orange-bg:rgba(253,203,110,.12);
  --blue:#74b9ff;--blue-bg:rgba(116,185,255,.12);
  --ms-blue:#0078d4;
}
html{font-family:'Inter',system-ui,sans-serif;font-size:14px;background:var(--bg);color:var(--text)}
body{min-height:100vh;overflow-x:hidden}

/* ── TOP NAV ── */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:0 24px;height:56px;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.topbar .logo{display:flex;align-items:center;gap:10px;font-weight:700;font-size:16px;letter-spacing:-.3px}
.topbar .logo svg{width:28px;height:28px}
.topbar-actions{display:flex;align-items:center;gap:12px}
.btn{padding:7px 16px;border-radius:8px;border:none;font-size:13px;font-weight:500;cursor:pointer;transition:.15s;font-family:inherit;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:#7c6df0}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--surface2);color:var(--text)}
.btn-sm{padding:5px 12px;font-size:12px}
.btn-ms{background:var(--ms-blue);color:#fff;font-weight:600}
.btn-ms:hover{background:#106ebe}
.btn-icon{width:34px;height:34px;padding:0;display:grid;place-items:center;border-radius:8px;background:transparent;border:1px solid var(--border);color:var(--text2);cursor:pointer;transition:.15s}
.btn-icon:hover{background:var(--surface2);color:var(--text)}
.user-pill{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;font-size:12px;color:var(--text2)}
.user-pill .dot{width:8px;height:8px;border-radius:50%;background:var(--green)}

/* ── LAYOUT ── */
.layout{display:flex;height:calc(100vh - 56px)}
.sidebar{width:240px;background:var(--surface);border-right:1px solid var(--border);padding:16px 12px;flex-shrink:0;display:flex;flex-direction:column;gap:4px;overflow-y:auto}
.sidebar-section{margin-top:16px;margin-bottom:6px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text2);padding:0 12px}
.sidebar-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:8px;color:var(--text2);cursor:pointer;transition:.15s;font-size:13px;font-weight:500}
.sidebar-item:hover,.sidebar-item.active{background:var(--surface2);color:var(--text)}
.sidebar-item.active{color:var(--accent2)}
.sidebar-item svg{width:18px;height:18px;flex-shrink:0}
.sidebar-badge{margin-left:auto;background:var(--accent);color:#fff;font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px}
.main{flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:20px}

/* ── WELCOME / SIGN-IN SCREEN ── */
.welcome-screen{display:flex;align-items:center;justify-content:center;flex:1;padding:40px}
.welcome-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:48px;max-width:520px;text-align:center}
.welcome-card h1{font-size:28px;font-weight:700;margin-bottom:8px}
.welcome-card .subtitle{color:var(--text2);font-size:15px;line-height:1.6;margin-bottom:32px}
.welcome-card .ms-btn{display:inline-flex;align-items:center;gap:12px;padding:14px 32px;background:#fff;color:#333;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:.15s;font-family:inherit}
.welcome-card .ms-btn:hover{background:#f0f0f0;transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,.2)}
.welcome-card .ms-btn svg{width:20px;height:20px}
.welcome-features{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:32px;text-align:left}
.welcome-feat{display:flex;align-items:start;gap:10px;padding:12px;background:var(--surface2);border-radius:10px}
.welcome-feat svg{width:18px;height:18px;color:var(--accent2);flex-shrink:0;margin-top:2px}
.welcome-feat div{display:flex;flex-direction:column;gap:2px}
.welcome-feat .feat-title{font-size:13px;font-weight:600;color:var(--text)}
.welcome-feat .feat-desc{font-size:11px;color:var(--text2)}
.welcome-note{margin-top:20px;font-size:11px;color:var(--text2);line-height:1.5}

/* ── SCAN PROGRESS BANNER ── */
.scan-banner{background:linear-gradient(135deg,rgba(0,120,212,.15),rgba(108,92,231,.1));border:1px solid rgba(0,120,212,.3);border-radius:12px;padding:16px 20px;display:none;align-items:center;gap:14px}
.scan-banner.active{display:flex}
.scan-spinner{width:20px;height:20px;border-radius:50%;border:3px solid var(--border);border-top-color:var(--ms-blue);animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.scan-banner .scan-text{flex:1;font-size:13px;color:var(--text)}
.scan-banner .scan-count{font-size:12px;color:var(--text2)}

/* ── STATS ROW ── */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px 20px;display:flex;flex-direction:column;gap:6px}
.stat-card .stat-label{font-size:12px;color:var(--text2);font-weight:500}
.stat-card .stat-value{font-size:26px;font-weight:700;letter-spacing:-.5px}
.stat-card .stat-change{font-size:11px;font-weight:600;display:flex;align-items:center;gap:4px}
.stat-up{color:var(--green)}.stat-down{color:var(--red)}

/* ── TOOLBAR ── */
.toolbar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.toolbar-left{display:flex;align-items:center;gap:10px}
.toolbar-right{display:flex;align-items:center;gap:10px}
.search-box{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:7px 14px;width:260px;transition:.15s}
.search-box:focus-within{border-color:var(--accent)}
.search-box input{background:none;border:none;outline:none;color:var(--text);font-size:13px;width:100%;font-family:inherit}
.search-box svg{width:16px;height:16px;color:var(--text2);flex-shrink:0}

/* ── TABLE ── */
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;flex:1}
table{width:100%;border-collapse:collapse}
thead{position:sticky;top:0;z-index:2}
th{background:var(--surface2);text-align:left;padding:10px 16px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--text2);border-bottom:1px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none;transition:.15s}
th:hover{color:var(--text)}
td{padding:12px 16px;border-bottom:1px solid var(--border);font-size:13px;white-space:nowrap}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(108,92,231,.04)}
tr.row-selected td{background:rgba(108,92,231,.08)}

/* ── CHECKBOX ── */
th.col-check,td.col-check{width:40px;text-align:center;padding:10px 8px 10px 14px}
.row-checkbox{width:16px;height:16px;accent-color:var(--accent);cursor:pointer}

/* ── BULK ACTIONS BAR ── */
.bulk-bar{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px 20px;display:none;align-items:center;gap:16px;z-index:95;box-shadow:0 8px 32px rgba(0,0,0,.4);backdrop-filter:blur(8px)}
.bulk-bar.active{display:flex}
.bulk-bar .bulk-count{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap}
.bulk-bar .bulk-sep{width:1px;height:24px;background:var(--border)}
.bulk-bar .btn-danger{background:var(--red-bg);color:var(--red);border:1px solid rgba(255,118,117,.2)}
.bulk-bar .btn-danger:hover{background:rgba(255,118,117,.2)}

.company-cell{display:flex;align-items:center;gap:10px}
.company-logo{width:32px;height:32px;border-radius:8px;display:grid;place-items:center;font-weight:700;font-size:13px;color:#fff;flex-shrink:0}
.company-info{display:flex;flex-direction:column}
.company-name{font-weight:600;color:var(--text)}
.company-domain{font-size:11px;color:var(--text2)}

.contact-cell{display:flex;align-items:center;gap:8px}
.avatar{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;font-weight:600;font-size:10px;color:#fff;flex-shrink:0}
.contact-name{font-weight:500}

.badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-hot{background:var(--red-bg);color:var(--red)}
.badge-warm{background:var(--orange-bg);color:var(--orange)}
.badge-new{background:var(--green-bg);color:var(--green)}
.badge-cold{background:var(--blue-bg);color:var(--blue)}

.email-bar{display:flex;align-items:center;gap:6px;font-size:12px}
.bar-track{width:80px;height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;display:flex}
.bar-sent{background:var(--accent);height:100%;border-radius:3px 0 0 3px}
.bar-recv{background:var(--green);height:100%;border-radius:0 3px 3px 0}

.trend-spark{display:flex;align-items:end;gap:2px;height:24px}
.trend-spark .bar{width:4px;border-radius:2px;background:var(--accent);opacity:.6;transition:.15s}
.trend-spark .bar:last-child{opacity:1}

.ai-score{display:flex;align-items:center;gap:6px}
.score-ring{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;font-weight:700;font-size:11px;position:relative}
.score-ring svg{position:absolute;inset:0;transform:rotate(-90deg)}
.score-ring circle{fill:none;stroke-width:3}
.score-ring .track{stroke:var(--surface2)}
.score-ring .fill{stroke-linecap:round;transition:.5s}

/* ── DETAIL PANEL (right side, inline) ── */
.detail-panel{position:fixed;right:0;top:56px;width:0;height:calc(100vh - 56px);background:var(--surface);border-left:1px solid var(--border);z-index:90;transition:width .25s ease;overflow:hidden;display:flex;flex-direction:column}
.detail-panel.open{width:440px}
.dp-scroll{flex:1;overflow-y:auto;padding:20px}
.dp-header{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.dp-back{background:none;border:none;color:var(--text2);cursor:pointer;padding:4px;border-radius:6px;display:none;transition:.15s}
.dp-back:hover{background:var(--surface2);color:var(--text)}
.dp-back svg{width:16px;height:16px}
.dp-back.visible{display:flex}
.dp-breadcrumb{font-size:12px;color:var(--text2);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dp-breadcrumb b{color:var(--text);font-weight:600}
.dp-close{background:none;border:1px solid var(--border);color:var(--text2);cursor:pointer;width:28px;height:28px;border-radius:6px;display:grid;place-items:center;flex-shrink:0;transition:.15s}
.dp-close:hover{background:var(--surface2);color:var(--text)}
.dp-close svg{width:14px;height:14px}

/* Panel — Company State */
.dp-company-head{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.dp-co-logo{width:44px;height:44px;border-radius:10px;display:grid;place-items:center;font-weight:700;font-size:16px;color:#fff;flex-shrink:0}
.dp-co-info h2{font-size:16px;font-weight:700;letter-spacing:-.2px}
.dp-co-info .dp-domain{font-size:12px;color:var(--text2)}
.dp-co-meta{display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.dp-mini-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
.dp-mini-stat{background:var(--surface2);border-radius:8px;padding:10px 12px}
.dp-mini-stat .label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.4px;font-weight:600}
.dp-mini-stat .value{font-size:18px;font-weight:700;margin-top:2px}
.dp-section{margin-top:16px}
.dp-section-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text2);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.dp-section-title .cnt{font-size:10px;background:var(--surface2);padding:1px 6px;border-radius:8px;color:var(--text)}

/* Contact rows in panel */
.dp-contact{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;transition:.15s;margin-bottom:4px}
.dp-contact:hover{background:var(--surface2)}
.dp-contact .dp-ct-avatar{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;font-weight:600;font-size:11px;color:#fff;flex-shrink:0}
.dp-contact .dp-ct-info{flex:1;min-width:0}
.dp-contact .dp-ct-name{font-size:13px;font-weight:600;display:flex;align-items:center;gap:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dp-contact .dp-ct-email{font-size:11px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dp-contact .dp-ct-count{font-size:11px;color:var(--text2);flex-shrink:0;font-weight:600}
.dp-star{background:none;border:none;cursor:pointer;font-size:16px;color:var(--border);padding:2px;transition:.15s;flex-shrink:0;line-height:1}
.dp-star:hover{color:var(--orange);transform:scale(1.15)}
.dp-star.active{color:var(--orange)}
.dp-primary-badge{font-size:9px;padding:1px 6px;border-radius:8px;background:var(--accent);color:#fff;font-weight:700;flex-shrink:0}

/* Panel — Contact State */
.dp-ct-head{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.dp-ct-big-avatar{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;font-weight:700;font-size:16px;color:#fff;flex-shrink:0}
.dp-ct-head-info h2{font-size:16px;font-weight:700}
.dp-ct-head-info .dp-ct-head-email{font-size:12px;color:var(--text2)}
.dp-ct-head-info .dp-ct-head-company{font-size:11px;color:var(--accent2);cursor:pointer}
.dp-ct-head-info .dp-ct-head-company:hover{text-decoration:underline}
.dp-ct-actions{display:flex;gap:6px;margin-bottom:16px}
.dp-ct-actions .btn{font-size:11px;padding:5px 10px}
.dp-tabs{display:flex;gap:0;margin-bottom:12px;border-bottom:1px solid var(--border)}
.dp-tab{padding:6px 12px;font-size:12px;font-weight:500;color:var(--text2);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;transition:.15s;font-family:inherit}
.dp-tab:hover{color:var(--text)}
.dp-tab.active{color:var(--accent2);border-bottom-color:var(--accent)}

/* Timeline items in panel */
.tl-loading{display:flex;align-items:center;gap:8px;padding:16px;color:var(--text2);font-size:12px}
.tl-loading .scan-spinner{width:14px;height:14px;border-width:2px}
.tl-empty{text-align:center;padding:32px 16px;color:var(--text2);font-size:12px}
.tl-list{display:flex;flex-direction:column;gap:1px}
.tl-date-group{margin-top:12px}
.tl-date-group:first-child{margin-top:0}
.tl-date-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.4px;color:var(--text2);padding:6px 0;position:sticky;top:0;background:var(--surface);z-index:1}
.tl-item{display:flex;align-items:flex-start;gap:10px;padding:8px 10px;border-radius:6px;transition:.15s;cursor:pointer}
.tl-item:hover{background:var(--surface2)}
.tl-icon{width:28px;height:28px;border-radius:6px;display:grid;place-items:center;flex-shrink:0}
.tl-icon.sent{background:rgba(108,92,231,.12);color:var(--accent2)}
.tl-icon.received{background:var(--green-bg);color:var(--green)}
.tl-icon.meeting{background:var(--orange-bg);color:var(--orange)}
.tl-icon svg{width:14px;height:14px}
.tl-content{flex:1;min-width:0}
.tl-subject{font-size:12px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tl-meta{font-size:10px;color:var(--text2);margin-top:1px}
.tl-preview{font-size:11px;color:var(--text2);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tl-time{font-size:10px;color:var(--text2);flex-shrink:0;white-space:nowrap}
.tl-reply-btn{background:none;border:1px solid var(--border);color:var(--text2);cursor:pointer;padding:3px 6px;border-radius:4px;font-size:10px;flex-shrink:0;transition:.15s;font-family:inherit}
.tl-reply-btn:hover{background:var(--surface2);color:var(--text);border-color:var(--accent)}

/* Compose email modal */
.compose-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;place-items:center;backdrop-filter:blur(4px)}
.compose-overlay.active{display:grid}
.compose-box{background:var(--surface);border:1px solid var(--border);border-radius:14px;width:560px;max-width:92vw;max-height:85vh;display:flex;flex-direction:column;overflow:hidden}
.compose-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border)}
.compose-header h3{font-size:14px;font-weight:600}
.compose-fields{padding:12px 18px;display:flex;flex-direction:column;gap:8px;border-bottom:1px solid var(--border)}
.compose-field{display:flex;align-items:center;gap:8px;font-size:12px}
.compose-field label{color:var(--text2);min-width:32px;font-weight:500}
.compose-field input{flex:1;background:none;border:none;outline:none;color:var(--text);font-size:13px;font-family:inherit;padding:4px 0}
.compose-body{flex:1;padding:0}
.compose-body textarea{width:100%;min-height:180px;background:none;border:none;outline:none;color:var(--text);font-size:13px;font-family:inherit;padding:14px 18px;resize:none;line-height:1.6}
.compose-footer{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;border-top:1px solid var(--border)}
.compose-footer .btn-send{background:var(--accent);color:#fff;font-weight:600;padding:7px 20px;border-radius:8px;border:none;font-size:13px;cursor:pointer;font-family:inherit;transition:.15s}
.compose-footer .btn-send:hover{background:#7c6df0}
.compose-footer .btn-send:disabled{opacity:.5;cursor:not-allowed}

/* Shift main when panel is open */
.main.panel-open{margin-right:440px}

/* ── SETTINGS MODAL ── */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;place-items:center;backdrop-filter:blur(4px)}
.modal-overlay.active{display:grid}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px;width:520px;max-width:90vw;max-height:90vh;overflow-y:auto}
.modal h2{font-size:20px;font-weight:700;margin-bottom:8px}
.modal p{color:var(--text2);font-size:13px;margin-bottom:16px;line-height:1.5}
.modal label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;margin-top:16px}
.modal input[type=text]{width:100%;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;font-family:inherit;outline:none}
.modal input[type=text]:focus{border-color:var(--accent)}
.modal .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:24px}
.modal .help-text{font-size:11px;color:var(--text2);margin-top:6px;line-height:1.5}
.modal .steps{text-align:left;background:var(--surface2);border-radius:10px;padding:16px;margin-top:12px}
.modal .steps ol{margin:0;padding-left:20px;display:flex;flex-direction:column;gap:8px;font-size:13px;color:var(--text);line-height:1.5}
.modal .steps code{background:var(--bg);padding:2px 6px;border-radius:4px;font-size:12px;color:var(--accent2)}

/* ── BLOCKED DOMAIN TAGS ── */
.blocked-tag{display:inline-flex;align-items:center;gap:4px;background:var(--red-bg);color:var(--red);border:1px solid rgba(255,118,117,.2);border-radius:6px;padding:3px 8px 3px 10px;font-size:11px;font-weight:500}
.blocked-tag button{background:none;border:none;color:var(--red);cursor:pointer;padding:0 2px;font-size:14px;line-height:1;opacity:.7;transition:.15s}
.blocked-tag button:hover{opacity:1}

/* ── AI CHAT MINI ── */
.ai-chat-fab{position:fixed;bottom:24px;right:24px;width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#a29bfe);border:none;cursor:pointer;display:grid;place-items:center;z-index:80;box-shadow:0 4px 20px rgba(108,92,231,.4);transition:.2s}
.ai-chat-fab:hover{transform:scale(1.08)}
.ai-chat-fab svg{width:24px;height:24px;color:#fff}
.ai-chat{position:fixed;bottom:90px;right:24px;width:360px;background:var(--surface);border:1px solid var(--border);border-radius:16px;z-index:80;display:none;flex-direction:column;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,.4)}
.ai-chat.open{display:flex}
.ai-chat-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;font-weight:600;font-size:14px}
.ai-chat-header .dot{width:8px;height:8px;border-radius:50%;background:var(--green)}
.ai-chat-messages{flex:1;padding:16px;display:flex;flex-direction:column;gap:12px;max-height:300px;overflow-y:auto}
.ai-msg{max-width:85%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.5}
.ai-msg.bot{background:var(--surface2);align-self:flex-start;border-bottom-left-radius:4px}
.ai-msg.user{background:var(--accent);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.ai-chat-input{display:flex;border-top:1px solid var(--border);padding:10px}
.ai-chat-input input{flex:1;background:var(--surface2);border:none;border-radius:8px;padding:10px 14px;color:var(--text);font-size:13px;font-family:inherit;outline:none}
.ai-chat-input button{background:none;border:none;cursor:pointer;padding:0 10px;color:var(--accent2)}

.crm-content{display:none;flex-direction:column;gap:20px;flex:1}
.crm-content.active{display:flex}

.ai-insight{background:linear-gradient(135deg,rgba(108,92,231,.1),rgba(162,155,254,.08));border:1px solid rgba(108,92,231,.2);border-radius:8px;padding:10px;margin-top:8px;display:flex;gap:8px}
.ai-insight svg{width:16px;height:16px;color:var(--accent2);flex-shrink:0;margin-top:2px}
.ai-insight p{font-size:12px;line-height:1.4;color:var(--text)}
.ai-insight .label{font-size:10px;font-weight:600;color:var(--accent2);margin-bottom:2px}

/* ── RESPONSIVE ── */
@media(max-width:900px){
  .sidebar{display:none}
  .stats{grid-template-columns:repeat(2,1fr)}
  .detail-panel.open{width:100%;position:fixed}
  .main.panel-open{margin-right:0}
}
@media(max-width:600px){
  .stats{grid-template-columns:1fr}
  .search-box{width:100%}
  .toolbar{flex-direction:column;align-items:stretch}
  .compose-box{width:100%;max-width:100%;border-radius:0;max-height:100vh}
}
</style>
</head>
<body>

<!-- TOP BAR -->
<header class="topbar">
  <div class="logo">
    <svg viewBox="0 0 28 28" fill="none"><rect width="28" height="28" rx="7" fill="#6c5ce7"/><path d="M8 14l4 4 8-8" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    RelateFlow
  </div>
  <div class="topbar-actions" id="topbarActions">
    <button class="btn btn-ghost btn-sm" id="settingsBtn" onclick="openSettings()" style="display:none" title="Configure Azure App">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.32 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      Settings
    </button>
    <button class="btn btn-ms btn-sm" id="scanOutlookBtn" onclick="scanOutlookEmails()" style="display:none">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
      Sync Emails
    </button>
    <button class="btn btn-ghost btn-sm" id="exportBtn" onclick="exportCSV()" style="display:none">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Export CSV
    </button>
    <div class="user-pill" id="userPill" style="display:none">
      <span class="dot"></span>
      <span id="userName">user@outlook.com</span>
    </div>
    <button class="btn btn-ghost btn-sm" id="signOutBtn" onclick="signOut()" style="display:none">Sign Out</button>
  </div>
</header>

<div class="layout">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar" style="display:none">
    <div class="sidebar-item active" onclick="filterByStatus('all',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      All Companies
      <span class="sidebar-badge" id="companyCount">0</span>
    </div>
    <div class="sidebar-section">Segments</div>
    <div class="sidebar-item" onclick="filterByStatus('Hot',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      Hot Leads
    </div>
    <div class="sidebar-item" onclick="filterByStatus('Warm',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/></svg>
      Warm Leads
    </div>
    <div class="sidebar-item" onclick="filterByStatus('New',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      New
    </div>
    <div class="sidebar-item" onclick="filterByStatus('Cold',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h20"/></svg>
      Cold
    </div>
    <div class="sidebar-section">Actions</div>
    <div class="sidebar-item" onclick="scanOutlookEmails()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Sync Emails
    </div>
    <div class="sidebar-section">Manage</div>
    <div class="sidebar-item" id="blockedViewItem" onclick="showBlockedView()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
      Blocked
      <span class="sidebar-badge" id="blockedCount" style="background:var(--red)">0</span>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">
    <!-- WELCOME / SIGN IN -->
    <div class="welcome-screen" id="welcomeScreen">
      <div class="welcome-card">
        <h1>Welcome to RelateFlow</h1>
        <p class="subtitle">AI-powered CRM that scans your Outlook emails to automatically build your sales pipeline. Zero data entry.</p>

        <button class="ms-btn" onclick="signIn()">
          <svg viewBox="0 0 21 21"><rect x="1" y="1" width="9" height="9" fill="#f25022"/><rect x="11" y="1" width="9" height="9" fill="#7fba00"/><rect x="1" y="11" width="9" height="9" fill="#00a4ef"/><rect x="11" y="11" width="9" height="9" fill="#ffb900"/></svg>
          Sign in with Microsoft
        </button>

        <div class="welcome-features">
          <div class="welcome-feat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            <div><span class="feat-title">Email Scanning</span><span class="feat-desc">Reads your Outlook inbox automatically</span></div>
          </div>
          <div class="welcome-feat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/></svg>
            <div><span class="feat-title">Auto Companies</span><span class="feat-desc">Creates companies from email domains</span></div>
          </div>
          <div class="welcome-feat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
            <div><span class="feat-title">Email Tracking</span><span class="feat-desc">Sent vs received per company</span></div>
          </div>
          <div class="welcome-feat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            <div><span class="feat-title">AI Scoring</span><span class="feat-desc">Smart lead scoring from engagement</span></div>
          </div>
        </div>

        <p class="welcome-note">First time? You'll need an Azure App registration. Click the gear icon after sign-in to configure, or <a href="#" onclick="openSettings();return false" style="color:var(--accent2)">set it up now</a>.</p>
      </div>
    </div>

    <!-- CRM CONTENT (shown after sign-in) -->
    <div class="crm-content" id="crmContent">
      <!-- SCAN BANNER -->
      <div class="scan-banner" id="scanBanner">
        <div class="scan-spinner"></div>
        <span class="scan-text" id="scanText">Scanning your Outlook emails...</span>
        <span class="scan-count" id="scanCount"></span>
      </div>

      <!-- LAST SYNC STATUS -->
      <div id="lastSyncBar" style="display:none;padding:6px 16px;font-size:11px;color:var(--text2);background:var(--surface2);border-radius:8px;margin:8px 16px 0;display:none;align-items:center;gap:6px">
        <span id="syncStatusDot" style="width:6px;height:6px;border-radius:50%;background:var(--green);flex-shrink:0"></span>
        <span id="lastSyncText">Never synced</span>
      </div>

      <!-- STATS -->
      <div class="stats">
        <div class="stat-card">
          <span class="stat-label">Total Companies</span>
          <span class="stat-value" id="statCompanies">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Emails Sent</span>
          <span class="stat-value" id="statSent">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Emails Received</span>
          <span class="stat-value" id="statRecv">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Top Contacts</span>
          <span class="stat-value" id="statContacts">0</span>
        </div>
      </div>

      <!-- TOOLBAR -->
      <div class="toolbar">
        <div class="toolbar-left">
          <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" id="searchInput" placeholder="Search companies, contacts..." oninput="renderTable()">
          </div>
        </div>
        <div class="toolbar-right">
          <button class="btn btn-ghost btn-sm" onclick="sortTable('sent')">Sort: Most Emails</button>
        </div>
      </div>

      <!-- TABLE -->
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="col-check"><input type="checkbox" class="row-checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)"></th>
              <th onclick="sortTable('company')">Company</th>
              <th onclick="sortTable('contact')">Primary Contact</th>
              <th onclick="sortTable('sent')">Sent</th>
              <th onclick="sortTable('received')">Received</th>
              <th>Email Ratio</th>
              <th onclick="sortTable('status')">Status</th>
              <th onclick="sortTable('score')">AI Score</th>
              <th onclick="sortTable('lastActivity')">Last Email</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<!-- BULK ACTIONS BAR -->
<div class="bulk-bar" id="bulkBar">
  <span class="bulk-count" id="bulkCount">0 selected</span>
  <div class="bulk-sep"></div>
  <button class="btn btn-sm btn-danger" onclick="bulkBlockSelected()">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
    Block from System
  </button>
  <button class="btn btn-ghost btn-sm" onclick="clearSelection()">Cancel</button>
</div>

<!-- INLINE DETAIL PANEL (right side) -->
<div class="detail-panel" id="detailPanel">
  <div class="dp-scroll" id="dpScroll"></div>
</div>

<!-- COMPOSE EMAIL MODAL -->
<div class="compose-overlay" id="composeOverlay">
  <div class="compose-box">
    <div class="compose-header">
      <h3 id="composeTitle">New Email</h3>
      <button class="dp-close" onclick="closeCompose()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="compose-fields">
      <div class="compose-field"><label>To</label><input type="text" id="composeTo" readonly></div>
      <div class="compose-field"><label>Subj</label><input type="text" id="composeSubject" placeholder="Subject"></div>
    </div>
    <div class="compose-body">
      <textarea id="composeBody" placeholder="Write your message..."></textarea>
    </div>
    <div class="compose-footer">
      <span style="font-size:11px;color:var(--text2)" id="composeSendStatus"></span>
      <button class="btn-send" id="composeSendBtn" onclick="sendComposedEmail()">Send</button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <h2>Azure App Configuration</h2>
    <p>To connect your Outlook, you need a Microsoft Azure App Registration. This gives RelateFlow permission to read your emails.</p>

    <div class="steps">
      <ol>
        <li>Go to <strong>portal.azure.com</strong> &rarr; <strong>Microsoft Entra ID</strong> &rarr; <strong>App registrations</strong></li>
        <li>Click <strong>New registration</strong>, name it "RelateFlow CRM"</li>
        <li>Set <strong>Redirect URI</strong> (SPA) to: <code id="redirectDisplay">https://sheph007-pixel.github.io/codex/</code></li>
        <li>Under <strong>API permissions</strong>, add: <code>Mail.Read</code> and <code>Mail.Send</code> (Delegated)</li>
        <li>Click <strong>Grant admin consent</strong> (or have your admin do it)</li>
        <li>Copy the <strong>Application (client) ID</strong> and paste it below</li>
      </ol>
    </div>

    <label>Application (Client) ID</label>
    <input type="text" id="clientIdInput" placeholder="e.g. 12345678-abcd-1234-abcd-123456789abc">
    <p class="help-text">This is stored only in your browser's localStorage. Nothing is sent to any server.</p>

    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
      <label style="font-size:12px;color:var(--text2);margin-bottom:6px;display:block">Protected Domains &amp; Emails</label>
      <p class="help-text" style="margin-top:0;margin-bottom:8px">Domains and emails listed here will never appear in your CRM. Add multiple at once — one per line, or comma/space separated.</p>
      <div style="display:flex;gap:8px">
        <textarea id="blockDomainsInput" rows="3" placeholder="e.g. newsletter.com, noreply@company.com, spam.org" style="flex:1;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;font-family:inherit;outline:none;resize:vertical"></textarea>
        <button class="btn btn-primary" onclick="addBlockedDomainsFromInput()" style="align-self:flex-start;font-size:12px;white-space:nowrap">Block</button>
      </div>
      <div id="blockedDomainsList" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px"></div>
    </div>

    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
      <label style="font-size:12px;color:var(--text2);margin-bottom:6px;display:block">Data Management</label>
      <button class="btn btn-ghost" onclick="fullRescan()" style="color:var(--red);border-color:var(--red);font-size:12px">Reset &amp; Full Re-scan</button>
      <p class="help-text" style="margin-top:4px">Clears all cached data and re-scans every email from scratch.</p>
    </div>

    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeSettings()">Cancel</button>
      <button class="btn btn-primary" onclick="saveSettings()">Save & Connect</button>
    </div>
  </div>
</div>

<!-- AI CHAT FAB -->
<button class="ai-chat-fab" onclick="toggleAIChat()" id="chatFab" style="display:none">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
</button>
<div class="ai-chat" id="aiChat">
  <div class="ai-chat-header"><span class="dot"></span> RelateFlow AI</div>
  <div class="ai-chat-messages" id="aiMessages">
    <div class="ai-msg bot">Hi! I'm analyzing your real email data. Ask me anything — "Who should I follow up with?" or "Show me my hottest leads."</div>
  </div>
  <div class="ai-chat-input">
    <input type="text" id="aiInput" placeholder="Ask AI about your pipeline..." onkeydown="if(event.key==='Enter')sendAI()">
    <button onclick="sendAI()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
  </div>
</div>

<script>
// ──────────────────────────────────────────────
// CONFIG & STATE
// ──────────────────────────────────────────────
const COLORS = ['#6c5ce7','#00cec9','#e17055','#0984e3','#fdcb6e','#e84393','#00b894','#d63031','#6c5ce7','#fd79a8','#74b9ff','#a29bfe'];
const STATUS_CLASS = {Hot:'badge-hot',Warm:'badge-warm',New:'badge-new',Cold:'badge-cold'};
const SKIP_DOMAINS = new Set(['gmail.com','yahoo.com','hotmail.com','outlook.com','live.com','aol.com','icloud.com','me.com','mac.com','msn.com','googlemail.com','protonmail.com','proton.me','ymail.com','mail.com']);

let companies = [];
let domainMap = {};
let lastScanTime = null;
let currentSort = {key:'sent',asc:false};
let currentFilter = 'all';
let msalInstance = null;
let currentAccount = null;
let userEmail = '';
let isScanning = false;
let fullScanDone = false;
let autoSyncTimer = null;
const AUTO_SYNC_INTERVAL = 5 * 60 * 1000; // 5 minutes
let blockedDomains = new Set();
let selectedIds = new Set();
let starredContacts = {};  // { "domain": "email@example.com" }
let currentCompanyOverlay = null;  // company object for open overlay
let currentContactOverlay = null;  // { contact, company, domain }
let currentContactTab = 'all';
let contactTimelineCache = {};  // "email" -> [{type,subject,date,...}]

// ──────────────────────────────────────────────
// STARRED / PRIMARY CONTACTS PERSISTENCE
// ──────────────────────────────────────────────
function loadStarredContacts() {
  try {
    const raw = localStorage.getItem('relateflow_starred_contacts');
    starredContacts = raw ? JSON.parse(raw) : {};
  } catch(e) { starredContacts = {}; }
}

function saveStarredContacts() {
  localStorage.setItem('relateflow_starred_contacts', JSON.stringify(starredContacts));
}

function getPrimaryContact(domain, contacts) {
  // If user has starred someone, use that
  if (starredContacts[domain]) {
    const starred = contacts.find(c => c.email === starredContacts[domain]);
    if (starred) return starred;
  }
  // Default: most interactions (already sorted by buildCompaniesFromDomainMap)
  return contacts[0];
}

// ──────────────────────────────────────────────
// BLOCKED DOMAINS PERSISTENCE (localStorage)
// ──────────────────────────────────────────────
function loadBlockedDomains() {
  try {
    const raw = localStorage.getItem('relateflow_blocked_domains');
    blockedDomains = raw ? new Set(JSON.parse(raw)) : new Set();
  } catch(e) { blockedDomains = new Set(); }
}

function saveBlockedDomains() {
  localStorage.setItem('relateflow_blocked_domains', JSON.stringify([...blockedDomains]));
}

function isBlockedDomain(domain) {
  return SKIP_DOMAINS.has(domain) || blockedDomains.has(domain);
}

// ──────────────────────────────────────────────
// SMART NAME FORMATTING
// ──────────────────────────────────────────────
const NAME_SMALL_WORDS = new Set(['a','an','the','and','but','or','for','nor','at','by','in','of','on','to','up','as','is','it']);

function titleCase(str) {
  if (!str) return '';
  return str.replace(/\w\S*/g, (word, index) => {
    if (index > 0 && NAME_SMALL_WORDS.has(word.toLowerCase())) return word.toLowerCase();
    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
  });
}

function formatContactName(rawName, email) {
  if (!rawName || rawName === email || rawName === email?.toLowerCase()) {
    // No real name — try to extract from email prefix
    if (!email) return 'Unknown';
    const prefix = email.split('@')[0];
    // Handle john.doe, john_doe, john-doe patterns
    const parts = prefix.split(/[._\-+]+/).filter(Boolean);
    if (parts.length >= 2 && parts.every(p => /^[a-z]+$/i.test(p))) {
      return parts.map(p => p.charAt(0).toUpperCase() + p.slice(1).toLowerCase()).join(' ');
    }
    return titleCase(prefix);
  }

  let name = rawName.trim();
  // Strip surrounding quotes
  name = name.replace(/^["']|["']$/g, '').trim();
  // Handle "Last, First" format
  if (/^[^,]+,\s*[^,]+$/.test(name)) {
    const [last, first] = name.split(',').map(s => s.trim());
    name = first + ' ' + last;
  }
  // If all uppercase or all lowercase, apply title case
  if (name === name.toUpperCase() || name === name.toLowerCase()) {
    name = titleCase(name);
  }
  // Handle mixed: only fix if first letter of each word is lowercase
  const words = name.split(/\s+/);
  name = words.map(w => {
    if (w.length <= 1) return w.toUpperCase();
    // Preserve intentional casing like "McDonald", "O'Brien", "MacLeod"
    if (/^(Mc|Mac|O')[A-Z]/.test(w)) return w;
    // If word is all-caps (initials like "CEO", "Jr", "III"), keep it
    if (w === w.toUpperCase() && w.length <= 4) return w;
    // If first char is lowercase, fix it
    if (w[0] === w[0].toLowerCase() && w[0] !== w[0].toUpperCase()) {
      return w.charAt(0).toUpperCase() + w.slice(1);
    }
    return w;
  }).join(' ');

  return name;
}

// ──────────────────────────────────────────────
// COMPANY NAME LOOKUP (Clearbit Autocomplete API)
// ──────────────────────────────────────────────
const companyNameCache = {};
let companyNameCacheDirty = false;

function loadCompanyNameCache() {
  try {
    const raw = localStorage.getItem('relateflow_company_names');
    if (raw) Object.assign(companyNameCache, JSON.parse(raw));
  } catch(e) {}
}

function saveCompanyNameCache() {
  if (!companyNameCacheDirty) return;
  try {
    localStorage.setItem('relateflow_company_names', JSON.stringify(companyNameCache));
    companyNameCacheDirty = false;
  } catch(e) {}
}

// Known brand corrections for common domains
const KNOWN_BRANDS = {
  'github.com':'GitHub','linkedin.com':'LinkedIn','youtube.com':'YouTube',
  'stackoverflow.com':'Stack Overflow','wordpress.com':'WordPress','javascript.com':'JavaScript',
  'salesforce.com':'Salesforce','hubspot.com':'HubSpot','mailchimp.com':'Mailchimp',
  'shopify.com':'Shopify','atlassian.com':'Atlassian','bitbucket.org':'Bitbucket',
  'microsoft.com':'Microsoft','apple.com':'Apple','amazon.com':'Amazon',
  'google.com':'Google','facebook.com':'Meta','twitter.com':'X (Twitter)',
  'netflix.com':'Netflix','uber.com':'Uber','airbnb.com':'Airbnb',
  'stripe.com':'Stripe','twilio.com':'Twilio','figma.com':'Figma',
  'notion.so':'Notion','slack.com':'Slack','zoom.us':'Zoom',
  'dropbox.com':'Dropbox','asana.com':'Asana','trello.com':'Trello',
  'intercom.io':'Intercom','zendesk.com':'Zendesk','freshdesk.com':'Freshdesk',
  'squarespace.com':'Squarespace','wix.com':'Wix','godaddy.com':'GoDaddy',
  'cloudflare.com':'Cloudflare','digitalocean.com':'DigitalOcean',
  'mongodb.com':'MongoDB','postgresql.org':'PostgreSQL','oracle.com':'Oracle',
  'ibm.com':'IBM','dell.com':'Dell','hp.com':'HP','intel.com':'Intel',
  'nvidia.com':'NVIDIA','amd.com':'AMD','cisco.com':'Cisco',
  'vmware.com':'VMware','redhat.com':'Red Hat','canonical.com':'Canonical',
  'paypal.com':'PayPal','jpmorgan.com':'JPMorgan','goldmansachs.com':'Goldman Sachs',
  'deloitte.com':'Deloitte','mckinsey.com':'McKinsey','bcg.com':'BCG',
  'pwc.com':'PwC','ey.com':'Ernst & Young','kpmg.com':'KPMG',
};

async function lookupCompanyName(domain) {
  // 1. Check cache
  if (companyNameCache[domain]) return companyNameCache[domain];
  // 2. Check known brands
  if (KNOWN_BRANDS[domain]) {
    companyNameCache[domain] = KNOWN_BRANDS[domain];
    companyNameCacheDirty = true;
    return KNOWN_BRANDS[domain];
  }
  // 3. Try Clearbit autocomplete API (free, no auth)
  try {
    const query = domain.split('.')[0];
    const resp = await fetch('https://autocomplete.clearbit.com/v1/companies/suggest?query=' + encodeURIComponent(query));
    if (resp.ok) {
      const results = await resp.json();
      // Find exact domain match
      const match = results.find(r => r.domain === domain);
      if (match && match.name) {
        companyNameCache[domain] = match.name;
        companyNameCacheDirty = true;
        return match.name;
      }
      // Fuzzy: if domain prefix matches closely
      const fuzzy = results.find(r => r.domain && r.domain.split('.')[0] === domain.split('.')[0]);
      if (fuzzy && fuzzy.name) {
        companyNameCache[domain] = fuzzy.name;
        companyNameCacheDirty = true;
        return fuzzy.name;
      }
    }
  } catch(e) { /* API unavailable — fall through to smart formatting */ }
  // 4. Fallback: smart title case from domain prefix
  const prefix = domain.split('.')[0];
  const formatted = titleCase(prefix.replace(/[-_]/g, ' '));
  companyNameCache[domain] = formatted;
  companyNameCacheDirty = true;
  return formatted;
}

// ──────────────────────────────────────────────
// INDEXEDDB PERSISTENCE
// ──────────────────────────────────────────────
const DB_NAME = 'relateflow';
const DB_VERSION = 1;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('domainData')) db.createObjectStore('domainData', { keyPath: 'domain' });
      if (!db.objectStoreNames.contains('meta')) db.createObjectStore('meta', { keyPath: 'key' });
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function persistData() {
  try {
    const db = await openDB();
    const tx = db.transaction(['domainData', 'meta'], 'readwrite');
    const domainStore = tx.objectStore('domainData');
    const metaStore = tx.objectStore('meta');
    domainStore.clear();
    for (const [domain, data] of Object.entries(domainMap)) {
      const rec = { domain, contacts: {}, totalSent: data.totalSent, totalReceived: data.totalReceived, lastDate: data.lastDate ? data.lastDate.toISOString() : null };
      for (const [email, c] of Object.entries(data.contacts)) {
        rec.contacts[email] = { ...c, lastDate: c.lastDate ? c.lastDate.toISOString() : null };
      }
      domainStore.put(rec);
    }
    metaStore.put({ key: 'lastScanTime', value: lastScanTime ? lastScanTime.toISOString() : null });
    metaStore.put({ key: 'userEmail', value: userEmail });
    metaStore.put({ key: 'fullScanDone', value: fullScanDone });
    await new Promise((res, rej) => { tx.oncomplete = res; tx.onerror = () => rej(tx.error); });
  } catch(e) { console.warn('Persist failed:', e); }
}

async function loadPersistedData() {
  try {
    const db = await openDB();
    const tx = db.transaction(['domainData', 'meta'], 'readonly');
    const ds = tx.objectStore('domainData');
    const ms = tx.objectStore('meta');
    const [domains, scanRec, emailRec, fullScanRec] = await Promise.all([
      new Promise((r, j) => { const q = ds.getAll(); q.onsuccess = () => r(q.result); q.onerror = j; }),
      new Promise((r, j) => { const q = ms.get('lastScanTime'); q.onsuccess = () => r(q.result); q.onerror = j; }),
      new Promise((r, j) => { const q = ms.get('userEmail'); q.onsuccess = () => r(q.result); q.onerror = j; }),
      new Promise((r, j) => { const q = ms.get('fullScanDone'); q.onsuccess = () => r(q.result); q.onerror = j; }),
    ]);
    if (!domains || domains.length === 0) return null;
    if (emailRec?.value && emailRec.value !== userEmail) return null;
    const map = {};
    for (const d of domains) {
      map[d.domain] = { contacts: {}, totalSent: d.totalSent, totalReceived: d.totalReceived, lastDate: d.lastDate ? new Date(d.lastDate) : null };
      for (const [email, c] of Object.entries(d.contacts)) {
        map[d.domain].contacts[email] = { ...c, lastDate: c.lastDate ? new Date(c.lastDate) : null };
      }
    }
    return { domainMap: map, lastScanTime: scanRec?.value ? new Date(scanRec.value) : null, fullScanDone: !!fullScanRec?.value };
  } catch(e) { console.warn('Load failed:', e); return null; }
}

async function clearPersistedData() {
  try {
    const db = await openDB();
    const tx = db.transaction(['domainData', 'meta'], 'readwrite');
    tx.objectStore('domainData').clear();
    tx.objectStore('meta').clear();
    await new Promise(r => { tx.oncomplete = r; });
  } catch(e) { console.warn('Clear failed:', e); }
}

// ──────────────────────────────────────────────
// MSAL SETUP
// ──────────────────────────────────────────────
const MSAL_CDN_URLS = [
  'https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js',
  'https://unpkg.com/@azure/msal-browser@2.38.3/lib/msal-browser.min.js',
  'https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js'
];

function loadScript(url) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = url;
    s.onload = resolve;
    s.onerror = () => reject(new Error('Failed to load: ' + url));
    document.head.appendChild(s);
  });
}

async function ensureMSALLoaded() {
  if (typeof msal !== 'undefined') return true;
  for (const url of MSAL_CDN_URLS) {
    try {
      await loadScript(url);
      if (typeof msal !== 'undefined') return true;
    } catch(e) {
      console.warn(e.message);
    }
  }
  return false;
}

function getClientId() {
  return localStorage.getItem('relateflow_client_id') || '';
}

async function initMSAL() {
  const clientId = getClientId();
  if (!clientId) return null;

  const loaded = await ensureMSALLoaded();
  if (!loaded) {
    alert('Could not load the Microsoft authentication library. Please check your internet connection or try disabling ad-blockers, then refresh the page.');
    return null;
  }

  const config = {
    auth: {
      clientId: clientId,
      authority: 'https://login.microsoftonline.com/common',
      redirectUri: window.location.origin + window.location.pathname,
    },
    cache: {
      cacheLocation: 'localStorage',
      storeAuthStateInCookie: false,
    }
  };
  try {
    msalInstance = new msal.PublicClientApplication(config);
    if (typeof msalInstance.initialize === 'function') {
      await msalInstance.initialize();
    }
    try { await msalInstance.handleRedirectPromise(); } catch(e) { console.warn('Redirect handle:', e); }
    return msalInstance;
  } catch(e) {
    console.error('MSAL init error:', e);
    alert('MSAL initialization failed: ' + e.message);
    msalInstance = null;
    return null;
  }
}

async function signIn() {
  if (!getClientId()) {
    openSettings();
    return;
  }
  if (!msalInstance) await initMSAL();
  if (!msalInstance) { alert('Could not initialize Microsoft authentication. Check your Client ID.'); openSettings(); return; }

  try {
    const resp = await msalInstance.loginPopup({
      scopes: ['Mail.Read','Mail.Send','User.Read'],
      prompt: 'select_account'
    });
    currentAccount = resp.account;
    userEmail = currentAccount.username;
    onSignedIn();
  } catch(e) {
    console.error('Sign-in error:', e);
    if (e.errorCode === 'user_cancelled') return;
    // If popup blocked, try redirect
    if (e.errorCode === 'popup_window_error' || e.errorCode === 'empty_window_error') {
      alert('Popup was blocked by your browser. Trying redirect login instead...');
      msalInstance.loginRedirect({ scopes: ['Mail.Read','Mail.Send','User.Read'] });
      return;
    }
    alert('Sign-in failed: ' + (e.errorCode || '') + ' — ' + (e.message || e));
  }
}

function signOut() {
  stopAutoSync();
  if (msalInstance && currentAccount) {
    msalInstance.logoutPopup({ account: currentAccount });
  }
  currentAccount = null;
  userEmail = '';
  companies = [];
  domainMap = {};
  lastScanTime = null;
  fullScanDone = false;
  isScanning = false;
  showWelcome();
}

async function getAccessToken() {
  if (!msalInstance || !currentAccount) throw new Error('Not signed in');
  try {
    const resp = await msalInstance.acquireTokenSilent({
      scopes: ['Mail.Read','Mail.Send','User.Read'],
      account: currentAccount
    });
    return resp.accessToken;
  } catch(e) {
    const resp = await msalInstance.acquireTokenPopup({
      scopes: ['Mail.Read','Mail.Send','User.Read']
    });
    currentAccount = resp.account;
    return resp.accessToken;
  }
}

// ──────────────────────────────────────────────
// DOMAIN MAP HELPERS
// ──────────────────────────────────────────────
function getDomain(email) {
  if (!email) return null;
  const d = email.split('@')[1];
  return d ? d.toLowerCase() : null;
}

function ensureDomain(domain) {
  if (!domainMap[domain]) {
    domainMap[domain] = { contacts: {}, totalSent: 0, totalReceived: 0, lastDate: null };
  }
}

function ensureContact(domain, email, name) {
  ensureDomain(domain);
  const le = email.toLowerCase();
  const formatted = formatContactName(name, le);
  if (!domainMap[domain].contacts[le]) {
    domainMap[domain].contacts[le] = { name: formatted, email: le, sent: 0, received: 0, lastDate: null };
  } else {
    const existing = domainMap[domain].contacts[le].name;
    // Upgrade name if current one is just the email or worse quality
    if (existing === le || existing === email || (name && name !== email && existing === formatContactName(null, le))) {
      domainMap[domain].contacts[le].name = formatted;
    }
  }
}

function updateDate(obj, dateStr) {
  if (!dateStr) return;
  const d = new Date(dateStr);
  if (!obj.lastDate || d > obj.lastDate) obj.lastDate = d;
}

// ──────────────────────────────────────────────
// PROCESS EMAIL BATCH → UPDATE DOMAIN MAP
// ──────────────────────────────────────────────
function processEmailBatch(messages) {
  const myEmailLower = userEmail ? userEmail.toLowerCase() : '';
  const myDomain = userEmail ? getDomain(userEmail) : null;

  for (const msg of messages) {
    const fromEmail = msg.from?.emailAddress?.address?.toLowerCase() || '';
    const isSent = (fromEmail === myEmailLower);

    if (isSent) {
      // SENT email — track all recipients
      const recipients = [...(msg.toRecipients || []), ...(msg.ccRecipients || [])];
      for (const r of recipients) {
        const toEmail = r.emailAddress?.address;
        const toName = r.emailAddress?.name;
        if (!toEmail) continue;
        const domain = getDomain(toEmail);
        if (!domain || isBlockedDomain(domain) || domain === myDomain) continue;
        ensureContact(domain, toEmail, toName);
        const le = toEmail.toLowerCase();
        domainMap[domain].contacts[le].sent++;
        domainMap[domain].totalSent++;
        updateDate(domainMap[domain], msg.sentDateTime || msg.receivedDateTime);
        updateDate(domainMap[domain].contacts[le], msg.sentDateTime || msg.receivedDateTime);
      }
    } else {
      // RECEIVED email — track the sender
      const senderEmail = msg.from?.emailAddress?.address;
      const senderName = msg.from?.emailAddress?.name;
      if (!senderEmail) continue;
      const domain = getDomain(senderEmail);
      if (!domain || isBlockedDomain(domain) || domain === myDomain) continue;
      ensureContact(domain, senderEmail, senderName);
      const le = senderEmail.toLowerCase();
      domainMap[domain].contacts[le].received++;
      domainMap[domain].totalReceived++;
      updateDate(domainMap[domain], msg.receivedDateTime);
      updateDate(domainMap[domain].contacts[le], msg.receivedDateTime);
    }
  }
}

// ──────────────────────────────────────────────
// BUILD COMPANIES FROM DOMAIN MAP
// (Selective contact creation — like Attio, only
//  domains you've actively emailed become records.
//  Spam, newsletters, and cold inbound are filtered.)
// ──────────────────────────────────────────────
function buildCompaniesFromDomainMap() {
  companies = [];
  let id = 1;
  for (const [domain, data] of Object.entries(domainMap)) {
    // Skip blocked domains (including ones blocked after initial scan)
    if (isBlockedDomain(domain)) continue;

    const contactArr = Object.values(data.contacts);
    if (contactArr.length === 0) continue;

    // SELECTIVE: only create company if user has sent at least 1 email to this domain
    if (data.totalSent === 0) continue;

    contactArr.sort((a, b) => (b.sent + b.received) - (a.sent + a.received));
    const primary = getPrimaryContact(domain, contactArr);
    const totalEmails = data.totalSent + data.totalReceived;

    let score = Math.min(99, Math.round(
      Math.min(totalEmails * 1.5, 50) +
      Math.min(contactArr.length * 5, 20) +
      (data.totalSent > 0 && data.totalReceived > 0 ? 15 : 0) +
      (data.lastDate && (Date.now() - data.lastDate.getTime()) < 7 * 86400000 ? 14 : 0)
    ));

    let status = 'Cold';
    if (score >= 75) status = 'Hot';
    else if (score >= 50) status = 'Warm';
    else if (score >= 30) status = 'New';

    // Use cached company name or smart fallback (async lookup happens separately)
    const companyName = companyNameCache[domain]
      || KNOWN_BRANDS[domain]
      || titleCase(domain.split('.')[0].replace(/[-_]/g, ' '));

    companies.push({
      id: id++,
      name: companyName,
      domain: domain,
      contact: primary.name,
      contactEmail: primary.email,
      sent: data.totalSent,
      received: data.totalReceived,
      status: status,
      score: score,
      lastDate: data.lastDate,
      lastActivity: data.lastDate ? timeAgo(data.lastDate) : 'unknown',
      allContacts: contactArr,
    });
  }

  companies.sort((a, b) => (b.sent + b.received) - (a.sent + a.received));
  companies.forEach((c, i) => c.id = i + 1);
}

// Async: look up real company names for any domains not yet in cache
let nameLookupsRunning = false;
async function resolveCompanyNames() {
  if (nameLookupsRunning) return;
  nameLookupsRunning = true;
  try {
    const uncached = companies.filter(c => !companyNameCache[c.domain]).map(c => c.domain);
    if (uncached.length === 0) return;

    // Batch lookups, 5 at a time to avoid rate limits
    for (let i = 0; i < uncached.length; i += 5) {
      const batch = uncached.slice(i, i + 5);
      await Promise.all(batch.map(d => lookupCompanyName(d)));

      // Update company names in-place and re-render
      let changed = false;
      for (const c of companies) {
        if (companyNameCache[c.domain] && c.name !== companyNameCache[c.domain]) {
          c.name = companyNameCache[c.domain];
          changed = true;
        }
      }
      if (changed) renderTable();
    }
    saveCompanyNameCache();
  } catch(e) {
    console.warn('Company name lookup error:', e);
  } finally {
    nameLookupsRunning = false;
  }
}

// ──────────────────────────────────────────────
// PROGRESSIVE EMAIL FETCH + PROCESS + RENDER
// (Data populates in the table as emails are scanned)
// ──────────────────────────────────────────────
async function fetchEmailsProgressively(token, sinceDate) {
  const headers = { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' };
  let url = 'https://graph.microsoft.com/v1.0/me/messages?$top=200&$select=id,subject,from,toRecipients,ccRecipients,receivedDateTime,sentDateTime&$orderby=receivedDateTime desc';

  if (sinceDate) {
    url += '&$filter=receivedDateTime ge ' + sinceDate.toISOString();
  }

  let page = 0;
  let totalFetched = 0;

  while (url) {
    page++;
    updateScanBanner('Scanning' + (sinceDate ? ' recent' : ' all') + ' mail... (' + totalFetched.toLocaleString() + ' emails, page ' + page + ')');

    const resp = await fetch(url, { headers });
    if (!resp.ok) {
      const err = await resp.text();
      throw new Error('Graph API error: ' + resp.status + ' — ' + err);
    }
    const data = await resp.json();

    if (data.value && data.value.length > 0) {
      totalFetched += data.value.length;

      // Process this page immediately
      processEmailBatch(data.value);

      // Rebuild companies and update UI live
      buildCompaniesFromDomainMap();
      renderTable();
      updateStats();
      updateScanBanner('Scanning... ' + totalFetched.toLocaleString() + ' emails — ' + companies.length + ' companies found');

      // Persist every 3 pages so progress survives tab close/refresh
      if (page === 1 || page % 3 === 0) {
        lastScanTime = new Date();
        persistData();
      }
    }

    url = data['@odata.nextLink'] || null;
  }

  return totalFetched;
}

function timeAgo(date) {
  const now = Date.now();
  const diff = now - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  if (days < 7) return days + 'd ago';
  const weeks = Math.floor(days / 7);
  if (weeks < 4) return weeks + 'w ago';
  const months = Math.floor(days / 30);
  return months + 'mo ago';
}

// ──────────────────────────────────────────────
// OUTLOOK SCAN — Full first time, auto-sync after
// ──────────────────────────────────────────────
async function scanOutlookEmails(forceFullScan) {
  if (isScanning) return;
  isScanning = true;

  try {
    showScanBanner('Connecting to Microsoft Graph...');
    const token = await getAccessToken();

    // Decide: full scan or incremental sync
    const needsFullScan = forceFullScan || !fullScanDone;
    let totalFetched;

    if (needsFullScan) {
      // FULL SCAN: every email, all folders, all time
      // NOTE: we do NOT clear domainMap — processEmailBatch merges into
      // existing data, so a refresh mid-scan keeps all accumulated progress
      if (forceFullScan) domainMap = {};  // only clear on explicit "Reset & Full Re-scan"
      showScanBanner('Full scan — reading all emails' + (Object.keys(domainMap).length > 0 ? ' (resuming)' : '') + '...');
      totalFetched = await fetchEmailsProgressively(token, null);
      fullScanDone = true;
      updateScanBanner('Full scan complete! ' + totalFetched.toLocaleString() + ' emails processed, ' + companies.length + ' companies found');
    } else {
      // INCREMENTAL SYNC: only new emails since last scan
      const sinceDate = lastScanTime || new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
      showScanBanner('Quick sync — checking for new emails...');
      totalFetched = await fetchEmailsProgressively(token, sinceDate);
      if (totalFetched > 0) {
        updateScanBanner('Synced ' + totalFetched.toLocaleString() + ' new emails — ' + companies.length + ' companies');
      } else {
        updateScanBanner('All caught up — no new emails');
      }
    }

    lastScanTime = new Date();
    await persistData();
    updateLastSyncDisplay();

    // Resolve real company names in background
    resolveCompanyNames();

    // Keep banner visible briefly
    setTimeout(() => { hideScanBanner(); }, needsFullScan ? 4000 : 2000);

  } catch(e) {
    hideScanBanner();
    console.error('Scan error:', e);
    // Don't alert on auto-sync errors, only on manual scans
    if (!autoSyncTimer) alert('Email scan failed: ' + e.message);
  } finally {
    isScanning = false;
  }
}

// Full re-scan: clears everything and starts fresh
async function fullRescan() {
  domainMap = {};
  lastScanTime = null;
  fullScanDone = false;
  companies = [];
  await clearPersistedData();
  renderTable();
  updateStats();
  closeSettings();
  scanOutlookEmails(true);
}

// ──────────────────────────────────────────────
// AUTO-SYNC — runs every 5 minutes while tab is open
// ──────────────────────────────────────────────
function startAutoSync() {
  stopAutoSync();
  autoSyncTimer = setInterval(() => {
    if (!isScanning && fullScanDone && currentAccount) {
      console.log('[RelateFlow] Auto-sync triggered');
      scanOutlookEmails();
    }
  }, AUTO_SYNC_INTERVAL);
  console.log('[RelateFlow] Auto-sync started (every ' + (AUTO_SYNC_INTERVAL / 60000) + ' min)');
}

function stopAutoSync() {
  if (autoSyncTimer) {
    clearInterval(autoSyncTimer);
    autoSyncTimer = null;
  }
}

// Also sync when tab becomes visible again (user comes back)
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && fullScanDone && currentAccount && !isScanning) {
    // If more than 5 minutes since last sync, trigger immediately
    if (lastScanTime && (Date.now() - lastScanTime.getTime()) > AUTO_SYNC_INTERVAL) {
      console.log('[RelateFlow] Tab visible — syncing stale data');
      scanOutlookEmails();
    }
  }
});

// Last sync display
function updateLastSyncDisplay() {
  const bar = document.getElementById('lastSyncBar');
  if (!lastScanTime) { bar.style.display = 'none'; return; }
  bar.style.display = 'flex';
  const syncStatus = fullScanDone ? 'Auto-sync active' : 'Full scan pending';
  document.getElementById('lastSyncText').textContent =
    'Last synced: ' + timeAgo(lastScanTime) + ' — ' +
    companies.length + ' companies, ' + Object.keys(domainMap).length + ' domains tracked' +
    ' · ' + syncStatus;
}

// ──────────────────────────────────────────────
// UI STATE
// ──────────────────────────────────────────────
function showWelcome() {
  document.getElementById('welcomeScreen').style.display = 'flex';
  document.getElementById('crmContent').classList.remove('active');
  document.getElementById('sidebar').style.display = 'none';
  document.getElementById('scanOutlookBtn').style.display = 'none';
  document.getElementById('exportBtn').style.display = 'none';
  document.getElementById('userPill').style.display = 'none';
  document.getElementById('signOutBtn').style.display = 'none';
  document.getElementById('settingsBtn').style.display = 'none';
  document.getElementById('chatFab').style.display = 'none';
}

async function onSignedIn() {
  document.getElementById('welcomeScreen').style.display = 'none';
  document.getElementById('crmContent').classList.add('active');
  document.getElementById('sidebar').style.display = 'flex';
  document.getElementById('scanOutlookBtn').style.display = '';
  document.getElementById('exportBtn').style.display = '';
  document.getElementById('settingsBtn').style.display = '';
  document.getElementById('signOutBtn').style.display = '';
  document.getElementById('chatFab').style.display = 'grid';
  document.getElementById('userPill').style.display = 'flex';
  document.getElementById('userName').textContent = userEmail;

  // Load cached data from IndexedDB — show instantly (no waiting for scan)
  const cached = await loadPersistedData();
  if (cached && cached.domainMap && Object.keys(cached.domainMap).length > 0) {
    domainMap = cached.domainMap;
    lastScanTime = cached.lastScanTime;
    fullScanDone = cached.fullScanDone || false;
    buildCompaniesFromDomainMap();
    renderTable();
    updateStats();
    updateLastSyncDisplay();
    resolveCompanyNames();
  }
  updateBlockedCount();

  // Scan: full if first time, incremental if full scan already done
  await scanOutlookEmails();

  // Start auto-sync (every 5 min) after initial scan completes
  startAutoSync();
}

function showScanBanner(text) {
  document.getElementById('scanBanner').classList.add('active');
  document.getElementById('scanText').textContent = text;
  document.getElementById('scanCount').textContent = '';
}
function updateScanBanner(text) {
  document.getElementById('scanText').textContent = text;
}
function hideScanBanner() {
  document.getElementById('scanBanner').classList.remove('active');
}

// ──────────────────────────────────────────────
// TABLE RENDERING
// ──────────────────────────────────────────────
function renderTable() {
  let data = [...companies];
  if (currentFilter !== 'all') data = data.filter(c => c.status === currentFilter);
  const q = (document.getElementById('searchInput').value || '').toLowerCase();
  if (q) data = data.filter(c => c.name.toLowerCase().includes(q) || c.contact.toLowerCase().includes(q) || c.domain.toLowerCase().includes(q));

  const {key, asc} = currentSort;
  data.sort((a,b) => {
    let va = a[key], vb = b[key];
    if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb||'').toLowerCase(); }
    if (va < vb) return asc ? -1 : 1;
    if (va > vb) return asc ? 1 : -1;
    return 0;
  });

  const tbody = document.getElementById('tableBody');
  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text2)">No companies found. Click "Sync Emails" to scan your Outlook.</td></tr>';
    updateBulkBar();
    return;
  }

  tbody.innerHTML = data.map(c => {
    const color = COLORS[c.id % COLORS.length];
    const total = c.sent + c.received;
    const sentPct = total ? (c.sent / total * 100) : 50;
    const recvPct = 100 - sentPct;
    const circumference = 2 * Math.PI * 12;
    const offset = circumference - (c.score / 100) * circumference;
    const scoreColor = c.score >= 75 ? 'var(--green)' : c.score >= 50 ? 'var(--orange)' : 'var(--red)';
    const initials = c.contact.split(' ').map(n => n[0]).join('').substring(0,2);
    const checked = selectedIds.has(c.id) ? 'checked' : '';
    const rowClass = selectedIds.has(c.id) ? ' row-selected' : '';

    return `<tr class="${rowClass}" style="cursor:pointer">
      <td class="col-check" onclick="event.stopPropagation()"><input type="checkbox" class="row-checkbox" ${checked} onchange="toggleRowSelect(${c.id}, this.checked)"></td>
      <td onclick="openDetail(${c.id})"><div class="company-cell"><div class="company-logo" style="background:${color}">${c.name[0].toUpperCase()}</div><div class="company-info"><span class="company-name">${esc(c.name)}</span><span class="company-domain">${esc(c.domain)}</span></div></div></td>
      <td onclick="openDetail(${c.id})"><div class="contact-cell"><div class="avatar" style="background:${color}">${esc(initials)}</div><span class="contact-name">${esc(c.contact)}</span></div></td>
      <td onclick="openDetail(${c.id})"><span style="color:var(--accent2);font-weight:600">${c.sent}</span></td>
      <td onclick="openDetail(${c.id})"><span style="color:var(--green);font-weight:600">${c.received}</span></td>
      <td onclick="openDetail(${c.id})"><div class="email-bar"><div class="bar-track"><div class="bar-sent" style="width:${sentPct}%"></div><div class="bar-recv" style="width:${recvPct}%"></div></div></div></td>
      <td onclick="openDetail(${c.id})"><span class="badge ${STATUS_CLASS[c.status]}">${c.status}</span></td>
      <td onclick="openDetail(${c.id})"><div class="ai-score"><div class="score-ring" style="color:${scoreColor}"><svg viewBox="0 0 30 30"><circle class="track" cx="15" cy="15" r="12"/><circle class="fill" cx="15" cy="15" r="12" stroke="${scoreColor}" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"/></svg>${c.score}</div></div></td>
      <td onclick="openDetail(${c.id})" style="color:var(--text2)">${esc(c.lastActivity)}</td>
    </tr>`;
  }).join('');

  // Sync select-all checkbox
  const selectAll = document.getElementById('selectAllCheckbox');
  if (selectAll) {
    const visibleIds = data.map(c => c.id);
    const allChecked = visibleIds.length > 0 && visibleIds.every(id => selectedIds.has(id));
    const someChecked = visibleIds.some(id => selectedIds.has(id));
    selectAll.checked = allChecked;
    selectAll.indeterminate = someChecked && !allChecked;
  }

  updateBulkBar();
  document.getElementById('companyCount').textContent = companies.length;
}

function updateStats() {
  document.getElementById('statCompanies').textContent = companies.length;
  document.getElementById('statSent').textContent = companies.reduce((s,c) => s + c.sent, 0).toLocaleString();
  document.getElementById('statRecv').textContent = companies.reduce((s,c) => s + c.received, 0).toLocaleString();
  document.getElementById('statContacts').textContent = companies.reduce((s,c) => s + (c.allContacts?.length || 1), 0).toLocaleString();
}

function sortTable(key) {
  if (currentSort.key === key) currentSort.asc = !currentSort.asc;
  else { currentSort.key = key; currentSort.asc = key === 'company' || key === 'contact'; }
  renderTable();
}

function filterByStatus(status, el) {
  currentFilter = status;
  document.querySelectorAll('.sidebar-item').forEach(e => e.classList.remove('active'));
  if (el) el.classList.add('active');
  clearSelection();
  renderTable();
}

// ──────────────────────────────────────────────
// SELECTION & BULK ACTIONS
// ──────────────────────────────────────────────
function toggleRowSelect(id, checked) {
  if (checked) selectedIds.add(id);
  else selectedIds.delete(id);
  renderTable();
}

function toggleSelectAll(checked) {
  // Get currently visible/filtered companies
  let data = [...companies];
  if (currentFilter !== 'all') data = data.filter(c => c.status === currentFilter);
  const q = (document.getElementById('searchInput').value || '').toLowerCase();
  if (q) data = data.filter(c => c.name.toLowerCase().includes(q) || c.contact.toLowerCase().includes(q) || c.domain.toLowerCase().includes(q));

  if (checked) {
    data.forEach(c => selectedIds.add(c.id));
  } else {
    data.forEach(c => selectedIds.delete(c.id));
  }
  renderTable();
}

function clearSelection() {
  selectedIds.clear();
  const selectAll = document.getElementById('selectAllCheckbox');
  if (selectAll) { selectAll.checked = false; selectAll.indeterminate = false; }
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById('bulkBar');
  if (selectedIds.size > 0) {
    bar.classList.add('active');
    document.getElementById('bulkCount').textContent = selectedIds.size + ' selected';
  } else {
    bar.classList.remove('active');
  }
}

function bulkBlockSelected() {
  const domains = [];
  for (const id of selectedIds) {
    const c = companies.find(x => x.id === id);
    if (c) domains.push(c.domain);
  }
  if (domains.length === 0) return;
  const msg = domains.length === 1
    ? 'Block "' + domains[0] + '" from your system?'
    : 'Block ' + domains.length + ' domains from your system?\n\n' + domains.join(', ');
  if (!confirm(msg)) return;

  for (const d of domains) {
    blockedDomains.add(d.toLowerCase());
  }
  saveBlockedDomains();
  selectedIds.clear();
  buildCompaniesFromDomainMap();
  renderTable();
  updateStats();
  updateBlockedCount();
}

// ──────────────────────────────────────────────
// BLOCKED DOMAINS VIEW
// ──────────────────────────────────────────────
function updateBlockedCount() {
  const badge = document.getElementById('blockedCount');
  if (badge) badge.textContent = blockedDomains.size;
}

function showBlockedView() {
  // Switch sidebar active
  document.querySelectorAll('.sidebar-item').forEach(e => e.classList.remove('active'));
  document.getElementById('blockedViewItem').classList.add('active');

  // Render blocked domains as a table in the main table body
  const tbody = document.getElementById('tableBody');
  const sorted = [...blockedDomains].sort();

  if (sorted.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text2)">No blocked domains. Domains you block will appear here.</td></tr>';
    return;
  }

  tbody.innerHTML = sorted.map(domain => {
    // Check if domain still has data in domainMap
    const data = domainMap[domain];
    const totalSent = data ? data.totalSent : 0;
    const totalRecv = data ? data.totalReceived : 0;
    const contactCount = data ? Object.keys(data.contacts).length : 0;

    return `<tr>
      <td class="col-check"></td>
      <td><div class="company-cell"><div class="company-logo" style="background:var(--red);opacity:.6">${domain[0].toUpperCase()}</div><div class="company-info"><span class="company-name" style="text-decoration:line-through;opacity:.6">${esc(domain.split('.')[0].charAt(0).toUpperCase() + domain.split('.')[0].slice(1))}</span><span class="company-domain">${esc(domain)}</span></div></div></td>
      <td colspan="5" style="color:var(--text2);font-size:12px">${totalSent} sent, ${totalRecv} received, ${contactCount} contact${contactCount !== 1 ? 's' : ''}</td>
      <td colspan="2" style="text-align:right">
        <button class="btn btn-ghost btn-sm" onclick="unblockDomain('${domain}')" style="font-size:11px;color:var(--green);border-color:var(--green)">Unblock</button>
      </td>
    </tr>`;
  }).join('');

  // Clear select-all since blocked view doesn't use checkboxes
  clearSelection();
}

function unblockDomain(domain) {
  blockedDomains.delete(domain);
  saveBlockedDomains();
  buildCompaniesFromDomainMap();
  updateStats();
  updateBlockedCount();
  showBlockedView(); // Re-render the blocked view
}

// ──────────────────────────────────────────────
// INLINE DETAIL PANEL — single page, no overlays
// States: 'company' (contacts list) or 'contact' (timeline)
// ──────────────────────────────────────────────
let panelState = null; // null | { view:'company', companyId } | { view:'contact', email, domain, companyId }

function openDetail(id) { showCompanyPanel(id); }

function showCompanyPanel(id) {
  const c = companies.find(x => x.id === id);
  if (!c) return;
  currentCompanyOverlay = c;
  panelState = { view: 'company', companyId: id };
  const color = COLORS[c.id % COLORS.length];
  const contacts = c.allContacts || [];
  const sorted = [...contacts].sort((a, b) => (b.sent + b.received) - (a.sent + a.received));
  const primaryEmail = starredContacts[c.domain] || (sorted[0] ? sorted[0].email : '');

  // AI insight
  let insight = '';
  if (c.score >= 75) insight = 'High engagement. ' + (c.sent + c.received) + ' emails exchanged — consider scheduling a call.';
  else if (c.score >= 50) insight = 'Active relationship. ' + (c.received > c.sent ? 'Good responsiveness from them.' : 'You send more than they reply — try a new angle.');
  else if (c.score >= 30) insight = 'Early stage — only ' + (c.sent + c.received) + ' emails. Increase outreach to build momentum.';
  else insight = 'Going cold — last activity ' + c.lastActivity + '. Re-engage with a personalized message.';

  const circumference = 2 * Math.PI * 12;
  const offset = circumference - (c.score / 100) * circumference;
  const scoreColor = c.score >= 75 ? 'var(--green)' : c.score >= 50 ? 'var(--orange)' : 'var(--red)';

  let html = '<div class="dp-header">' +
    '<button class="dp-back" onclick="closePanel()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>' +
    '<div class="dp-breadcrumb"><b>' + esc(c.name) + '</b></div>' +
    '<button class="dp-close" onclick="closePanel()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>' +
  '</div>';

  html += '<div class="dp-company-head">' +
    '<div class="dp-co-logo" style="background:' + color + '">' + c.name[0].toUpperCase() + '</div>' +
    '<div class="dp-co-info"><h2>' + esc(c.name) + '</h2><div class="dp-domain">' + esc(c.domain) + '</div></div>' +
  '</div>';

  html += '<div class="dp-co-meta">' +
    '<span class="badge ' + (STATUS_CLASS[c.status] || '') + '">' + c.status + '</span>' +
    '<div class="ai-score"><div class="score-ring" style="color:' + scoreColor + '"><svg viewBox="0 0 30 30"><circle class="track" cx="15" cy="15" r="12"/><circle class="fill" cx="15" cy="15" r="12" stroke="' + scoreColor + '" stroke-dasharray="' + circumference + '" stroke-dashoffset="' + offset + '"/></svg>' + c.score + '</div></div>' +
    '<span style="font-size:11px;color:var(--text2)">' + esc(c.lastActivity) + '</span>' +
  '</div>';

  html += '<div class="dp-mini-stats">' +
    '<div class="dp-mini-stat"><span class="label">Sent</span><div class="value" style="color:var(--accent2)">' + c.sent + '</div></div>' +
    '<div class="dp-mini-stat"><span class="label">Received</span><div class="value" style="color:var(--green)">' + c.received + '</div></div>' +
  '</div>';

  html += '<div class="ai-insight"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg><div><div class="label">AI Insight</div><p>' + esc(insight) + '</p></div></div>';

  html += '<div class="dp-section" style="margin-top:16px"><div class="dp-section-title">Relationships <span class="cnt">' + sorted.length + '</span></div>';

  for (const ct of sorted) {
    const initials = ct.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    const total = ct.sent + ct.received;
    const isPrimary = ct.email === primaryEmail;
    const eSafe = ct.email.replace(/'/g, "\\'");
    const dSafe = c.domain.replace(/'/g, "\\'");

    html += '<div class="dp-contact" onclick="showContactPanel(\'' + eSafe + '\',\'' + dSafe + '\',' + c.id + ')">' +
      '<div class="dp-ct-avatar" style="background:' + color + '">' + esc(initials) + '</div>' +
      '<div class="dp-ct-info">' +
        '<div class="dp-ct-name">' + esc(ct.name) + (isPrimary ? ' <span class="dp-primary-badge">Primary</span>' : '') + '</div>' +
        '<div class="dp-ct-email">' + esc(ct.email) + '</div>' +
      '</div>' +
      '<div class="dp-ct-count">' + total + '</div>' +
      '<button class="dp-star' + (isPrimary ? ' active' : '') + '" onclick="event.stopPropagation();toggleStar(\'' + dSafe + '\',\'' + eSafe + '\')" title="' + (isPrimary ? 'Primary' : 'Set primary') + '">&#9733;</button>' +
    '</div>';
  }

  html += '</div>';

  // Block domain button
  html += '<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">' +
    '<button class="btn btn-ghost btn-sm" onclick="if(confirm(\'Block ' + esc(c.domain) + '?\'))blockDomainFromDetail(\'' + c.domain.replace(/'/g, "\\'") + '\')" style="color:var(--red);border-color:var(--red);font-size:11px">' +
    '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg> Block domain</button></div>';

  document.getElementById('dpScroll').innerHTML = html;
  document.getElementById('detailPanel').classList.add('open');
  document.querySelector('.main').classList.add('panel-open');
}

function showContactPanel(email, domain, companyId) {
  const data = domainMap[domain];
  if (!data) return;
  const ct = data.contacts[email.toLowerCase()];
  if (!ct) return;
  const c = companies.find(x => x.domain === domain);
  const companyName = c ? c.name : domain;
  const color = COLORS[(c ? c.id : 0) % COLORS.length];
  currentContactOverlay = { contact: ct, company: c, domain: domain, email: email.toLowerCase() };
  panelState = { view: 'contact', email: email.toLowerCase(), domain: domain, companyId: companyId || (c ? c.id : 0) };
  currentContactTab = 'all';

  const initials = ct.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
  const isPrimary = starredContacts[domain] === email.toLowerCase() || (!starredContacts[domain] && c && c.contactEmail === email.toLowerCase());

  let html = '<div class="dp-header">' +
    '<button class="dp-back visible" onclick="showCompanyPanel(' + panelState.companyId + ')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>' +
    '<div class="dp-breadcrumb">' + esc(companyName) + ' &rsaquo; <b>' + esc(ct.name) + '</b></div>' +
    '<button class="dp-close" onclick="closePanel()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>' +
  '</div>';

  html += '<div class="dp-ct-head">' +
    '<div class="dp-ct-big-avatar" style="background:' + color + '">' + esc(initials) + '</div>' +
    '<div class="dp-ct-head-info">' +
      '<h2>' + esc(ct.name) + '</h2>' +
      '<div class="dp-ct-head-email">' + esc(ct.email) + '</div>' +
      '<div class="dp-ct-head-company" onclick="showCompanyPanel(' + panelState.companyId + ')">' + esc(companyName) + '</div>' +
    '</div>' +
    '<button class="dp-star' + (isPrimary ? ' active' : '') + '" onclick="toggleStarInPanel(\'' + domain.replace(/'/g, "\\'") + '\',\'' + email.toLowerCase().replace(/'/g, "\\'") + '\')" style="font-size:20px">&#9733;</button>' +
  '</div>';

  // Actions: Email + Reply
  const eSafe = ct.email.replace(/'/g, "\\'");
  html += '<div class="dp-ct-actions">' +
    '<button class="btn btn-primary btn-sm" onclick="openCompose(\'' + eSafe + '\',\'' + esc(ct.name) + '\',\'\',\'\')">' +
      '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> Email' +
    '</button>' +
  '</div>';

  html += '<div class="dp-mini-stats" style="grid-template-columns:1fr 1fr 1fr">' +
    '<div class="dp-mini-stat"><span class="label">Sent</span><div class="value" style="font-size:16px;color:var(--accent2)">' + ct.sent + '</div></div>' +
    '<div class="dp-mini-stat"><span class="label">Received</span><div class="value" style="font-size:16px;color:var(--green)">' + ct.received + '</div></div>' +
    '<div class="dp-mini-stat"><span class="label">Last</span><div class="value" style="font-size:12px">' + (ct.lastDate ? timeAgo(ct.lastDate) : '—') + '</div></div>' +
  '</div>';

  // Tabs
  html += '<div class="dp-tabs">' +
    '<button class="dp-tab active" onclick="switchTab(\'all\',this)">All</button>' +
    '<button class="dp-tab" onclick="switchTab(\'sent\',this)">Sent</button>' +
    '<button class="dp-tab" onclick="switchTab(\'received\',this)">Received</button>' +
    '<button class="dp-tab" onclick="switchTab(\'meetings\',this)">Meetings</button>' +
  '</div>';

  html += '<div id="dpTimeline"><div class="tl-loading"><div class="scan-spinner"></div>Loading...</div></div>';

  document.getElementById('dpScroll').innerHTML = html;
  document.getElementById('detailPanel').classList.add('open');
  document.querySelector('.main').classList.add('panel-open');

  fetchContactTimeline(email.toLowerCase(), domain);
}

function closePanel() {
  document.getElementById('detailPanel').classList.remove('open');
  document.querySelector('.main').classList.remove('panel-open');
  panelState = null;
  currentCompanyOverlay = null;
  currentContactOverlay = null;
}

function toggleStar(domain, email) {
  if (starredContacts[domain] === email) {
    delete starredContacts[domain];
  } else {
    starredContacts[domain] = email;
  }
  saveStarredContacts();
  buildCompaniesFromDomainMap();
  renderTable();
  updateStats();
  // Re-render current panel state
  if (panelState && panelState.view === 'company') {
    const c = companies.find(x => x.domain === domain);
    if (c) showCompanyPanel(c.id);
  }
}

function toggleStarInPanel(domain, email) {
  toggleStar(domain, email);
  // If on contact view, refresh it
  if (panelState && panelState.view === 'contact') {
    showContactPanel(panelState.email, panelState.domain, panelState.companyId);
  }
}

function switchTab(tab, el) {
  currentContactTab = tab;
  document.querySelectorAll('.dp-tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  if (currentContactOverlay) renderTimeline(currentContactOverlay.email);
}

// ──────────────────────────────────────────────
// TIMELINE — fetch from Outlook and render inline
// ──────────────────────────────────────────────
async function fetchContactTimeline(email, domain) {
  const el = document.getElementById('dpTimeline');
  if (!el) return;
  el.innerHTML = '<div class="tl-loading"><div class="scan-spinner"></div>Loading activity from Outlook...</div>';

  if (contactTimelineCache[email] && contactTimelineCache[email].length > 0) {
    renderTimeline(email);
    return;
  }

  try {
    const token = await getAccessToken();
    const headers = { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' };
    const items = [];
    const select = '$select=id,subject,from,toRecipients,receivedDateTime,sentDateTime,bodyPreview,conversationId';
    const orderBy = '$orderby=receivedDateTime desc';
    const top = '$top=50';

    // Received from this contact
    const url1 = 'https://graph.microsoft.com/v1.0/me/messages?' + top + '&' + select + '&' + orderBy + '&$filter=' + encodeURIComponent("from/emailAddress/address eq '" + email + "'");
    const resp1 = await fetch(url1, { headers });
    if (resp1.ok) {
      const d1 = await resp1.json();
      if (d1.value) for (const m of d1.value) items.push({ type: 'received', subject: m.subject || '(no subject)', date: new Date(m.receivedDateTime || m.sentDateTime), preview: m.bodyPreview || '', id: m.id, conversationId: m.conversationId });
    }

    // Sent to this contact
    const url2 = 'https://graph.microsoft.com/v1.0/me/messages?' + top + '&' + select + '&' + orderBy + '&$filter=' + encodeURIComponent("toRecipients/any(r:r/emailAddress/address eq '" + email + "')");
    const resp2 = await fetch(url2, { headers });
    if (resp2.ok) {
      const d2 = await resp2.json();
      if (d2.value) for (const m of d2.value) {
        if (m.from?.emailAddress?.address?.toLowerCase() === userEmail.toLowerCase()) {
          items.push({ type: 'sent', subject: m.subject || '(no subject)', date: new Date(m.sentDateTime || m.receivedDateTime), preview: m.bodyPreview || '', id: m.id, conversationId: m.conversationId });
        }
      }
    }

    // Calendar events
    try {
      const calUrl = "https://graph.microsoft.com/v1.0/me/events?$top=20&$select=subject,start,end,attendees,isOnlineMeeting&$orderby=start/dateTime desc&$filter=" + encodeURIComponent("attendees/any(a:a/emailAddress/address eq '" + email + "')");
      const calResp = await fetch(calUrl, { headers });
      if (calResp.ok) {
        const calData = await calResp.json();
        if (calData.value) for (const ev of calData.value) items.push({ type: 'meeting', subject: ev.subject || 'Meeting', date: new Date(ev.start?.dateTime), preview: (ev.isOnlineMeeting ? 'Online' : 'In-person') + ' · ' + (ev.attendees?.length || 0) + ' attendees', id: ev.id });
      }
    } catch(e) {}

    // Dedupe and sort
    const seen = new Set();
    const unique = [];
    for (const item of items) { if (!seen.has(item.id)) { seen.add(item.id); unique.push(item); } }
    unique.sort((a, b) => b.date - a.date);
    contactTimelineCache[email] = unique;
    renderTimeline(email);
  } catch(e) {
    console.error('Timeline fetch error:', e);
    if (el) el.innerHTML = '<div class="tl-empty">Could not load activity. ' + esc(e.message) + '</div>';
  }
}

function renderTimeline(email) {
  const el = document.getElementById('dpTimeline');
  if (!el) return;
  let items = contactTimelineCache[email] || [];

  if (currentContactTab === 'sent') items = items.filter(i => i.type === 'sent');
  else if (currentContactTab === 'received') items = items.filter(i => i.type === 'received');
  else if (currentContactTab === 'meetings') items = items.filter(i => i.type === 'meeting');

  if (items.length === 0) {
    const msgs = { all: 'No activity found.', sent: 'No sent emails.', received: 'No received emails.', meetings: 'No meetings found.' };
    el.innerHTML = '<div class="tl-empty">' + (msgs[currentContactTab] || msgs.all) + '</div>';
    return;
  }

  const groups = {};
  for (const item of items) { const key = formatDateGroup(item.date); if (!groups[key]) groups[key] = []; groups[key].push(item); }

  const svgSent = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>';
  const svgRecv = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>';
  const svgMeet = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>';

  let html = '<div class="tl-list">';
  for (const [dateLabel, groupItems] of Object.entries(groups)) {
    html += '<div class="tl-date-group"><div class="tl-date-label">' + esc(dateLabel) + '</div>';
    for (const item of groupItems) {
      const icon = item.type === 'meeting' ? svgMeet : item.type === 'sent' ? svgSent : svgRecv;
      const time = item.date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const replyBtn = item.type !== 'meeting'
        ? ' <button class="tl-reply-btn" onclick="event.stopPropagation();openReply(\'' + item.id.replace(/'/g, "\\'") + '\',\'' + (currentContactOverlay ? currentContactOverlay.email.replace(/'/g, "\\'") : '') + '\',\'' + esc(item.subject).replace(/'/g, "\\'") + '\')">Reply</button>'
        : '';
      html += '<div class="tl-item">' +
        '<div class="tl-icon ' + item.type + '">' + icon + '</div>' +
        '<div class="tl-content"><div class="tl-subject">' + esc(item.subject) + '</div>' +
        (item.preview ? '<div class="tl-preview">' + esc(item.preview.substring(0, 100)) + '</div>' : '') +
        '</div>' +
        '<div style="display:flex;flex-direction:column;align-items:flex-end;gap:2px"><div class="tl-time">' + time + '</div>' + replyBtn + '</div>' +
      '</div>';
    }
    html += '</div>';
  }
  html += '</div>';
  el.innerHTML = html;
}

function formatDateGroup(date) {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
  const diff = Math.floor((today - d) / 86400000);
  if (diff === 0) return 'Today';
  if (diff === 1) return 'Yesterday';
  if (diff < 7) return date.toLocaleDateString([], { weekday: 'long' });
  return date.toLocaleDateString([], { month: 'long', day: 'numeric', year: now.getFullYear() !== date.getFullYear() ? 'numeric' : undefined });
}

// ──────────────────────────────────────────────
// EMAIL COMPOSE & REPLY (via Graph API sendMail)
// ──────────────────────────────────────────────
let composeReplyToId = null;

function openCompose(toEmail, toName, subject, replyId) {
  composeReplyToId = replyId || null;
  document.getElementById('composeTo').value = toName ? toName + ' <' + toEmail + '>' : toEmail;
  document.getElementById('composeTo').dataset.email = toEmail;
  document.getElementById('composeSubject').value = subject || '';
  document.getElementById('composeBody').value = '';
  document.getElementById('composeSendStatus').textContent = '';
  document.getElementById('composeSendBtn').disabled = false;
  document.getElementById('composeTitle').textContent = replyId ? 'Reply' : 'New Email';
  document.getElementById('composeOverlay').classList.add('active');
  // Focus body for reply, subject for new
  setTimeout(() => { document.getElementById(subject ? 'composeBody' : 'composeSubject').focus(); }, 100);
}

function openReply(messageId, toEmail, subject) {
  const reSubject = subject.startsWith('Re:') ? subject : 'Re: ' + subject;
  const ctName = currentContactOverlay ? currentContactOverlay.contact.name : '';
  openCompose(toEmail, ctName, reSubject, messageId);
}

function closeCompose() {
  document.getElementById('composeOverlay').classList.remove('active');
  composeReplyToId = null;
}

async function sendComposedEmail() {
  const toEmail = document.getElementById('composeTo').dataset.email;
  const subject = document.getElementById('composeSubject').value.trim();
  const body = document.getElementById('composeBody').value.trim();
  if (!toEmail || !subject || !body) { alert('Please fill in subject and message.'); return; }

  const btn = document.getElementById('composeSendBtn');
  const status = document.getElementById('composeSendStatus');
  btn.disabled = true;
  status.textContent = 'Sending...';

  try {
    const token = await getAccessToken();
    const headers = { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' };

    const message = {
      subject: subject,
      body: { contentType: 'Text', content: body },
      toRecipients: [{ emailAddress: { address: toEmail } }]
    };

    const resp = await fetch('https://graph.microsoft.com/v1.0/me/sendMail', {
      method: 'POST',
      headers: headers,
      body: JSON.stringify({ message: message, saveToSentItems: true })
    });

    if (!resp.ok) {
      const err = await resp.text();
      throw new Error('Send failed: ' + resp.status + ' — ' + err);
    }

    status.textContent = 'Sent!';
    status.style.color = 'var(--green)';

    // Clear cache so timeline refreshes
    delete contactTimelineCache[toEmail.toLowerCase()];

    setTimeout(() => {
      closeCompose();
      status.style.color = '';
      // Refresh timeline if contact panel is open
      if (panelState && panelState.view === 'contact') {
        fetchContactTimeline(panelState.email, panelState.domain);
      }
    }, 1000);

  } catch(e) {
    console.error('Send error:', e);
    status.textContent = 'Failed: ' + e.message;
    status.style.color = 'var(--red)';
    btn.disabled = false;
  }
}

// ──────────────────────────────────────────────
// SETTINGS
// ──────────────────────────────────────────────
function openSettings() {
  document.getElementById('settingsModal').classList.add('active');
  document.getElementById('clientIdInput').value = getClientId();
  document.getElementById('redirectDisplay').textContent = window.location.origin + window.location.pathname;
  renderBlockedDomainsList();
}

function closeSettings() {
  document.getElementById('settingsModal').classList.remove('active');
}

async function saveSettings() {
  const clientId = document.getElementById('clientIdInput').value.trim();
  if (!clientId) { alert('Please enter your Application (Client) ID'); return; }
  if (!/^[a-f0-9-]{36}$/i.test(clientId)) {
    if (!confirm('That doesn\'t look like a standard Azure Client ID (should be a UUID). Save anyway?')) return;
  }
  localStorage.setItem('relateflow_client_id', clientId);
  closeSettings();
  msalInstance = null;
  await initMSAL();
  await signIn();
}

// ──────────────────────────────────────────────
// BLOCKED DOMAINS MANAGEMENT
// ──────────────────────────────────────────────
function addBlockedDomainsFromInput() {
  const input = document.getElementById('blockDomainsInput');
  const raw = input.value.trim();
  if (!raw) return;
  addBlockedDomains(raw);
  input.value = '';
}

function addBlockedDomains(raw) {
  // Parse: split on newlines, commas, spaces — extract domains
  const entries = raw.split(/[\n,;\s]+/).map(s => s.trim().toLowerCase()).filter(Boolean);
  let added = 0;
  for (const entry of entries) {
    // If it's an email address, extract domain
    const domain = entry.includes('@') ? entry.split('@')[1] : entry;
    if (domain && !SKIP_DOMAINS.has(domain) && !blockedDomains.has(domain)) {
      blockedDomains.add(domain);
      added++;
    }
  }
  if (added > 0) {
    saveBlockedDomains();
    // Rebuild companies to remove newly blocked domains
    buildCompaniesFromDomainMap();
    renderTable();
    updateStats();
    updateBlockedCount();
    renderBlockedDomainsList();
  }
}

function removeBlockedDomain(domain) {
  blockedDomains.delete(domain);
  saveBlockedDomains();
  // Rebuild companies — the unblocked domain may reappear
  buildCompaniesFromDomainMap();
  renderTable();
  updateStats();
  updateBlockedCount();
  renderBlockedDomainsList();
}

function blockDomainFromDetail(domain) {
  blockedDomains.add(domain.toLowerCase());
  saveBlockedDomains();
  buildCompaniesFromDomainMap();
  renderTable();
  updateStats();
  updateBlockedCount();
  closePanel();
}

function renderBlockedDomainsList() {
  const container = document.getElementById('blockedDomainsList');
  if (!container) return;
  if (blockedDomains.size === 0) {
    container.innerHTML = '<span style="font-size:11px;color:var(--text2)">No blocked domains yet</span>';
    return;
  }
  const sorted = [...blockedDomains].sort();
  container.innerHTML = sorted.map(d =>
    `<span class="blocked-tag">${esc(d)}<button onclick="removeBlockedDomain('${d}')" title="Unblock">&times;</button></span>`
  ).join('');
}

// ──────────────────────────────────────────────
// EXPORT CSV
// ──────────────────────────────────────────────
function exportCSV() {
  const header = 'Company,Domain,Primary Contact,Contact Email,Sent,Received,Status,AI Score,Last Activity\n';
  const rows = companies.map(c =>
    `"${c.name}","${c.domain}","${c.contact}","${c.contactEmail}",${c.sent},${c.received},"${c.status}",${c.score},"${c.lastActivity}"`
  ).join('\n');
  const blob = new Blob([header + rows], {type: 'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'relateflow-export.csv';
  a.click();
}

// ──────────────────────────────────────────────
// AI CHAT
// ──────────────────────────────────────────────
function toggleAIChat() {
  document.getElementById('aiChat').classList.toggle('open');
}

function sendAI() {
  const input = document.getElementById('aiInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  const msgs = document.getElementById('aiMessages');
  msgs.innerHTML += `<div class="ai-msg user">${esc(msg)}</div>`;
  msgs.scrollTop = msgs.scrollHeight;
  setTimeout(() => {
    msgs.innerHTML += `<div class="ai-msg bot">${generateAIReply(msg)}</div>`;
    msgs.scrollTop = msgs.scrollHeight;
  }, 400);
}

function generateAIReply(msg) {
  const lower = msg.toLowerCase();
  if (lower.includes('follow up') || lower.includes('followup') || lower.includes('reach out')) {
    const targets = companies.filter(c => c.status === 'Cold' || c.status === 'Warm').sort((a,b) => b.score - a.score).slice(0,5);
    if (targets.length === 0) return 'All your contacts look engaged! No immediate follow-ups needed.';
    return `I'd recommend following up with:<br>${targets.map(c => `<b>${c.contact}</b> at ${esc(c.name)} (${c.lastActivity}, score: ${c.score})`).join('<br>')}`;
  }
  if (lower.includes('hot') || lower.includes('best') || lower.includes('top')) {
    const hot = companies.filter(c => c.status === 'Hot').slice(0,5);
    if (hot.length === 0) return 'No hot leads yet. Keep emailing to build engagement!';
    return `Your hottest leads:<br>${hot.map(c => `<b>${esc(c.name)}</b> — Score: ${c.score}, ${c.sent+c.received} emails`).join('<br>')}`;
  }
  if (lower.includes('cold') || lower.includes('risk') || lower.includes('losing')) {
    const cold = companies.filter(c => c.status === 'Cold');
    return `${cold.length} companies at risk:<br>${cold.slice(0,5).map(c => `<b>${esc(c.name)}</b> — last: ${c.lastActivity}, score: ${c.score}`).join('<br>')}`;
  }
  if (lower.includes('summary') || lower.includes('overview') || lower.includes('stats')) {
    const ts = companies.reduce((s,c) => s+c.sent, 0);
    const tr = companies.reduce((s,c) => s+c.received, 0);
    return `Pipeline: <b>${companies.length}</b> companies, <b>${ts}</b> sent / <b>${tr}</b> received.<br>Hot: ${companies.filter(c=>c.status==='Hot').length} | Warm: ${companies.filter(c=>c.status==='Warm').length} | New: ${companies.filter(c=>c.status==='New').length} | Cold: ${companies.filter(c=>c.status==='Cold').length}`;
  }
  // Try to find a company match
  const match = companies.find(c => lower.includes(c.name.toLowerCase()) || lower.includes(c.domain.toLowerCase()));
  if (match) {
    return `<b>${esc(match.name)}</b> (${esc(match.domain)})<br>Contact: ${esc(match.contact)}<br>Sent: ${match.sent} | Received: ${match.received}<br>Score: ${match.score} (${match.status})<br>Last: ${match.lastActivity}`;
  }
  return `You have ${companies.length} companies in your pipeline. Try:<br>• "Who should I follow up with?"<br>• "Show me hot leads"<br>• "Give me a summary"<br>• Or ask about any company by name`;
}

function esc(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ──────────────────────────────────────────────
// INIT — check for existing session
// ──────────────────────────────────────────────
(async function init() {
  loadBlockedDomains();
  loadCompanyNameCache();
  loadStarredContacts();
  if (getClientId()) {
    await initMSAL();
    if (msalInstance) {
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length > 0) {
        currentAccount = accounts[0];
        userEmail = currentAccount.username;
        await onSignedIn();
        return;
      }
    }
  }
  document.getElementById('settingsBtn').style.display = '';
  showWelcome();
})();
</script>
</body>
</html>
