<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RelateFlow — AI-Driven CRM</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- MSAL loaded dynamically in initMSAL() with CDN fallbacks -->
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f1117;--surface:#181a20;--surface2:#1e2028;--border:#2a2d37;
  --text:#e4e5e9;--text2:#9ca0ab;--accent:#6c5ce7;--accent2:#a29bfe;
  --green:#00cec9;--green-bg:rgba(0,206,201,.12);
  --red:#ff7675;--red-bg:rgba(255,118,117,.12);
  --orange:#fdcb6e;--orange-bg:rgba(253,203,110,.12);
  --blue:#74b9ff;--blue-bg:rgba(116,185,255,.12);
  --ms-blue:#0078d4;
}
html{font-family:'Inter',system-ui,sans-serif;font-size:14px;background:var(--bg);color:var(--text)}
body{min-height:100vh;overflow-x:hidden}

/* ── TOP NAV ── */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:0 24px;height:56px;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.topbar .logo{display:flex;align-items:center;gap:10px;font-weight:700;font-size:16px;letter-spacing:-.3px}
.topbar .logo svg{width:28px;height:28px}
.topbar-actions{display:flex;align-items:center;gap:12px}
.btn{padding:7px 16px;border-radius:8px;border:none;font-size:13px;font-weight:500;cursor:pointer;transition:.15s;font-family:inherit;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:#7c6df0}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--surface2);color:var(--text)}
.btn-sm{padding:5px 12px;font-size:12px}
.btn-ms{background:var(--ms-blue);color:#fff;font-weight:600}
.btn-ms:hover{background:#106ebe}
.btn-icon{width:34px;height:34px;padding:0;display:grid;place-items:center;border-radius:8px;background:transparent;border:1px solid var(--border);color:var(--text2);cursor:pointer;transition:.15s}
.btn-icon:hover{background:var(--surface2);color:var(--text)}
.user-pill{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;font-size:12px;color:var(--text2)}
.user-pill .dot{width:8px;height:8px;border-radius:50%;background:var(--green)}

/* ── LAYOUT ── */
.layout{display:flex;height:calc(100vh - 56px)}
.sidebar{width:240px;background:var(--surface);border-right:1px solid var(--border);padding:16px 12px;flex-shrink:0;display:flex;flex-direction:column;gap:4px;overflow-y:auto}
.sidebar-section{margin-top:16px;margin-bottom:6px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text2);padding:0 12px}
.sidebar-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:8px;color:var(--text2);cursor:pointer;transition:.15s;font-size:13px;font-weight:500}
.sidebar-item:hover,.sidebar-item.active{background:var(--surface2);color:var(--text)}
.sidebar-item.active{color:var(--accent2)}
.sidebar-item svg{width:18px;height:18px;flex-shrink:0}
.sidebar-badge{margin-left:auto;background:var(--accent);color:#fff;font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px}
.main{flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:20px}

/* ── WELCOME / SIGN-IN SCREEN ── */
.welcome-screen{display:flex;align-items:center;justify-content:center;flex:1;padding:40px}
.welcome-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:48px;max-width:520px;text-align:center}
.welcome-card h1{font-size:28px;font-weight:700;margin-bottom:8px}
.welcome-card .subtitle{color:var(--text2);font-size:15px;line-height:1.6;margin-bottom:32px}
.welcome-card .ms-btn{display:inline-flex;align-items:center;gap:12px;padding:14px 32px;background:#fff;color:#333;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:.15s;font-family:inherit}
.welcome-card .ms-btn:hover{background:#f0f0f0;transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,.2)}
.welcome-card .ms-btn svg{width:20px;height:20px}
.welcome-features{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:32px;text-align:left}
.welcome-feat{display:flex;align-items:start;gap:10px;padding:12px;background:var(--surface2);border-radius:10px}
.welcome-feat svg{width:18px;height:18px;color:var(--accent2);flex-shrink:0;margin-top:2px}
.welcome-feat div{display:flex;flex-direction:column;gap:2px}
.welcome-feat .feat-title{font-size:13px;font-weight:600;color:var(--text)}
.welcome-feat .feat-desc{font-size:11px;color:var(--text2)}
.welcome-note{margin-top:20px;font-size:11px;color:var(--text2);line-height:1.5}

/* ── SCAN PROGRESS BANNER ── */
.scan-banner{background:linear-gradient(135deg,rgba(0,120,212,.15),rgba(108,92,231,.1));border:1px solid rgba(0,120,212,.3);border-radius:12px;padding:16px 20px;display:none;align-items:center;gap:14px}
.scan-banner.active{display:flex}
.scan-spinner{width:20px;height:20px;border-radius:50%;border:3px solid var(--border);border-top-color:var(--ms-blue);animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.scan-banner .scan-text{flex:1;font-size:13px;color:var(--text)}
.scan-banner .scan-count{font-size:12px;color:var(--text2)}

/* ── STATS ROW ── */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px 20px;display:flex;flex-direction:column;gap:6px}
.stat-card .stat-label{font-size:12px;color:var(--text2);font-weight:500}
.stat-card .stat-value{font-size:26px;font-weight:700;letter-spacing:-.5px}
.stat-card .stat-change{font-size:11px;font-weight:600;display:flex;align-items:center;gap:4px}
.stat-up{color:var(--green)}.stat-down{color:var(--red)}

/* ── TOOLBAR ── */
.toolbar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.toolbar-left{display:flex;align-items:center;gap:10px}
.toolbar-right{display:flex;align-items:center;gap:10px}
.search-box{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:7px 14px;width:260px;transition:.15s}
.search-box:focus-within{border-color:var(--accent)}
.search-box input{background:none;border:none;outline:none;color:var(--text);font-size:13px;width:100%;font-family:inherit}
.search-box svg{width:16px;height:16px;color:var(--text2);flex-shrink:0}

/* ── TABLE ── */
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;flex:1}
table{width:100%;border-collapse:collapse}
thead{position:sticky;top:0;z-index:2}
th{background:var(--surface2);text-align:left;padding:10px 16px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--text2);border-bottom:1px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none;transition:.15s}
th:hover{color:var(--text)}
td{padding:12px 16px;border-bottom:1px solid var(--border);font-size:13px;white-space:nowrap}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(108,92,231,.04)}

.company-cell{display:flex;align-items:center;gap:10px}
.company-logo{width:32px;height:32px;border-radius:8px;display:grid;place-items:center;font-weight:700;font-size:13px;color:#fff;flex-shrink:0}
.company-info{display:flex;flex-direction:column}
.company-name{font-weight:600;color:var(--text)}
.company-domain{font-size:11px;color:var(--text2)}

.contact-cell{display:flex;align-items:center;gap:8px}
.avatar{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;font-weight:600;font-size:10px;color:#fff;flex-shrink:0}
.contact-name{font-weight:500}

.badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-hot{background:var(--red-bg);color:var(--red)}
.badge-warm{background:var(--orange-bg);color:var(--orange)}
.badge-new{background:var(--green-bg);color:var(--green)}
.badge-cold{background:var(--blue-bg);color:var(--blue)}

.email-bar{display:flex;align-items:center;gap:6px;font-size:12px}
.bar-track{width:80px;height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;display:flex}
.bar-sent{background:var(--accent);height:100%;border-radius:3px 0 0 3px}
.bar-recv{background:var(--green);height:100%;border-radius:0 3px 3px 0}

.trend-spark{display:flex;align-items:end;gap:2px;height:24px}
.trend-spark .bar{width:4px;border-radius:2px;background:var(--accent);opacity:.6;transition:.15s}
.trend-spark .bar:last-child{opacity:1}

.ai-score{display:flex;align-items:center;gap:6px}
.score-ring{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;font-weight:700;font-size:11px;position:relative}
.score-ring svg{position:absolute;inset:0;transform:rotate(-90deg)}
.score-ring circle{fill:none;stroke-width:3}
.score-ring .track{stroke:var(--surface2)}
.score-ring .fill{stroke-linecap:round;transition:.5s}

/* ── DETAIL PANEL ── */
.detail-panel{position:fixed;right:-420px;top:56px;width:420px;height:calc(100vh - 56px);background:var(--surface);border-left:1px solid var(--border);z-index:90;transition:right .3s ease;overflow-y:auto;padding:24px}
.detail-panel.open{right:0}
.detail-header{display:flex;align-items:start;justify-content:space-between;margin-bottom:20px}
.detail-company{display:flex;align-items:center;gap:12px}
.detail-company .company-logo{width:44px;height:44px;font-size:17px;border-radius:10px}
.detail-title{font-size:18px;font-weight:700}
.detail-domain{font-size:13px;color:var(--text2)}
.detail-section{margin-top:20px}
.detail-section h3{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--text2);margin-bottom:10px}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.detail-stat{background:var(--surface2);border-radius:8px;padding:12px;display:flex;flex-direction:column;gap:4px}
.detail-stat .label{font-size:11px;color:var(--text2)}
.detail-stat .value{font-size:18px;font-weight:700}

.ai-insight{background:linear-gradient(135deg,rgba(108,92,231,.1),rgba(162,155,254,.08));border:1px solid rgba(108,92,231,.2);border-radius:10px;padding:14px;margin-top:10px;display:flex;gap:10px}
.ai-insight svg{width:20px;height:20px;color:var(--accent2);flex-shrink:0;margin-top:2px}
.ai-insight p{font-size:13px;line-height:1.5;color:var(--text)}
.ai-insight .label{font-size:11px;font-weight:600;color:var(--accent2);margin-bottom:4px}

.timeline{display:flex;flex-direction:column;gap:12px;margin-top:10px}
.timeline-item{display:flex;gap:10px;font-size:12px}
.timeline-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);margin-top:4px;flex-shrink:0}
.timeline-content{display:flex;flex-direction:column;gap:2px}
.timeline-content .time{color:var(--text2);font-size:11px}

/* ── SETTINGS MODAL ── */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;place-items:center;backdrop-filter:blur(4px)}
.modal-overlay.active{display:grid}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px;width:520px;max-width:90vw}
.modal h2{font-size:20px;font-weight:700;margin-bottom:8px}
.modal p{color:var(--text2);font-size:13px;margin-bottom:16px;line-height:1.5}
.modal label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;margin-top:16px}
.modal input[type=text]{width:100%;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;font-family:inherit;outline:none}
.modal input[type=text]:focus{border-color:var(--accent)}
.modal .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:24px}
.modal .help-text{font-size:11px;color:var(--text2);margin-top:6px;line-height:1.5}
.modal .steps{text-align:left;background:var(--surface2);border-radius:10px;padding:16px;margin-top:12px}
.modal .steps ol{margin:0;padding-left:20px;display:flex;flex-direction:column;gap:8px;font-size:13px;color:var(--text);line-height:1.5}
.modal .steps code{background:var(--bg);padding:2px 6px;border-radius:4px;font-size:12px;color:var(--accent2)}

/* ── AI CHAT MINI ── */
.ai-chat-fab{position:fixed;bottom:24px;right:24px;width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#a29bfe);border:none;cursor:pointer;display:grid;place-items:center;z-index:80;box-shadow:0 4px 20px rgba(108,92,231,.4);transition:.2s}
.ai-chat-fab:hover{transform:scale(1.08)}
.ai-chat-fab svg{width:24px;height:24px;color:#fff}
.ai-chat{position:fixed;bottom:90px;right:24px;width:360px;background:var(--surface);border:1px solid var(--border);border-radius:16px;z-index:80;display:none;flex-direction:column;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,.4)}
.ai-chat.open{display:flex}
.ai-chat-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;font-weight:600;font-size:14px}
.ai-chat-header .dot{width:8px;height:8px;border-radius:50%;background:var(--green)}
.ai-chat-messages{flex:1;padding:16px;display:flex;flex-direction:column;gap:12px;max-height:300px;overflow-y:auto}
.ai-msg{max-width:85%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.5}
.ai-msg.bot{background:var(--surface2);align-self:flex-start;border-bottom-left-radius:4px}
.ai-msg.user{background:var(--accent);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.ai-chat-input{display:flex;border-top:1px solid var(--border);padding:10px}
.ai-chat-input input{flex:1;background:var(--surface2);border:none;border-radius:8px;padding:10px 14px;color:var(--text);font-size:13px;font-family:inherit;outline:none}
.ai-chat-input button{background:none;border:none;cursor:pointer;padding:0 10px;color:var(--accent2)}

.crm-content{display:none;flex-direction:column;gap:20px;flex:1}
.crm-content.active{display:flex}

/* ── RESPONSIVE ── */
@media(max-width:900px){
  .sidebar{display:none}
  .stats{grid-template-columns:repeat(2,1fr)}
  .detail-panel{width:100%}
}
@media(max-width:600px){
  .stats{grid-template-columns:1fr}
  .search-box{width:100%}
  .toolbar{flex-direction:column;align-items:stretch}
}
</style>
</head>
<body>

<!-- TOP BAR -->
<header class="topbar">
  <div class="logo">
    <svg viewBox="0 0 28 28" fill="none"><rect width="28" height="28" rx="7" fill="#6c5ce7"/><path d="M8 14l4 4 8-8" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    RelateFlow
  </div>
  <div class="topbar-actions" id="topbarActions">
    <button class="btn btn-ghost btn-sm" id="settingsBtn" onclick="openSettings()" style="display:none" title="Configure Azure App">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.32 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      Settings
    </button>
    <button class="btn btn-ms btn-sm" id="scanOutlookBtn" onclick="scanOutlookEmails()" style="display:none">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
      Sync Emails
    </button>
    <button class="btn btn-ghost btn-sm" id="exportBtn" onclick="exportCSV()" style="display:none">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Export CSV
    </button>
    <div class="user-pill" id="userPill" style="display:none">
      <span class="dot"></span>
      <span id="userName">user@outlook.com</span>
    </div>
    <button class="btn btn-ghost btn-sm" id="signOutBtn" onclick="signOut()" style="display:none">Sign Out</button>
  </div>
</header>

<div class="layout">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar" style="display:none">
    <div class="sidebar-item active" onclick="filterByStatus('all',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      All Companies
      <span class="sidebar-badge" id="companyCount">0</span>
    </div>
    <div class="sidebar-section">Segments</div>
    <div class="sidebar-item" onclick="filterByStatus('Hot',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      Hot Leads
    </div>
    <div class="sidebar-item" onclick="filterByStatus('Warm',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/></svg>
      Warm Leads
    </div>
    <div class="sidebar-item" onclick="filterByStatus('New',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      New
    </div>
    <div class="sidebar-item" onclick="filterByStatus('Cold',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h20"/></svg>
      Cold
    </div>
    <div class="sidebar-section">Actions</div>
    <div class="sidebar-item" onclick="scanOutlookEmails()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Sync Emails
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">
    <!-- WELCOME / SIGN IN -->
    <div class="welcome-screen" id="welcomeScreen">
      <div class="welcome-card">
        <h1>Welcome to RelateFlow</h1>
        <p class="subtitle">AI-powered CRM that scans your Outlook emails to automatically build your sales pipeline. Zero data entry.</p>

        <button class="ms-btn" onclick="signIn()">
          <svg viewBox="0 0 21 21"><rect x="1" y="1" width="9" height="9" fill="#f25022"/><rect x="11" y="1" width="9" height="9" fill="#7fba00"/><rect x="1" y="11" width="9" height="9" fill="#00a4ef"/><rect x="11" y="11" width="9" height="9" fill="#ffb900"/></svg>
          Sign in with Microsoft
        </button>

        <div class="welcome-features">
          <div class="welcome-feat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            <div><span class="feat-title">Email Scanning</span><span class="feat-desc">Reads your Outlook inbox automatically</span></div>
          </div>
          <div class="welcome-feat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/></svg>
            <div><span class="feat-title">Auto Companies</span><span class="feat-desc">Creates companies from email domains</span></div>
          </div>
          <div class="welcome-feat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
            <div><span class="feat-title">Email Tracking</span><span class="feat-desc">Sent vs received per company</span></div>
          </div>
          <div class="welcome-feat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            <div><span class="feat-title">AI Scoring</span><span class="feat-desc">Smart lead scoring from engagement</span></div>
          </div>
        </div>

        <p class="welcome-note">First time? You'll need an Azure App registration. Click the gear icon after sign-in to configure, or <a href="#" onclick="openSettings();return false" style="color:var(--accent2)">set it up now</a>.</p>
      </div>
    </div>

    <!-- CRM CONTENT (shown after sign-in) -->
    <div class="crm-content" id="crmContent">
      <!-- SCAN BANNER -->
      <div class="scan-banner" id="scanBanner">
        <div class="scan-spinner"></div>
        <span class="scan-text" id="scanText">Scanning your Outlook emails...</span>
        <span class="scan-count" id="scanCount"></span>
      </div>

      <!-- LAST SYNC STATUS -->
      <div id="lastSyncBar" style="display:none;padding:6px 16px;font-size:11px;color:var(--text2);background:var(--surface2);border-radius:8px;margin:8px 16px 0;display:none;align-items:center;gap:6px">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        <span id="lastSyncText">Never synced</span>
      </div>

      <!-- STATS -->
      <div class="stats">
        <div class="stat-card">
          <span class="stat-label">Total Companies</span>
          <span class="stat-value" id="statCompanies">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Emails Sent</span>
          <span class="stat-value" id="statSent">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Emails Received</span>
          <span class="stat-value" id="statRecv">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Top Contacts</span>
          <span class="stat-value" id="statContacts">0</span>
        </div>
      </div>

      <!-- TOOLBAR -->
      <div class="toolbar">
        <div class="toolbar-left">
          <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" id="searchInput" placeholder="Search companies, contacts..." oninput="renderTable()">
          </div>
        </div>
        <div class="toolbar-right">
          <button class="btn btn-ghost btn-sm" onclick="sortTable('sent')">Sort: Most Emails</button>
        </div>
      </div>

      <!-- TABLE -->
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th onclick="sortTable('company')">Company</th>
              <th onclick="sortTable('contact')">Primary Contact</th>
              <th onclick="sortTable('sent')">Sent</th>
              <th onclick="sortTable('received')">Received</th>
              <th>Email Ratio</th>
              <th onclick="sortTable('status')">Status</th>
              <th onclick="sortTable('score')">AI Score</th>
              <th onclick="sortTable('lastActivity')">Last Email</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<!-- DETAIL PANEL -->
<div class="detail-panel" id="detailPanel">
  <div class="detail-header">
    <div class="detail-company">
      <div class="company-logo" id="detailLogo">A</div>
      <div>
        <div class="detail-title" id="detailTitle"></div>
        <div class="detail-domain" id="detailDomain"></div>
      </div>
    </div>
    <button class="btn-icon" onclick="closeDetail()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div class="detail-section">
    <h3>Email Activity</h3>
    <div class="detail-grid">
      <div class="detail-stat"><span class="label">Emails Sent</span><span class="value" id="detailSent">0</span></div>
      <div class="detail-stat"><span class="label">Emails Received</span><span class="value" id="detailRecv">0</span></div>
      <div class="detail-stat"><span class="label">Total Contacts</span><span class="value" id="detailContacts">0</span></div>
      <div class="detail-stat"><span class="label">Response Ratio</span><span class="value" id="detailRate">0%</span></div>
    </div>
  </div>
  <div class="detail-section">
    <h3>AI Insight</h3>
    <div class="ai-insight">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
      <div>
        <div class="label">AI Analysis</div>
        <p id="detailInsight"></p>
      </div>
    </div>
  </div>
  <div class="detail-section">
    <h3>All Contacts at Domain</h3>
    <div id="detailContactsList" style="display:flex;flex-direction:column;gap:8px"></div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <h2>Azure App Configuration</h2>
    <p>To connect your Outlook, you need a Microsoft Azure App Registration. This gives RelateFlow permission to read your emails.</p>

    <div class="steps">
      <ol>
        <li>Go to <strong>portal.azure.com</strong> &rarr; <strong>Microsoft Entra ID</strong> &rarr; <strong>App registrations</strong></li>
        <li>Click <strong>New registration</strong>, name it "RelateFlow CRM"</li>
        <li>Set <strong>Redirect URI</strong> (SPA) to: <code id="redirectDisplay">https://sheph007-pixel.github.io/codex/</code></li>
        <li>Under <strong>API permissions</strong>, add: <code>Mail.Read</code> (Delegated)</li>
        <li>Click <strong>Grant admin consent</strong> (or have your admin do it)</li>
        <li>Copy the <strong>Application (client) ID</strong> and paste it below</li>
      </ol>
    </div>

    <label>Application (Client) ID</label>
    <input type="text" id="clientIdInput" placeholder="e.g. 12345678-abcd-1234-abcd-123456789abc">
    <p class="help-text">This is stored only in your browser's localStorage. Nothing is sent to any server.</p>

    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
      <label style="font-size:12px;color:var(--text2);margin-bottom:6px;display:block">Data Management</label>
      <button class="btn btn-ghost" onclick="fullRescan()" style="color:var(--red);border-color:var(--red);font-size:12px">Reset &amp; Full Re-scan</button>
      <p class="help-text" style="margin-top:4px">Clears all cached data and re-scans every email from scratch.</p>
    </div>

    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeSettings()">Cancel</button>
      <button class="btn btn-primary" onclick="saveSettings()">Save & Connect</button>
    </div>
  </div>
</div>

<!-- AI CHAT FAB -->
<button class="ai-chat-fab" onclick="toggleAIChat()" id="chatFab" style="display:none">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
</button>
<div class="ai-chat" id="aiChat">
  <div class="ai-chat-header"><span class="dot"></span> RelateFlow AI</div>
  <div class="ai-chat-messages" id="aiMessages">
    <div class="ai-msg bot">Hi! I'm analyzing your real email data. Ask me anything — "Who should I follow up with?" or "Show me my hottest leads."</div>
  </div>
  <div class="ai-chat-input">
    <input type="text" id="aiInput" placeholder="Ask AI about your pipeline..." onkeydown="if(event.key==='Enter')sendAI()">
    <button onclick="sendAI()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
  </div>
</div>

<script>
// ──────────────────────────────────────────────
// CONFIG & STATE
// ──────────────────────────────────────────────
const COLORS = ['#6c5ce7','#00cec9','#e17055','#0984e3','#fdcb6e','#e84393','#00b894','#d63031','#6c5ce7','#fd79a8','#74b9ff','#a29bfe'];
const STATUS_CLASS = {Hot:'badge-hot',Warm:'badge-warm',New:'badge-new',Cold:'badge-cold'};
const SKIP_DOMAINS = new Set(['gmail.com','yahoo.com','hotmail.com','outlook.com','live.com','aol.com','icloud.com','me.com','mac.com','msn.com','googlemail.com','protonmail.com','proton.me','ymail.com','mail.com']);

let companies = [];
let domainMap = {};
let lastScanTime = null;
let currentSort = {key:'sent',asc:false};
let currentFilter = 'all';
let msalInstance = null;
let currentAccount = null;
let userEmail = '';
let isScanning = false;

// ──────────────────────────────────────────────
// INDEXEDDB PERSISTENCE
// ──────────────────────────────────────────────
const DB_NAME = 'relateflow';
const DB_VERSION = 1;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('domainData')) db.createObjectStore('domainData', { keyPath: 'domain' });
      if (!db.objectStoreNames.contains('meta')) db.createObjectStore('meta', { keyPath: 'key' });
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function persistData() {
  try {
    const db = await openDB();
    const tx = db.transaction(['domainData', 'meta'], 'readwrite');
    const domainStore = tx.objectStore('domainData');
    const metaStore = tx.objectStore('meta');
    domainStore.clear();
    for (const [domain, data] of Object.entries(domainMap)) {
      const rec = { domain, contacts: {}, totalSent: data.totalSent, totalReceived: data.totalReceived, lastDate: data.lastDate ? data.lastDate.toISOString() : null };
      for (const [email, c] of Object.entries(data.contacts)) {
        rec.contacts[email] = { ...c, lastDate: c.lastDate ? c.lastDate.toISOString() : null };
      }
      domainStore.put(rec);
    }
    metaStore.put({ key: 'lastScanTime', value: lastScanTime ? lastScanTime.toISOString() : null });
    metaStore.put({ key: 'userEmail', value: userEmail });
    await new Promise((res, rej) => { tx.oncomplete = res; tx.onerror = () => rej(tx.error); });
  } catch(e) { console.warn('Persist failed:', e); }
}

async function loadPersistedData() {
  try {
    const db = await openDB();
    const tx = db.transaction(['domainData', 'meta'], 'readonly');
    const ds = tx.objectStore('domainData');
    const ms = tx.objectStore('meta');
    const [domains, scanRec, emailRec] = await Promise.all([
      new Promise((r, j) => { const q = ds.getAll(); q.onsuccess = () => r(q.result); q.onerror = j; }),
      new Promise((r, j) => { const q = ms.get('lastScanTime'); q.onsuccess = () => r(q.result); q.onerror = j; }),
      new Promise((r, j) => { const q = ms.get('userEmail'); q.onsuccess = () => r(q.result); q.onerror = j; }),
    ]);
    if (!domains || domains.length === 0) return null;
    if (emailRec?.value && emailRec.value !== userEmail) return null;
    const map = {};
    for (const d of domains) {
      map[d.domain] = { contacts: {}, totalSent: d.totalSent, totalReceived: d.totalReceived, lastDate: d.lastDate ? new Date(d.lastDate) : null };
      for (const [email, c] of Object.entries(d.contacts)) {
        map[d.domain].contacts[email] = { ...c, lastDate: c.lastDate ? new Date(c.lastDate) : null };
      }
    }
    return { domainMap: map, lastScanTime: scanRec?.value ? new Date(scanRec.value) : null };
  } catch(e) { console.warn('Load failed:', e); return null; }
}

async function clearPersistedData() {
  try {
    const db = await openDB();
    const tx = db.transaction(['domainData', 'meta'], 'readwrite');
    tx.objectStore('domainData').clear();
    tx.objectStore('meta').clear();
    await new Promise(r => { tx.oncomplete = r; });
  } catch(e) { console.warn('Clear failed:', e); }
}

// ──────────────────────────────────────────────
// MSAL SETUP
// ──────────────────────────────────────────────
const MSAL_CDN_URLS = [
  'https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js',
  'https://unpkg.com/@azure/msal-browser@2.38.3/lib/msal-browser.min.js',
  'https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js'
];

function loadScript(url) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = url;
    s.onload = resolve;
    s.onerror = () => reject(new Error('Failed to load: ' + url));
    document.head.appendChild(s);
  });
}

async function ensureMSALLoaded() {
  if (typeof msal !== 'undefined') return true;
  for (const url of MSAL_CDN_URLS) {
    try {
      await loadScript(url);
      if (typeof msal !== 'undefined') return true;
    } catch(e) {
      console.warn(e.message);
    }
  }
  return false;
}

function getClientId() {
  return localStorage.getItem('relateflow_client_id') || '';
}

async function initMSAL() {
  const clientId = getClientId();
  if (!clientId) return null;

  const loaded = await ensureMSALLoaded();
  if (!loaded) {
    alert('Could not load the Microsoft authentication library. Please check your internet connection or try disabling ad-blockers, then refresh the page.');
    return null;
  }

  const config = {
    auth: {
      clientId: clientId,
      authority: 'https://login.microsoftonline.com/common',
      redirectUri: window.location.origin + window.location.pathname,
    },
    cache: {
      cacheLocation: 'localStorage',
      storeAuthStateInCookie: false,
    }
  };
  try {
    msalInstance = new msal.PublicClientApplication(config);
    if (typeof msalInstance.initialize === 'function') {
      await msalInstance.initialize();
    }
    try { await msalInstance.handleRedirectPromise(); } catch(e) { console.warn('Redirect handle:', e); }
    return msalInstance;
  } catch(e) {
    console.error('MSAL init error:', e);
    alert('MSAL initialization failed: ' + e.message);
    msalInstance = null;
    return null;
  }
}

async function signIn() {
  if (!getClientId()) {
    openSettings();
    return;
  }
  if (!msalInstance) await initMSAL();
  if (!msalInstance) { alert('Could not initialize Microsoft authentication. Check your Client ID.'); openSettings(); return; }

  try {
    const resp = await msalInstance.loginPopup({
      scopes: ['Mail.Read','User.Read'],
      prompt: 'select_account'
    });
    currentAccount = resp.account;
    userEmail = currentAccount.username;
    onSignedIn();
  } catch(e) {
    console.error('Sign-in error:', e);
    if (e.errorCode === 'user_cancelled') return;
    // If popup blocked, try redirect
    if (e.errorCode === 'popup_window_error' || e.errorCode === 'empty_window_error') {
      alert('Popup was blocked by your browser. Trying redirect login instead...');
      msalInstance.loginRedirect({ scopes: ['Mail.Read','User.Read'] });
      return;
    }
    alert('Sign-in failed: ' + (e.errorCode || '') + ' — ' + (e.message || e));
  }
}

function signOut() {
  if (msalInstance && currentAccount) {
    msalInstance.logoutPopup({ account: currentAccount });
  }
  currentAccount = null;
  userEmail = '';
  companies = [];
  domainMap = {};
  lastScanTime = null;
  isScanning = false;
  showWelcome();
}

async function getAccessToken() {
  if (!msalInstance || !currentAccount) throw new Error('Not signed in');
  try {
    const resp = await msalInstance.acquireTokenSilent({
      scopes: ['Mail.Read','User.Read'],
      account: currentAccount
    });
    return resp.accessToken;
  } catch(e) {
    const resp = await msalInstance.acquireTokenPopup({
      scopes: ['Mail.Read','User.Read']
    });
    currentAccount = resp.account;
    return resp.accessToken;
  }
}

// ──────────────────────────────────────────────
// DOMAIN MAP HELPERS
// ──────────────────────────────────────────────
function getDomain(email) {
  if (!email) return null;
  const d = email.split('@')[1];
  return d ? d.toLowerCase() : null;
}

function ensureDomain(domain) {
  if (!domainMap[domain]) {
    domainMap[domain] = { contacts: {}, totalSent: 0, totalReceived: 0, lastDate: null };
  }
}

function ensureContact(domain, email, name) {
  ensureDomain(domain);
  const le = email.toLowerCase();
  if (!domainMap[domain].contacts[le]) {
    domainMap[domain].contacts[le] = { name: name || email, email: le, sent: 0, received: 0, lastDate: null };
  } else if (name && name !== email && domainMap[domain].contacts[le].name === le) {
    domainMap[domain].contacts[le].name = name;
  }
}

function updateDate(obj, dateStr) {
  if (!dateStr) return;
  const d = new Date(dateStr);
  if (!obj.lastDate || d > obj.lastDate) obj.lastDate = d;
}

// ──────────────────────────────────────────────
// PROCESS EMAIL BATCH → UPDATE DOMAIN MAP
// ──────────────────────────────────────────────
function processEmailBatch(messages) {
  const myEmailLower = userEmail ? userEmail.toLowerCase() : '';
  const myDomain = userEmail ? getDomain(userEmail) : null;

  for (const msg of messages) {
    const fromEmail = msg.from?.emailAddress?.address?.toLowerCase() || '';
    const isSent = (fromEmail === myEmailLower);

    if (isSent) {
      // SENT email — track all recipients
      const recipients = [...(msg.toRecipients || []), ...(msg.ccRecipients || [])];
      for (const r of recipients) {
        const toEmail = r.emailAddress?.address;
        const toName = r.emailAddress?.name;
        if (!toEmail) continue;
        const domain = getDomain(toEmail);
        if (!domain || SKIP_DOMAINS.has(domain) || domain === myDomain) continue;
        ensureContact(domain, toEmail, toName);
        const le = toEmail.toLowerCase();
        domainMap[domain].contacts[le].sent++;
        domainMap[domain].totalSent++;
        updateDate(domainMap[domain], msg.sentDateTime || msg.receivedDateTime);
        updateDate(domainMap[domain].contacts[le], msg.sentDateTime || msg.receivedDateTime);
      }
    } else {
      // RECEIVED email — track the sender
      const senderEmail = msg.from?.emailAddress?.address;
      const senderName = msg.from?.emailAddress?.name;
      if (!senderEmail) continue;
      const domain = getDomain(senderEmail);
      if (!domain || SKIP_DOMAINS.has(domain) || domain === myDomain) continue;
      ensureContact(domain, senderEmail, senderName);
      const le = senderEmail.toLowerCase();
      domainMap[domain].contacts[le].received++;
      domainMap[domain].totalReceived++;
      updateDate(domainMap[domain], msg.receivedDateTime);
      updateDate(domainMap[domain].contacts[le], msg.receivedDateTime);
    }
  }
}

// ──────────────────────────────────────────────
// BUILD COMPANIES FROM DOMAIN MAP
// (Selective contact creation — like Attio, only
//  domains you've actively emailed become records.
//  Spam, newsletters, and cold inbound are filtered.)
// ──────────────────────────────────────────────
function buildCompaniesFromDomainMap() {
  companies = [];
  let id = 1;
  for (const [domain, data] of Object.entries(domainMap)) {
    const contactArr = Object.values(data.contacts);
    if (contactArr.length === 0) continue;

    // SELECTIVE: only create company if user has sent at least 1 email to this domain
    if (data.totalSent === 0) continue;

    contactArr.sort((a, b) => (b.sent + b.received) - (a.sent + a.received));
    const primary = contactArr[0];
    const totalEmails = data.totalSent + data.totalReceived;

    let score = Math.min(99, Math.round(
      Math.min(totalEmails * 1.5, 50) +
      Math.min(contactArr.length * 5, 20) +
      (data.totalSent > 0 && data.totalReceived > 0 ? 15 : 0) +
      (data.lastDate && (Date.now() - data.lastDate.getTime()) < 7 * 86400000 ? 14 : 0)
    ));

    let status = 'Cold';
    if (score >= 75) status = 'Hot';
    else if (score >= 50) status = 'Warm';
    else if (score >= 30) status = 'New';

    const companyName = domain.split('.')[0].charAt(0).toUpperCase() + domain.split('.')[0].slice(1);

    companies.push({
      id: id++,
      name: companyName,
      domain: domain,
      contact: primary.name,
      contactEmail: primary.email,
      sent: data.totalSent,
      received: data.totalReceived,
      status: status,
      score: score,
      lastDate: data.lastDate,
      lastActivity: data.lastDate ? timeAgo(data.lastDate) : 'unknown',
      allContacts: contactArr,
    });
  }

  companies.sort((a, b) => (b.sent + b.received) - (a.sent + a.received));
  companies.forEach((c, i) => c.id = i + 1);
}

// ──────────────────────────────────────────────
// PROGRESSIVE EMAIL FETCH + PROCESS + RENDER
// (Data populates in the table as emails are scanned)
// ──────────────────────────────────────────────
async function fetchEmailsProgressively(token, sinceDate) {
  const headers = { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' };
  let url = 'https://graph.microsoft.com/v1.0/me/messages?$top=200&$select=id,subject,from,toRecipients,ccRecipients,receivedDateTime,sentDateTime&$orderby=receivedDateTime desc';

  if (sinceDate) {
    url += '&$filter=receivedDateTime ge ' + sinceDate.toISOString();
  }

  let page = 0;
  let totalFetched = 0;

  while (url) {
    page++;
    updateScanBanner('Scanning' + (sinceDate ? ' recent' : ' all') + ' mail... (' + totalFetched.toLocaleString() + ' emails, page ' + page + ')');

    const resp = await fetch(url, { headers });
    if (!resp.ok) {
      const err = await resp.text();
      throw new Error('Graph API error: ' + resp.status + ' — ' + err);
    }
    const data = await resp.json();

    if (data.value && data.value.length > 0) {
      totalFetched += data.value.length;

      // Process this page immediately
      processEmailBatch(data.value);

      // Rebuild companies and update UI live
      buildCompaniesFromDomainMap();
      renderTable();
      updateStats();
      updateScanBanner('Scanning... ' + totalFetched.toLocaleString() + ' emails — ' + companies.length + ' companies found');
    }

    url = data['@odata.nextLink'] || null;
  }

  return totalFetched;
}

function timeAgo(date) {
  const now = Date.now();
  const diff = now - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  if (days < 7) return days + 'd ago';
  const weeks = Math.floor(days / 7);
  if (weeks < 4) return weeks + 'w ago';
  const months = Math.floor(days / 30);
  return months + 'mo ago';
}

// ──────────────────────────────────────────────
// OUTLOOK SCAN — Smart: full first time, incremental after
// ──────────────────────────────────────────────
async function scanOutlookEmails(forceFullScan) {
  if (isScanning) return;
  isScanning = true;

  try {
    showScanBanner('Connecting to Microsoft Graph...');
    const token = await getAccessToken();

    const isIncremental = !forceFullScan && lastScanTime && Object.keys(domainMap).length > 0;
    let totalFetched;

    if (isIncremental) {
      // Incremental: only fetch emails since last scan
      showScanBanner('Syncing new emails since last scan...');
      totalFetched = await fetchEmailsProgressively(token, lastScanTime);
      updateScanBanner('Sync complete — ' + totalFetched.toLocaleString() + ' new emails checked');
    } else {
      // Full scan: clear and rebuild everything
      domainMap = {};
      showScanBanner('Full email scan (all folders, all time)...');
      totalFetched = await fetchEmailsProgressively(token, null);
      updateScanBanner('Full scan complete — ' + totalFetched.toLocaleString() + ' emails processed, ' + companies.length + ' companies');
    }

    lastScanTime = new Date();
    await persistData();
    updateLastSyncDisplay();

    // Keep banner visible briefly so user sees the summary
    setTimeout(() => { hideScanBanner(); }, 2500);

  } catch(e) {
    hideScanBanner();
    console.error('Scan error:', e);
    alert('Email scan failed: ' + e.message);
  } finally {
    isScanning = false;
  }
}

// Full re-scan: clears everything and starts fresh
async function fullRescan() {
  domainMap = {};
  lastScanTime = null;
  companies = [];
  await clearPersistedData();
  renderTable();
  updateStats();
  closeSettings();
  scanOutlookEmails(true);
}

// Last sync display
function updateLastSyncDisplay() {
  const bar = document.getElementById('lastSyncBar');
  if (!lastScanTime) { bar.style.display = 'none'; return; }
  bar.style.display = 'flex';
  document.getElementById('lastSyncText').textContent = 'Last synced: ' + timeAgo(lastScanTime) + ' — ' + companies.length + ' companies, ' + Object.keys(domainMap).length + ' domains tracked';
}

// ──────────────────────────────────────────────
// UI STATE
// ──────────────────────────────────────────────
function showWelcome() {
  document.getElementById('welcomeScreen').style.display = 'flex';
  document.getElementById('crmContent').classList.remove('active');
  document.getElementById('sidebar').style.display = 'none';
  document.getElementById('scanOutlookBtn').style.display = 'none';
  document.getElementById('exportBtn').style.display = 'none';
  document.getElementById('userPill').style.display = 'none';
  document.getElementById('signOutBtn').style.display = 'none';
  document.getElementById('settingsBtn').style.display = 'none';
  document.getElementById('chatFab').style.display = 'none';
}

async function onSignedIn() {
  document.getElementById('welcomeScreen').style.display = 'none';
  document.getElementById('crmContent').classList.add('active');
  document.getElementById('sidebar').style.display = 'flex';
  document.getElementById('scanOutlookBtn').style.display = '';
  document.getElementById('exportBtn').style.display = '';
  document.getElementById('settingsBtn').style.display = '';
  document.getElementById('signOutBtn').style.display = '';
  document.getElementById('chatFab').style.display = 'grid';
  document.getElementById('userPill').style.display = 'flex';
  document.getElementById('userName').textContent = userEmail;

  // Load cached data from IndexedDB — show instantly (no waiting for scan)
  const cached = await loadPersistedData();
  if (cached && cached.domainMap && Object.keys(cached.domainMap).length > 0) {
    domainMap = cached.domainMap;
    lastScanTime = cached.lastScanTime;
    buildCompaniesFromDomainMap();
    renderTable();
    updateStats();
    updateLastSyncDisplay();
  }

  // Background sync: incremental if we have cached data, full if first time
  scanOutlookEmails();
}

function showScanBanner(text) {
  document.getElementById('scanBanner').classList.add('active');
  document.getElementById('scanText').textContent = text;
  document.getElementById('scanCount').textContent = '';
}
function updateScanBanner(text) {
  document.getElementById('scanText').textContent = text;
}
function hideScanBanner() {
  document.getElementById('scanBanner').classList.remove('active');
}

// ──────────────────────────────────────────────
// TABLE RENDERING
// ──────────────────────────────────────────────
function renderTable() {
  let data = [...companies];
  if (currentFilter !== 'all') data = data.filter(c => c.status === currentFilter);
  const q = (document.getElementById('searchInput').value || '').toLowerCase();
  if (q) data = data.filter(c => c.name.toLowerCase().includes(q) || c.contact.toLowerCase().includes(q) || c.domain.toLowerCase().includes(q));

  const {key, asc} = currentSort;
  data.sort((a,b) => {
    let va = a[key], vb = b[key];
    if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb||'').toLowerCase(); }
    if (va < vb) return asc ? -1 : 1;
    if (va > vb) return asc ? 1 : -1;
    return 0;
  });

  const tbody = document.getElementById('tableBody');
  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text2)">No companies found. Click "Re-scan Emails" to sync your Outlook.</td></tr>';
    return;
  }

  tbody.innerHTML = data.map(c => {
    const color = COLORS[c.id % COLORS.length];
    const total = c.sent + c.received;
    const sentPct = total ? (c.sent / total * 100) : 50;
    const recvPct = 100 - sentPct;
    const circumference = 2 * Math.PI * 12;
    const offset = circumference - (c.score / 100) * circumference;
    const scoreColor = c.score >= 75 ? 'var(--green)' : c.score >= 50 ? 'var(--orange)' : 'var(--red)';
    const initials = c.contact.split(' ').map(n => n[0]).join('').substring(0,2);

    return `<tr onclick="openDetail(${c.id})" style="cursor:pointer">
      <td><div class="company-cell"><div class="company-logo" style="background:${color}">${c.name[0].toUpperCase()}</div><div class="company-info"><span class="company-name">${esc(c.name)}</span><span class="company-domain">${esc(c.domain)}</span></div></div></td>
      <td><div class="contact-cell"><div class="avatar" style="background:${color}">${esc(initials)}</div><span class="contact-name">${esc(c.contact)}</span></div></td>
      <td><span style="color:var(--accent2);font-weight:600">${c.sent}</span></td>
      <td><span style="color:var(--green);font-weight:600">${c.received}</span></td>
      <td><div class="email-bar"><div class="bar-track"><div class="bar-sent" style="width:${sentPct}%"></div><div class="bar-recv" style="width:${recvPct}%"></div></div></div></td>
      <td><span class="badge ${STATUS_CLASS[c.status]}">${c.status}</span></td>
      <td><div class="ai-score"><div class="score-ring" style="color:${scoreColor}"><svg viewBox="0 0 30 30"><circle class="track" cx="15" cy="15" r="12"/><circle class="fill" cx="15" cy="15" r="12" stroke="${scoreColor}" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"/></svg>${c.score}</div></div></td>
      <td style="color:var(--text2)">${esc(c.lastActivity)}</td>
    </tr>`;
  }).join('');

  document.getElementById('companyCount').textContent = companies.length;
}

function updateStats() {
  document.getElementById('statCompanies').textContent = companies.length;
  document.getElementById('statSent').textContent = companies.reduce((s,c) => s + c.sent, 0).toLocaleString();
  document.getElementById('statRecv').textContent = companies.reduce((s,c) => s + c.received, 0).toLocaleString();
  document.getElementById('statContacts').textContent = companies.reduce((s,c) => s + (c.allContacts?.length || 1), 0).toLocaleString();
}

function sortTable(key) {
  if (currentSort.key === key) currentSort.asc = !currentSort.asc;
  else { currentSort.key = key; currentSort.asc = key === 'company' || key === 'contact'; }
  renderTable();
}

function filterByStatus(status, el) {
  currentFilter = status;
  document.querySelectorAll('.sidebar-item').forEach(e => e.classList.remove('active'));
  if (el) el.classList.add('active');
  renderTable();
}

// ──────────────────────────────────────────────
// DETAIL PANEL
// ──────────────────────────────────────────────
function openDetail(id) {
  const c = companies.find(x => x.id === id);
  if (!c) return;
  const color = COLORS[c.id % COLORS.length];
  document.getElementById('detailLogo').style.background = color;
  document.getElementById('detailLogo').textContent = c.name[0].toUpperCase();
  document.getElementById('detailTitle').textContent = c.name;
  document.getElementById('detailDomain').textContent = c.domain;
  document.getElementById('detailSent').textContent = c.sent;
  document.getElementById('detailRecv').textContent = c.received;
  document.getElementById('detailContacts').textContent = c.allContacts ? c.allContacts.length : 1;
  const rate = (c.sent + c.received) > 0 ? Math.round(c.received / (c.sent + c.received) * 100) : 0;
  document.getElementById('detailRate').textContent = rate + '%';

  // AI insight based on real data
  let insight = '';
  if (c.score >= 75) insight = `High engagement with ${c.name}. ${c.sent + c.received} total emails exchanged. This is one of your most active relationships — consider a direct call or meeting.`;
  else if (c.score >= 50) insight = `Moderate engagement with ${c.name}. The conversation is active but could use more follow-up. ${c.received > c.sent ? 'They reply more than you send — great responsiveness.' : 'You send more than they reply — try a different approach.'}`;
  else if (c.score >= 30) insight = `Early-stage relationship with ${c.name}. Only ${c.sent + c.received} emails exchanged so far. Consider increasing outreach to build momentum.`;
  else insight = `Low activity with ${c.name}. Risk of going cold — last email was ${c.lastActivity}. AI recommends re-engaging with a personalized message.`;
  document.getElementById('detailInsight').textContent = insight;

  // Contacts list
  const contacts = c.allContacts || [{ name: c.contact, email: c.contactEmail, sent: c.sent, received: c.received }];
  document.getElementById('detailContactsList').innerHTML = contacts.map(ct => `
    <div style="display:flex;align-items:center;justify-content:space-between;background:var(--surface2);border-radius:8px;padding:10px 14px">
      <div style="display:flex;align-items:center;gap:8px">
        <div class="avatar" style="background:${color}">${ct.name.split(' ').map(n=>n[0]).join('').substring(0,2)}</div>
        <div style="display:flex;flex-direction:column">
          <span style="font-weight:600;font-size:13px">${esc(ct.name)}</span>
          <span style="font-size:11px;color:var(--text2)">${esc(ct.email)}</span>
        </div>
      </div>
      <div style="display:flex;gap:12px;font-size:12px">
        <span style="color:var(--accent2)">${ct.sent} sent</span>
        <span style="color:var(--green)">${ct.received} recv</span>
      </div>
    </div>
  `).join('');

  document.getElementById('detailPanel').classList.add('open');
}

function closeDetail() {
  document.getElementById('detailPanel').classList.remove('open');
}

// ──────────────────────────────────────────────
// SETTINGS
// ──────────────────────────────────────────────
function openSettings() {
  document.getElementById('settingsModal').classList.add('active');
  document.getElementById('clientIdInput').value = getClientId();
  document.getElementById('redirectDisplay').textContent = window.location.origin + window.location.pathname;
}

function closeSettings() {
  document.getElementById('settingsModal').classList.remove('active');
}

async function saveSettings() {
  const clientId = document.getElementById('clientIdInput').value.trim();
  if (!clientId) { alert('Please enter your Application (Client) ID'); return; }
  if (!/^[a-f0-9-]{36}$/i.test(clientId)) {
    if (!confirm('That doesn\'t look like a standard Azure Client ID (should be a UUID). Save anyway?')) return;
  }
  localStorage.setItem('relateflow_client_id', clientId);
  closeSettings();
  msalInstance = null;
  await initMSAL();
  await signIn();
}

// ──────────────────────────────────────────────
// EXPORT CSV
// ──────────────────────────────────────────────
function exportCSV() {
  const header = 'Company,Domain,Primary Contact,Contact Email,Sent,Received,Status,AI Score,Last Activity\n';
  const rows = companies.map(c =>
    `"${c.name}","${c.domain}","${c.contact}","${c.contactEmail}",${c.sent},${c.received},"${c.status}",${c.score},"${c.lastActivity}"`
  ).join('\n');
  const blob = new Blob([header + rows], {type: 'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'relateflow-export.csv';
  a.click();
}

// ──────────────────────────────────────────────
// AI CHAT
// ──────────────────────────────────────────────
function toggleAIChat() {
  document.getElementById('aiChat').classList.toggle('open');
}

function sendAI() {
  const input = document.getElementById('aiInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  const msgs = document.getElementById('aiMessages');
  msgs.innerHTML += `<div class="ai-msg user">${esc(msg)}</div>`;
  msgs.scrollTop = msgs.scrollHeight;
  setTimeout(() => {
    msgs.innerHTML += `<div class="ai-msg bot">${generateAIReply(msg)}</div>`;
    msgs.scrollTop = msgs.scrollHeight;
  }, 400);
}

function generateAIReply(msg) {
  const lower = msg.toLowerCase();
  if (lower.includes('follow up') || lower.includes('followup') || lower.includes('reach out')) {
    const targets = companies.filter(c => c.status === 'Cold' || c.status === 'Warm').sort((a,b) => b.score - a.score).slice(0,5);
    if (targets.length === 0) return 'All your contacts look engaged! No immediate follow-ups needed.';
    return `I'd recommend following up with:<br>${targets.map(c => `<b>${c.contact}</b> at ${esc(c.name)} (${c.lastActivity}, score: ${c.score})`).join('<br>')}`;
  }
  if (lower.includes('hot') || lower.includes('best') || lower.includes('top')) {
    const hot = companies.filter(c => c.status === 'Hot').slice(0,5);
    if (hot.length === 0) return 'No hot leads yet. Keep emailing to build engagement!';
    return `Your hottest leads:<br>${hot.map(c => `<b>${esc(c.name)}</b> — Score: ${c.score}, ${c.sent+c.received} emails`).join('<br>')}`;
  }
  if (lower.includes('cold') || lower.includes('risk') || lower.includes('losing')) {
    const cold = companies.filter(c => c.status === 'Cold');
    return `${cold.length} companies at risk:<br>${cold.slice(0,5).map(c => `<b>${esc(c.name)}</b> — last: ${c.lastActivity}, score: ${c.score}`).join('<br>')}`;
  }
  if (lower.includes('summary') || lower.includes('overview') || lower.includes('stats')) {
    const ts = companies.reduce((s,c) => s+c.sent, 0);
    const tr = companies.reduce((s,c) => s+c.received, 0);
    return `Pipeline: <b>${companies.length}</b> companies, <b>${ts}</b> sent / <b>${tr}</b> received.<br>Hot: ${companies.filter(c=>c.status==='Hot').length} | Warm: ${companies.filter(c=>c.status==='Warm').length} | New: ${companies.filter(c=>c.status==='New').length} | Cold: ${companies.filter(c=>c.status==='Cold').length}`;
  }
  // Try to find a company match
  const match = companies.find(c => lower.includes(c.name.toLowerCase()) || lower.includes(c.domain.toLowerCase()));
  if (match) {
    return `<b>${esc(match.name)}</b> (${esc(match.domain)})<br>Contact: ${esc(match.contact)}<br>Sent: ${match.sent} | Received: ${match.received}<br>Score: ${match.score} (${match.status})<br>Last: ${match.lastActivity}`;
  }
  return `You have ${companies.length} companies in your pipeline. Try:<br>• "Who should I follow up with?"<br>• "Show me hot leads"<br>• "Give me a summary"<br>• Or ask about any company by name`;
}

function esc(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ──────────────────────────────────────────────
// INIT — check for existing session
// ──────────────────────────────────────────────
(async function init() {
  if (getClientId()) {
    await initMSAL();
    if (msalInstance) {
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length > 0) {
        currentAccount = accounts[0];
        userEmail = currentAccount.username;
        onSignedIn();
        return;
      }
    }
  }
  document.getElementById('settingsBtn').style.display = '';
  showWelcome();
})();
</script>
</body>
</html>
