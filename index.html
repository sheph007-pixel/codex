<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kennion CRM</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- MSAL loaded dynamically in initMSAL() with CDN fallbacks -->
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f8f9fa;--surface:#ffffff;--surface2:#f1f3f4;--border:#dadce0;
  --text:#202124;--text2:#5f6368;--accent:#1a73e8;--accent2:#1967d2;
  --green:#1e8e3e;--green-bg:rgba(30,142,62,.08);
  --red:#d93025;--red-bg:rgba(217,48,37,.08);
  --orange:#e8710a;--orange-bg:rgba(232,113,10,.08);
  --blue:#1a73e8;--blue-bg:rgba(26,115,232,.08);
  --ms-blue:#1a73e8;
}
html{font-family:'Inter',system-ui,sans-serif;font-size:14px;background:var(--bg);color:var(--text)}
body{min-height:100vh;overflow-x:hidden}

/* ── TOP NAV ── */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:0 24px;height:56px;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;box-shadow:0 1px 3px rgba(60,64,67,.08)}
.topbar .logo{display:flex;align-items:center;gap:10px;font-weight:700;font-size:16px;letter-spacing:-.3px}
.topbar .logo svg{width:28px;height:28px}
.topbar-actions{display:flex;align-items:center;gap:12px}
.btn{padding:7px 16px;border-radius:8px;border:none;font-size:13px;font-weight:500;cursor:pointer;transition:.15s;font-family:inherit;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:#1557b0}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--surface2);color:var(--text)}
.btn-sm{padding:5px 12px;font-size:12px}
.btn-ms{background:var(--ms-blue);color:#fff;font-weight:600}
.btn-ms:hover{background:#1557b0}
.btn-icon{width:34px;height:34px;padding:0;display:grid;place-items:center;border-radius:8px;background:transparent;border:1px solid var(--border);color:var(--text2);cursor:pointer;transition:.15s}
.btn-icon:hover{background:var(--surface2);color:var(--text)}
.user-pill{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;font-size:12px;color:var(--text2)}
.user-pill .dot{width:8px;height:8px;border-radius:50%;background:var(--green)}

/* ── LAYOUT ── */
.layout{display:flex;height:calc(100vh - 56px)}
.sidebar{width:240px;min-width:0;background:var(--surface);border-right:1px solid var(--border);padding:16px 12px;flex-shrink:0;display:flex;flex-direction:column;gap:4px;overflow-y:auto;overflow-x:hidden;transition:width .25s cubic-bezier(.4,0,.2,1),padding .25s cubic-bezier(.4,0,.2,1),border .25s}
.sidebar.collapsed{width:0!important;padding:0 !important;border-right-color:transparent;overflow:hidden;pointer-events:none}
.sidebar-toggle{background:none;border:1px solid var(--border);color:var(--text2);cursor:pointer;width:28px;height:28px;border-radius:6px;display:grid;place-items:center;transition:.15s}
.sidebar-toggle:hover{background:var(--surface2);color:var(--text)}
.sidebar-toggle svg{width:16px;height:16px}
.sidebar-section{margin-top:16px;margin-bottom:6px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text2);padding:0 12px}
.sidebar-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:8px;color:var(--text2);cursor:pointer;transition:.15s;font-size:13px;font-weight:500}
.sidebar-item:hover,.sidebar-item.active{background:var(--surface2);color:var(--text)}
.sidebar-item.active{color:var(--accent2)}
.sidebar-item svg{width:18px;height:18px;flex-shrink:0}
.sidebar-badge{margin-left:auto;background:var(--accent);color:#fff;font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px}
.main{flex:1;overflow-y:auto;overflow-x:hidden;padding:24px;display:flex;flex-direction:column;gap:20px}
.main:has(.detail-page.active){padding:0;gap:0;overflow:hidden}

/* ── WELCOME / SIGN-IN SCREEN ── */
.welcome-screen{display:flex;align-items:center;justify-content:center;flex:1;padding:40px}
.welcome-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:48px;max-width:520px;text-align:center;box-shadow:0 1px 4px rgba(60,64,67,.1)}
.welcome-card h1{font-size:28px;font-weight:700;margin-bottom:8px}
.welcome-card .subtitle{color:var(--text2);font-size:15px;line-height:1.6;margin-bottom:32px}
.welcome-card .ms-btn{display:inline-flex;align-items:center;gap:12px;padding:14px 32px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:.15s;font-family:inherit}
.welcome-card .ms-btn:hover{background:#1557b0;transform:translateY(-1px);box-shadow:0 2px 8px rgba(26,115,232,.3)}
.welcome-card .ms-btn svg{width:20px;height:20px}
.welcome-features{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:32px;text-align:left}
.welcome-feat{display:flex;align-items:start;gap:10px;padding:12px;background:var(--surface2);border-radius:10px}
.welcome-feat svg{width:18px;height:18px;color:var(--accent2);flex-shrink:0;margin-top:2px}
.welcome-feat div{display:flex;flex-direction:column;gap:2px}
.welcome-feat .feat-title{font-size:13px;font-weight:600;color:var(--text)}
.welcome-feat .feat-desc{font-size:11px;color:var(--text2)}
.welcome-note{margin-top:20px;font-size:11px;color:var(--text2);line-height:1.5}

/* ── CONNECTED ACCOUNT BAR ── */
.account-bar{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;margin:0 0 4px}
.account-bar-left{display:flex;align-items:center;gap:10px;color:var(--text2)}
.account-bar-left svg{flex-shrink:0;color:var(--ms-blue)}
.account-email{font-size:13px;font-weight:500;color:var(--text)}
.sync-badge{display:inline-flex;align-items:center;gap:5px;font-size:11px;font-weight:600;padding:2px 8px;border-radius:20px;background:rgba(52,168,83,.12);color:#1e7e34}
.sync-badge.scanning{background:rgba(26,115,232,.12);color:var(--ms-blue)}
.sync-badge.error{background:rgba(234,67,53,.12);color:var(--red)}
.sync-dot{width:6px;height:6px;border-radius:50%;background:currentColor}
.sync-badge.scanning .sync-dot{animation:pulse 1.2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.account-bar-right{display:flex;align-items:center;gap:10px}
.last-sync-text{font-size:11px;color:var(--text2)}
.btn-xs{padding:3px 8px;font-size:11px;border-radius:6px}

/* ── SCAN SPINNER (reused in timeline loading) ── */
.scan-spinner{width:20px;height:20px;border-radius:50%;border:3px solid var(--border);border-top-color:var(--ms-blue);animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── STATS ROW ── */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px 20px;display:flex;flex-direction:column;gap:6px;box-shadow:0 1px 2px rgba(60,64,67,.08)}
.stat-card .stat-label{font-size:12px;color:var(--text2);font-weight:500}
.stat-card .stat-value{font-size:26px;font-weight:700;letter-spacing:-.5px}
.stat-card .stat-change{font-size:11px;font-weight:600;display:flex;align-items:center;gap:4px}
.stat-up{color:var(--green)}.stat-down{color:var(--red)}

/* ── TOOLBAR ── */
.toolbar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.toolbar-left{display:flex;align-items:center;gap:10px}
.toolbar-right{display:flex;align-items:center;gap:10px}
.search-box{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:7px 14px;width:260px;transition:.15s}
.search-box:focus-within{border-color:var(--accent)}
.search-box input{background:none;border:none;outline:none;color:var(--text);font-size:13px;width:100%;font-family:inherit}
.search-box svg{width:16px;height:16px;color:var(--text2);flex-shrink:0}

/* ── TABLE ── */
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;flex:1;box-shadow:0 1px 2px rgba(60,64,67,.08)}
table{width:100%;border-collapse:collapse}
thead{position:sticky;top:0;z-index:2}
th{background:var(--surface2);text-align:left;padding:10px 16px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--text2);border-bottom:1px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none}
th:hover{color:var(--text)}
td{padding:12px 16px;border-bottom:1px solid var(--border);font-size:13px;white-space:nowrap}
table{will-change:auto;contain:layout style}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(26,115,232,.04)}
tr.row-selected td{background:rgba(26,115,232,.08)}

/* ── CHECKBOX ── */
th.col-check,td.col-check{width:40px;text-align:center;padding:10px 8px 10px 14px}
.row-checkbox{width:16px;height:16px;accent-color:var(--accent);cursor:pointer}

/* ── BULK ACTIONS BAR ── */
.bulk-bar{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px 20px;display:none;align-items:center;gap:16px;z-index:95;box-shadow:0 2px 12px rgba(60,64,67,.15);backdrop-filter:blur(8px)}
.bulk-bar.active{display:flex}
.bulk-bar .bulk-count{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap}
.bulk-bar .bulk-sep{width:1px;height:24px;background:var(--border)}
.bulk-bar .btn-danger{background:var(--red-bg);color:var(--red);border:1px solid rgba(255,118,117,.2)}
.bulk-bar .btn-danger:hover{background:rgba(255,118,117,.2)}

.company-cell{display:flex;align-items:center;gap:10px}
.company-logo{width:32px;height:32px;border-radius:8px;display:grid;place-items:center;font-weight:700;font-size:13px;color:#fff;flex-shrink:0;overflow:hidden;position:relative}
.company-logo img{width:100%;height:100%;object-fit:contain;position:absolute;inset:0;background:#fff;padding:3px;border-radius:inherit}
.company-info{display:flex;flex-direction:column}
.company-name{font-weight:600;color:var(--text)}
.company-domain{font-size:11px;color:var(--text2)}

.contact-cell{display:flex;align-items:center;gap:8px}
.avatar{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;font-weight:600;font-size:10px;color:#fff;flex-shrink:0;overflow:hidden;position:relative}
.avatar img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;border-radius:inherit}
.contact-name{font-weight:500}
.contact-title{font-size:10px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.linkedin-link{display:inline-flex;align-items:center;gap:3px;color:#0a66c2;font-size:10px;text-decoration:none;font-weight:500;transition:.15s;flex-shrink:0}
.linkedin-link:hover{text-decoration:underline}
.linkedin-link svg{width:12px;height:12px}
[data-placeholder]:empty::before{content:attr(data-placeholder);color:var(--text2);opacity:.5;font-style:italic}

.badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-hot{background:var(--green-bg);color:var(--green)}
.badge-warm{background:var(--orange-bg);color:var(--orange)}
.badge-cold{background:var(--blue-bg);color:var(--blue)}

.email-bar{display:flex;align-items:center;gap:6px;font-size:12px}
.bar-track{width:80px;height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;display:flex}
.bar-sent{background:var(--accent);height:100%;border-radius:3px 0 0 3px}
.bar-recv{background:var(--green);height:100%;border-radius:0 3px 3px 0}

.trend-spark{display:flex;align-items:end;gap:2px;height:24px}
.trend-spark .bar{width:4px;border-radius:2px;background:var(--accent);opacity:.6;transition:.15s}
.trend-spark .bar:last-child{opacity:1}

.ai-score{display:flex;align-items:center;gap:6px}
.score-num{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;font-weight:700;font-size:11px;border:3px solid}
.score-ring{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;font-weight:700;font-size:11px;position:relative}
.score-ring svg{position:absolute;inset:0;transform:rotate(-90deg)}
.score-ring circle{fill:none;stroke-width:3}
.score-ring .track{stroke:var(--surface2)}
.score-ring .fill{stroke-linecap:round}
.show-more-row td{text-align:center;padding:12px;cursor:pointer;color:var(--accent);font-weight:600;font-size:13px}
.show-more-row:hover td{background:rgba(26,115,232,.04)}

/* ── COLUMN MANAGEMENT ── */
.col-mgr-wrap{position:relative;display:inline-block}
.col-mgr-drop{position:absolute;top:100%;right:0;margin-top:6px;background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:0 4px 24px rgba(60,64,67,.15);width:300px;max-height:460px;overflow-y:auto;z-index:120;display:none;padding:12px 0}
.col-mgr-drop.open{display:block}
.col-mgr-section{padding:4px 16px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--text2);margin-top:8px}
.col-mgr-section:first-child{margin-top:0}
.col-mgr-item{display:flex;align-items:center;gap:10px;padding:7px 16px;font-size:13px;cursor:pointer;transition:.1s}
.col-mgr-item:hover{background:var(--surface2)}
.col-mgr-item input[type=checkbox]{accent-color:var(--accent);width:15px;height:15px;cursor:pointer}
.col-mgr-item .col-label{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.col-mgr-item .col-remove{color:var(--red);font-size:16px;line-height:1;cursor:pointer;opacity:0;transition:.15s;padding:0 2px}
.col-mgr-item:hover .col-remove{opacity:1}
.col-mgr-add{display:flex;align-items:center;gap:6px;padding:8px 16px;font-size:12px;color:var(--accent);font-weight:600;cursor:pointer;transition:.1s;border:none;background:none;width:100%;font-family:inherit}
.col-mgr-add:hover{background:var(--surface2)}
.col-mgr-add svg{width:14px;height:14px}
.col-mgr-presets{padding:4px 16px;display:flex;flex-wrap:wrap;gap:6px}
.col-preset-chip{padding:4px 10px;border-radius:16px;font-size:11px;font-weight:500;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text);transition:.15s}
.col-preset-chip:hover{border-color:var(--accent);color:var(--accent)}
.col-rename-input{background:var(--surface2);border:1px solid var(--accent);border-radius:4px;padding:2px 6px;font-size:11px;font-family:inherit;color:var(--text);outline:none;width:100%}
td.custom-cell{cursor:text;position:relative;min-width:80px}
td.custom-cell:hover{background:rgba(26,115,232,.04)}
td.custom-cell .cell-val{display:inline-block;min-height:16px;min-width:40px}
td.custom-cell .cell-val:empty::after{content:'—';color:var(--text2)}
td.custom-cell .cell-val.enriching{color:var(--text2);font-style:italic}
td.custom-cell input.cell-edit{background:var(--surface);border:1px solid var(--accent);border-radius:4px;padding:2px 6px;font-size:13px;font-family:inherit;color:var(--text);outline:none;width:90%}

/* ── DETAIL PANEL (full-page overlay) ── */
/* ── FULL-PAGE COMPANY DETAIL ── */
.detail-page{display:none;flex-direction:column;height:100%}
.detail-page.active{display:flex}
.dp-topbar{display:flex;align-items:center;gap:12px;padding:14px 24px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0}
.dp-topbar-back{display:flex;align-items:center;gap:6px;background:none;border:none;color:var(--accent);cursor:pointer;font-size:13px;font-weight:500;font-family:inherit;padding:6px 10px;border-radius:6px;transition:.15s}
.dp-topbar-back:hover{background:var(--surface2)}
.dp-topbar-back svg{width:16px;height:16px}
.dp-topbar-title{flex:1;font-size:15px;font-weight:700;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dp-topbar-close{background:none;border:1px solid var(--border);color:var(--text2);cursor:pointer;width:34px;height:34px;border-radius:8px;display:grid;place-items:center;flex-shrink:0;transition:.15s}
.dp-topbar-close:hover{background:var(--surface2);color:var(--text)}
.dp-topbar-close svg{width:16px;height:16px}

.dp-body{display:flex;flex:1;overflow:hidden}

/* Left: company info + relationships */
.dp-left{width:340px;min-width:280px;border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0}
.dp-left-head{padding:20px 20px 0;flex-shrink:0}
.dp-company-head{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.dp-co-logo{width:44px;height:44px;border-radius:10px;display:grid;place-items:center;font-weight:700;font-size:16px;color:#fff;flex-shrink:0;overflow:hidden;position:relative}
.dp-co-logo img{width:100%;height:100%;object-fit:contain;position:absolute;inset:0;background:#fff;padding:4px;border-radius:inherit}
.dp-co-info h2{font-size:15px;font-weight:700;letter-spacing:-.2px}
.dp-co-info .dp-domain{font-size:11px;color:var(--text2)}
.dp-co-meta{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.dp-mini-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.dp-mini-stat{background:var(--surface2);border-radius:8px;padding:8px 10px}
.dp-mini-stat .label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.4px;font-weight:600}
.dp-mini-stat .value{font-size:16px;font-weight:700;margin-top:2px}
.dp-left-contacts{flex:1;overflow-y:auto;padding:0 12px 16px}
.dp-section-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text2);margin-bottom:8px;padding:8px 8px 0;display:flex;align-items:center;gap:6px}
.dp-section-title .cnt{font-size:10px;background:var(--surface2);padding:1px 6px;border-radius:8px;color:var(--text)}
.dp-contact{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:8px;cursor:pointer;transition:.15s;margin-bottom:2px}
.dp-contact:hover{background:var(--surface2)}
.dp-contact.selected{background:var(--surface2);box-shadow:inset 3px 0 0 var(--accent)}
.dp-contact .dp-ct-avatar{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;font-weight:600;font-size:10px;color:#fff;flex-shrink:0;overflow:hidden;position:relative}
.dp-contact .dp-ct-avatar img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;border-radius:inherit}
.dp-contact .dp-ct-info{flex:1;min-width:0}
.dp-contact .dp-ct-name{font-size:12px;font-weight:600;display:flex;align-items:center;gap:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dp-contact .dp-ct-email{font-size:10px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dp-contact .dp-ct-count{font-size:11px;color:var(--text2);flex-shrink:0;font-weight:600}
.dp-star{background:none;border:none;cursor:pointer;font-size:15px;color:var(--border);padding:2px;transition:.15s;flex-shrink:0;line-height:1}
.dp-star:hover{color:var(--orange);transform:scale(1.15)}
.dp-star.active{color:var(--orange)}
.dp-primary-badge{font-size:8px;padding:1px 5px;border-radius:8px;background:var(--accent);color:#fff;font-weight:700;flex-shrink:0}
.dp-left-foot{padding:8px 20px;border-top:1px solid var(--border);flex-shrink:0}

/* Right: selected contact timeline */
.dp-right{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.dp-right-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text2);gap:8px;padding:40px}
.dp-right-empty svg{width:40px;height:40px;opacity:.3}
.dp-right-empty p{font-size:13px}
.dp-right-head{padding:16px 24px;border-bottom:1px solid var(--border);flex-shrink:0}
.dp-ct-head{display:flex;align-items:center;gap:12px;margin-bottom:0}
.dp-ct-big-avatar{width:40px;height:40px;border-radius:50%;display:grid;place-items:center;font-weight:700;font-size:14px;color:#fff;flex-shrink:0;overflow:hidden;position:relative}
.dp-ct-big-avatar img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;border-radius:inherit}
.dp-ct-head-info h2{font-size:15px;font-weight:700}
.dp-ct-head-info .dp-ct-head-email{font-size:11px;color:var(--text2)}
.dp-ct-actions{display:flex;gap:6px;margin-top:10px}
.dp-ct-actions .btn{font-size:11px;padding:5px 10px}
.dp-ct-stats-row{display:flex;gap:16px;margin-top:10px}
.dp-ct-stats-row .dp-ct-stat{font-size:11px;color:var(--text2)}
.dp-ct-stats-row .dp-ct-stat b{font-weight:700;font-size:14px;display:block;margin-bottom:1px}
.dp-right-tabs{padding:0 24px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;gap:0}
.dp-tab{padding:8px 14px;font-size:12px;font-weight:500;color:var(--text2);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;transition:.15s;font-family:inherit}
.dp-tab:hover{color:var(--text)}
.dp-tab.active{color:var(--accent2);border-bottom-color:var(--accent)}
.dp-right-timeline{flex:1;overflow-y:auto;padding:12px 24px 24px;-webkit-overflow-scrolling:touch}

/* Timeline items */
.tl-loading{display:flex;align-items:center;gap:8px;padding:16px;color:var(--text2);font-size:12px}
.tl-loading .scan-spinner{width:14px;height:14px;border-width:2px}
.tl-empty{text-align:center;padding:32px 16px;color:var(--text2);font-size:12px}
.tl-list{display:flex;flex-direction:column;gap:1px}
.tl-date-group{margin-top:12px}
.tl-date-group:first-child{margin-top:0}
.tl-date-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.4px;color:var(--text2);padding:6px 0;position:sticky;top:0;background:var(--surface);z-index:1}
.tl-item{display:flex;align-items:flex-start;gap:10px;padding:8px 10px;border-radius:6px;transition:.15s;cursor:pointer;position:relative}
.tl-item:hover{background:var(--surface2)}
.tl-icon{width:28px;height:28px;border-radius:6px;display:grid;place-items:center;flex-shrink:0}
.tl-icon.sent{background:rgba(26,115,232,.08);color:var(--accent)}
.tl-icon.received{background:var(--green-bg);color:var(--green)}
.tl-icon.meeting{background:var(--orange-bg);color:var(--orange)}
.tl-icon svg{width:14px;height:14px}
.tl-content{flex:1;min-width:0}
.tl-subject{font-size:12px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tl-meta{font-size:10px;color:var(--text2);margin-top:1px}
.tl-preview{font-size:11px;color:var(--text2);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tl-time{font-size:10px;color:var(--text2);flex-shrink:0;white-space:nowrap}
.tl-reply-btn{background:none;border:1px solid var(--border);color:var(--text2);cursor:pointer;padding:3px 6px;border-radius:4px;font-size:10px;flex-shrink:0;transition:.15s;font-family:inherit}
.tl-reply-btn:hover{background:var(--surface2);color:var(--text);border-color:var(--accent)}

/* Inline reply form (in sidebar) */
.dp-inline-reply{border-top:1px solid var(--border);padding:12px 20px 16px;flex-shrink:0;background:var(--surface)}
.dp-inline-reply-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.dp-inline-reply-title{font-size:12px;font-weight:600;color:var(--text)}
.dp-inline-reply-close{background:none;border:none;color:var(--text2);cursor:pointer;padding:2px;border-radius:4px;display:grid;place-items:center;transition:.15s}
.dp-inline-reply-close:hover{background:var(--surface2);color:var(--text)}
.dp-inline-reply-to{font-size:11px;color:var(--text2);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dp-inline-reply-subject{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text2);font-size:12px;padding:6px 10px;margin-bottom:6px;font-family:inherit;outline:none}
.dp-inline-reply-body{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;padding:8px 10px;font-family:inherit;resize:vertical;min-height:72px;max-height:200px;outline:none;line-height:1.5;transition:border-color .15s}
.dp-inline-reply-body:focus{border-color:var(--accent)}
.dp-inline-reply-footer{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
.dp-inline-reply-status{font-size:11px;color:var(--text2)}

@media(max-width:768px){
  .dp-body{flex-direction:column}
  .dp-left{width:100%;border-right:none;border-bottom:1px solid var(--border);max-height:40vh}
  .dp-right{min-height:50vh}
}

/* Compose email modal */
.compose-overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:200;display:none;place-items:center;backdrop-filter:blur(4px)}
.compose-overlay.active{display:grid}
.compose-box{background:var(--surface);border:1px solid var(--border);border-radius:14px;width:560px;max-width:92vw;max-height:85vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 4px 24px rgba(60,64,67,.15)}

/* ── EMAIL VIEWER — slide-over panel ── */
.ev-overlay{position:fixed;inset:0;z-index:200;display:none;pointer-events:none}
.ev-overlay.active{display:block;pointer-events:auto}
.ev-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.25);backdrop-filter:blur(3px);opacity:0;transition:opacity .25s}
.ev-overlay.active .ev-backdrop{opacity:1}
.ev-panel{position:absolute;top:0;right:0;bottom:0;width:min(780px,100vw);background:var(--surface);border-left:1px solid var(--border);box-shadow:-4px 0 32px rgba(60,64,67,.12);display:flex;flex-direction:column;transform:translateX(100%);transition:transform .25s ease}
.ev-overlay.active .ev-panel{transform:translateX(0)}

.ev-toolbar{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;border-bottom:1px solid var(--border);gap:12px;flex-shrink:0}
.ev-back-btn{display:flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;border:none;background:none;cursor:pointer;color:var(--text);transition:.15s}
.ev-back-btn:hover{background:var(--surface2)}
.ev-toolbar-actions{display:flex;align-items:center;gap:6px}
.ev-action-btn{display:inline-flex;align-items:center;gap:5px;padding:7px 14px;border-radius:8px;border:1px solid var(--border);background:var(--surface);font-size:13px;color:var(--text);cursor:pointer;transition:.15s;font-family:inherit}
.ev-action-btn:hover{background:var(--surface2);border-color:var(--ms-blue);color:var(--ms-blue)}

.ev-scroll{flex:1;overflow-y:auto;padding:0}
.ev-subject{font-size:22px;font-weight:700;padding:24px 28px 8px;color:var(--text);line-height:1.3;margin:0}
.ev-sender-card{display:flex;align-items:flex-start;gap:12px;padding:12px 28px 16px;border-bottom:1px solid var(--border)}
.ev-avatar{width:40px;height:40px;border-radius:50%;background:var(--ms-blue);display:grid;place-items:center;font-size:16px;font-weight:600;color:#fff;flex-shrink:0}
.ev-sender-info{flex:1;min-width:0}
.ev-from{font-size:14px;font-weight:600;color:var(--text)}
.ev-from span{font-weight:400;color:var(--text2);font-size:12px;margin-left:6px}
.ev-to{font-size:12px;color:var(--text2);margin-top:2px}
.ev-date{font-size:12px;color:var(--text2);white-space:nowrap;flex-shrink:0;padding-top:2px}

.ev-attachments{padding:12px 28px;border-bottom:1px solid var(--border);display:flex;flex-wrap:wrap;gap:8px}
.ev-att-chip{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;font-size:12px;color:var(--text);cursor:pointer;text-decoration:none;transition:.15s}
.ev-att-chip:hover{background:var(--ms-blue);color:#fff;border-color:var(--ms-blue)}
.ev-att-chip svg{flex-shrink:0}

.ev-body-wrap{flex:1;min-height:400px;padding:0}
.ev-body-frame{width:100%;height:100%;min-height:400px;border:none;background:#fff}
.ev-loading{display:none;padding:60px 28px;color:var(--text2);font-size:14px}
.ev-loading.active{display:flex;align-items:center;justify-content:center;gap:12px}
.compose-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border)}
.compose-header h3{font-size:14px;font-weight:600}
.compose-fields{padding:12px 18px;display:flex;flex-direction:column;gap:8px;border-bottom:1px solid var(--border)}
.compose-field{display:flex;align-items:center;gap:8px;font-size:12px}
.compose-field label{color:var(--text2);min-width:32px;font-weight:500}
.compose-field input{flex:1;background:none;border:none;outline:none;color:var(--text);font-size:13px;font-family:inherit;padding:4px 0}
.compose-body{flex:1;padding:0}
.compose-body textarea{width:100%;min-height:180px;background:none;border:none;outline:none;color:var(--text);font-size:13px;font-family:inherit;padding:14px 18px;resize:none;line-height:1.6}
.compose-footer{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;border-top:1px solid var(--border)}
.compose-footer .btn-send{background:var(--accent);color:#fff;font-weight:600;padding:7px 20px;border-radius:8px;border:none;font-size:13px;cursor:pointer;font-family:inherit;transition:.15s}
.compose-footer .btn-send:hover{background:#1557b0}
.compose-footer .btn-send:disabled{opacity:.5;cursor:not-allowed}

/* ── SETTINGS MODAL ── */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:200;display:none;place-items:center;backdrop-filter:blur(4px)}
.modal-overlay.active{display:grid}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px;width:520px;max-width:90vw;max-height:90vh;overflow-y:auto;box-shadow:0 4px 24px rgba(60,64,67,.15)}
.modal h2{font-size:20px;font-weight:700;margin-bottom:8px}
.modal p{color:var(--text2);font-size:13px;margin-bottom:16px;line-height:1.5}
.modal label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;margin-top:16px}
.modal input[type=text]{width:100%;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;font-family:inherit;outline:none}
.modal input[type=text]:focus{border-color:var(--accent)}
.modal .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:24px}
.modal .help-text{font-size:11px;color:var(--text2);margin-top:6px;line-height:1.5}
.modal .steps{text-align:left;background:var(--surface2);border-radius:10px;padding:16px;margin-top:12px}
.modal .steps ol{margin:0;padding-left:20px;display:flex;flex-direction:column;gap:8px;font-size:13px;color:var(--text);line-height:1.5}
.modal .steps code{background:#e8eaed;padding:2px 6px;border-radius:4px;font-size:12px;color:var(--accent2)}

/* ── BLOCKED DOMAIN TAGS ── */
.blocked-tag{display:inline-flex;align-items:center;gap:4px;background:var(--red-bg);color:var(--red);border:1px solid rgba(255,118,117,.2);border-radius:6px;padding:3px 8px 3px 10px;font-size:11px;font-weight:500}
.blocked-tag button{background:none;border:none;color:var(--red);cursor:pointer;padding:0 2px;font-size:14px;line-height:1;opacity:.7;transition:.15s}
.blocked-tag button:hover{opacity:1}

/* ── AI CHAT MINI ── */
.ai-chat-fab{position:fixed;bottom:24px;right:24px;width:52px;height:52px;border-radius:50%;background:var(--accent);border:none;cursor:pointer;display:grid;place-items:center;z-index:80;box-shadow:0 2px 10px rgba(26,115,232,.3);transition:.2s}
.ai-chat-fab:hover{transform:scale(1.08)}
.ai-chat-fab svg{width:24px;height:24px;color:#fff}
.ai-chat{position:fixed;bottom:90px;right:24px;width:360px;background:var(--surface);border:1px solid var(--border);border-radius:16px;z-index:80;display:none;flex-direction:column;overflow:hidden;box-shadow:0 2px 16px rgba(60,64,67,.15)}
.ai-chat.open{display:flex}
.ai-chat-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;font-weight:600;font-size:14px}
.ai-chat-header .dot{width:8px;height:8px;border-radius:50%;background:var(--green)}
.ai-chat-messages{flex:1;padding:16px;display:flex;flex-direction:column;gap:12px;max-height:300px;overflow-y:auto}
.ai-msg{max-width:85%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.5}
.ai-msg.bot{background:var(--surface2);align-self:flex-start;border-bottom-left-radius:4px}
.ai-msg.user{background:var(--accent);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.ai-chat-input{display:flex;border-top:1px solid var(--border);padding:10px}
.ai-chat-input input{flex:1;background:var(--surface2);border:none;border-radius:8px;padding:10px 14px;color:var(--text);font-size:13px;font-family:inherit;outline:none}
.ai-chat-input button{background:none;border:none;cursor:pointer;padding:0 10px;color:var(--accent2)}

.crm-content{display:none;flex-direction:column;gap:20px;flex:1}
.crm-content.active{display:flex}

.ai-insight{background:linear-gradient(135deg,rgba(26,115,232,.06),rgba(26,115,232,.03));border:1px solid rgba(26,115,232,.15);border-radius:8px;padding:10px;margin-top:8px;display:flex;gap:8px}
.ai-insight svg{width:16px;height:16px;color:var(--accent2);flex-shrink:0;margin-top:2px}
.ai-insight p{font-size:12px;line-height:1.4;color:var(--text)}
.ai-insight .label{font-size:10px;font-weight:600;color:var(--accent2);margin-bottom:2px}

/* AI Company Research Card */
.ai-research-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;margin-top:10px;overflow:hidden}
.ai-research-header{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);background:linear-gradient(135deg,rgba(156,39,176,.05),rgba(103,58,183,.05))}
.ai-research-header svg{width:16px;height:16px;color:#7c3aed;flex-shrink:0}
.ai-research-header .title{font-size:11px;font-weight:700;color:#7c3aed;text-transform:uppercase;letter-spacing:.4px;flex:1}
.ai-research-header .refresh-btn{background:none;border:none;cursor:pointer;color:var(--text2);padding:2px;border-radius:4px;display:grid;place-items:center;transition:.15s}
.ai-research-header .refresh-btn:hover{color:#7c3aed;background:rgba(124,58,237,.1)}
.ai-research-header .refresh-btn svg{width:14px;height:14px}
.ai-research-body{padding:12px}
.ai-research-desc{font-size:12px;line-height:1.5;color:var(--text);margin-bottom:10px}
.ai-research-desc.loading{color:var(--text2);font-style:italic}
.ai-research-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.ai-research-item{display:flex;flex-direction:column;gap:1px;padding:6px 8px;background:var(--bg);border-radius:6px}
.ai-research-item .r-label{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.4px;color:var(--text2)}
.ai-research-item .r-value{font-size:11px;font-weight:600;color:var(--text)}
.ai-research-item.full-width{grid-column:1/-1}
.ai-research-source{font-size:10px;color:var(--text2);margin-top:8px;text-align:right}
.ai-research-source a{color:var(--accent);text-decoration:none}
.ai-research-source a:hover{text-decoration:underline}

/* ── RESPONSIVE ── */
@media(max-width:900px){
  .sidebar{display:none}
  .stats{grid-template-columns:repeat(2,1fr)}
}
@media(max-width:600px){
  .stats{grid-template-columns:1fr}
  .search-box{width:100%}
  .toolbar{flex-direction:column;align-items:stretch}
  .compose-box{width:100%;max-width:100%;border-radius:0;max-height:100vh}
  .ev-panel{width:100vw}
  .ev-subject{font-size:18px;padding:16px 16px 6px}
  .ev-sender-card{padding:10px 16px 12px}
  .ev-attachments{padding:10px 16px}
}
</style>
</head>
<body>

<!-- TOP BAR -->
<header class="topbar">
  <div class="logo">
    <svg viewBox="0 0 28 28" fill="none"><rect width="28" height="28" rx="7" fill="#1a73e8"/><path d="M8 14l4 4 8-8" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    Kennion CRM
  </div>
  <div class="topbar-actions" id="topbarActions">
    <button class="btn btn-ghost btn-sm" id="settingsBtn" onclick="openSettings()" style="display:none" title="Configure Azure App">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.32 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      Settings
    </button>
    <button class="btn btn-ms btn-sm" id="scanOutlookBtn" onclick="scanOutlookEmails()" style="display:none">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
      Sync Emails
    </button>
    <button class="btn btn-ghost btn-sm" id="exportBtn" onclick="exportCSV()" style="display:none">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Export CSV
    </button>
    <div class="user-pill" id="userPill" style="display:none">
      <span class="dot"></span>
      <span id="userName">user@outlook.com</span>
    </div>
    <button class="btn btn-ghost btn-sm" id="signOutBtn" onclick="signOut()" style="display:none">Sign Out</button>
  </div>
</header>

<div class="layout">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar" style="display:none">
    <div class="sidebar-item active" onclick="filterByStatus('all',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      All Companies
      <span class="sidebar-badge" id="companyCount">0</span>
    </div>
    <div class="sidebar-section">Segments</div>
    <div class="sidebar-item" onclick="filterByStatus('Hot',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      Hot Leads
      <span class="sidebar-badge" id="hotCount" style="background:var(--green)">0</span>
    </div>
    <div class="sidebar-item" onclick="filterByStatus('Warm',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      Warm Leads
      <span class="sidebar-badge" id="warmCount" style="background:var(--orange)">0</span>
    </div>
    <div class="sidebar-item" onclick="filterByStatus('Cold',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 17.58A5 5 0 0018 8h-1.26A8 8 0 104 16.25"/><path d="M8 16h.01M8 20h.01M12 18h.01M12 22h.01M16 16h.01M16 20h.01"/></svg>
      Cold Leads
      <span class="sidebar-badge" id="coldCount" style="background:var(--blue)">0</span>
    </div>
    <div class="sidebar-section">Actions</div>
    <div class="sidebar-item" onclick="scanOutlookEmails()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Sync Emails
    </div>
    <div class="sidebar-section">Manage</div>
    <div class="sidebar-item" id="blockedViewItem" onclick="showBlockedView()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
      Blocked
      <span class="sidebar-badge" id="blockedCount" style="background:var(--red)">0</span>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">
    <!-- WELCOME / SIGN IN -->
    <div class="welcome-screen" id="welcomeScreen">
      <div class="welcome-card">
        <h1>Welcome to Kennion CRM</h1>
        <p class="subtitle">AI-powered CRM that scans your Outlook emails to automatically build your sales pipeline. Zero data entry.</p>

        <button class="ms-btn" onclick="signIn()">
          <svg viewBox="0 0 21 21"><rect x="1" y="1" width="9" height="9" fill="#f25022"/><rect x="11" y="1" width="9" height="9" fill="#7fba00"/><rect x="1" y="11" width="9" height="9" fill="#00a4ef"/><rect x="11" y="11" width="9" height="9" fill="#ffb900"/></svg>
          Sign in with Microsoft
        </button>

        <div class="welcome-features">
          <div class="welcome-feat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            <div><span class="feat-title">Email Scanning</span><span class="feat-desc">Reads your Outlook inbox automatically</span></div>
          </div>
          <div class="welcome-feat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/></svg>
            <div><span class="feat-title">Auto Companies</span><span class="feat-desc">Creates companies from email domains</span></div>
          </div>
          <div class="welcome-feat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
            <div><span class="feat-title">Email Tracking</span><span class="feat-desc">Sent vs received per company</span></div>
          </div>
          <div class="welcome-feat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            <div><span class="feat-title">AI Scoring</span><span class="feat-desc">Smart lead scoring from engagement</span></div>
          </div>
        </div>

        <p class="welcome-note">First time? You'll need an Azure App registration. Click the gear icon after sign-in to configure, or <a href="#" onclick="openSettings();return false" style="color:var(--accent2)">set it up now</a>.</p>
      </div>
    </div>

    <!-- CRM CONTENT (shown after sign-in) -->
    <div class="crm-content" id="crmContent">
      <!-- CONNECTED ACCOUNT BAR -->
      <div class="account-bar" id="accountBar" style="display:none">
        <div class="account-bar-left">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          <span class="account-email" id="accountEmail"></span>
          <span class="sync-badge" id="syncBadge">
            <span class="sync-dot"></span>
            <span id="syncBadgeText">Connected</span>
          </span>
        </div>
        <div class="account-bar-right">
          <span class="last-sync-text" id="lastSyncText"></span>
          <button class="btn btn-ghost btn-xs" id="accountSyncBtn" onclick="scanOutlookEmails()" title="Sync now">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
            Sync
          </button>
        </div>
      </div>

      <!-- STATS -->
      <div class="stats">
        <div class="stat-card">
          <span class="stat-label">Total Companies</span>
          <span class="stat-value" id="statCompanies">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Emails Sent</span>
          <span class="stat-value" id="statSent">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Emails Received</span>
          <span class="stat-value" id="statRecv">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Top Contacts</span>
          <span class="stat-value" id="statContacts">0</span>
        </div>
      </div>

      <!-- TOOLBAR -->
      <div class="toolbar">
        <div class="toolbar-left">
          <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
          </button>
          <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" id="searchInput" placeholder="Search companies, contacts...">
          </div>
        </div>
        <div class="toolbar-right">
          <button class="btn btn-ghost btn-sm" onclick="sortTable('sent')">Sort: Most Emails</button>
          <div class="col-mgr-wrap">
            <button class="btn btn-ghost btn-sm" onclick="toggleColumnManager()" id="colMgrBtn">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
              Columns
            </button>
            <div class="col-mgr-drop" id="colMgrDrop"></div>
          </div>
        </div>
      </div>

      <!-- TABLE -->
      <div class="table-wrap">
        <table>
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- FULL-PAGE COMPANY DETAIL -->
    <div class="detail-page" id="detailPage">
      <div class="dp-topbar">
        <button class="dp-topbar-back" onclick="closePanel()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
          All Companies
        </button>
        <div class="dp-topbar-title" id="dpTopbarTitle"></div>
        <button class="dp-topbar-close" onclick="closePanel()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      </div>
      <div class="dp-body">
        <div class="dp-left">
          <div class="dp-left-head" id="dpLeftHead"></div>
          <div class="dp-left-contacts" id="dpLeftContacts"></div>
          <div class="dp-left-foot" id="dpLeftFoot"></div>
        </div>
        <div class="dp-right" id="dpRight">
          <div class="dp-right-empty" id="dpRightEmpty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
            <p>Select a contact to view their history</p>
          </div>
          <div class="dp-right-head" id="dpRightHead" style="display:none"></div>
          <div class="dp-right-tabs" id="dpRightTabs" style="display:none"></div>
          <div class="dp-right-timeline" id="dpTimeline" style="display:none"></div>
          <div class="dp-inline-reply" id="dpInlineReply" style="display:none">
            <div class="dp-inline-reply-header">
              <span class="dp-inline-reply-title" id="inlineReplyTitle">Reply</span>
              <button class="dp-inline-reply-close" onclick="closeInlineReply()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="dp-inline-reply-to" id="inlineReplyTo"></div>
            <input type="text" class="dp-inline-reply-subject" id="inlineReplySubject" placeholder="Subject" readonly>
            <textarea class="dp-inline-reply-body" id="inlineReplyBody" placeholder="Write your reply..." rows="4"></textarea>
            <div class="dp-inline-reply-footer">
              <span class="dp-inline-reply-status" id="inlineReplyStatus"></span>
              <div style="display:flex;gap:8px">
                <button class="btn btn-ghost btn-sm" onclick="closeInlineReply()">Cancel</button>
                <button class="btn-send" id="inlineReplySendBtn" onclick="sendInlineReply()">Send</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- BULK ACTIONS BAR -->
<div class="bulk-bar" id="bulkBar">
  <span class="bulk-count" id="bulkCount">0 selected</span>
  <div class="bulk-sep"></div>
  <button class="btn btn-sm btn-danger" onclick="bulkBlockSelected()">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
    Block from System
  </button>
  <button class="btn btn-ghost btn-sm" onclick="clearSelection()">Cancel</button>
</div>

<!-- COMPOSE EMAIL MODAL -->
<div class="compose-overlay" id="composeOverlay">
  <div class="compose-box">
    <div class="compose-header">
      <h3 id="composeTitle">New Email</h3>
      <button class="dp-close" onclick="closeCompose()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="compose-fields">
      <div class="compose-field"><label>To</label><input type="text" id="composeTo" readonly></div>
      <div class="compose-field"><label>Subj</label><input type="text" id="composeSubject" placeholder="Subject"></div>
    </div>
    <div class="compose-body">
      <textarea id="composeBody" placeholder="Write your message..."></textarea>
    </div>
    <div class="compose-footer">
      <span style="font-size:11px;color:var(--text2)" id="composeSendStatus"></span>
      <button class="btn-send" id="composeSendBtn" onclick="sendComposedEmail()">Send</button>
    </div>
  </div>
</div>

<!-- EMAIL VIEWER — full-width slide-over panel -->
<div class="ev-overlay" id="emailViewerOverlay">
  <div class="ev-backdrop" onclick="closeEmailViewer()"></div>
  <div class="ev-panel" id="evPanel">
    <!-- Toolbar -->
    <div class="ev-toolbar">
      <button class="ev-back-btn" onclick="closeEmailViewer()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
      </button>
      <div class="ev-toolbar-actions">
        <button class="ev-action-btn" onclick="replyFromViewer()" title="Reply">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 00-4-4H4"/></svg>
          Reply
        </button>
        <button class="ev-action-btn" onclick="openInOutlook()" title="Open in Outlook">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Open in Outlook
        </button>
      </div>
    </div>

    <!-- Email content -->
    <div class="ev-scroll">
      <!-- Loading state -->
      <div class="ev-loading" id="evLoading"><div class="scan-spinner"></div> Loading email...</div>

      <!-- Subject -->
      <h1 class="ev-subject" id="evSubject"></h1>

      <!-- Sender card -->
      <div class="ev-sender-card">
        <div class="ev-avatar" id="evAvatar"></div>
        <div class="ev-sender-info">
          <div class="ev-from" id="evFrom"></div>
          <div class="ev-to" id="evTo"></div>
        </div>
        <div class="ev-date" id="evDate"></div>
      </div>

      <!-- Attachments -->
      <div class="ev-attachments" id="evAttachments" style="display:none"></div>

      <!-- Body -->
      <div class="ev-body-wrap">
        <iframe id="evBodyFrame" sandbox="allow-same-origin" class="ev-body-frame"></iframe>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <h2>Azure App Configuration</h2>
    <p>To connect your Outlook, you need a Microsoft Azure App Registration. This gives Kennion CRM permission to read your emails.</p>

    <div class="steps">
      <ol>
        <li>Go to <strong>portal.azure.com</strong> &rarr; <strong>Microsoft Entra ID</strong> &rarr; <strong>App registrations</strong></li>
        <li>Click <strong>New registration</strong>, name it "Kennion CRM"</li>
        <li>Set <strong>Redirect URI</strong> (SPA) to: <code id="redirectDisplay">https://sheph007-pixel.github.io/codex/</code></li>
        <li>Under <strong>API permissions</strong>, add: <code>Mail.Read</code> and <code>Mail.Send</code> (Delegated)</li>
        <li>Click <strong>Grant admin consent</strong> (or have your admin do it)</li>
        <li>Copy the <strong>Application (client) ID</strong> and paste it below</li>
      </ol>
    </div>

    <label>Application (Client) ID</label>
    <input type="text" id="clientIdInput" placeholder="e.g. 12345678-abcd-1234-abcd-123456789abc">
    <p class="help-text">This is stored only in your browser's localStorage. Nothing is sent to any server.</p>

    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
      <label style="font-size:12px;color:var(--text2);margin-bottom:6px;display:block">Protected Domains &amp; Emails</label>
      <p class="help-text" style="margin-top:0;margin-bottom:8px">Domains and emails listed here will never appear in your CRM. Add multiple at once — one per line, or comma/space separated.</p>
      <div style="display:flex;gap:8px">
        <textarea id="blockDomainsInput" rows="3" placeholder="e.g. newsletter.com, noreply@company.com, spam.org" style="flex:1;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;font-family:inherit;outline:none;resize:vertical"></textarea>
        <button class="btn btn-primary" onclick="addBlockedDomainsFromInput()" style="align-self:flex-start;font-size:12px;white-space:nowrap">Block</button>
      </div>
      <div id="blockedDomainsList" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px"></div>
    </div>

    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
      <label style="font-size:12px;color:var(--text2);margin-bottom:6px;display:block">Data Management</label>
      <button class="btn btn-ghost" onclick="fullRescan()" style="color:var(--red);border-color:var(--red);font-size:12px">Reset &amp; Full Re-scan</button>
      <p class="help-text" style="margin-top:4px">Clears all cached data and re-scans every email from scratch.</p>
    </div>

    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeSettings()">Cancel</button>
      <button class="btn btn-primary" onclick="saveSettings()">Save & Connect</button>
    </div>
  </div>
</div>

<!-- AI CHAT FAB -->
<button class="ai-chat-fab" onclick="toggleAIChat()" id="chatFab" style="display:none">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
</button>
<div class="ai-chat" id="aiChat">
  <div class="ai-chat-header"><span class="dot"></span> Kennion AI</div>
  <div class="ai-chat-messages" id="aiMessages">
    <div class="ai-msg bot">Hi! I'm analyzing your real email data. Ask me anything — "Who should I follow up with?" or "Show me my hottest leads."</div>
  </div>
  <div class="ai-chat-input">
    <input type="text" id="aiInput" placeholder="Ask AI about your pipeline..." onkeydown="if(event.key==='Enter')sendAI()">
    <button onclick="sendAI()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
  </div>
</div>

<script>
// ──────────────────────────────────────────────
// CONFIG & STATE
// ──────────────────────────────────────────────
const COLORS = ['#1a73e8','#1e8e3e','#e8710a','#d93025','#9334e6','#e37400','#0d652d','#185abc','#a142f4','#c5221f','#137333','#1967d2'];
const STATUS_CLASS = {Hot:'badge-hot',Warm:'badge-warm',Cold:'badge-cold'};
const SKIP_DOMAINS = new Set(['gmail.com','yahoo.com','hotmail.com','outlook.com','live.com','aol.com','icloud.com','me.com','mac.com','msn.com','googlemail.com','protonmail.com','proton.me','ymail.com','mail.com']);

let companies = [];
let domainMap = {};
let seenMsgIds = new Set(); // track processed email IDs to prevent double-counting
let lastScanTime = null;
let deltaLink = null; // Microsoft Graph delta sync token — tracks last sync position
let currentSort = {key:'sent',asc:false};
let currentFilter = 'all';
let msalInstance = null;
let currentAccount = null;
let userEmail = '';
let isScanning = false;
let fullScanDone = false;
const AUTO_SYNC_INTERVAL = 5 * 60 * 1000; // 5 minutes
let autoSyncTimer = null;
let blockedDomains = new Set();
let selectedIds = new Set();
let starredContacts = {};  // { "domain": "email@example.com" }
let currentCompanyOverlay = null;  // company object for open overlay
let currentContactOverlay = null;  // { contact, company, domain }
let currentContactTab = 'all';
let contactTimelineCache = {};  // "email" -> [{type,subject,date,...}]

// ──────────────────────────────────────────────
// COLUMN CONFIGURATION (Attio-style)
// ──────────────────────────────────────────────
const BUILTIN_COLUMNS = [
  { id:'company', label:'Company', sortKey:'company', removable:false },
  { id:'contact', label:'Primary Contact', sortKey:'contact', removable:true },
  { id:'sent', label:'Sent', sortKey:'sent', removable:true },
  { id:'received', label:'Received', sortKey:'received', removable:true },
  { id:'emailFlow', label:'Email Ratio', sortKey:null, removable:true },
  { id:'status', label:'Status', sortKey:'status', removable:true },
  { id:'score', label:'AI Score', sortKey:'score', removable:true },
  { id:'lastActivity', label:'Last Email', sortKey:'lastActivity', removable:true },
];

const AI_COLUMN_PRESETS = [
  { id:'ai_state', label:'State', enrich:'state' },
  { id:'ai_employees', label:'Employees', enrich:'employees' },
  { id:'ai_industry', label:'Industry', enrich:'industry' },
  { id:'ai_city', label:'City', enrich:'city' },
  { id:'ai_country', label:'Country', enrich:'country' },
  { id:'ai_founded', label:'Founded', enrich:'founded' },
  { id:'ai_type', label:'Type', enrich:'type' },
];

let columnConfig = [];   // [{ id, label, type:'builtin'|'custom'|'ai', visible, enrich? }]
let customColumnData = {};  // { domain: { colId: value, ... } }
let enrichmentCache = {};   // { domain: { state, employees, industry, ... } }
let enrichmentRunning = false;

function getDefaultColumns() {
  return BUILTIN_COLUMNS.map(c => ({ id: c.id, label: c.label, type: 'builtin', visible: true }));
}

function loadColumnConfig() {
  try {
    const raw = localStorage.getItem('kennion_columns');
    if (raw) { columnConfig = JSON.parse(raw); return; }
  } catch(e) {}
  columnConfig = getDefaultColumns();
}

function saveColumnConfig() {
  localStorage.setItem('kennion_columns', JSON.stringify(columnConfig));
}

function loadCustomColumnData() {
  try {
    const raw = localStorage.getItem('kennion_custom_data');
    if (raw) customColumnData = JSON.parse(raw);
  } catch(e) {}
}

function saveCustomColumnData() {
  localStorage.setItem('kennion_custom_data', JSON.stringify(customColumnData));
}

function loadEnrichmentCache() {
  try {
    const raw = localStorage.getItem('kennion_enrichment');
    if (raw) enrichmentCache = JSON.parse(raw);
  } catch(e) {}
}

function saveEnrichmentCache() {
  localStorage.setItem('kennion_enrichment', JSON.stringify(enrichmentCache));
}

function getVisibleColumns() {
  return columnConfig.filter(c => c.visible);
}

// ──────────────────────────────────────────────
// AI ENRICHMENT (Clearbit + heuristics)
// ──────────────────────────────────────────────
async function enrichDomain(domain) {
  // Re-enrich if state is missing (old cache before geo enrichment)
  if (enrichmentCache[domain] && enrichmentCache[domain].state) return enrichmentCache[domain];
  const result = enrichmentCache[domain] || {};
  try {
    // Use Clearbit Company API (free autocomplete endpoint)
    const query = domain.split('.')[0];
    const resp = await fetch('https://autocomplete.clearbit.com/v1/companies/suggest?query=' + encodeURIComponent(query));
    if (resp.ok) {
      const results = await resp.json();
      const match = results.find(r => r.domain === domain) || results.find(r => r.domain && r.domain.split('.')[0] === domain.split('.')[0]);
      if (match) {
        result._clearbit = match;
      }
    }
  } catch(e) {}

  // Heuristic enrichments
  const tld = domain.split('.').pop().toLowerCase();
  const sld = domain.split('.').slice(-2).join('.');
  const contactCount = domainMap[domain] ? Object.keys(domainMap[domain].contacts).length : 0;

  // Country from TLD
  const TLD_COUNTRY = {uk:'United Kingdom',de:'Germany',fr:'France',jp:'Japan',au:'Australia',ca:'Canada',br:'Brazil',in:'India',nl:'Netherlands',es:'Spain',it:'Italy',ch:'Switzerland',se:'Sweden',no:'Norway',dk:'Denmark',fi:'Finland',ie:'Ireland',nz:'New Zealand',sg:'Singapore',kr:'South Korea',mx:'Mexico',za:'South Africa',at:'Austria',be:'Belgium',pt:'Portugal',pl:'Poland',cz:'Czech Republic',il:'Israel',ae:'UAE',hk:'Hong Kong',tw:'Taiwan'};
  if (TLD_COUNTRY[tld]) {
    result.country = TLD_COUNTRY[tld];
  } else if (['com','org','net','io','co','ai','app','dev'].includes(tld)) {
    result.country = 'United States';
  }

  // Employee range from contact count heuristic
  if (contactCount >= 20) result.employees = '1,000+';
  else if (contactCount >= 10) result.employees = '200–1,000';
  else if (contactCount >= 5) result.employees = '50–200';
  else if (contactCount >= 2) result.employees = '10–50';
  else result.employees = '1–10';

  // Industry from domain keywords
  const name = domain.split('.')[0].toLowerCase();
  const IND_KEYWORDS = {tech:'Technology',soft:'Technology',dev:'Technology',code:'Technology',data:'Technology',cloud:'Technology',ai:'Technology',cyber:'Technology',health:'Healthcare',med:'Healthcare',pharma:'Healthcare',bio:'Healthcare',care:'Healthcare',bank:'Finance',capital:'Finance',invest:'Finance',financ:'Finance',insur:'Insurance',pay:'Finance',law:'Legal',legal:'Legal',consult:'Consulting',market:'Marketing',media:'Media',design:'Design',edu:'Education',learn:'Education',school:'Education',build:'Construction',real:'Real Estate',estate:'Real Estate',energy:'Energy',oil:'Energy',food:'Food & Beverage',travel:'Travel',hotel:'Hospitality',retail:'Retail',shop:'Retail',auto:'Automotive',logistic:'Logistics',ship:'Logistics',freight:'Logistics'};
  for (const [kw, ind] of Object.entries(IND_KEYWORDS)) {
    if (name.includes(kw)) { result.industry = ind; break; }
  }
  if (!result.industry) {
    if (tld === 'edu') result.industry = 'Education';
    else if (tld === 'gov') result.industry = 'Government';
    else if (tld === 'org') result.industry = 'Non-Profit';
    else if (['io','dev','app','ai'].includes(tld)) result.industry = 'Technology';
  }

  // Type
  if (tld === 'edu') result.type = 'Education';
  else if (tld === 'gov') result.type = 'Government';
  else if (tld === 'org') result.type = 'Non-Profit';
  else result.type = 'Company';

  // State & City — resolve domain IP then geolocate (free APIs, no keys)
  try {
    // Step 1: DNS resolve via Google DNS-over-HTTPS
    const dnsResp = await fetch('https://dns.google/resolve?name=' + encodeURIComponent(domain) + '&type=A');
    if (dnsResp.ok) {
      const dnsData = await dnsResp.json();
      const aRecord = dnsData.Answer && dnsData.Answer.find(a => a.type === 1);
      if (aRecord && aRecord.data) {
        // Step 2: Geolocate the IP via ipwho.is (free, HTTPS, no key)
        const geoResp = await fetch('https://ipwho.is/' + aRecord.data);
        if (geoResp.ok) {
          const geo = await geoResp.json();
          if (geo.success !== false) {
            if (geo.region) result.state = geo.region;
            if (geo.city) result.city = geo.city;
            if (geo.country && !result.country) result.country = geo.country;
          }
        }
      }
    }
  } catch(e3) {}

  enrichmentCache[domain] = result;
  return result;
}

async function runEnrichment() {
  if (enrichmentRunning) return;
  enrichmentRunning = true;
  const aiCols = columnConfig.filter(c => c.type === 'ai' && c.visible);
  if (aiCols.length === 0) { enrichmentRunning = false; return; }

  const domains = companies.map(c => c.domain).filter(d => !enrichmentCache[d] || !enrichmentCache[d].state);
  if (domains.length === 0) { enrichmentRunning = false; return; }

  // Process in batches of 5
  let changed = false;
  for (let i = 0; i < domains.length; i += 5) {
    const batch = domains.slice(i, i + 5);
    await Promise.all(batch.map(d => enrichDomain(d)));
    changed = true;
    if (i % 15 === 0 && changed) { renderTable(); }
  }
  saveEnrichmentCache();
  if (changed) renderTable();
  enrichmentRunning = false;
}

function getEnrichedValue(domain, enrichKey) {
  const data = enrichmentCache[domain];
  if (!data) return '';
  return data[enrichKey] || '';
}

function getCellValue(company, col) {
  if (col.type === 'builtin') return null; // handled specially in renderTable
  if (col.type === 'ai') {
    // Check manual override first
    if (customColumnData[company.domain] && customColumnData[company.domain][col.id] !== undefined) {
      return customColumnData[company.domain][col.id];
    }
    const preset = AI_COLUMN_PRESETS.find(p => p.id === col.id);
    return preset ? getEnrichedValue(company.domain, preset.enrich) : '';
  }
  if (col.type === 'custom') {
    return (customColumnData[company.domain] && customColumnData[company.domain][col.id]) || '';
  }
  return '';
}

// ──────────────────────────────────────────────
// CONTACT & COMPANY ENRICHMENT (photos, LinkedIn, titles)
// ──────────────────────────────────────────────
let contactEnrichment = {}; // { "email": { photo, title, linkedin, photoFailed } }
let companyLogoFailed = {}; // { "domain": true } — tracks failed logo loads

function loadContactEnrichment() {
  try {
    const raw = localStorage.getItem('kennion_contact_enrich');
    if (raw) contactEnrichment = JSON.parse(raw);
  } catch(e) {}
}

function saveContactEnrichment() {
  localStorage.setItem('kennion_contact_enrich', JSON.stringify(contactEnrichment));
}

// Company logo: Clearbit Logo API (free, no auth)
let logoFailedCache = {};
function loadLogoFailedCache() {
  try { const r = localStorage.getItem('kennion_logo_failed'); if (r) logoFailedCache = JSON.parse(r); } catch(e) {}
}
function saveLogoFailedCache() {
  localStorage.setItem('kennion_logo_failed', JSON.stringify(logoFailedCache));
}
function markLogoFailed(img, domain) {
  img.style.display = 'none';
  logoFailedCache[domain] = true;
  saveLogoFailedCache();
}
function companyLogoHTML(domain, color, name, size) {
  const sz = size || 32;
  const initial = name ? name[0].toUpperCase() : domain[0].toUpperCase();
  if (logoFailedCache[domain]) return initial;
  const imgSrc = 'https://logo.clearbit.com/' + encodeURIComponent(domain);
  return '<img src="' + imgSrc + '" alt="" loading="lazy" onerror="markLogoFailed(this,\'' + domain.replace(/'/g, "\\'") + '\')">' + initial;
}

// Contact photo: unavatar.io (aggregates Gravatar, Google, GitHub, Twitter)
function contactPhotoHTML(email, color, initials, size) {
  const sz = size || 26;
  const enrich = contactEnrichment[email.toLowerCase()];
  // If we know the photo failed, skip the img
  if (enrich && enrich.photoFailed) return esc(initials);
  const imgSrc = 'https://unavatar.io/' + encodeURIComponent(email.toLowerCase()) + '?fallback=false';
  return '<img src="' + imgSrc + '" alt="" loading="lazy" onerror="markPhotoFailed(this,\'' + email.toLowerCase().replace(/'/g, "\\'") + '\')">' + esc(initials);
}

function markPhotoFailed(img, email) {
  img.style.display = 'none';
  if (!contactEnrichment[email]) contactEnrichment[email] = {};
  contactEnrichment[email].photoFailed = true;
  saveContactEnrichment();
}

// LinkedIn search URL generators
function linkedInPersonURL(name, companyName) {
  const q = (name + (companyName ? ' ' + companyName : '')).trim();
  return 'https://www.linkedin.com/search/results/people/?keywords=' + encodeURIComponent(q);
}

function linkedInCompanyURL(domain) {
  // Try company name from domain prefix, or use known match
  const prefix = domain.split('.')[0];
  return 'https://www.linkedin.com/search/results/companies/?keywords=' + encodeURIComponent(prefix);
}

function linkedInIconSVG() {
  return '<svg viewBox="0 0 24 24" fill="#0a66c2"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>';
}

// Get or set contact title
function getContactTitle(email) {
  const e = contactEnrichment[email.toLowerCase()];
  return e && e.title ? e.title : '';
}

function setContactTitle(email, title) {
  if (!contactEnrichment[email.toLowerCase()]) contactEnrichment[email.toLowerCase()] = {};
  contactEnrichment[email.toLowerCase()].title = title;
  saveContactEnrichment();
}

// Get or set contact LinkedIn URL (manual override)
function getContactLinkedIn(email) {
  const e = contactEnrichment[email.toLowerCase()];
  return e && e.linkedin ? e.linkedin : '';
}

function setContactLinkedIn(email, url) {
  if (!contactEnrichment[email.toLowerCase()]) contactEnrichment[email.toLowerCase()] = {};
  contactEnrichment[email.toLowerCase()].linkedin = url;
  saveContactEnrichment();
}

// ──────────────────────────────────────────────
// AI COMPANY RESEARCH AGENT
// ──────────────────────────────────────────────
let companyResearch = {}; // { domain: { description, employees, state, fetchedAt } }

function loadCompanyResearch() {
  try {
    const raw = localStorage.getItem('kennion_company_research');
    if (raw) companyResearch = JSON.parse(raw);
  } catch(e) {}
}

function saveCompanyResearch() {
  localStorage.setItem('kennion_company_research', JSON.stringify(companyResearch));
}

// Extract meta description + title from raw HTML
function parseMetaFromHTML(html) {
  const result = { title: '', description: '' };
  // Meta description
  const metaDesc = html.match(/<meta[^>]*name\s*=\s*["']description["'][^>]*content\s*=\s*["']([^"']{5,})["']/i)
    || html.match(/<meta[^>]*content\s*=\s*["']([^"']{5,})["'][^>]*name\s*=\s*["']description["']/i);
  if (metaDesc) result.description = metaDesc[1].trim();
  // OG description fallback
  if (!result.description) {
    const ogDesc = html.match(/<meta[^>]*property\s*=\s*["']og:description["'][^>]*content\s*=\s*["']([^"']{5,})["']/i)
      || html.match(/<meta[^>]*content\s*=\s*["']([^"']{5,})["'][^>]*property\s*=\s*["']og:description["']/i);
    if (ogDesc) result.description = ogDesc[1].trim();
  }
  // Title
  const titleMatch = html.match(/<title[^>]*>([^<]{2,})<\/title>/i);
  if (titleMatch) result.title = titleMatch[1].trim();
  return result;
}

// Generate a clean 1-2 sentence AI summary from raw research data
function generateCompanySummary(name, domain, rawDesc, rawTitle, enrichData) {
  const state = enrichData.state || '';
  const employees = enrichData.employees || '';
  const industry = enrichData.industry || '';

  // Clean up the raw description — strip marketing fluff, CTAs, trailing fragments
  let cleaned = (rawDesc || '').trim();
  cleaned = cleaned.replace(/\s*[|–—·•]\s*Official Site.*$/i, '');
  cleaned = cleaned.replace(/\s*Learn more.*$/i, '');
  cleaned = cleaned.replace(/\s*Click here.*$/i, '');
  cleaned = cleaned.replace(/\s*Sign up.*$/i, '');
  cleaned = cleaned.replace(/\s*Get started.*$/i, '');
  cleaned = cleaned.replace(/\s*Visit us.*$/i, '');
  cleaned = cleaned.replace(/\s*Contact us.*$/i, '');
  cleaned = cleaned.replace(/\u2026\s*$/, '.');
  cleaned = cleaned.replace(/\.{2,}$/, '.');
  if (cleaned && !cleaned.match(/[.!?]$/)) cleaned += '.';

  // Extract what the company does from the raw description
  let whatTheyDo = '';
  if (cleaned.length > 20) {
    // Take first 1-2 sentences from the cleaned description
    const sentences = cleaned.match(/[^.!?]*[.!?]/g) || [];
    if (sentences.length >= 1) {
      whatTheyDo = sentences.slice(0, 2).join(' ').trim();
      // If it's too long, just take the first sentence
      if (whatTheyDo.length > 200 && sentences[0]) whatTheyDo = sentences[0].trim();
    } else {
      whatTheyDo = cleaned;
    }
  }

  // Build the summary: aim for simple, 8th-grade reading level
  let summary = '';

  if (whatTheyDo) {
    // Check if the description already starts with the company name
    const startsWithName = whatTheyDo.toLowerCase().startsWith(name.toLowerCase());
    if (startsWithName) {
      summary = whatTheyDo;
    } else {
      summary = name + ' ' + lowerFirst(whatTheyDo);
      // If it reads awkwardly (starts with "the", "a", etc.), use "is a company that" bridge
      if (/^[A-Z]/.test(whatTheyDo) && !whatTheyDo.toLowerCase().startsWith('is ') && !whatTheyDo.toLowerCase().startsWith('provides ') && !whatTheyDo.toLowerCase().startsWith('offers ')) {
        summary = name + ' — ' + whatTheyDo;
      }
    }
  } else if (rawTitle && rawTitle.length > 3 && rawTitle.length < 120) {
    // Use page title as last resort
    // Strip "CompanyName |" prefix or "| Home" suffix patterns from page titles
    const nameEsc = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const titleClean = rawTitle
      .replace(/\s*[|–—:]\s*Home.*$/i, '').replace(/\s*[|–—:]\s*Official.*$/i, '')
      .replace(new RegExp('^' + nameEsc + '\\s*[|–—:]\\s*', 'i'), '')
      .replace(new RegExp('\\s*[|–—:]\\s*' + nameEsc + '\\s*$', 'i'), '')
      .trim();
    if (titleClean.length > 3) {
      summary = name + ' — ' + titleClean + '.';
    }
  }

  // If we have enrichment data but no web description, build from what we know
  if (!summary) {
    summary = name + ' is a' + (industry ? ' ' + industry.toLowerCase() : '') + ' company';
    if (state) summary += ' based in ' + state;
    summary += '.';
  }

  // Add location + size as a second sentence if not already mentioned
  const hasState = state && summary.toLowerCase().includes(state.toLowerCase());
  let extra = '';
  if (state && !hasState && employees) {
    extra = 'They are based in ' + state + ' with an estimated ' + employees + ' employees.';
  } else if (state && !hasState) {
    extra = 'They are based in ' + state + '.';
  } else if (employees && !summary.includes(employees)) {
    extra = 'The company has an estimated ' + employees + ' employees.';
  }

  if (extra) summary = summary + ' ' + extra;

  return summary.trim();
}

function lowerFirst(s) {
  if (!s) return s;
  // Don't lowercase acronyms or proper nouns that start sentences
  if (s.length > 1 && s[1] === s[1].toUpperCase()) return s; // e.g. "AI", "IBM"
  return s[0].toLowerCase() + s.slice(1);
}

// Research a company using its actual domain + name
async function researchCompany(domain, forceRefresh) {
  if (!forceRefresh && companyResearch[domain] && companyResearch[domain].summary) {
    return companyResearch[domain];
  }

  const company = companies.find(c => c.domain === domain);
  const companyName = company ? company.name : domain.split('.')[0].charAt(0).toUpperCase() + domain.split('.')[0].slice(1);
  const enrichData = enrichmentCache[domain] || {};

  const research = {
    name: companyName,
    domain: domain,
    summary: '',
    rawDesc: '',
    rawTitle: '',
    employees: enrichData.employees || '',
    state: enrichData.state || '',
    sourceUrl: 'https://' + domain,
    fetchedAt: new Date().toISOString()
  };

  // Step 1: Fetch the company's actual website to get meta description
  try {
    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://' + domain);
    const resp = await fetch(proxyUrl, { signal: AbortSignal.timeout(8000) });
    if (resp.ok) {
      const reader = resp.body.getReader();
      let html = '';
      while (html.length < 50000) {
        const { done, value } = await reader.read();
        if (done) break;
        html += new TextDecoder().decode(value);
      }
      try { reader.cancel(); } catch(e) {}
      const meta = parseMetaFromHTML(html);
      if (meta.description) {
        research.rawDesc = meta.description.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&nbsp;/g,' ');
      }
      if (meta.title) {
        research.rawTitle = meta.title.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"').replace(/&#39;/g,"'");
      }
    }
  } catch(e) {}

  // Step 2: Clearbit autocomplete to verify / refine company name
  try {
    const cbResp = await fetch('https://autocomplete.clearbit.com/v1/companies/suggest?query=' + encodeURIComponent(domain.split('.')[0]));
    if (cbResp.ok) {
      const cbResults = await cbResp.json();
      const match = cbResults.find(r => r.domain === domain) || cbResults.find(r => r.domain && r.domain.split('.')[0] === domain.split('.')[0]);
      if (match && match.name) research.name = match.name;
    }
  } catch(e) {}

  // Step 3: Generate the AI summary from all gathered data
  research.summary = generateCompanySummary(research.name, domain, research.rawDesc, research.rawTitle, enrichData);

  companyResearch[domain] = research;
  saveCompanyResearch();
  return research;
}

// Build the AI research card HTML
function buildResearchCardHTML(research, domain, loading) {
  const refreshIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>';
  const brainIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a7 7 0 017 7c0 2.38-1.19 4.47-3 5.74V17a2 2 0 01-2 2h-4a2 2 0 01-2-2v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 017-7z"/><path d="M9 22h6"/><path d="M10 2v1"/><path d="M14 2v1"/></svg>';

  let html = '<div class="ai-research-card">';
  html += '<div class="ai-research-header">' + brainIcon + '<span class="title">AI Company Research</span>';
  html += '<button class="refresh-btn" onclick="refreshCompanyResearch(\'' + domain.replace(/'/g, "\\'") + '\')" title="Re-research">' + refreshIcon + '</button>';
  html += '</div>';
  html += '<div class="ai-research-body">';

  if (loading) {
    html += '<div class="ai-research-desc loading">Researching ' + esc(research ? research.name : domain) + '...</div>';
  } else if (research) {
    html += '<div class="ai-research-desc">' + esc(research.summary || '') + '</div>';
    html += '<div class="ai-research-grid">';
    if (research.employees) html += '<div class="ai-research-item"><span class="r-label">Employees (est.)</span><span class="r-value">' + esc(research.employees) + '</span></div>';
    if (research.state) html += '<div class="ai-research-item"><span class="r-label">State</span><span class="r-value">' + esc(research.state) + '</span></div>';
    html += '<div class="ai-research-item"><span class="r-label">Website</span><span class="r-value"><a href="https://' + esc(research.domain) + '" target="_blank" style="color:var(--accent);text-decoration:none">' + esc(research.domain) + '</a></span></div>';
    html += '</div>';
    html += '<div class="ai-research-source">Source: <a href="https://' + esc(domain) + '" target="_blank">' + esc(domain) + '</a></div>';
  }

  html += '</div></div>';
  return html;
}

async function refreshCompanyResearch(domain) {
  const el = document.querySelector('.ai-research-card');
  if (el) {
    const company = companies.find(c => c.domain === domain);
    el.outerHTML = buildResearchCardHTML({ name: company ? company.name : domain }, domain, true);
  }
  const research = await researchCompany(domain, true);
  const el2 = document.querySelector('.ai-research-card');
  if (el2) el2.outerHTML = buildResearchCardHTML(research, domain, false);
}

// ──────────────────────────────────────────────
// COLUMN MANAGEMENT UI
// ──────────────────────────────────────────────
function toggleColumnManager() {
  const drop = document.getElementById('colMgrDrop');
  const isOpen = drop.classList.contains('open');
  drop.classList.toggle('open');
  if (!isOpen) renderColumnManager();
}

function renderColumnManager() {
  const drop = document.getElementById('colMgrDrop');
  let html = '<div class="col-mgr-section">Built-in Columns</div>';
  for (const col of columnConfig) {
    if (col.type === 'builtin') {
      const meta = BUILTIN_COLUMNS.find(b => b.id === col.id);
      const disabled = meta && !meta.removable ? ' disabled' : '';
      html += '<div class="col-mgr-item">' +
        '<input type="checkbox"' + (col.visible ? ' checked' : '') + disabled + ' onchange="toggleColumn(\'' + col.id + '\',this.checked)">' +
        '<span class="col-label" ondblclick="startRenameColumn(\'' + col.id + '\',this)">' + esc(col.label) + '</span>' +
      '</div>';
    }
  }

  const customCols = columnConfig.filter(c => c.type === 'ai' || c.type === 'custom');
  if (customCols.length > 0) {
    html += '<div class="col-mgr-section">Custom Columns</div>';
    for (const col of customCols) {
      html += '<div class="col-mgr-item">' +
        '<input type="checkbox"' + (col.visible ? ' checked' : '') + ' onchange="toggleColumn(\'' + col.id + '\',this.checked)">' +
        '<span class="col-label" ondblclick="startRenameColumn(\'' + col.id + '\',this)">' + esc(col.label) + '</span>' +
        '<span class="col-remove" onclick="removeColumn(\'' + col.id + '\')" title="Remove">&times;</span>' +
      '</div>';
    }
  }

  // AI preset chips
  const usedIds = new Set(columnConfig.map(c => c.id));
  const available = AI_COLUMN_PRESETS.filter(p => !usedIds.has(p.id));
  if (available.length > 0) {
    html += '<div class="col-mgr-section">Add AI Column</div>';
    html += '<div class="col-mgr-presets">';
    for (const p of available) {
      html += '<span class="col-preset-chip" onclick="addAIColumn(\'' + p.id + '\')">' + esc(p.label) + '</span>';
    }
    html += '</div>';
  }

  // Add blank custom column
  html += '<button class="col-mgr-add" onclick="addCustomColumn()">' +
    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>' +
    'Add custom column</button>';

  drop.innerHTML = html;
}

function toggleColumn(id, visible) {
  const col = columnConfig.find(c => c.id === id);
  if (col) { col.visible = visible; saveColumnConfig(); renderTableHeader(); renderTable(); }
}

function removeColumn(id) {
  columnConfig = columnConfig.filter(c => c.id !== id);
  // Clean up custom data for this column
  for (const domain of Object.keys(customColumnData)) {
    delete customColumnData[domain][id];
  }
  saveColumnConfig(); saveCustomColumnData();
  renderColumnManager(); renderTableHeader(); renderTable();
}

function addAIColumn(presetId) {
  const preset = AI_COLUMN_PRESETS.find(p => p.id === presetId);
  if (!preset) return;
  columnConfig.push({ id: preset.id, label: preset.label, type: 'ai', visible: true, enrich: preset.enrich });
  saveColumnConfig(); renderColumnManager(); renderTableHeader(); renderTable();
  // Start enrichment for this column
  runEnrichment();
}

function addCustomColumn() {
  const name = prompt('Column name:');
  if (!name || !name.trim()) return;
  const id = 'custom_' + Date.now();
  columnConfig.push({ id: id, label: name.trim(), type: 'custom', visible: true });
  saveColumnConfig(); renderColumnManager(); renderTableHeader(); renderTable();
}

function startRenameColumn(id, el) {
  const col = columnConfig.find(c => c.id === id);
  if (!col) return;
  const oldLabel = col.label;
  el.innerHTML = '<input class="col-rename-input" value="' + esc(oldLabel) + '">';
  const input = el.querySelector('input');
  input.focus();
  input.select();
  input.onblur = function() { finishRename(id, input.value, el); };
  input.onkeydown = function(e) {
    if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
    if (e.key === 'Escape') { el.textContent = oldLabel; }
  };
}

function finishRename(id, newLabel, el) {
  const col = columnConfig.find(c => c.id === id);
  if (col && newLabel.trim()) {
    col.label = newLabel.trim();
    saveColumnConfig();
    renderTableHeader();
  }
  el.textContent = col ? col.label : newLabel;
}

// Close column manager on outside click
document.addEventListener('click', function(e) {
  const drop = document.getElementById('colMgrDrop');
  if (drop && drop.classList.contains('open') && !e.target.closest('.col-mgr-wrap')) {
    drop.classList.remove('open');
  }
});

// ──────────────────────────────────────────────
// STARRED / PRIMARY CONTACTS PERSISTENCE
// ──────────────────────────────────────────────
function loadStarredContacts() {
  try {
    const raw = localStorage.getItem('relateflow_starred_contacts');
    starredContacts = raw ? JSON.parse(raw) : {};
  } catch(e) { starredContacts = {}; }
}

function saveStarredContacts() {
  localStorage.setItem('relateflow_starred_contacts', JSON.stringify(starredContacts));
}

function getPrimaryContact(domain, contacts) {
  // If user has starred someone, use that
  if (starredContacts[domain]) {
    const starred = contacts.find(c => c.email === starredContacts[domain]);
    if (starred) return starred;
  }
  // Default: most interactions (already sorted by buildCompaniesFromDomainMap)
  return contacts[0];
}

// ──────────────────────────────────────────────
// BLOCKED DOMAINS PERSISTENCE (localStorage)
// ──────────────────────────────────────────────
function loadBlockedDomains() {
  try {
    const raw = localStorage.getItem('relateflow_blocked_domains');
    blockedDomains = raw ? new Set(JSON.parse(raw)) : new Set();
  } catch(e) { blockedDomains = new Set(); }
}

function saveBlockedDomains() {
  localStorage.setItem('relateflow_blocked_domains', JSON.stringify([...blockedDomains]));
}

function isBlockedDomain(domain) {
  return SKIP_DOMAINS.has(domain) || blockedDomains.has(domain);
}

// ──────────────────────────────────────────────
// SMART NAME FORMATTING
// ──────────────────────────────────────────────
const NAME_SMALL_WORDS = new Set(['a','an','the','and','but','or','for','nor','at','by','in','of','on','to','up','as','is','it']);

function titleCase(str) {
  if (!str) return '';
  return str.replace(/\w\S*/g, (word, index) => {
    if (index > 0 && NAME_SMALL_WORDS.has(word.toLowerCase())) return word.toLowerCase();
    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
  });
}

function formatContactName(rawName, email) {
  if (!rawName || rawName === email || rawName === email?.toLowerCase()) {
    // No real name — try to extract from email prefix
    if (!email) return 'Unknown';
    const prefix = email.split('@')[0];
    // Handle john.doe, john_doe, john-doe patterns
    const parts = prefix.split(/[._\-+]+/).filter(Boolean);
    if (parts.length >= 2 && parts.every(p => /^[a-z]+$/i.test(p))) {
      return parts.map(p => p.charAt(0).toUpperCase() + p.slice(1).toLowerCase()).join(' ');
    }
    return titleCase(prefix);
  }

  let name = rawName.trim();
  // Strip surrounding quotes
  name = name.replace(/^["']|["']$/g, '').trim();
  // Handle "Last, First" format
  if (/^[^,]+,\s*[^,]+$/.test(name)) {
    const [last, first] = name.split(',').map(s => s.trim());
    name = first + ' ' + last;
  }
  // If all uppercase or all lowercase, apply title case
  if (name === name.toUpperCase() || name === name.toLowerCase()) {
    name = titleCase(name);
  }
  // Handle mixed: only fix if first letter of each word is lowercase
  const words = name.split(/\s+/);
  name = words.map(w => {
    if (w.length <= 1) return w.toUpperCase();
    // Preserve intentional casing like "McDonald", "O'Brien", "MacLeod"
    if (/^(Mc|Mac|O')[A-Z]/.test(w)) return w;
    // If word is all-caps (initials like "CEO", "Jr", "III"), keep it
    if (w === w.toUpperCase() && w.length <= 4) return w;
    // If first char is lowercase, fix it
    if (w[0] === w[0].toLowerCase() && w[0] !== w[0].toUpperCase()) {
      return w.charAt(0).toUpperCase() + w.slice(1);
    }
    return w;
  }).join(' ');

  return name;
}

// ──────────────────────────────────────────────
// COMPANY NAME LOOKUP (Clearbit Autocomplete API)
// ──────────────────────────────────────────────
const companyNameCache = {};
let companyNameCacheDirty = false;

function loadCompanyNameCache() {
  try {
    const raw = localStorage.getItem('relateflow_company_names');
    if (raw) Object.assign(companyNameCache, JSON.parse(raw));
  } catch(e) {}
}

function saveCompanyNameCache() {
  if (!companyNameCacheDirty) return;
  try {
    localStorage.setItem('relateflow_company_names', JSON.stringify(companyNameCache));
    companyNameCacheDirty = false;
  } catch(e) {}
}

// Known brand corrections for common domains
const KNOWN_BRANDS = {
  'github.com':'GitHub','linkedin.com':'LinkedIn','youtube.com':'YouTube',
  'stackoverflow.com':'Stack Overflow','wordpress.com':'WordPress','javascript.com':'JavaScript',
  'salesforce.com':'Salesforce','hubspot.com':'HubSpot','mailchimp.com':'Mailchimp',
  'shopify.com':'Shopify','atlassian.com':'Atlassian','bitbucket.org':'Bitbucket',
  'microsoft.com':'Microsoft','apple.com':'Apple','amazon.com':'Amazon',
  'google.com':'Google','facebook.com':'Meta','twitter.com':'X (Twitter)',
  'netflix.com':'Netflix','uber.com':'Uber','airbnb.com':'Airbnb',
  'stripe.com':'Stripe','twilio.com':'Twilio','figma.com':'Figma',
  'notion.so':'Notion','slack.com':'Slack','zoom.us':'Zoom',
  'dropbox.com':'Dropbox','asana.com':'Asana','trello.com':'Trello',
  'intercom.io':'Intercom','zendesk.com':'Zendesk','freshdesk.com':'Freshdesk',
  'squarespace.com':'Squarespace','wix.com':'Wix','godaddy.com':'GoDaddy',
  'cloudflare.com':'Cloudflare','digitalocean.com':'DigitalOcean',
  'mongodb.com':'MongoDB','postgresql.org':'PostgreSQL','oracle.com':'Oracle',
  'ibm.com':'IBM','dell.com':'Dell','hp.com':'HP','intel.com':'Intel',
  'nvidia.com':'NVIDIA','amd.com':'AMD','cisco.com':'Cisco',
  'vmware.com':'VMware','redhat.com':'Red Hat','canonical.com':'Canonical',
  'paypal.com':'PayPal','jpmorgan.com':'JPMorgan','goldmansachs.com':'Goldman Sachs',
  'deloitte.com':'Deloitte','mckinsey.com':'McKinsey','bcg.com':'BCG',
  'pwc.com':'PwC','ey.com':'Ernst & Young','kpmg.com':'KPMG',
};

async function lookupCompanyName(domain) {
  // 1. Check cache
  if (companyNameCache[domain]) return companyNameCache[domain];
  // 2. Check known brands
  if (KNOWN_BRANDS[domain]) {
    companyNameCache[domain] = KNOWN_BRANDS[domain];
    companyNameCacheDirty = true;
    return KNOWN_BRANDS[domain];
  }
  // 3. Try Clearbit autocomplete API (free, no auth)
  try {
    const query = domain.split('.')[0];
    const resp = await fetch('https://autocomplete.clearbit.com/v1/companies/suggest?query=' + encodeURIComponent(query));
    if (resp.ok) {
      const results = await resp.json();
      // Find exact domain match
      const match = results.find(r => r.domain === domain);
      if (match && match.name) {
        companyNameCache[domain] = match.name;
        companyNameCacheDirty = true;
        return match.name;
      }
      // Fuzzy: if domain prefix matches closely
      const fuzzy = results.find(r => r.domain && r.domain.split('.')[0] === domain.split('.')[0]);
      if (fuzzy && fuzzy.name) {
        companyNameCache[domain] = fuzzy.name;
        companyNameCacheDirty = true;
        return fuzzy.name;
      }
    }
  } catch(e) { /* API unavailable — fall through to smart formatting */ }
  // 4. Fallback: smart title case from domain prefix
  const prefix = domain.split('.')[0];
  const formatted = titleCase(prefix.replace(/[-_]/g, ' '));
  companyNameCache[domain] = formatted;
  companyNameCacheDirty = true;
  return formatted;
}

// ──────────────────────────────────────────────
// INDEXEDDB PERSISTENCE
// ──────────────────────────────────────────────
const DB_NAME = 'relateflow';
const DB_VERSION = 1;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('domainData')) db.createObjectStore('domainData', { keyPath: 'domain' });
      if (!db.objectStoreNames.contains('meta')) db.createObjectStore('meta', { keyPath: 'key' });
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function persistData() {
  try {
    const db = await openDB();
    const tx = db.transaction(['domainData', 'meta'], 'readwrite');
    const domainStore = tx.objectStore('domainData');
    const metaStore = tx.objectStore('meta');
    domainStore.clear();
    for (const [domain, data] of Object.entries(domainMap)) {
      const rec = { domain, contacts: {}, sentIds: Array.from(data.sentIds), receivedIds: Array.from(data.receivedIds), lastDate: data.lastDate ? data.lastDate.toISOString() : null, lastSentDate: data.lastSentDate ? data.lastSentDate.toISOString() : null, lastReceivedDate: data.lastReceivedDate ? data.lastReceivedDate.toISOString() : null };
      for (const [email, c] of Object.entries(data.contacts)) {
        rec.contacts[email] = { name: c.name, email: c.email, sentIds: Array.from(c.sentIds), receivedIds: Array.from(c.receivedIds), lastDate: c.lastDate ? c.lastDate.toISOString() : null };
      }
      domainStore.put(rec);
    }
    metaStore.put({ key: 'lastScanTime', value: lastScanTime ? lastScanTime.toISOString() : null });
    metaStore.put({ key: 'userEmail', value: userEmail });
    metaStore.put({ key: 'fullScanDone', value: fullScanDone });
    metaStore.put({ key: 'seenMsgIds', value: Array.from(seenMsgIds) });
    metaStore.put({ key: 'deltaLink', value: deltaLink });
    await new Promise((res, rej) => { tx.oncomplete = res; tx.onerror = () => rej(tx.error); });
  } catch(e) { console.warn('Persist failed:', e); }
}

async function loadPersistedData() {
  try {
    const db = await openDB();
    const tx = db.transaction(['domainData', 'meta'], 'readonly');
    const ds = tx.objectStore('domainData');
    const ms = tx.objectStore('meta');
    const [domains, scanRec, emailRec, fullScanRec, seenRec, deltaRec] = await Promise.all([
      new Promise((r, j) => { const q = ds.getAll(); q.onsuccess = () => r(q.result); q.onerror = j; }),
      new Promise((r, j) => { const q = ms.get('lastScanTime'); q.onsuccess = () => r(q.result); q.onerror = j; }),
      new Promise((r, j) => { const q = ms.get('userEmail'); q.onsuccess = () => r(q.result); q.onerror = j; }),
      new Promise((r, j) => { const q = ms.get('fullScanDone'); q.onsuccess = () => r(q.result); q.onerror = j; }),
      new Promise((r, j) => { const q = ms.get('seenMsgIds'); q.onsuccess = () => r(q.result); q.onerror = j; }),
      new Promise((r, j) => { const q = ms.get('deltaLink'); q.onsuccess = () => r(q.result); q.onerror = j; }),
    ]);
    if (!domains || domains.length === 0) return null;
    if (emailRec?.value && emailRec.value !== userEmail) return null;
    const map = {};
    for (const d of domains) {
      const key = d.domain.toLowerCase();
      if (!map[key]) {
        map[key] = { contacts: {}, sentIds: new Set(), receivedIds: new Set(), lastDate: null, lastSentDate: null, lastReceivedDate: null };
      }
      const entry = map[key];
      // Restore Sets from arrays (new format) or rebuild from old counter format
      const dSentIds = Array.isArray(d.sentIds) ? d.sentIds : [];
      const dRecvIds = Array.isArray(d.receivedIds) ? d.receivedIds : [];
      for (const id of dSentIds) entry.sentIds.add(id);
      for (const id of dRecvIds) entry.receivedIds.add(id);
      if (d.lastDate) {
        const dt = new Date(d.lastDate);
        if (!entry.lastDate || dt > entry.lastDate) entry.lastDate = dt;
      }
      if (d.lastSentDate) {
        const sd = new Date(d.lastSentDate);
        if (!entry.lastSentDate || sd > entry.lastSentDate) entry.lastSentDate = sd;
      }
      if (d.lastReceivedDate) {
        const rd = new Date(d.lastReceivedDate);
        if (!entry.lastReceivedDate || rd > entry.lastReceivedDate) entry.lastReceivedDate = rd;
      }
      for (const [email, c] of Object.entries(d.contacts)) {
        const le = email.toLowerCase();
        if (!entry.contacts[le]) {
          const cSentIds = Array.isArray(c.sentIds) ? c.sentIds : [];
          const cRecvIds = Array.isArray(c.receivedIds) ? c.receivedIds : [];
          entry.contacts[le] = { name: c.name, email: le, sentIds: new Set(cSentIds), receivedIds: new Set(cRecvIds), lastDate: c.lastDate ? new Date(c.lastDate) : null };
        } else {
          const cSentIds = Array.isArray(c.sentIds) ? c.sentIds : [];
          const cRecvIds = Array.isArray(c.receivedIds) ? c.receivedIds : [];
          for (const id of cSentIds) entry.contacts[le].sentIds.add(id);
          for (const id of cRecvIds) entry.contacts[le].receivedIds.add(id);
          if (c.lastDate) {
            const cdt = new Date(c.lastDate);
            if (!entry.contacts[le].lastDate || cdt > entry.contacts[le].lastDate) entry.contacts[le].lastDate = cdt;
          }
        }
      }
    }
    const restoredSeenIds = seenRec?.value ? new Set(seenRec.value) : new Set();
    const restoredDeltaLink = deltaRec?.value || null;
    return { domainMap: map, lastScanTime: scanRec?.value ? new Date(scanRec.value) : null, fullScanDone: !!fullScanRec?.value, seenMsgIds: restoredSeenIds, deltaLink: restoredDeltaLink };
  } catch(e) { console.warn('Load failed:', e); return null; }
}

async function clearPersistedData() {
  try {
    const db = await openDB();
    const tx = db.transaction(['domainData', 'meta'], 'readwrite');
    tx.objectStore('domainData').clear();
    tx.objectStore('meta').clear();
    await new Promise(r => { tx.oncomplete = r; });
  } catch(e) { console.warn('Clear failed:', e); }
}

// ──────────────────────────────────────────────
// MSAL SETUP
// ──────────────────────────────────────────────
const MSAL_CDN_URLS = [
  'https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js',
  'https://unpkg.com/@azure/msal-browser@2.38.3/lib/msal-browser.min.js',
  'https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js'
];

function loadScript(url) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = url;
    s.onload = resolve;
    s.onerror = () => reject(new Error('Failed to load: ' + url));
    document.head.appendChild(s);
  });
}

async function ensureMSALLoaded() {
  if (typeof msal !== 'undefined') return true;
  for (const url of MSAL_CDN_URLS) {
    try {
      await loadScript(url);
      if (typeof msal !== 'undefined') return true;
    } catch(e) {
      console.warn(e.message);
    }
  }
  return false;
}

function getClientId() {
  return localStorage.getItem('relateflow_client_id') || '';
}

async function initMSAL() {
  const clientId = getClientId();
  if (!clientId) return null;

  const loaded = await ensureMSALLoaded();
  if (!loaded) {
    alert('Could not load the Microsoft authentication library. Please check your internet connection or try disabling ad-blockers, then refresh the page.');
    return null;
  }

  const config = {
    auth: {
      clientId: clientId,
      authority: 'https://login.microsoftonline.com/common',
      redirectUri: window.location.origin + window.location.pathname,
    },
    cache: {
      cacheLocation: 'localStorage',
      storeAuthStateInCookie: false,
    }
  };
  try {
    msalInstance = new msal.PublicClientApplication(config);
    if (typeof msalInstance.initialize === 'function') {
      await msalInstance.initialize();
    }
    try { await msalInstance.handleRedirectPromise(); } catch(e) { console.warn('Redirect handle:', e); }
    return msalInstance;
  } catch(e) {
    console.error('MSAL init error:', e);
    alert('MSAL initialization failed: ' + e.message);
    msalInstance = null;
    return null;
  }
}

async function signIn() {
  if (!getClientId()) {
    openSettings();
    return;
  }
  if (!msalInstance) await initMSAL();
  if (!msalInstance) { alert('Could not initialize Microsoft authentication. Check your Client ID.'); openSettings(); return; }

  try {
    const resp = await msalInstance.loginPopup({
      scopes: ['Mail.Read','Mail.Send','User.Read'],
      prompt: 'select_account'
    });
    currentAccount = resp.account;
    userEmail = currentAccount.username;
    onSignedIn();
  } catch(e) {
    console.error('Sign-in error:', e);
    if (e.errorCode === 'user_cancelled') return;
    // If popup blocked, try redirect
    if (e.errorCode === 'popup_window_error' || e.errorCode === 'empty_window_error') {
      alert('Popup was blocked by your browser. Trying redirect login instead...');
      msalInstance.loginRedirect({ scopes: ['Mail.Read','Mail.Send','User.Read'] });
      return;
    }
    alert('Sign-in failed: ' + (e.errorCode || '') + ' — ' + (e.message || e));
  }
}

function signOut() {
  if (msalInstance && currentAccount) {
    msalInstance.logoutPopup({ account: currentAccount });
  }
  currentAccount = null;
  userEmail = '';
  companies = [];
  domainMap = {};
  seenMsgIds = new Set();
  deltaLink = null;
  lastScanTime = null;
  fullScanDone = false;
  isScanning = false;
  stopAutoSync();
  document.getElementById('accountBar').style.display = 'none';
  showWelcome();
}

async function getAccessToken() {
  if (!msalInstance || !currentAccount) throw new Error('Not signed in');
  try {
    const resp = await msalInstance.acquireTokenSilent({
      scopes: ['Mail.Read','Mail.Send','User.Read'],
      account: currentAccount
    });
    return resp.accessToken;
  } catch(e) {
    const resp = await msalInstance.acquireTokenPopup({
      scopes: ['Mail.Read','Mail.Send','User.Read']
    });
    currentAccount = resp.account;
    return resp.accessToken;
  }
}

// Build Graph API headers with Immutable IDs to prevent ID drift on email moves
function graphHeaders(token) {
  return { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json', 'Prefer': 'IdType="ImmutableId"' };
}

// ──────────────────────────────────────────────
// DOMAIN MAP HELPERS
// ──────────────────────────────────────────────
function getDomain(email) {
  if (!email) return null;
  const d = email.split('@')[1];
  return d ? d.toLowerCase() : null;
}

function ensureDomain(domain) {
  if (!domainMap[domain]) {
    domainMap[domain] = { contacts: {}, sentIds: new Set(), receivedIds: new Set(), lastDate: null, lastSentDate: null, lastReceivedDate: null };
  }
}

function ensureContact(domain, email, name) {
  ensureDomain(domain);
  const le = email.toLowerCase();
  const formatted = formatContactName(name, le);
  if (!domainMap[domain].contacts[le]) {
    domainMap[domain].contacts[le] = { name: formatted, email: le, sentIds: new Set(), receivedIds: new Set(), lastDate: null };
  } else {
    const existing = domainMap[domain].contacts[le].name;
    // Upgrade name if current one is just the email or worse quality
    if (existing === le || existing === email || (name && name !== email && existing === formatContactName(null, le))) {
      domainMap[domain].contacts[le].name = formatted;
    }
  }
}

function updateDate(obj, dateStr) {
  if (!dateStr) return;
  const d = new Date(dateStr);
  if (!obj.lastDate || d > obj.lastDate) obj.lastDate = d;
}

function updateDateField(obj, field, dateStr) {
  if (!dateStr) return;
  const d = new Date(dateStr);
  if (!obj[field] || d > obj[field]) obj[field] = d;
}

// ──────────────────────────────────────────────
// PROCESS EMAIL BATCH → UPDATE DOMAIN MAP
// ──────────────────────────────────────────────
function processEmailBatch(messages) {
  const myEmailLower = userEmail ? userEmail.toLowerCase() : '';
  const myDomain = userEmail ? getDomain(userEmail) : null;

  for (const msg of messages) {
    // Skip already-processed messages to prevent double-counting
    if (msg.id && seenMsgIds.has(msg.id)) continue;
    if (msg.id) seenMsgIds.add(msg.id);

    const fromEmail = msg.from?.emailAddress?.address?.toLowerCase() || '';
    const isSent = (fromEmail === myEmailLower);

    if (isSent) {
      // SENT email — add msg.id to Sets (duplicates are impossible)
      const recipients = [...(msg.toRecipients || []), ...(msg.ccRecipients || [])];
      for (const r of recipients) {
        const toEmail = r.emailAddress?.address;
        const toName = r.emailAddress?.name;
        if (!toEmail) continue;
        const domain = getDomain(toEmail);
        if (!domain || isBlockedDomain(domain) || domain === myDomain) continue;
        ensureContact(domain, toEmail, toName);
        const le = toEmail.toLowerCase();
        domainMap[domain].contacts[le].sentIds.add(msg.id);
        domainMap[domain].sentIds.add(msg.id);
        const sentDt = msg.sentDateTime || msg.receivedDateTime;
        updateDate(domainMap[domain], sentDt);
        updateDate(domainMap[domain].contacts[le], sentDt);
        updateDateField(domainMap[domain], 'lastSentDate', sentDt);
      }
    } else {
      // RECEIVED email — add msg.id to Sets
      const senderEmail = msg.from?.emailAddress?.address;
      const senderName = msg.from?.emailAddress?.name;
      if (!senderEmail) continue;
      const domain = getDomain(senderEmail);
      if (!domain || isBlockedDomain(domain) || domain === myDomain) continue;
      ensureContact(domain, senderEmail, senderName);
      const le = senderEmail.toLowerCase();
      domainMap[domain].contacts[le].receivedIds.add(msg.id);
      domainMap[domain].receivedIds.add(msg.id);
      updateDate(domainMap[domain], msg.receivedDateTime);
      updateDate(domainMap[domain].contacts[le], msg.receivedDateTime);
      updateDateField(domainMap[domain], 'lastReceivedDate', msg.receivedDateTime);
    }
  }
}

// Handle @removed items from delta sync — delete email ID from all Sets
function processRemovedEmail(msgId) {
  if (!msgId) return;
  seenMsgIds.delete(msgId);
  for (const data of Object.values(domainMap)) {
    data.sentIds.delete(msgId);
    data.receivedIds.delete(msgId);
    for (const ct of Object.values(data.contacts)) {
      ct.sentIds.delete(msgId);
      ct.receivedIds.delete(msgId);
    }
  }
}

// ──────────────────────────────────────────────
// BUILD COMPANIES FROM DOMAIN MAP
// (Selective contact creation — like Attio, only
//  domains you've actively emailed become records.
//  Spam, newsletters, and cold inbound are filtered.)
// ──────────────────────────────────────────────
function buildCompaniesFromDomainMap() {
  // Deduplicate domainMap keys by lowercase (merge any case-variant entries)
  const keys = Object.keys(domainMap);
  const seen = {};
  for (const k of keys) {
    const lk = k.toLowerCase();
    if (lk !== k) {
      // Merge into lowercase key
      if (!domainMap[lk]) { domainMap[lk] = domainMap[k]; }
      else {
        for (const id of domainMap[k].sentIds) domainMap[lk].sentIds.add(id);
        for (const id of domainMap[k].receivedIds) domainMap[lk].receivedIds.add(id);
        if (domainMap[k].lastDate && (!domainMap[lk].lastDate || domainMap[k].lastDate > domainMap[lk].lastDate)) domainMap[lk].lastDate = domainMap[k].lastDate;
        if (domainMap[k].lastSentDate && (!domainMap[lk].lastSentDate || domainMap[k].lastSentDate > domainMap[lk].lastSentDate)) domainMap[lk].lastSentDate = domainMap[k].lastSentDate;
        if (domainMap[k].lastReceivedDate && (!domainMap[lk].lastReceivedDate || domainMap[k].lastReceivedDate > domainMap[lk].lastReceivedDate)) domainMap[lk].lastReceivedDate = domainMap[k].lastReceivedDate;
        for (const [e, c] of Object.entries(domainMap[k].contacts)) {
          const le = e.toLowerCase();
          if (!domainMap[lk].contacts[le]) domainMap[lk].contacts[le] = c;
          else { for (const id of c.sentIds) domainMap[lk].contacts[le].sentIds.add(id); for (const id of c.receivedIds) domainMap[lk].contacts[le].receivedIds.add(id); }
        }
      }
      delete domainMap[k];
    }
  }

  companies = [];
  let id = 1;
  for (const [domain, data] of Object.entries(domainMap)) {
    // Skip blocked domains (including ones blocked after initial scan)
    if (isBlockedDomain(domain)) continue;

    const contactArr = Object.values(data.contacts);
    if (contactArr.length === 0) continue;

    // Derive counts from Sets — guaranteed accurate, duplicate-proof
    const domainSent = data.sentIds.size;
    const domainReceived = data.receivedIds.size;
    for (const ct of contactArr) { ct.sent = ct.sentIds.size; ct.received = ct.receivedIds.size; }

    // SELECTIVE: only create company if user has sent at least 1 email to this domain
    if (domainSent === 0) continue;

    contactArr.sort((a, b) => (b.sent + b.received) - (a.sent + a.received));
    const primary = getPrimaryContact(domain, contactArr);
    const totalEmails = domainSent + domainReceived;

    // ── AI SEGMENT SCORING ──
    // Combines email volume, recency, two-way engagement, and frequency
    const now = Date.now();
    const DAY = 86400000;
    const lastAny = data.lastDate ? data.lastDate.getTime() : 0;
    const lastSent = data.lastSentDate ? data.lastSentDate.getTime() : 0;
    const lastRecv = data.lastReceivedDate ? data.lastReceivedDate.getTime() : 0;
    const daysSinceAny = lastAny ? (now - lastAny) / DAY : 9999;
    const daysSinceSent = lastSent ? (now - lastSent) / DAY : 9999;
    const daysSinceRecv = lastRecv ? (now - lastRecv) / DAY : 9999;
    const hasTwoWay = domainSent > 0 && domainReceived > 0;

    let score = Math.min(99, Math.round(
      // Volume (up to 35 pts)
      Math.min(totalEmails * 1.2, 35) +
      // Two-way engagement (up to 20 pts)
      (hasTwoWay ? 12 + Math.min(Math.min(domainSent, domainReceived) * 2, 8) : 0) +
      // Recency (up to 25 pts)
      (daysSinceAny < 7 ? 25 : daysSinceAny < 30 ? 18 : daysSinceAny < 90 ? 10 : daysSinceAny < 180 ? 5 : 0) +
      // Contact diversity (up to 10 pts)
      Math.min(contactArr.length * 3, 10) +
      // Reply ratio bonus (up to 9 pts) — strong back-and-forth signals real engagement
      (hasTwoWay ? Math.min(Math.round(Math.min(domainReceived / domainSent, 1) * 9), 9) : 0)
    ));

    // ── AI STATUS DETERMINATION ──
    // Hot: Active two-way conversation, recent activity (last 30 days)
    // Warm: Two-way activity in last 90-180 days, some engagement
    // Cold: No inbound in 365+ days, or outbound-only with no replies
    let status = 'Cold';
    if (hasTwoWay && daysSinceRecv <= 30 && daysSinceAny <= 30) {
      // Two-way interaction with received email in last 30 days = Hot
      status = 'Hot';
    } else if (hasTwoWay && daysSinceRecv <= 180) {
      // Two-way interaction with received email in last 180 days = Warm
      status = 'Warm';
    }
    // Everything else stays Cold: outbound-only, no replies, or stale > 180 days

    // Use cached company name or smart fallback (async lookup happens separately)
    const companyName = companyNameCache[domain]
      || KNOWN_BRANDS[domain]
      || titleCase(domain.split('.')[0].replace(/[-_]/g, ' '));

    companies.push({
      id: id++,
      name: companyName,
      domain: domain,
      contact: primary.name,
      contactEmail: primary.email,
      sent: domainSent,
      received: domainReceived,
      status: status,
      score: score,
      lastDate: data.lastDate,
      lastActivity: data.lastDate ? timeAgo(data.lastDate) : 'unknown',
      allContacts: contactArr,
    });
  }

  companies.sort((a, b) => (b.sent + b.received) - (a.sent + a.received));
  companies.forEach((c, i) => c.id = i + 1);
}

// Async: look up real company names for any domains not yet in cache
let nameLookupsRunning = false;
async function resolveCompanyNames() {
  if (nameLookupsRunning) return;
  nameLookupsRunning = true;
  try {
    const uncached = companies.filter(c => !companyNameCache[c.domain]).map(c => c.domain);
    if (uncached.length === 0) return;

    // Batch lookups, 5 at a time to avoid rate limits
    for (let i = 0; i < uncached.length; i += 5) {
      const batch = uncached.slice(i, i + 5);
      await Promise.all(batch.map(d => lookupCompanyName(d)));

      // Update company names in-place and re-render
      let changed = false;
      for (const c of companies) {
        if (companyNameCache[c.domain] && c.name !== companyNameCache[c.domain]) {
          c.name = companyNameCache[c.domain];
          changed = true;
        }
      }
      if (changed) renderTable();
    }
    saveCompanyNameCache();
  } catch(e) {
    console.warn('Company name lookup error:', e);
  } finally {
    nameLookupsRunning = false;
  }
}

// ──────────────────────────────────────────────
// PROGRESSIVE EMAIL FETCH + PROCESS + RENDER
// (Data populates in the table as emails are scanned)
// ──────────────────────────────────────────────
async function fetchEmailsProgressively(token, useDelta) {
  const headers = graphHeaders(token);
  const DELTA_SELECT = '$select=id,subject,from,toRecipients,ccRecipients,receivedDateTime,sentDateTime';

  // Delta sync: use saved deltaLink for incremental, or start fresh
  let url;
  if (useDelta && deltaLink) {
    // Incremental: resume from where we left off — only changes since last sync
    url = deltaLink;
  } else {
    // Initial full delta scan — fetches all messages then gives us a deltaLink
    url = 'https://graph.microsoft.com/v1.0/me/messages/delta?$top=200&' + DELTA_SELECT;
    deltaLink = null; // clear stale link
  }

  let page = 0;
  let totalFetched = 0;
  let totalRemoved = 0;
  const isIncremental = useDelta && !!deltaLink;

  while (url) {
    page++;
    updateScanBanner('Scanning' + (isIncremental ? ' changes' : ' all mail') + '... (' + totalFetched.toLocaleString() + ' emails, page ' + page + ')');

    // Fetch with 30s timeout to prevent hanging forever
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 30000);
    let resp;
    try {
      resp = await fetch(url, { headers, signal: controller.signal });
    } catch(e) {
      clearTimeout(timeout);
      if (e.name === 'AbortError') throw new Error('Request timed out — please try again');
      throw e;
    }
    clearTimeout(timeout);

    if (!resp.ok) {
      // If delta token expired/invalid (410 Gone or 404), reset and do full sync
      if ((resp.status === 410 || resp.status === 404) && useDelta) {
        console.warn('Delta token expired (' + resp.status + '), resetting to full sync');
        deltaLink = null;
        url = 'https://graph.microsoft.com/v1.0/me/messages/delta?$top=200&' + DELTA_SELECT;
        continue;
      }
      const err = await resp.text();
      throw new Error('Graph API error: ' + resp.status + ' — ' + err);
    }
    const data = await resp.json();

    if (data.value && data.value.length > 0) {
      // Separate removed items from regular messages
      const regular = [];
      for (const item of data.value) {
        if (item['@removed']) {
          processRemovedEmail(item.id);
          totalRemoved++;
        } else {
          regular.push(item);
        }
      }

      if (regular.length > 0) {
        totalFetched += regular.length;
        processEmailBatch(regular);
      }

      // Throttle UI: only rebuild table every 5 pages (heavy DOM work)
      if (page === 1 || page % 5 === 0) {
        buildCompaniesFromDomainMap();
        renderTable();
        updateStats();
      }
      updateScanBanner('Scanning... ' + totalFetched.toLocaleString() + ' emails' + (totalRemoved > 0 ? ', ' + totalRemoved + ' removed' : '') + ' — ' + companies.length + ' companies');

      // Persist every 5 pages
      if (page === 1 || page % 5 === 0) {
        lastScanTime = new Date();
        persistData();
      }
    }

    // Delta queries use @odata.nextLink for pagination, @odata.deltaLink on final page
    if (data['@odata.nextLink']) {
      url = data['@odata.nextLink'];
    } else {
      // Final page — save the deltaLink for next incremental sync
      if (data['@odata.deltaLink']) {
        deltaLink = data['@odata.deltaLink'];
      }
      url = null;
    }
  }

  // Final UI update
  buildCompaniesFromDomainMap();
  renderTable();
  updateStats();

  return totalFetched;
}

function timeAgo(date) {
  const now = Date.now();
  const diff = now - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  if (days < 7) return days + 'd ago';
  const weeks = Math.floor(days / 7);
  if (weeks < 4) return weeks + 'w ago';
  const months = Math.floor(days / 30);
  return months + 'mo ago';
}

// ──────────────────────────────────────────────
// OUTLOOK SCAN — Full first time, auto-sync after
// ──────────────────────────────────────────────
async function scanOutlookEmails(forceFullScan) {
  if (isScanning) return;
  isScanning = true;
  setSyncBadge('scanning');

  try {
    showScanBanner('Connecting to Microsoft Graph...');
    const token = await getAccessToken();

    // Decide: full scan or delta sync
    const needsFullScan = forceFullScan || !fullScanDone;
    let totalFetched;

    if (needsFullScan) {
      if (forceFullScan) { domainMap = {}; seenMsgIds = new Set(); deltaLink = null; }
      showScanBanner('Full scan — reading all emails' + (Object.keys(domainMap).length > 0 ? ' (resuming)' : '') + '...');
      totalFetched = await fetchEmailsProgressively(token, false); // full delta scan
      fullScanDone = true;
      updateScanBanner('Full scan complete! ' + totalFetched.toLocaleString() + ' emails processed, ' + companies.length + ' companies found');
    } else {
      showScanBanner('Delta sync — checking for changes...');
      totalFetched = await fetchEmailsProgressively(token, true); // incremental delta
      if (totalFetched > 0) {
        updateScanBanner('Synced ' + totalFetched.toLocaleString() + ' new emails — ' + companies.length + ' companies');
      } else {
        updateScanBanner('All caught up — no new emails');
      }
    }

    lastScanTime = new Date();
    await persistData();
    setSyncBadge('synced', 'In Sync');
    updateLastSyncDisplay();

    resolveCompanyNames();
    runEnrichment();

    setTimeout(() => { hideScanBanner(); }, needsFullScan ? 4000 : 2000);

  } catch(e) {
    hideScanBanner();
    setSyncBadge('error', 'Sync Failed');
    console.error('Scan error:', e);
    alert('Email scan failed: ' + e.message);
  } finally {
    isScanning = false;
  }
}

// Full re-scan: clears everything and starts fresh
async function fullRescan() {
  domainMap = {};
  seenMsgIds = new Set();
  deltaLink = null;
  lastScanTime = null;
  fullScanDone = false;
  companies = [];
  await clearPersistedData();
  renderTable();
  updateStats();
  closeSettings();
  scanOutlookEmails(true);
}

// ──────────────────────────────────────────────
// ──────────────────────────────────────────────
// AUTO-SYNC — quiet background sync every 5 minutes
// ──────────────────────────────────────────────
function startAutoSync() {
  stopAutoSync();
  autoSyncTimer = setInterval(() => {
    if (!isScanning && fullScanDone && currentAccount) {
      scanOutlookEmails();
    }
  }, AUTO_SYNC_INTERVAL);
}
function stopAutoSync() {
  if (autoSyncTimer) { clearInterval(autoSyncTimer); autoSyncTimer = null; }
}

// Last sync display
function updateLastSyncDisplay() {
  const bar = document.getElementById('accountBar');
  if (!currentAccount) { bar.style.display = 'none'; return; }
  bar.style.display = 'flex';
  document.getElementById('accountEmail').textContent = userEmail || currentAccount.username || '';
  if (lastScanTime) {
    document.getElementById('lastSyncText').textContent =
      'Last synced ' + timeAgo(lastScanTime) + ' · ' +
      companies.length + ' companies';
  } else {
    document.getElementById('lastSyncText').textContent = 'Not yet synced';
  }
}
function setSyncBadge(state, text) {
  const badge = document.getElementById('syncBadge');
  badge.className = 'sync-badge' + (state === 'scanning' ? ' scanning' : state === 'error' ? ' error' : '');
  document.getElementById('syncBadgeText').textContent = text || (state === 'scanning' ? 'Syncing...' : state === 'error' ? 'Error' : 'In Sync');
}

// ──────────────────────────────────────────────
// UI STATE
// ──────────────────────────────────────────────
function showWelcome() {
  document.getElementById('welcomeScreen').style.display = 'flex';
  document.getElementById('crmContent').classList.remove('active');
  document.getElementById('sidebar').style.display = 'none';
  document.getElementById('scanOutlookBtn').style.display = 'none';
  document.getElementById('exportBtn').style.display = 'none';
  document.getElementById('userPill').style.display = 'none';
  document.getElementById('signOutBtn').style.display = 'none';
  document.getElementById('settingsBtn').style.display = 'none';
  document.getElementById('chatFab').style.display = 'none';
}

async function onSignedIn() {
  document.getElementById('welcomeScreen').style.display = 'none';
  document.getElementById('crmContent').classList.add('active');
  const sb = document.getElementById('sidebar');
  sb.style.display = 'flex';
  if (localStorage.getItem('relateflow_sidebar') === 'collapsed') {
    sb.classList.add('collapsed');
  } else {
    sb.classList.remove('collapsed');
  }
  document.getElementById('scanOutlookBtn').style.display = '';
  document.getElementById('exportBtn').style.display = '';
  document.getElementById('settingsBtn').style.display = '';
  document.getElementById('signOutBtn').style.display = '';
  document.getElementById('chatFab').style.display = 'grid';
  document.getElementById('userPill').style.display = 'flex';
  document.getElementById('userName').textContent = userEmail;

  // Load cached data from IndexedDB — show instantly (no waiting for scan)
  const cached = await loadPersistedData();
  if (cached && cached.domainMap && Object.keys(cached.domainMap).length > 0) {
    domainMap = cached.domainMap;
    lastScanTime = cached.lastScanTime;
    fullScanDone = cached.fullScanDone || false;
    deltaLink = cached.deltaLink || null;
    if (cached.seenMsgIds && cached.seenMsgIds.size > 0) {
      seenMsgIds = cached.seenMsgIds;
    } else {
      // Upgrade from old cache: no dedup tracking.
      // Force full rescan to rebuild with immutable IDs + delta sync.
      seenMsgIds = new Set();
      deltaLink = null;
      fullScanDone = false;
    }
    // Migration: if no deltaLink exists, old data used mutable IDs.
    // Force full rescan to rebuild with immutable IDs + delta sync.
    if (!deltaLink && fullScanDone) {
      seenMsgIds = new Set();
      for (const d of Object.values(domainMap)) {
        if (d.sentIds instanceof Set) d.sentIds.clear(); else d.sentIds = new Set();
        if (d.receivedIds instanceof Set) d.receivedIds.clear(); else d.receivedIds = new Set();
        for (const c of Object.values(d.contacts)) {
          if (c.sentIds instanceof Set) c.sentIds.clear(); else c.sentIds = new Set();
          if (c.receivedIds instanceof Set) c.receivedIds.clear(); else c.receivedIds = new Set();
        }
      }
      fullScanDone = false;
    }
    // Check if any domain still uses old counter format (no sentIds Set)
    const needsSetUpgrade = Object.values(domainMap).some(d => !(d.sentIds instanceof Set));
    if (needsSetUpgrade) {
      for (const d of Object.values(domainMap)) {
        if (!(d.sentIds instanceof Set)) d.sentIds = new Set();
        if (!(d.receivedIds instanceof Set)) d.receivedIds = new Set();
        for (const c of Object.values(d.contacts)) {
          if (!(c.sentIds instanceof Set)) c.sentIds = new Set();
          if (!(c.receivedIds instanceof Set)) c.receivedIds = new Set();
        }
      }
      fullScanDone = false;
      deltaLink = null;
    }
    buildCompaniesFromDomainMap();
    renderTableHeader();
    renderTable();
    updateStats();
    updateLastSyncDisplay();
    resolveCompanyNames();
    runEnrichment();
  }
  updateBlockedCount();

  updateLastSyncDisplay();

  // If we have cached data, show it instantly — sync in background
  // If no cached data (first time), run scan in foreground
  const hasCachedData = companies.length > 0;
  if (hasCachedData) {
    // Non-blocking: sync new emails quietly in background
    scanOutlookEmails();
  } else {
    // First time: must scan to have anything to show
    await scanOutlookEmails();
  }

  // Keep data fresh automatically
  startAutoSync();
}

// Scan progress shown in the account bar
function showScanBanner(text) {
  setSyncBadge('scanning', 'Syncing...');
  document.getElementById('lastSyncText').textContent = text;
}
function updateScanBanner(text) {
  document.getElementById('lastSyncText').textContent = text;
}
function hideScanBanner() { updateLastSyncDisplay(); }

// ──────────────────────────────────────────────
// TABLE RENDERING (dynamic columns)
// ──────────────────────────────────────────────
const TABLE_PAGE_SIZE = 100;
let tableShowAll = false;

function renderTableHeader() {
  const cols = getVisibleColumns();
  let html = '<tr><th class="col-check"><input type="checkbox" class="row-checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)"></th>';
  for (const col of cols) {
    const meta = BUILTIN_COLUMNS.find(b => b.id === col.id);
    const sortKey = meta ? meta.sortKey : (col.type === 'ai' || col.type === 'custom' ? col.id : null);
    const sortAttr = sortKey ? ' onclick="sortTable(\'' + sortKey + '\')" style="cursor:pointer"' : '';
    const arrow = currentSort.key === sortKey ? (currentSort.asc ? ' &#9650;' : ' &#9660;') : '';
    html += '<th' + sortAttr + ' ondblclick="startRenameColumnHeader(\'' + col.id + '\',this)">' + esc(col.label) + arrow + '</th>';
  }
  html += '</tr>';
  document.getElementById('tableHead').innerHTML = html;
}

function startRenameColumnHeader(id, th) {
  const col = columnConfig.find(c => c.id === id);
  if (!col) return;
  const oldLabel = col.label;
  th.innerHTML = '<input class="col-rename-input" value="' + esc(oldLabel) + '" style="width:90%;font-size:11px">';
  const input = th.querySelector('input');
  input.focus();
  input.select();
  input.onclick = function(e) { e.stopPropagation(); };
  input.onblur = function() {
    if (input.value.trim()) { col.label = input.value.trim(); saveColumnConfig(); }
    renderTableHeader();
  };
  input.onkeydown = function(e) {
    if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
    if (e.key === 'Escape') { renderTableHeader(); }
  };
}

function buildCellHTML(col, c, color) {
  if (col.type === 'builtin') {
    switch (col.id) {
      case 'company':
        return '<div class="company-cell"><div class="company-logo" style="background:' + color + '">' + companyLogoHTML(c.domain, color, c.name) + '</div><div class="company-info"><span class="company-name">' + esc(c.name) + '</span><span class="company-domain">' + esc(c.domain) + '</span></div></div>';
      case 'contact':
        var initials = c.contact ? c.contact.split(' ').map(function(n){return n[0]}).join('').substring(0,2) : '';
        var ctTitle = getContactTitle(c.contactEmail || '');
        return '<div class="contact-cell"><div class="avatar" style="background:' + color + '">' + contactPhotoHTML(c.contactEmail || '', color, initials) + '</div><div><span class="contact-name">' + esc(c.contact) + '</span>' + (ctTitle ? '<div class="contact-title">' + esc(ctTitle) + '</div>' : '') + '</div></div>';
      case 'sent':
        return '<span style="color:var(--accent2);font-weight:600">' + c.sent + '</span>';
      case 'received':
        return '<span style="color:var(--green);font-weight:600">' + c.received + '</span>';
      case 'emailFlow':
        var total = c.sent + c.received;
        var sentPct = total ? (c.sent / total * 100) : 50;
        return '<div class="email-bar"><div class="bar-track"><div class="bar-sent" style="width:' + sentPct + '%"></div><div class="bar-recv" style="width:' + (100 - sentPct) + '%"></div></div></div>';
      case 'status':
        return '<span class="badge ' + STATUS_CLASS[c.status] + '">' + c.status + '</span>';
      case 'score':
        var scoreColor = c.score >= 75 ? '#1e8e3e' : c.score >= 50 ? '#e8710a' : '#d93025';
        return '<div class="ai-score"><div class="score-num" style="color:' + scoreColor + ';border-color:' + scoreColor + '">' + c.score + '</div></div>';
      case 'lastActivity':
        return '<span style="color:var(--text2)">' + esc(c.lastActivity) + '</span>';
      default: return '';
    }
  }
  // AI or custom column
  var val = getCellValue(c, col);
  return '<span class="cell-val">' + esc(val) + '</span>';
}

function renderTable() {
  let data = [...companies];
  if (currentFilter !== 'all') data = data.filter(c => c.status === currentFilter);
  const q = (document.getElementById('searchInput').value || '').toLowerCase();
  if (q) data = data.filter(c => {
    if (c.name.toLowerCase().includes(q) || c.contact.toLowerCase().includes(q) || c.domain.toLowerCase().includes(q)) return true;
    // Search custom/ai column values too
    for (const col of getVisibleColumns()) {
      if (col.type === 'ai' || col.type === 'custom') {
        var val = getCellValue(c, col);
        if (val && val.toLowerCase().includes(q)) return true;
      }
    }
    return false;
  });

  const {key, asc} = currentSort;
  data.sort((a,b) => {
    let va, vb;
    // Check if sorting by a custom/ai column
    const col = columnConfig.find(c => c.id === key);
    if (col && (col.type === 'ai' || col.type === 'custom')) {
      va = getCellValue(a, col) || '';
      vb = getCellValue(b, col) || '';
    } else {
      va = a[key]; vb = b[key];
    }
    if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb||'').toLowerCase(); }
    if (va < vb) return asc ? -1 : 1;
    if (va > vb) return asc ? 1 : -1;
    return 0;
  });

  const cols = getVisibleColumns();
  const colCount = cols.length + 1; // +1 for checkbox
  const tbody = document.getElementById('tableBody');
  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="' + colCount + '" style="text-align:center;padding:40px;color:var(--text2)">No companies found. Click "Sync Emails" to scan your Outlook.</td></tr>';
    updateBulkBar();
    return;
  }

  const totalCount = data.length;
  const visible = tableShowAll ? data : data.slice(0, TABLE_PAGE_SIZE);

  const rows = [];
  for (let i = 0; i < visible.length; i++) {
    const c = visible[i];
    const color = COLORS[c.id % COLORS.length];
    const sel = selectedIds.has(c.id);
    let row = '<tr' + (sel ? ' class="row-selected"' : '') + ' data-id="' + c.id + '">';
    row += '<td class="col-check"><input type="checkbox" class="row-checkbox"' + (sel ? ' checked' : '') + ' data-rid="' + c.id + '"></td>';
    for (const col of cols) {
      const isCustom = col.type === 'ai' || col.type === 'custom';
      row += '<td' + (isCustom ? ' class="custom-cell" data-col="' + col.id + '" data-domain="' + c.domain + '"' : '') + '>' + buildCellHTML(col, c, color) + '</td>';
    }
    row += '</tr>';
    rows.push(row);
  }

  if (!tableShowAll && totalCount > TABLE_PAGE_SIZE) {
    rows.push('<tr class="show-more-row" data-action="showmore"><td colspan="' + colCount + '">Show all ' + totalCount + ' companies (' + (totalCount - TABLE_PAGE_SIZE) + ' more)</td></tr>');
  }

  tbody.innerHTML = rows.join('');

  const selectAll = document.getElementById('selectAllCheckbox');
  if (selectAll) {
    const visibleIds = visible.map(c => c.id);
    const allChecked = visibleIds.length > 0 && visibleIds.every(id => selectedIds.has(id));
    const someChecked = visibleIds.some(id => selectedIds.has(id));
    selectAll.checked = allChecked;
    selectAll.indeterminate = someChecked && !allChecked;
  }

  updateBulkBar();
  document.getElementById('companyCount').textContent = companies.length;
}

function updateStats() {
  document.getElementById('statCompanies').textContent = companies.length;
  document.getElementById('statSent').textContent = companies.reduce((s,c) => s + c.sent, 0).toLocaleString();
  document.getElementById('statRecv').textContent = companies.reduce((s,c) => s + c.received, 0).toLocaleString();
  document.getElementById('statContacts').textContent = companies.reduce((s,c) => s + (c.allContacts?.length || 1), 0).toLocaleString();
  // Update segment counts in sidebar
  const hot = companies.filter(c => c.status === 'Hot').length;
  const warm = companies.filter(c => c.status === 'Warm').length;
  const cold = companies.filter(c => c.status === 'Cold').length;
  document.getElementById('hotCount').textContent = hot;
  document.getElementById('warmCount').textContent = warm;
  document.getElementById('coldCount').textContent = cold;
}

function sortTable(key) {
  if (currentSort.key === key) currentSort.asc = !currentSort.asc;
  else { currentSort.key = key; currentSort.asc = key === 'company' || key === 'contact'; }
  renderTable();
}

function toggleSidebar() {
  const sb = document.getElementById('sidebar');
  sb.classList.toggle('collapsed');
  localStorage.setItem('relateflow_sidebar', sb.classList.contains('collapsed') ? 'collapsed' : '');
}

function filterByStatus(status, el) {
  currentFilter = status;
  tableShowAll = false;
  document.querySelectorAll('.sidebar-item').forEach(e => e.classList.remove('active'));
  if (el) el.classList.add('active');
  clearSelection();
  renderTable();
}

// ──────────────────────────────────────────────
// SELECTION & BULK ACTIONS
// ──────────────────────────────────────────────
function toggleRowSelect(id, checked) {
  if (checked) selectedIds.add(id);
  else selectedIds.delete(id);
  renderTable();
}

function toggleSelectAll(checked) {
  // Get currently visible/filtered companies
  let data = [...companies];
  if (currentFilter !== 'all') data = data.filter(c => c.status === currentFilter);
  const q = (document.getElementById('searchInput').value || '').toLowerCase();
  if (q) data = data.filter(c => c.name.toLowerCase().includes(q) || c.contact.toLowerCase().includes(q) || c.domain.toLowerCase().includes(q));

  if (checked) {
    data.forEach(c => selectedIds.add(c.id));
  } else {
    data.forEach(c => selectedIds.delete(c.id));
  }
  renderTable();
}

function clearSelection() {
  selectedIds.clear();
  const selectAll = document.getElementById('selectAllCheckbox');
  if (selectAll) { selectAll.checked = false; selectAll.indeterminate = false; }
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById('bulkBar');
  if (selectedIds.size > 0) {
    bar.classList.add('active');
    document.getElementById('bulkCount').textContent = selectedIds.size + ' selected';
  } else {
    bar.classList.remove('active');
  }
}

function bulkBlockSelected() {
  const domains = [];
  for (const id of selectedIds) {
    const c = companies.find(x => x.id === id);
    if (c) domains.push(c.domain);
  }
  if (domains.length === 0) return;
  const msg = domains.length === 1
    ? 'Block "' + domains[0] + '" from your system?'
    : 'Block ' + domains.length + ' domains from your system?\n\n' + domains.join(', ');
  if (!confirm(msg)) return;

  for (const d of domains) {
    blockedDomains.add(d.toLowerCase());
  }
  saveBlockedDomains();
  selectedIds.clear();
  buildCompaniesFromDomainMap();
  renderTable();
  updateStats();
  updateBlockedCount();
}

// ──────────────────────────────────────────────
// BLOCKED DOMAINS VIEW
// ──────────────────────────────────────────────
function updateBlockedCount() {
  const badge = document.getElementById('blockedCount');
  if (badge) badge.textContent = blockedDomains.size;
}

function showBlockedView() {
  // Switch sidebar active
  document.querySelectorAll('.sidebar-item').forEach(e => e.classList.remove('active'));
  document.getElementById('blockedViewItem').classList.add('active');

  // Render blocked domains as a table in the main table body
  const tbody = document.getElementById('tableBody');
  const sorted = [...blockedDomains].sort();

  if (sorted.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text2)">No blocked domains. Domains you block will appear here.</td></tr>';
    return;
  }

  tbody.innerHTML = sorted.map(domain => {
    // Check if domain still has data in domainMap
    const data = domainMap[domain];
    const totalSent = data ? data.sentIds.size : 0;
    const totalRecv = data ? data.receivedIds.size : 0;
    const contactCount = data ? Object.keys(data.contacts).length : 0;

    return `<tr>
      <td class="col-check"></td>
      <td><div class="company-cell"><div class="company-logo" style="background:var(--red);opacity:.6">${domain[0].toUpperCase()}</div><div class="company-info"><span class="company-name" style="text-decoration:line-through;opacity:.6">${esc(domain.split('.')[0].charAt(0).toUpperCase() + domain.split('.')[0].slice(1))}</span><span class="company-domain">${esc(domain)}</span></div></div></td>
      <td colspan="5" style="color:var(--text2);font-size:12px">${totalSent} sent, ${totalRecv} received, ${contactCount} contact${contactCount !== 1 ? 's' : ''}</td>
      <td colspan="2" style="text-align:right">
        <button class="btn btn-ghost btn-sm" onclick="unblockDomain('${domain}')" style="font-size:11px;color:var(--green);border-color:var(--green)">Unblock</button>
      </td>
    </tr>`;
  }).join('');

  // Clear select-all since blocked view doesn't use checkboxes
  clearSelection();
}

function unblockDomain(domain) {
  blockedDomains.delete(domain);
  saveBlockedDomains();
  buildCompaniesFromDomainMap();
  updateStats();
  updateBlockedCount();
  showBlockedView(); // Re-render the blocked view
}

// ──────────────────────────────────────────────
// INLINE DETAIL PANEL — single page, no overlays
// States: 'company' (contacts list) or 'contact' (timeline)
// ──────────────────────────────────────────────
let panelState = null; // null | { view:'company', companyId } | { view:'contact', email, domain, companyId }

function openDetail(id) { showCompanyPanel(id); }

function showCompanyPanel(id) {
  const c = companies.find(x => x.id === id);
  if (!c) return;
  currentCompanyOverlay = c;
  panelState = { view: 'company', companyId: id, selectedContact: null };
  const color = COLORS[c.id % COLORS.length];
  const contacts = c.allContacts || [];
  const sorted = [...contacts].sort((a, b) => (b.sent + b.received) - (a.sent + a.received));
  const primaryEmail = starredContacts[c.domain] || (sorted[0] ? sorted[0].email : '');

  // AI insight
  let insight = '';
  if (c.score >= 75) insight = 'High engagement. ' + (c.sent + c.received) + ' emails exchanged — consider scheduling a call.';
  else if (c.score >= 50) insight = 'Active relationship. ' + (c.received > c.sent ? 'Good responsiveness from them.' : 'You send more than they reply — try a new angle.');
  else if (c.score >= 30) insight = 'Early stage — only ' + (c.sent + c.received) + ' emails. Increase outreach to build momentum.';
  else insight = 'Going cold — last activity ' + c.lastActivity + '. Re-engage with a personalized message.';

  const circumference = 2 * Math.PI * 12;
  const offset = circumference - (c.score / 100) * circumference;
  const scoreColor = c.score >= 75 ? 'var(--green)' : c.score >= 50 ? 'var(--orange)' : 'var(--red)';

  // Topbar
  document.getElementById('dpTopbarTitle').textContent = c.name;

  // Left head: company info
  let headHtml = '<div class="dp-company-head">' +
    '<div class="dp-co-logo" style="background:' + color + '">' + companyLogoHTML(c.domain, color, c.name, 44) + '</div>' +
    '<div class="dp-co-info"><h2>' + esc(c.name) + '</h2><div class="dp-domain">' + esc(c.domain) + ' <a href="' + linkedInCompanyURL(c.domain) + '" target="_blank" class="linkedin-link" title="Find on LinkedIn">' + linkedInIconSVG() + '</a></div></div>' +
  '</div>';

  headHtml += '<div class="dp-co-meta">' +
    '<span class="badge ' + (STATUS_CLASS[c.status] || '') + '">' + c.status + '</span>' +
    '<div class="ai-score"><div class="score-ring" style="color:' + scoreColor + '"><svg viewBox="0 0 30 30"><circle class="track" cx="15" cy="15" r="12"/><circle class="fill" cx="15" cy="15" r="12" stroke="' + scoreColor + '" stroke-dasharray="' + circumference + '" stroke-dashoffset="' + offset + '"/></svg>' + c.score + '</div></div>' +
    '<span style="font-size:11px;color:var(--text2)">' + esc(c.lastActivity) + '</span>' +
  '</div>';

  headHtml += '<div class="dp-mini-stats">' +
    '<div class="dp-mini-stat"><span class="label">Sent</span><div class="value" style="color:var(--accent2)">' + c.sent + '</div></div>' +
    '<div class="dp-mini-stat"><span class="label">Received</span><div class="value" style="color:var(--green)">' + c.received + '</div></div>' +
  '</div>';

  headHtml += '<div class="ai-insight" style="margin-bottom:0"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg><div><div class="label">AI Insight</div><p style="margin:0">' + esc(insight) + '</p></div></div>';

  // AI Company Research card — show cached immediately, then fetch if needed
  const cachedResearch = companyResearch[c.domain];
  if (cachedResearch && cachedResearch.summary) {
    headHtml += buildResearchCardHTML(cachedResearch, c.domain, false);
  } else {
    headHtml += buildResearchCardHTML({ name: c.name }, c.domain, true);
    // Kick off research asynchronously
    researchCompany(c.domain).then(function(result) {
      const el = document.querySelector('.ai-research-card');
      if (el) el.outerHTML = buildResearchCardHTML(result, c.domain, false);
    });
  }

  document.getElementById('dpLeftHead').innerHTML = headHtml;

  // Left contacts list
  let ctHtml = '<div class="dp-section-title">Relationships <span class="cnt">' + sorted.length + '</span></div>';
  for (const ct of sorted) {
    const initials = ct.name.split(' ').map(function(n){return n[0]}).join('').substring(0, 2).toUpperCase();
    const total = ct.sent + ct.received;
    const isPrimary = ct.email === primaryEmail;
    const eSafe = ct.email.replace(/'/g, "\\'");
    const dSafe = c.domain.replace(/'/g, "\\'");

    const ctTitle = getContactTitle(ct.email);
    ctHtml += '<div class="dp-contact" data-email="' + esc(ct.email) + '" onclick="selectContact(\'' + eSafe + '\',\'' + dSafe + '\',' + c.id + ')">' +
      '<div class="dp-ct-avatar" style="background:' + color + '">' + contactPhotoHTML(ct.email, color, initials, 30) + '</div>' +
      '<div class="dp-ct-info">' +
        '<div class="dp-ct-name">' + esc(ct.name) + (isPrimary ? ' <span class="dp-primary-badge">Primary</span>' : '') + '</div>' +
        '<div class="dp-ct-email">' + esc(ct.email) + (ctTitle ? ' · ' + esc(ctTitle) : '') + '</div>' +
      '</div>' +
      '<div class="dp-ct-count">' + total + '</div>' +
      '<button class="dp-star' + (isPrimary ? ' active' : '') + '" onclick="event.stopPropagation();toggleStar(\'' + dSafe + '\',\'' + eSafe + '\')" title="' + (isPrimary ? 'Primary' : 'Set primary') + '">&#9733;</button>' +
    '</div>';
  }
  document.getElementById('dpLeftContacts').innerHTML = ctHtml;

  // Left footer
  document.getElementById('dpLeftFoot').innerHTML =
    '<button class="btn btn-ghost btn-sm" onclick="if(confirm(\'Block ' + esc(c.domain) + '?\'))blockDomainFromDetail(\'' + c.domain.replace(/'/g, "\\'") + '\')" style="color:var(--red);border-color:var(--red);font-size:11px;width:100%">' +
    '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg> Block domain</button>';

  // Reset right side to empty state
  document.getElementById('dpRightEmpty').style.display = 'flex';
  document.getElementById('dpRightHead').style.display = 'none';
  document.getElementById('dpRightTabs').style.display = 'none';
  document.getElementById('dpTimeline').style.display = 'none';

  // Show detail page, hide CRM table
  document.getElementById('crmContent').style.display = 'none';
  document.getElementById('detailPage').classList.add('active');

  // Auto-select first contact if available
  if (sorted.length > 0) {
    selectContact(sorted[0].email, c.domain, c.id);
  }
}

function selectContact(email, domain, companyId) {
  const data = domainMap[domain];
  if (!data) return;
  const ct = data.contacts[email.toLowerCase()];
  if (!ct) return;
  const c = companies.find(x => x.domain === domain);
  const color = COLORS[(c ? c.id : 0) % COLORS.length];
  currentContactOverlay = { contact: ct, company: c, domain: domain, email: email.toLowerCase() };
  if (panelState) panelState.selectedContact = email.toLowerCase();
  currentContactTab = 'all';
  closeInlineReply();

  // Highlight selected contact in left list
  document.querySelectorAll('#dpLeftContacts .dp-contact').forEach(function(el) {
    el.classList.toggle('selected', el.dataset.email === email.toLowerCase());
  });

  const initials = ct.name.split(' ').map(function(n){return n[0]}).join('').substring(0, 2).toUpperCase();
  const isPrimary = starredContacts[domain] === email.toLowerCase();
  const eSafe = ct.email.replace(/'/g, "\\'");

  const companyName = c ? c.name : domain;
  const ctTitle = getContactTitle(ct.email);
  const ctLinkedIn = getContactLinkedIn(ct.email) || linkedInPersonURL(ct.name, companyName);
  const titleESafe = ct.email.replace(/'/g, "\\'");

  // Right head
  let headHtml = '<div class="dp-ct-head">' +
    '<div class="dp-ct-big-avatar" style="background:' + color + '">' + contactPhotoHTML(ct.email, color, initials, 40) + '</div>' +
    '<div class="dp-ct-head-info">' +
      '<h2>' + esc(ct.name) + '</h2>' +
      '<div class="dp-ct-head-email">' + esc(ct.email) + '</div>' +
      '<div style="display:flex;align-items:center;gap:8px;margin-top:3px">' +
        '<span class="contact-title" contenteditable="true" style="min-width:60px;padding:1px 4px;border:1px solid transparent;border-radius:3px;cursor:text;font-size:11px;color:var(--text2)" ' +
          'onblur="setContactTitle(\'' + titleESafe + '\',this.textContent);this.style.borderColor=\'transparent\'" ' +
          'onfocus="this.style.borderColor=\'var(--border)\'" ' +
          'data-placeholder="Add title...">' + esc(ctTitle) + '</span>' +
        '<a href="' + ctLinkedIn + '" target="_blank" class="linkedin-link" title="LinkedIn profile">' + linkedInIconSVG() + ' LinkedIn</a>' +
      '</div>' +
    '</div>' +
    '<button class="dp-star' + (isPrimary ? ' active' : '') + '" onclick="toggleStarInPanel(\'' + domain.replace(/'/g, "\\'") + '\',\'' + email.toLowerCase().replace(/'/g, "\\'") + '\')" style="font-size:20px">&#9733;</button>' +
  '</div>';
  headHtml += '<div class="dp-ct-actions">' +
    '<button class="btn btn-primary btn-sm" onclick="openCompose(\'' + eSafe + '\',\'' + esc(ct.name) + '\',\'\',\'\')">' +
      '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> Email' +
    '</button>' +
  '</div>';
  headHtml += '<div class="dp-ct-stats-row">' +
    '<div class="dp-ct-stat"><b style="color:var(--accent2)">' + ct.sent + '</b>Sent</div>' +
    '<div class="dp-ct-stat"><b style="color:var(--green)">' + ct.received + '</b>Received</div>' +
    '<div class="dp-ct-stat"><b>' + (ct.lastDate ? timeAgo(ct.lastDate) : '—') + '</b>Last</div>' +
  '</div>';

  document.getElementById('dpRightHead').innerHTML = headHtml;

  // Right tabs
  document.getElementById('dpRightTabs').innerHTML =
    '<button class="dp-tab active" onclick="switchTab(\'all\',this)">All</button>' +
    '<button class="dp-tab" onclick="switchTab(\'sent\',this)">Sent</button>' +
    '<button class="dp-tab" onclick="switchTab(\'received\',this)">Received</button>' +
    '<button class="dp-tab" onclick="switchTab(\'meetings\',this)">Meetings</button>';

  // Show right side, hide empty state
  document.getElementById('dpRightEmpty').style.display = 'none';
  document.getElementById('dpRightHead').style.display = '';
  document.getElementById('dpRightTabs').style.display = '';
  document.getElementById('dpTimeline').style.display = '';
  document.getElementById('dpTimeline').innerHTML = '<div class="tl-loading"><div class="scan-spinner"></div>Loading...</div>';

  fetchContactTimeline(email.toLowerCase(), domain);
}

// Keep showContactPanel as alias for legacy calls
function showContactPanel(email, domain, companyId) {
  selectContact(email, domain, companyId);
}

function closePanel() {
  document.getElementById('detailPage').classList.remove('active');
  document.getElementById('crmContent').style.display = '';
  panelState = null;
  currentCompanyOverlay = null;
  currentContactOverlay = null;
}

// Close with Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && document.getElementById('detailPage').classList.contains('active')) closePanel();
});

function toggleStar(domain, email) {
  if (starredContacts[domain] === email) {
    delete starredContacts[domain];
  } else {
    starredContacts[domain] = email;
  }
  saveStarredContacts();
  buildCompaniesFromDomainMap();
  renderTable();
  updateStats();
  // Re-render current panel state
  if (panelState && panelState.view === 'company') {
    const c = companies.find(x => x.domain === domain);
    if (c) showCompanyPanel(c.id);
  }
}

function toggleStarInPanel(domain, email) {
  toggleStar(domain, email);
  // If on contact view, refresh it
  if (panelState && panelState.view === 'contact') {
    showContactPanel(panelState.email, panelState.domain, panelState.companyId);
  }
}

function switchTab(tab, el) {
  currentContactTab = tab;
  document.querySelectorAll('.dp-tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  if (currentContactOverlay) renderTimeline(currentContactOverlay.email);
}

// ──────────────────────────────────────────────
// TIMELINE — fetch from Outlook and render inline
// ──────────────────────────────────────────────
async function fetchContactTimeline(email, domain) {
  const el = document.getElementById('dpTimeline');
  if (!el) return;
  el.innerHTML = '<div class="tl-loading"><div class="scan-spinner"></div>Loading activity from Outlook...</div>';

  if (contactTimelineCache[email] && contactTimelineCache[email].length > 0) {
    renderTimeline(email);
    return;
  }

  try {
    const token = await getAccessToken();
    const headers = graphHeaders(token);
    const items = [];
    const select = '$select=id,subject,from,toRecipients,receivedDateTime,sentDateTime,bodyPreview,conversationId,webLink';
    const top = '$top=75';

    // Use $search with "participants:" — this reliably finds ALL emails
    // involving this contact (both sent to and received from).
    // Note: $search cannot be combined with $orderby, so we sort client-side.
    const searchUrl = 'https://graph.microsoft.com/v1.0/me/messages?' + top + '&' + select +
      '&$search=' + encodeURIComponent('"participants:' + email + '"');
    const searchResp = await fetch(searchUrl, { headers });
    if (searchResp.ok) {
      const searchData = await searchResp.json();
      if (searchData.value) {
        const myLower = userEmail.toLowerCase();
        for (const m of searchData.value) {
          const fromAddr = (m.from?.emailAddress?.address || '').toLowerCase();
          const isSent = fromAddr === myLower;
          const isFromContact = fromAddr === email.toLowerCase();
          // Classify: sent by me, received from contact, or skip
          if (isSent) {
            items.push({ type: 'sent', subject: m.subject || '(no subject)', date: new Date(m.sentDateTime || m.receivedDateTime), preview: m.bodyPreview || '', id: m.id, conversationId: m.conversationId, webLink: m.webLink || '' });
          } else if (isFromContact) {
            items.push({ type: 'received', subject: m.subject || '(no subject)', date: new Date(m.receivedDateTime || m.sentDateTime), preview: m.bodyPreview || '', id: m.id, conversationId: m.conversationId, webLink: m.webLink || '' });
          }
        }
      }
    } else {
      // Fallback: try simple $filter on from address only (always works)
      console.warn('$search failed (' + searchResp.status + '), falling back to $filter');
      const filterUrl = 'https://graph.microsoft.com/v1.0/me/messages?' + top + '&' + select +
        '&$orderby=receivedDateTime desc&$filter=' + encodeURIComponent("from/emailAddress/address eq '" + email + "'");
      const filterResp = await fetch(filterUrl, { headers });
      if (filterResp.ok) {
        const filterData = await filterResp.json();
        if (filterData.value) {
          for (const m of filterData.value) {
            items.push({ type: 'received', subject: m.subject || '(no subject)', date: new Date(m.receivedDateTime || m.sentDateTime), preview: m.bodyPreview || '', id: m.id, conversationId: m.conversationId, webLink: m.webLink || '' });
          }
        }
      }
    }

    // Calendar events — wrapped in try/catch since Calendars.Read may not be granted
    try {
      const calUrl = 'https://graph.microsoft.com/v1.0/me/events?$top=20&$select=subject,start,end,attendees,isOnlineMeeting' +
        '&$search=' + encodeURIComponent('"' + email + '"');
      const calResp = await fetch(calUrl, { headers });
      if (calResp.ok) {
        const calData = await calResp.json();
        if (calData.value) for (const ev of calData.value) {
          items.push({ type: 'meeting', subject: ev.subject || 'Meeting', date: new Date(ev.start?.dateTime), preview: (ev.isOnlineMeeting ? 'Online' : 'In-person') + ' · ' + (ev.attendees?.length || 0) + ' attendees', id: ev.id });
        }
      }
    } catch(e) {}

    // Dedupe and sort by date descending
    const seen = new Set();
    const unique = [];
    for (const item of items) { if (!seen.has(item.id)) { seen.add(item.id); unique.push(item); } }
    unique.sort((a, b) => b.date - a.date);
    contactTimelineCache[email] = unique;
    renderTimeline(email);
  } catch(e) {
    console.error('Timeline fetch error:', e);
    if (el) el.innerHTML = '<div class="tl-empty">Could not load activity. ' + esc(e.message) + '</div>';
  }
}

function renderTimeline(email) {
  const el = document.getElementById('dpTimeline');
  if (!el) return;
  let items = contactTimelineCache[email] || [];

  if (currentContactTab === 'sent') items = items.filter(i => i.type === 'sent');
  else if (currentContactTab === 'received') items = items.filter(i => i.type === 'received');
  else if (currentContactTab === 'meetings') items = items.filter(i => i.type === 'meeting');

  if (items.length === 0) {
    const msgs = { all: 'No activity found.', sent: 'No sent emails.', received: 'No received emails.', meetings: 'No meetings found.' };
    el.innerHTML = '<div class="tl-empty">' + (msgs[currentContactTab] || msgs.all) + '</div>';
    return;
  }

  const groups = {};
  for (const item of items) { const key = formatDateGroup(item.date); if (!groups[key]) groups[key] = []; groups[key].push(item); }

  const svgSent = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>';
  const svgRecv = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>';
  const svgMeet = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>';

  let html = '<div class="tl-list">';
  for (const [dateLabel, groupItems] of Object.entries(groups)) {
    html += '<div class="tl-date-group"><div class="tl-date-label">' + esc(dateLabel) + '</div>';
    for (const item of groupItems) {
      const icon = item.type === 'meeting' ? svgMeet : item.type === 'sent' ? svgSent : svgRecv;
      const time = item.date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const replyBtn = item.type !== 'meeting'
        ? ' <button class="tl-reply-btn" onclick="event.stopPropagation();openReply(\'' + item.id.replace(/'/g, "\\'") + '\',\'' + (currentContactOverlay ? currentContactOverlay.email.replace(/'/g, "\\'") : '') + '\',\'' + esc(item.subject).replace(/'/g, "\\'") + '\')">Reply</button>'
        : '';
      const clickAttr = item.type !== 'meeting' ? ' onclick="openEmailViewer(\'' + item.id.replace(/'/g, "\\'") + '\')"' : '';
      html += '<div class="tl-item"' + clickAttr + ' title="View email">' +
        '<div class="tl-icon ' + item.type + '">' + icon + '</div>' +
        '<div class="tl-content"><div class="tl-subject">' + esc(item.subject) + '</div>' +
        (item.preview ? '<div class="tl-preview">' + esc(item.preview.substring(0, 100)) + '</div>' : '') +
        '</div>' +
        '<div style="display:flex;flex-direction:column;align-items:flex-end;gap:2px"><div class="tl-time">' + time + '</div>' + replyBtn + '</div>' +
      '</div>';
    }
    html += '</div>';
  }
  html += '</div>';
  el.innerHTML = html;
}

function formatDateGroup(date) {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
  const diff = Math.floor((today - d) / 86400000);
  if (diff === 0) return 'Today';
  if (diff === 1) return 'Yesterday';
  if (diff < 7) return date.toLocaleDateString([], { weekday: 'long' });
  return date.toLocaleDateString([], { month: 'long', day: 'numeric', year: now.getFullYear() !== date.getFullYear() ? 'numeric' : undefined });
}

// ──────────────────────────────────────────────
// EMAIL VIEWER — inline viewer for reading emails inside CRM
// ──────────────────────────────────────────────
let currentViewerMsgId = null;
let currentViewerWebLink = null;

async function openEmailViewer(messageId) {
  currentViewerMsgId = messageId;
  currentViewerWebLink = null;
  const overlay = document.getElementById('emailViewerOverlay');
  const loading = document.getElementById('evLoading');
  overlay.classList.add('active');
  loading.classList.add('active');
  document.getElementById('evSubject').textContent = '';
  document.getElementById('evFrom').innerHTML = '';
  document.getElementById('evTo').innerHTML = '';
  document.getElementById('evDate').textContent = '';
  document.getElementById('evAvatar').textContent = '';
  document.getElementById('evAttachments').style.display = 'none';
  document.getElementById('evBodyFrame').srcdoc = '';

  try {
    const token = await getAccessToken();
    const headers = graphHeaders(token);
    const resp = await fetch('https://graph.microsoft.com/v1.0/me/messages/' + messageId + '?$select=subject,from,toRecipients,ccRecipients,receivedDateTime,sentDateTime,body,hasAttachments,webLink', { headers });
    if (!resp.ok) throw new Error('Failed to load email (' + resp.status + ')');
    const msg = await resp.json();

    currentViewerWebLink = msg.webLink || null;

    // Subject
    document.getElementById('evSubject').textContent = msg.subject || '(no subject)';

    // Sender avatar + name
    const fromName = msg.from?.emailAddress?.name || '';
    const fromAddr = msg.from?.emailAddress?.address || '';
    const initials = fromName ? fromName.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase() : fromAddr.substring(0, 1).toUpperCase();
    document.getElementById('evAvatar').textContent = initials;
    document.getElementById('evFrom').innerHTML = esc(fromName || fromAddr) + (fromName ? ' <span>' + esc(fromAddr) + '</span>' : '');

    // To + CC
    const toNames = (msg.toRecipients || []).map(r => esc(r.emailAddress?.name || r.emailAddress?.address || '')).join(', ');
    const ccNames = (msg.ccRecipients || []).map(r => esc(r.emailAddress?.name || r.emailAddress?.address || '')).join(', ');
    let toHtml = 'to ' + toNames;
    if (ccNames) toHtml += ', <strong>CC:</strong> ' + ccNames;
    document.getElementById('evTo').innerHTML = toHtml;

    // Date
    const dt = new Date(msg.receivedDateTime || msg.sentDateTime);
    document.getElementById('evDate').textContent = dt.toLocaleString([], { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });

    // Body — render in sandboxed iframe with generous padding
    const bodyContent = msg.body?.content || '';
    const bodyType = msg.body?.contentType || 'text';
    const frame = document.getElementById('evBodyFrame');
    const baseStyle = 'body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-size:14px;color:#222;padding:24px 28px;margin:0;line-height:1.6;word-break:break-word}img{max-width:100%;height:auto}a{color:#1a73e8}pre,code{white-space:pre-wrap;word-break:break-all}blockquote{border-left:3px solid #ddd;margin:8px 0;padding:4px 12px;color:#555}';
    if (bodyType === 'html') {
      frame.srcdoc = '<html><head><style>' + baseStyle + '</style></head><body>' + bodyContent + '</body></html>';
    } else {
      frame.srcdoc = '<html><head><style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-size:14px;color:#222;padding:24px 28px;margin:0;white-space:pre-wrap;word-break:break-word;line-height:1.6}</style></head><body>' + esc(bodyContent) + '</body></html>';
    }

    // Attachments
    if (msg.hasAttachments) {
      loadAttachments(messageId, token);
    }

    loading.classList.remove('active');
  } catch(e) {
    loading.classList.remove('active');
    document.getElementById('evSubject').textContent = 'Error loading email';
    document.getElementById('evFrom').innerHTML = '<span style="color:var(--red)">' + esc(e.message) + '</span>';
    console.error('Email viewer error:', e);
  }
}

async function loadAttachments(messageId, token) {
  try {
    const resp = await fetch('https://graph.microsoft.com/v1.0/me/messages/' + messageId + '/attachments?$select=id,name,contentType,size', { headers: graphHeaders(token) });
    if (!resp.ok) return;
    const data = await resp.json();
    const atts = data.value || [];
    if (atts.length === 0) return;

    const el = document.getElementById('evAttachments');
    const clipSvg = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>';
    let html = '';
    for (const att of atts) {
      const sizeKB = Math.round((att.size || 0) / 1024);
      const sizeStr = sizeKB > 1024 ? (sizeKB / 1024).toFixed(1) + ' MB' : sizeKB + ' KB';
      html += '<a class="ev-att-chip" href="#" onclick="event.preventDefault();downloadAttachment(\'' + messageId + '\',\'' + att.id.replace(/'/g, "\\'") + '\',\'' + esc(att.name).replace(/'/g, "\\'") + '\')">' + clipSvg + ' ' + esc(att.name) + ' <span style="opacity:.6">(' + sizeStr + ')</span></a>';
    }
    el.innerHTML = html;
    el.style.display = 'flex';
  } catch(e) { console.warn('Attachment load error:', e); }
}

async function downloadAttachment(messageId, attachmentId, fileName) {
  try {
    const token = await getAccessToken();
    const resp = await fetch('https://graph.microsoft.com/v1.0/me/messages/' + messageId + '/attachments/' + attachmentId + '/$value', { headers: graphHeaders(token) });
    if (!resp.ok) throw new Error('Download failed');
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = fileName; a.click();
    URL.revokeObjectURL(url);
  } catch(e) { alert('Could not download attachment: ' + e.message); }
}

function closeEmailViewer() {
  document.getElementById('emailViewerOverlay').classList.remove('active');
  currentViewerMsgId = null;
  currentViewerWebLink = null;
}
document.addEventListener('keydown', e => { if (e.key === 'Escape' && currentViewerMsgId) closeEmailViewer(); });

function replyFromViewer() {
  if (!currentViewerMsgId) return;
  const subject = document.getElementById('evSubject').textContent || '';
  const contactEmail = currentContactOverlay ? currentContactOverlay.email : '';
  closeEmailViewer();
  openReply(currentViewerMsgId, contactEmail, subject);
}

function openInOutlook() {
  if (currentViewerWebLink) window.open(currentViewerWebLink, '_blank');
}

// ──────────────────────────────────────────────
// EMAIL COMPOSE & REPLY (via Graph API sendMail)
// ──────────────────────────────────────────────
let composeReplyToId = null;

function openCompose(toEmail, toName, subject, replyId) {
  composeReplyToId = replyId || null;
  document.getElementById('composeTo').value = toName ? toName + ' <' + toEmail + '>' : toEmail;
  document.getElementById('composeTo').dataset.email = toEmail;
  document.getElementById('composeSubject').value = subject || '';
  document.getElementById('composeBody').value = '';
  document.getElementById('composeSendStatus').textContent = '';
  document.getElementById('composeSendBtn').disabled = false;
  document.getElementById('composeTitle').textContent = replyId ? 'Reply' : 'New Email';
  document.getElementById('composeOverlay').classList.add('active');
  // Focus body for reply, subject for new
  setTimeout(() => { document.getElementById(subject ? 'composeBody' : 'composeSubject').focus(); }, 100);
}

function openReply(messageId, toEmail, subject) {
  const reSubject = subject.startsWith('Re:') ? subject : 'Re: ' + subject;
  const ctName = currentContactOverlay ? currentContactOverlay.contact.name : '';
  composeReplyToId = messageId || null;

  // Show inline reply form in sidebar instead of modal popup
  const panel = document.getElementById('dpInlineReply');
  document.getElementById('inlineReplyTitle').textContent = 'Reply';
  document.getElementById('inlineReplyTo').textContent = 'To: ' + (ctName ? ctName + ' <' + toEmail + '>' : toEmail);
  document.getElementById('inlineReplyTo').dataset.email = toEmail;
  document.getElementById('inlineReplySubject').value = reSubject;
  document.getElementById('inlineReplyBody').value = '';
  document.getElementById('inlineReplyStatus').textContent = '';
  document.getElementById('inlineReplyStatus').style.color = '';
  document.getElementById('inlineReplySendBtn').disabled = false;
  panel.style.display = '';

  // Scroll timeline to bottom so reply form is visible
  const timeline = document.getElementById('dpTimeline');
  if (timeline) setTimeout(() => timeline.scrollTop = timeline.scrollHeight, 50);
  setTimeout(() => document.getElementById('inlineReplyBody').focus(), 100);
}

function closeInlineReply() {
  const el = document.getElementById('dpInlineReply');
  if (el) el.style.display = 'none';
  const body = document.getElementById('inlineReplyBody');
  if (body) body.value = '';
  composeReplyToId = null;
}

function closeCompose() {
  document.getElementById('composeOverlay').classList.remove('active');
  composeReplyToId = null;
}

async function sendInlineReply() {
  const toEmail = document.getElementById('inlineReplyTo').dataset.email;
  const subject = document.getElementById('inlineReplySubject').value.trim();
  const body = document.getElementById('inlineReplyBody').value.trim();
  if (!toEmail || !body) { document.getElementById('inlineReplyStatus').textContent = 'Please write a message.'; document.getElementById('inlineReplyStatus').style.color = 'var(--red)'; return; }

  const btn = document.getElementById('inlineReplySendBtn');
  const status = document.getElementById('inlineReplyStatus');
  btn.disabled = true;
  status.textContent = 'Sending...';
  status.style.color = '';

  try {
    const token = await getAccessToken();
    const headers = graphHeaders(token);

    const message = {
      subject: subject,
      body: { contentType: 'Text', content: body },
      toRecipients: [{ emailAddress: { address: toEmail } }]
    };

    const resp = await fetch('https://graph.microsoft.com/v1.0/me/sendMail', {
      method: 'POST',
      headers: headers,
      body: JSON.stringify({ message: message, saveToSentItems: true })
    });

    if (!resp.ok) {
      const err = await resp.text();
      throw new Error('Send failed: ' + resp.status + ' — ' + err);
    }

    status.textContent = 'Sent!';
    status.style.color = 'var(--green)';

    // Clear cache so timeline refreshes
    delete contactTimelineCache[toEmail.toLowerCase()];

    setTimeout(() => {
      closeInlineReply();
      // Refresh timeline if contact panel is open
      if (panelState && panelState.view === 'contact') {
        fetchContactTimeline(panelState.email, panelState.domain);
      }
    }, 1000);

  } catch(e) {
    console.error('Send error:', e);
    status.textContent = 'Failed: ' + e.message;
    status.style.color = 'var(--red)';
    btn.disabled = false;
  }
}

async function sendComposedEmail() {
  const toEmail = document.getElementById('composeTo').dataset.email;
  const subject = document.getElementById('composeSubject').value.trim();
  const body = document.getElementById('composeBody').value.trim();
  if (!toEmail || !subject || !body) { alert('Please fill in subject and message.'); return; }

  const btn = document.getElementById('composeSendBtn');
  const status = document.getElementById('composeSendStatus');
  btn.disabled = true;
  status.textContent = 'Sending...';

  try {
    const token = await getAccessToken();
    const headers = graphHeaders(token);
    const message = { subject, body: { contentType: 'Text', content: body }, toRecipients: [{ emailAddress: { address: toEmail } }] };
    const resp = await fetch('https://graph.microsoft.com/v1.0/me/sendMail', { method: 'POST', headers, body: JSON.stringify({ message, saveToSentItems: true }) });
    if (!resp.ok) { const err = await resp.text(); throw new Error('Send failed: ' + resp.status + ' — ' + err); }

    status.textContent = 'Sent!';
    status.style.color = 'var(--green)';
    delete contactTimelineCache[toEmail.toLowerCase()];
    setTimeout(() => { closeCompose(); status.style.color = ''; if (panelState && panelState.view === 'contact') fetchContactTimeline(panelState.email, panelState.domain); }, 1000);
  } catch(e) {
    console.error('Send error:', e);
    status.textContent = 'Failed: ' + e.message;
    status.style.color = 'var(--red)';
    btn.disabled = false;
  }
}

// ──────────────────────────────────────────────
// SETTINGS
// ──────────────────────────────────────────────
function openSettings() {
  document.getElementById('settingsModal').classList.add('active');
  document.getElementById('clientIdInput').value = getClientId();
  document.getElementById('redirectDisplay').textContent = window.location.origin + window.location.pathname;
  renderBlockedDomainsList();
}

function closeSettings() {
  document.getElementById('settingsModal').classList.remove('active');
}

async function saveSettings() {
  const clientId = document.getElementById('clientIdInput').value.trim();
  if (!clientId) { alert('Please enter your Application (Client) ID'); return; }
  if (!/^[a-f0-9-]{36}$/i.test(clientId)) {
    if (!confirm('That doesn\'t look like a standard Azure Client ID (should be a UUID). Save anyway?')) return;
  }
  localStorage.setItem('relateflow_client_id', clientId);
  closeSettings();
  msalInstance = null;
  await initMSAL();
  await signIn();
}

// ──────────────────────────────────────────────
// BLOCKED DOMAINS MANAGEMENT
// ──────────────────────────────────────────────
function addBlockedDomainsFromInput() {
  const input = document.getElementById('blockDomainsInput');
  const raw = input.value.trim();
  if (!raw) return;
  addBlockedDomains(raw);
  input.value = '';
}

function addBlockedDomains(raw) {
  // Parse: split on newlines, commas, spaces — extract domains
  const entries = raw.split(/[\n,;\s]+/).map(s => s.trim().toLowerCase()).filter(Boolean);
  let added = 0;
  for (const entry of entries) {
    // If it's an email address, extract domain
    const domain = entry.includes('@') ? entry.split('@')[1] : entry;
    if (domain && !SKIP_DOMAINS.has(domain) && !blockedDomains.has(domain)) {
      blockedDomains.add(domain);
      added++;
    }
  }
  if (added > 0) {
    saveBlockedDomains();
    // Rebuild companies to remove newly blocked domains
    buildCompaniesFromDomainMap();
    renderTable();
    updateStats();
    updateBlockedCount();
    renderBlockedDomainsList();
  }
}

function removeBlockedDomain(domain) {
  blockedDomains.delete(domain);
  saveBlockedDomains();
  // Rebuild companies — the unblocked domain may reappear
  buildCompaniesFromDomainMap();
  renderTable();
  updateStats();
  updateBlockedCount();
  renderBlockedDomainsList();
}

function blockDomainFromDetail(domain) {
  blockedDomains.add(domain.toLowerCase());
  saveBlockedDomains();
  buildCompaniesFromDomainMap();
  renderTable();
  updateStats();
  updateBlockedCount();
  closePanel();
}

function renderBlockedDomainsList() {
  const container = document.getElementById('blockedDomainsList');
  if (!container) return;
  if (blockedDomains.size === 0) {
    container.innerHTML = '<span style="font-size:11px;color:var(--text2)">No blocked domains yet</span>';
    return;
  }
  const sorted = [...blockedDomains].sort();
  container.innerHTML = sorted.map(d =>
    `<span class="blocked-tag">${esc(d)}<button onclick="removeBlockedDomain('${d}')" title="Unblock">&times;</button></span>`
  ).join('');
}

// ──────────────────────────────────────────────
// EXPORT CSV
// ──────────────────────────────────────────────
function exportCSV() {
  const header = 'Company,Domain,Primary Contact,Contact Email,Sent,Received,Status,AI Score,Last Activity\n';
  const rows = companies.map(c =>
    `"${c.name}","${c.domain}","${c.contact}","${c.contactEmail}",${c.sent},${c.received},"${c.status}",${c.score},"${c.lastActivity}"`
  ).join('\n');
  const blob = new Blob([header + rows], {type: 'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'relateflow-export.csv';
  a.click();
}

// ──────────────────────────────────────────────
// AI CHAT
// ──────────────────────────────────────────────
function toggleAIChat() {
  document.getElementById('aiChat').classList.toggle('open');
}

function sendAI() {
  const input = document.getElementById('aiInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  const msgs = document.getElementById('aiMessages');
  msgs.innerHTML += `<div class="ai-msg user">${esc(msg)}</div>`;
  msgs.scrollTop = msgs.scrollHeight;
  setTimeout(() => {
    msgs.innerHTML += `<div class="ai-msg bot">${generateAIReply(msg)}</div>`;
    msgs.scrollTop = msgs.scrollHeight;
  }, 400);
}

function generateAIReply(msg) {
  const lower = msg.toLowerCase();
  if (lower.includes('follow up') || lower.includes('followup') || lower.includes('reach out')) {
    const targets = companies.filter(c => c.status === 'Cold' || c.status === 'Warm').sort((a,b) => b.score - a.score).slice(0,5);
    if (targets.length === 0) return 'All your contacts look engaged! No immediate follow-ups needed.';
    return `I'd recommend following up with:<br>${targets.map(c => `<b>${c.contact}</b> at ${esc(c.name)} (${c.lastActivity}, score: ${c.score})`).join('<br>')}`;
  }
  if (lower.includes('hot') || lower.includes('best') || lower.includes('top')) {
    const hot = companies.filter(c => c.status === 'Hot').slice(0,5);
    if (hot.length === 0) return 'No hot leads yet. Keep emailing to build engagement!';
    return `Your hottest leads:<br>${hot.map(c => `<b>${esc(c.name)}</b> — Score: ${c.score}, ${c.sent+c.received} emails`).join('<br>')}`;
  }
  if (lower.includes('cold') || lower.includes('risk') || lower.includes('losing')) {
    const cold = companies.filter(c => c.status === 'Cold');
    return `${cold.length} companies at risk:<br>${cold.slice(0,5).map(c => `<b>${esc(c.name)}</b> — last: ${c.lastActivity}, score: ${c.score}`).join('<br>')}`;
  }
  if (lower.includes('summary') || lower.includes('overview') || lower.includes('stats')) {
    const ts = companies.reduce((s,c) => s+c.sent, 0);
    const tr = companies.reduce((s,c) => s+c.received, 0);
    return `Pipeline: <b>${companies.length}</b> companies, <b>${ts}</b> sent / <b>${tr}</b> received.<br>Hot: ${companies.filter(c=>c.status==='Hot').length} | Warm: ${companies.filter(c=>c.status==='Warm').length} | Cold: ${companies.filter(c=>c.status==='Cold').length}`;
  }
  // Try to find a company match
  const match = companies.find(c => lower.includes(c.name.toLowerCase()) || lower.includes(c.domain.toLowerCase()));
  if (match) {
    return `<b>${esc(match.name)}</b> (${esc(match.domain)})<br>Contact: ${esc(match.contact)}<br>Sent: ${match.sent} | Received: ${match.received}<br>Score: ${match.score} (${match.status})<br>Last: ${match.lastActivity}`;
  }
  return `You have ${companies.length} companies in your pipeline. Try:<br>• "Who should I follow up with?"<br>• "Show me hot leads"<br>• "Give me a summary"<br>• Or ask about any company by name`;
}

const _escMap = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};
function esc(text) {
  if (!text) return '';
  return String(text).replace(/[&<>"']/g, c => _escMap[c]);
}

// ──────────────────────────────────────────────
// INIT — check for existing session
// ──────────────────────────────────────────────
(async function init() {
  loadBlockedDomains();
  loadCompanyNameCache();
  loadStarredContacts();
  loadColumnConfig();
  loadCustomColumnData();
  loadEnrichmentCache();
  loadContactEnrichment();
  loadCompanyResearch();
  loadLogoFailedCache();
  renderTableHeader();
  if (getClientId()) {
    await initMSAL();
    if (msalInstance) {
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length > 0) {
        currentAccount = accounts[0];
        userEmail = currentAccount.username;
        await onSignedIn();
        return;
      }
    }
  }
  document.getElementById('settingsBtn').style.display = '';
  showWelcome();
})();

// ──────────────────────────────────────────────
// EVENT DELEGATION — single listener on table body
// (Avoids hundreds of inline onclick handlers)
// ──────────────────────────────────────────────
document.getElementById('tableBody').addEventListener('click', function(e) {
  // "Show more" row
  const showMore = e.target.closest('[data-action="showmore"]');
  if (showMore) { tableShowAll = true; renderTable(); return; }
  // Inline editing for custom/AI cells
  if (e.target.closest('input.cell-edit')) return; // already editing
  const customCell = e.target.closest('td.custom-cell');
  if (customCell) {
    e.stopPropagation();
    startCellEdit(customCell);
    return;
  }
  // Checkbox handling
  const checkbox = e.target.closest('input.row-checkbox');
  if (checkbox) {
    e.stopPropagation();
    const rid = parseInt(checkbox.dataset.rid, 10);
    if (checkbox.checked) selectedIds.add(rid); else selectedIds.delete(rid);
    renderTable();
    return;
  }
  // Skip if clicking inside col-check area
  if (e.target.closest('.col-check')) return;
  // Row click → open detail
  const row = e.target.closest('tr[data-id]');
  if (row) openDetail(parseInt(row.dataset.id, 10));
});

function startCellEdit(td) {
  const colId = td.dataset.col;
  const domain = td.dataset.domain;
  if (!colId || !domain) return;
  const currentVal = (customColumnData[domain] && customColumnData[domain][colId]) || getCellValue({ domain: domain }, columnConfig.find(c => c.id === colId) || {}) || '';
  td.innerHTML = '<input class="cell-edit" value="' + esc(currentVal) + '">';
  const input = td.querySelector('input');
  input.focus();
  input.select();
  input.onblur = function() { finishCellEdit(td, colId, domain, input.value); };
  input.onkeydown = function(e) {
    if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
    if (e.key === 'Escape') { renderTable(); }
    e.stopPropagation();
  };
}

function finishCellEdit(td, colId, domain, value) {
  if (!customColumnData[domain]) customColumnData[domain] = {};
  customColumnData[domain][colId] = value.trim();
  saveCustomColumnData();
  // Update just this cell without full re-render
  td.innerHTML = '<span class="cell-val">' + esc(value.trim()) + '</span>';
}

// Debounced search input
let _searchTimer = null;
document.getElementById('searchInput').oninput = function() {
  clearTimeout(_searchTimer);
  tableShowAll = false;
  _searchTimer = setTimeout(renderTable, 150);
};
</script>
</body>
</html>

