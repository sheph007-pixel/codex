<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kennion CRM</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- MSAL loaded dynamically in initMSAL() with CDN fallbacks -->
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f8f9fa;--surface:#ffffff;--surface2:#f1f3f4;--border:#dadce0;
  --text:#202124;--text2:#5f6368;--accent:#1a73e8;--accent2:#1967d2;
  --green:#1e8e3e;--green-bg:rgba(30,142,62,.08);
  --red:#d93025;--red-bg:rgba(217,48,37,.08);
  --orange:#e8710a;--orange-bg:rgba(232,113,10,.08);
  --blue:#1a73e8;--blue-bg:rgba(26,115,232,.08);
  --ms-blue:#1a73e8;
}
html{font-family:'Inter',system-ui,sans-serif;font-size:14px;background:var(--bg);color:var(--text)}
body{min-height:100vh;overflow-x:hidden}

/* ── TOP NAV ── */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:0 24px;height:56px;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;box-shadow:0 1px 3px rgba(60,64,67,.08)}
.topbar .logo{display:flex;align-items:center;gap:10px;font-weight:700;font-size:16px;letter-spacing:-.3px}
.topbar .logo svg{width:28px;height:28px}
.topbar-actions{display:flex;align-items:center;gap:12px}
.global-search-wrap{position:relative;flex:1;max-width:480px;margin:0 24px}
.global-search-box{display:flex;align-items:center;gap:8px;background:#1e1e2d;border:1px solid var(--border);border-radius:10px;padding:7px 14px;transition:.2s}
.global-search-box:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px rgba(91,156,246,.15)}
.global-search-box svg{width:16px;height:16px;color:var(--text3);flex-shrink:0}
.global-search-box input{background:none;border:none;outline:none;color:var(--text);font-size:13px;width:100%;font-family:inherit}
.global-search-box input::placeholder{color:var(--text3)}
.global-search-kbd{margin-left:auto;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:1px 6px;font-size:11px;color:var(--text3);font-family:inherit;line-height:1.4}
.global-search-dropdown{display:none;position:absolute;top:calc(100% + 6px);left:0;right:0;background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 32px rgba(0,0,0,.35);max-height:420px;overflow-y:auto;z-index:999;padding:6px}
.global-search-dropdown.open{display:block}
.global-search-dropdown .gs-section{padding:6px 12px 4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text3)}
.global-search-dropdown .gs-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;cursor:pointer;transition:.1s}
.global-search-dropdown .gs-item:hover,.global-search-dropdown .gs-item.gs-active{background:#2a2a3d}
.global-search-dropdown .gs-avatar{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;font-weight:700;font-size:12px;color:#fff;flex-shrink:0}
.global-search-dropdown .gs-info{flex:1;min-width:0}
.global-search-dropdown .gs-name{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.global-search-dropdown .gs-meta{font-size:11px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.global-search-dropdown .gs-tag{font-size:10px;font-weight:600;padding:2px 8px;border-radius:6px;flex-shrink:0}
.global-search-dropdown .gs-empty{padding:20px;text-align:center;color:var(--text3);font-size:13px}
.btn{padding:7px 16px;border-radius:8px;border:none;font-size:13px;font-weight:500;cursor:pointer;transition:.15s;font-family:inherit;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:#1557b0}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--surface2);color:var(--text)}
.btn-sm{padding:5px 12px;font-size:12px}
.btn-ms{background:var(--ms-blue);color:#fff;font-weight:600}
.btn-ms:hover{background:#1557b0}
.btn-icon{width:34px;height:34px;padding:0;display:grid;place-items:center;border-radius:8px;background:transparent;border:1px solid var(--border);color:var(--text2);cursor:pointer;transition:.15s}
.btn-icon:hover{background:var(--surface2);color:var(--text)}
.user-pill{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;font-size:12px;color:var(--text2)}
.user-pill .dot{width:8px;height:8px;border-radius:50%;background:var(--green)}

/* ── LAYOUT ── */
.layout{display:flex;height:calc(100vh - 56px)}
.sidebar{width:240px;min-width:0;background:#1e1e2d;border-right:1px solid #2a2a3d;padding:16px 12px;flex-shrink:0;display:flex;flex-direction:column;gap:4px;overflow-y:auto;overflow-x:hidden;transition:width .25s cubic-bezier(.4,0,.2,1),padding .25s cubic-bezier(.4,0,.2,1),border .25s}
.sidebar.collapsed{width:52px!important;min-width:52px;padding:16px 12px!important;overflow:hidden}
.sidebar.collapsed>*:not(.sidebar-collapse-row){display:none}
.sidebar-collapse-row{display:flex;align-items:center;justify-content:flex-end;margin-bottom:8px;flex-shrink:0}
.sidebar.collapsed .sidebar-collapse-row{justify-content:center}
.sidebar-toggle{background:none;border:1px solid #3a3a4d;color:#9e9eb8;cursor:pointer;width:28px;height:28px;border-radius:6px;display:grid;place-items:center;transition:.15s}
.sidebar-toggle:hover{background:#2a2a3d;color:#e0e0ef}
.sidebar-toggle svg{width:16px;height:16px}
.sidebar-section{margin-top:16px;margin-bottom:6px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:#7a7a95;padding:0 12px}
.sidebar-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:8px;color:#b0b0c8;cursor:pointer;transition:.15s;font-size:13px;font-weight:500}
.sidebar-item:hover,.sidebar-item.active{background:#2a2a3d;color:#e8e8f0}
.sidebar-item.active{color:#5b9cf6}
.sidebar-item svg{width:18px;height:18px;flex-shrink:0}
.sidebar-badge{margin-left:auto;background:var(--accent);color:#fff;font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px}
.main{flex:1;overflow-y:auto;overflow-x:hidden;padding:24px;display:flex;flex-direction:column;gap:20px}
.main:has(.detail-page.active){padding:0;gap:0;overflow:hidden}

/* ── WELCOME / SIGN-IN SCREEN ── */
.welcome-screen{display:flex;align-items:center;justify-content:center;flex:1;padding:40px}
.welcome-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:48px;max-width:520px;text-align:center;box-shadow:0 1px 4px rgba(60,64,67,.1)}
.welcome-card h1{font-size:28px;font-weight:700;margin-bottom:8px}
.welcome-card .subtitle{color:var(--text2);font-size:15px;line-height:1.6;margin-bottom:32px}
.welcome-card .ms-btn{display:inline-flex;align-items:center;gap:12px;padding:14px 32px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:.15s;font-family:inherit}
.welcome-card .ms-btn:hover{background:#1557b0;transform:translateY(-1px);box-shadow:0 2px 8px rgba(26,115,232,.3)}
.welcome-card .ms-btn svg{width:20px;height:20px}
.welcome-features{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:32px;text-align:left}
.welcome-feat{display:flex;align-items:start;gap:10px;padding:12px;background:var(--surface2);border-radius:10px}
.welcome-feat svg{width:18px;height:18px;color:var(--accent2);flex-shrink:0;margin-top:2px}
.welcome-feat div{display:flex;flex-direction:column;gap:2px}
.welcome-feat .feat-title{font-size:13px;font-weight:600;color:var(--text)}
.welcome-feat .feat-desc{font-size:11px;color:var(--text2)}
.welcome-note{margin-top:20px;font-size:11px;color:var(--text2);line-height:1.5}

/* ── CONNECTED ACCOUNT BAR ── */
.account-bar{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;margin:0 0 4px}
.account-bar-left{display:flex;align-items:center;gap:10px;color:var(--text2)}
.account-bar-left svg{flex-shrink:0;color:var(--ms-blue)}
.account-email{font-size:13px;font-weight:500;color:var(--text)}
.sync-badge{display:inline-flex;align-items:center;gap:5px;font-size:11px;font-weight:600;padding:2px 8px;border-radius:20px;background:rgba(52,168,83,.12);color:#1e7e34}
.sync-badge.scanning{background:rgba(26,115,232,.12);color:var(--ms-blue)}
.sync-badge.error{background:rgba(234,67,53,.12);color:var(--red)}
.sync-dot{width:6px;height:6px;border-radius:50%;background:currentColor}
.sync-badge.scanning .sync-dot{animation:pulse 1.2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.account-bar-right{display:flex;align-items:center;gap:10px}
.last-sync-text{font-size:11px;color:var(--text2)}
.btn-xs{padding:3px 8px;font-size:11px;border-radius:6px}

/* ── SCAN SPINNER (reused in timeline loading) ── */
.scan-spinner{width:20px;height:20px;border-radius:50%;border:3px solid var(--border);border-top-color:var(--ms-blue);animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── STATS ROW ── */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px 20px;display:flex;flex-direction:column;gap:6px;box-shadow:0 1px 2px rgba(60,64,67,.08)}
.stat-card .stat-label{font-size:12px;color:var(--text2);font-weight:500}
.stat-card .stat-value{font-size:26px;font-weight:700;letter-spacing:-.5px}
.stat-card .stat-change{font-size:11px;font-weight:600;display:flex;align-items:center;gap:4px}
.stat-up{color:var(--green)}.stat-down{color:var(--red)}

/* ── TOOLBAR ── */
.toolbar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.toolbar-left{display:flex;align-items:center;gap:10px}
.toolbar-right{display:flex;align-items:center;gap:10px}
.search-box{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:7px 14px;width:260px;transition:.15s}
.search-box:focus-within{border-color:var(--accent)}
.search-box input{background:none;border:none;outline:none;color:var(--text);font-size:13px;width:100%;font-family:inherit}
.search-box svg{width:16px;height:16px;color:var(--text2);flex-shrink:0}

/* ── TABLE ── */
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;flex:1;box-shadow:0 1px 2px rgba(60,64,67,.08)}
table{width:100%;border-collapse:collapse}
thead{position:sticky;top:0;z-index:2}
th{background:var(--surface2);text-align:left;padding:10px 16px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--text2);border-bottom:1px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none}
th:hover{color:var(--text)}
td{padding:12px 16px;border-bottom:1px solid var(--border);font-size:13px;white-space:nowrap}
table{will-change:auto;contain:layout style}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(26,115,232,.04)}
tr.row-selected td{background:rgba(26,115,232,.08)}

/* ── CHECKBOX ── */
th.col-check,td.col-check{width:40px;text-align:center;padding:10px 8px 10px 14px}
.row-checkbox{width:16px;height:16px;accent-color:var(--accent);cursor:pointer}

/* ── BULK ACTIONS BAR ── */
.bulk-bar{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px 20px;display:none;align-items:center;gap:16px;z-index:95;box-shadow:0 2px 12px rgba(60,64,67,.15);backdrop-filter:blur(8px)}
.bulk-bar.active{display:flex}
.bulk-bar .bulk-count{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap}
.bulk-bar .bulk-sep{width:1px;height:24px;background:var(--border)}
.bulk-bar .btn-danger{background:var(--red-bg);color:var(--red);border:1px solid rgba(255,118,117,.2)}
.bulk-bar .btn-danger:hover{background:rgba(255,118,117,.2)}

.company-cell{display:flex;align-items:center;gap:10px}
.row-star{background:none;border:none;cursor:pointer;font-size:16px;color:var(--border);padding:0 2px;transition:.15s;flex-shrink:0;line-height:1}
.row-star:hover{color:#f5a623}
.row-star.active{color:#f5a623}
.company-logo{width:32px;height:32px;border-radius:8px;display:grid;place-items:center;font-weight:700;font-size:13px;color:#fff;flex-shrink:0;overflow:hidden;position:relative}
.company-logo img{width:100%;height:100%;object-fit:contain;position:absolute;inset:0;background:#fff;padding:3px;border-radius:inherit}
.company-info{display:flex;flex-direction:column}
.company-name{font-weight:600;color:var(--text)}
.company-domain{font-size:11px;color:var(--text2)}

.contact-cell{display:flex;align-items:center;gap:8px}
.avatar{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;font-weight:600;font-size:10px;color:#fff;flex-shrink:0;overflow:hidden;position:relative}
.avatar img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;border-radius:inherit}
.contact-name{font-weight:500}
.contact-title{font-size:10px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.linkedin-link{display:inline-flex;align-items:center;gap:3px;color:#0a66c2;font-size:10px;text-decoration:none;font-weight:500;transition:.15s;flex-shrink:0}
.linkedin-link:hover{text-decoration:underline}
.linkedin-link svg{width:12px;height:12px}
[data-placeholder]:empty::before{content:attr(data-placeholder);color:var(--text2);opacity:.5;font-style:italic}

.badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-hot{background:var(--green-bg);color:var(--green)}
.badge-warm{background:var(--orange-bg);color:var(--orange)}
.badge-cold{background:var(--blue-bg);color:var(--blue)}

.email-bar{display:flex;align-items:center;gap:6px;font-size:12px}
.bar-track{width:80px;height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;display:flex}
.bar-sent{background:var(--accent);height:100%;border-radius:3px 0 0 3px}
.bar-recv{background:var(--green);height:100%;border-radius:0 3px 3px 0}

.trend-spark{display:flex;align-items:end;gap:2px;height:24px}
.trend-spark .bar{width:4px;border-radius:2px;background:var(--accent);opacity:.6;transition:.15s}
.trend-spark .bar:last-child{opacity:1}

.ai-score{display:flex;align-items:center;gap:6px}
.score-num{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;font-weight:700;font-size:11px;border:3px solid}
.score-ring{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;font-weight:700;font-size:11px;position:relative}
.score-ring svg{position:absolute;inset:0;transform:rotate(-90deg)}
.score-ring circle{fill:none;stroke-width:3}
.score-ring .track{stroke:var(--surface2)}
.score-ring .fill{stroke-linecap:round}
.show-more-row td{text-align:center;padding:12px;cursor:pointer;color:var(--accent);font-weight:600;font-size:13px}
.show-more-row:hover td{background:rgba(26,115,232,.04)}

/* ── COLUMN MANAGEMENT ── */
.col-mgr-wrap{position:relative;display:inline-block}
.col-mgr-drop{position:absolute;top:100%;right:0;margin-top:6px;background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:0 4px 24px rgba(60,64,67,.15);width:300px;max-height:460px;overflow-y:auto;z-index:120;display:none;padding:12px 0}
.col-mgr-drop.open{display:block}
.col-mgr-section{padding:4px 16px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--text2);margin-top:8px}
.col-mgr-section:first-child{margin-top:0}
.col-mgr-item{display:flex;align-items:center;gap:10px;padding:7px 16px;font-size:13px;cursor:pointer;transition:.1s}
.col-mgr-item:hover{background:var(--surface2)}
.col-mgr-item input[type=checkbox]{accent-color:var(--accent);width:15px;height:15px;cursor:pointer}
.col-mgr-item .col-label{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.col-mgr-item .col-remove{color:var(--red);font-size:16px;line-height:1;cursor:pointer;opacity:0;transition:.15s;padding:0 2px}
.col-mgr-item:hover .col-remove{opacity:1}
.col-mgr-add{display:flex;align-items:center;gap:6px;padding:8px 16px;font-size:12px;color:var(--accent);font-weight:600;cursor:pointer;transition:.1s;border:none;background:none;width:100%;font-family:inherit}
.col-mgr-add:hover{background:var(--surface2)}
.col-mgr-add svg{width:14px;height:14px}
.col-mgr-presets{padding:4px 16px;display:flex;flex-wrap:wrap;gap:6px}
.col-preset-chip{padding:4px 10px;border-radius:16px;font-size:11px;font-weight:500;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text);transition:.15s}
.col-preset-chip:hover{border-color:var(--accent);color:var(--accent)}
.col-rename-input{background:var(--surface2);border:1px solid var(--accent);border-radius:4px;padding:2px 6px;font-size:11px;font-family:inherit;color:var(--text);outline:none;width:100%}
td.custom-cell{cursor:text;position:relative;min-width:80px}
td.custom-cell:hover{background:rgba(26,115,232,.04)}
td.custom-cell .cell-val{display:inline-block;min-height:16px;min-width:40px}
td.custom-cell .cell-val:empty::after{content:'—';color:var(--text2)}
td.custom-cell .cell-val.enriching{color:var(--text2);font-style:italic}
td.custom-cell input.cell-edit{background:var(--surface);border:1px solid var(--accent);border-radius:4px;padding:2px 6px;font-size:13px;font-family:inherit;color:var(--text);outline:none;width:90%}

/* ── DETAIL PANEL (full-page overlay) ── */
/* ── FULL-PAGE COMPANY DETAIL ── */
.detail-page{display:none;flex-direction:column;height:100%}
.detail-page.active{display:flex}
.dp-topbar{display:flex;align-items:center;gap:12px;padding:14px 24px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0}
.dp-topbar-back{display:flex;align-items:center;gap:6px;background:none;border:none;color:var(--accent);cursor:pointer;font-size:13px;font-weight:500;font-family:inherit;padding:6px 10px;border-radius:6px;transition:.15s}
.dp-topbar-back:hover{background:var(--surface2)}
.dp-topbar-back svg{width:16px;height:16px}
.dp-topbar-title{flex:1;font-size:15px;font-weight:700;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dp-topbar-close{background:none;border:1px solid var(--border);color:var(--text2);cursor:pointer;width:34px;height:34px;border-radius:8px;display:grid;place-items:center;flex-shrink:0;transition:.15s}
.dp-topbar-close:hover{background:var(--surface2);color:var(--text)}
.dp-topbar-close svg{width:16px;height:16px}

.dp-body{display:flex;flex:1;overflow:hidden}

/* Left: company info + relationships */
.dp-left{width:340px;min-width:280px;border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0}
.dp-left-head{padding:20px 20px 0;flex-shrink:0}
.dp-company-head{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.dp-co-logo{width:44px;height:44px;border-radius:10px;display:grid;place-items:center;font-weight:700;font-size:16px;color:#fff;flex-shrink:0;overflow:hidden;position:relative}
.dp-co-logo img{width:100%;height:100%;object-fit:contain;position:absolute;inset:0;background:#fff;padding:4px;border-radius:inherit}
.dp-co-info h2{font-size:15px;font-weight:700;letter-spacing:-.2px}
.dp-co-info .dp-domain{font-size:11px;color:var(--text2)}
.dp-co-meta{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.cp-type-select{background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:11px;font-family:inherit;cursor:pointer;outline:none;transition:border-color .15s}
.cp-type-select:hover,.cp-type-select:focus{border-color:var(--accent)}
.dp-mini-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.dp-mini-stat{background:var(--surface2);border-radius:8px;padding:8px 10px}
.dp-mini-stat .label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.4px;font-weight:600}
.dp-mini-stat .value{font-size:16px;font-weight:700;margin-top:2px}
.dp-left-contacts{flex:1;overflow-y:auto;padding:0 12px 16px}
.dp-section-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text2);margin-bottom:8px;padding:8px 8px 0;display:flex;align-items:center;gap:6px}
.dp-section-title .cnt{font-size:10px;background:var(--surface2);padding:1px 6px;border-radius:8px;color:var(--text)}
.dp-contact{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:8px;cursor:pointer;transition:.15s;margin-bottom:2px}
.dp-contact:hover{background:var(--surface2)}
.dp-contact.selected{background:var(--surface2);box-shadow:inset 3px 0 0 var(--accent)}
.dp-contact .dp-ct-avatar{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;font-weight:600;font-size:10px;color:#fff;flex-shrink:0;overflow:hidden;position:relative}
.dp-contact .dp-ct-avatar img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;border-radius:inherit}
.dp-contact .dp-ct-info{flex:1;min-width:0}
.dp-contact .dp-ct-name{font-size:12px;font-weight:600;display:flex;align-items:center;gap:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dp-contact .dp-ct-email{font-size:10px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dp-contact .dp-ct-count{font-size:11px;color:var(--text2);flex-shrink:0;font-weight:600}
.dp-star{background:none;border:none;cursor:pointer;font-size:15px;color:var(--border);padding:2px;transition:.15s;flex-shrink:0;line-height:1}
.dp-star:hover{color:var(--orange);transform:scale(1.15)}
.dp-star.active{color:var(--orange)}
.dp-primary-badge{font-size:8px;padding:1px 5px;border-radius:8px;background:var(--accent);color:#fff;font-weight:700;flex-shrink:0}
.dp-left-foot{padding:8px 20px;border-top:1px solid var(--border);flex-shrink:0}

/* Right: selected contact timeline */
.dp-right{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.dp-right-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text2);gap:8px;padding:40px}
.dp-right-empty svg{width:40px;height:40px;opacity:.3}
.dp-right-empty p{font-size:13px}
.dp-right-head{padding:16px 24px;border-bottom:1px solid var(--border);flex-shrink:0}
.dp-ct-head{display:flex;align-items:center;gap:12px;margin-bottom:0}
.dp-ct-big-avatar{width:40px;height:40px;border-radius:50%;display:grid;place-items:center;font-weight:700;font-size:14px;color:#fff;flex-shrink:0;overflow:hidden;position:relative}
.dp-ct-big-avatar img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;border-radius:inherit}
.dp-ct-head-info h2{font-size:15px;font-weight:700}
.dp-ct-head-info .dp-ct-head-email{font-size:11px;color:var(--text2)}
.dp-ct-actions{display:flex;gap:6px;margin-top:10px}
.dp-ct-actions .btn{font-size:11px;padding:5px 10px}
.dp-ct-stats-row{display:flex;gap:16px;margin-top:10px}
.dp-ct-stats-row .dp-ct-stat{font-size:11px;color:var(--text2)}
.dp-ct-stats-row .dp-ct-stat b{font-weight:700;font-size:14px;display:block;margin-bottom:1px}
.dp-right-tabs{padding:0 24px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;gap:0}
.dp-tab{padding:8px 14px;font-size:12px;font-weight:500;color:var(--text2);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;transition:.15s;font-family:inherit}
.dp-tab:hover{color:var(--text)}
.dp-tab.active{color:var(--accent2);border-bottom-color:var(--accent)}
.dp-right-timeline{flex:1;overflow-y:auto;padding:12px 24px 24px;-webkit-overflow-scrolling:touch}

/* Timeline items */
.tl-loading{display:flex;align-items:center;gap:8px;padding:16px;color:var(--text2);font-size:12px}
.tl-loading .scan-spinner{width:14px;height:14px;border-width:2px}
.tl-empty{text-align:center;padding:32px 16px;color:var(--text2);font-size:12px}
.tl-list{display:flex;flex-direction:column;gap:1px}
.tl-date-group{margin-top:12px}
.tl-date-group:first-child{margin-top:0}
.tl-date-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.4px;color:var(--text2);padding:6px 0;position:sticky;top:0;background:var(--surface);z-index:1}
.tl-item{display:flex;align-items:flex-start;gap:10px;padding:8px 10px;border-radius:6px;transition:.15s;cursor:pointer;position:relative}
.tl-item:hover{background:var(--surface2)}
.tl-icon{width:28px;height:28px;border-radius:6px;display:grid;place-items:center;flex-shrink:0}
.tl-icon.sent{background:rgba(26,115,232,.08);color:var(--accent)}
.tl-icon.received{background:var(--green-bg);color:var(--green)}
.tl-icon.meeting{background:var(--orange-bg);color:var(--orange)}
.tl-icon svg{width:14px;height:14px}
.tl-content{flex:1;min-width:0}
.tl-subject{font-size:12px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tl-meta{font-size:10px;color:var(--text2);margin-top:1px}
.tl-preview{font-size:11px;color:var(--text2);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tl-time{font-size:10px;color:var(--text2);flex-shrink:0;white-space:nowrap}
.tl-reply-btn{background:none;border:1px solid var(--border);color:var(--text2);cursor:pointer;padding:3px 6px;border-radius:4px;font-size:10px;flex-shrink:0;transition:.15s;font-family:inherit}
.tl-reply-btn:hover{background:var(--surface2);color:var(--text);border-color:var(--accent)}

@media(max-width:768px){
  .dp-body{flex-direction:column}
  .dp-left{width:100%;border-right:none;border-bottom:1px solid var(--border);max-height:40vh}
  .dp-right{min-height:50vh}
}

/* Outlook-style compose popup */
.compose-popup{position:fixed;z-index:300;display:none;flex-direction:column;background:var(--surface);border:1px solid var(--border);border-radius:10px 10px 0 0;box-shadow:0 8px 40px rgba(0,0,0,.22);overflow:hidden;transition:box-shadow .2s}
.compose-popup.active{display:flex}
.compose-popup.cp-normal{bottom:0;right:24px;width:520px;max-width:calc(100vw - 48px);height:480px}
.compose-popup.cp-fullscreen{inset:0;width:100%;height:100%;border-radius:0}
.compose-popup.cp-minimized{bottom:0;right:24px;width:320px;height:auto;cursor:pointer;border-radius:10px 10px 0 0}
.compose-popup.cp-minimized .compose-fields,.compose-popup.cp-minimized .compose-body,.compose-popup.cp-minimized .compose-footer{display:none}
.compose-popup .compose-titlebar{display:flex;align-items:center;padding:0 6px 0 16px;height:40px;background:var(--accent);color:#fff;flex-shrink:0;cursor:default;user-select:none;gap:6px}
.compose-popup .compose-titlebar .cp-title{flex:1;font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.compose-popup .compose-titlebar .cp-btn{background:none;border:none;color:rgba(255,255,255,.85);cursor:pointer;width:30px;height:30px;display:grid;place-items:center;border-radius:4px;transition:.12s;padding:0}
.compose-popup .compose-titlebar .cp-btn:hover{background:rgba(255,255,255,.18);color:#fff}
.compose-popup .compose-titlebar .cp-btn.cp-close:hover{background:#e81123;color:#fff}

/* ── EMAIL VIEWER — slide-over panel ── */
.ev-overlay{position:fixed;inset:0;z-index:200;display:none;pointer-events:none}
.ev-overlay.active{display:block;pointer-events:auto}
.ev-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.25);backdrop-filter:blur(3px);opacity:0;transition:opacity .25s}
.ev-overlay.active .ev-backdrop{opacity:1}
.ev-panel{position:absolute;top:0;right:0;bottom:0;width:min(780px,100vw);background:var(--surface);border-left:1px solid var(--border);box-shadow:-4px 0 32px rgba(60,64,67,.12);display:flex;flex-direction:column;transform:translateX(100%);transition:transform .25s ease}
.ev-overlay.active .ev-panel{transform:translateX(0)}

.ev-toolbar{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;border-bottom:1px solid var(--border);gap:12px;flex-shrink:0}
.ev-back-btn{display:flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;border:none;background:none;cursor:pointer;color:var(--text);transition:.15s}
.ev-back-btn:hover{background:var(--surface2)}
.ev-toolbar-actions{display:flex;align-items:center;gap:6px}
.ev-action-btn{display:inline-flex;align-items:center;gap:5px;padding:7px 14px;border-radius:8px;border:1px solid var(--border);background:var(--surface);font-size:13px;color:var(--text);cursor:pointer;transition:.15s;font-family:inherit}
.ev-action-btn:hover{background:var(--surface2);border-color:var(--ms-blue);color:var(--ms-blue)}

.ev-scroll{flex:1;overflow-y:auto;padding:0}
.ev-subject{font-size:22px;font-weight:700;padding:24px 28px 8px;color:var(--text);line-height:1.3;margin:0}
.ev-sender-card{display:flex;align-items:flex-start;gap:12px;padding:12px 28px 16px;border-bottom:1px solid var(--border)}
.ev-avatar{width:40px;height:40px;border-radius:50%;background:var(--ms-blue);display:grid;place-items:center;font-size:16px;font-weight:600;color:#fff;flex-shrink:0}
.ev-sender-info{flex:1;min-width:0}
.ev-from{font-size:14px;font-weight:600;color:var(--text)}
.ev-from span{font-weight:400;color:var(--text2);font-size:12px;margin-left:6px}
.ev-to{font-size:12px;color:var(--text2);margin-top:2px}
.ev-date{font-size:12px;color:var(--text2);white-space:nowrap;flex-shrink:0;padding-top:2px}

.ev-attachments{padding:12px 28px;border-bottom:1px solid var(--border);display:flex;flex-wrap:wrap;gap:8px}
.ev-att-chip{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;font-size:12px;color:var(--text);cursor:pointer;text-decoration:none;transition:.15s}
.ev-att-chip:hover{background:var(--ms-blue);color:#fff;border-color:var(--ms-blue)}
.ev-att-chip svg{flex-shrink:0}

.ev-body-wrap{flex:1;min-height:400px;padding:0}
.ev-body-frame{width:100%;height:100%;min-height:400px;border:none;background:#fff}
.ev-loading{display:none;padding:60px 28px;color:var(--text2);font-size:14px}
.ev-loading.active{display:flex;align-items:center;justify-content:center;gap:12px}
.compose-fields{padding:10px 16px;display:flex;flex-direction:column;gap:6px;border-bottom:1px solid var(--border)}
.compose-field{display:flex;align-items:center;gap:8px;font-size:12px}
.compose-field label{color:var(--text2);min-width:32px;font-weight:500}
.compose-field input{flex:1;background:none;border:none;outline:none;color:var(--text);font-size:13px;font-family:inherit;padding:4px 0}
.compose-body{flex:1;padding:0;overflow:auto}
.compose-body textarea{width:100%;height:100%;background:none;border:none;outline:none;color:var(--text);font-size:13px;font-family:inherit;padding:14px 16px;resize:none;line-height:1.6;box-sizing:border-box}
.compose-footer{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-top:1px solid var(--border);flex-shrink:0}
.compose-footer .btn-send{background:var(--accent);color:#fff;font-weight:600;padding:7px 20px;border-radius:8px;border:none;font-size:13px;cursor:pointer;font-family:inherit;transition:.15s}
.compose-footer .btn-send:hover{background:#1557b0}
.compose-footer .btn-send:disabled{opacity:.5;cursor:not-allowed}

/* ── SETTINGS MODAL ── */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:200;display:none;place-items:center;backdrop-filter:blur(4px)}
.modal-overlay.active{display:grid}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px;width:520px;max-width:90vw;max-height:90vh;overflow-y:auto;box-shadow:0 4px 24px rgba(60,64,67,.15)}
.modal h2{font-size:20px;font-weight:700;margin-bottom:8px}
.modal p{color:var(--text2);font-size:13px;margin-bottom:16px;line-height:1.5}
.modal label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;margin-top:16px}
.modal input[type=text]{width:100%;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;font-family:inherit;outline:none}
.modal input[type=text]:focus{border-color:var(--accent)}
.modal .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:24px}
.modal .help-text{font-size:11px;color:var(--text2);margin-top:6px;line-height:1.5}
.modal .steps{text-align:left;background:var(--surface2);border-radius:10px;padding:16px;margin-top:12px}
.modal .steps ol{margin:0;padding-left:20px;display:flex;flex-direction:column;gap:8px;font-size:13px;color:var(--text);line-height:1.5}
.modal .steps code{background:#e8eaed;padding:2px 6px;border-radius:4px;font-size:12px;color:var(--accent2)}

/* ── BLOCKED DOMAIN TAGS ── */
.blocked-tag{display:inline-flex;align-items:center;gap:4px;background:var(--red-bg);color:var(--red);border:1px solid rgba(255,118,117,.2);border-radius:6px;padding:3px 8px 3px 10px;font-size:11px;font-weight:500}
.blocked-tag button{background:none;border:none;color:var(--red);cursor:pointer;padding:0 2px;font-size:14px;line-height:1;opacity:.7;transition:.15s}
.blocked-tag button:hover{opacity:1}

/* ── AI CHAT PANEL (inline on dashboard) ── */
.ai-panel{background:var(--surface);border:1px solid var(--border);border-radius:12px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 1px 3px rgba(60,64,67,.12);min-height:200px;max-height:480px}
.ai-panel-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;font-weight:600;font-size:14px;background:linear-gradient(135deg,rgba(26,115,232,.07),rgba(156,39,176,.04))}
.ai-panel-header .ai-icon{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#1a73e8,#7c4dff);display:grid;place-items:center;flex-shrink:0}
.ai-panel-header .ai-icon svg{width:16px;height:16px;color:#fff}
.ai-panel-header .dot{width:7px;height:7px;border-radius:50%;background:var(--green);flex-shrink:0}
.ai-panel-header .ai-panel-title{flex:1}
.ai-panel-header .ai-panel-subtitle{font-size:11px;font-weight:400;color:var(--text2)}
.ai-panel-header .ai-clear-btn{background:none;border:1px solid var(--border);border-radius:6px;padding:4px 10px;font-size:11px;color:var(--text2);cursor:pointer;font-family:inherit;transition:.15s}
.ai-panel-header .ai-clear-btn:hover{border-color:var(--accent);color:var(--accent)}
.ai-panel-suggestions{display:flex;gap:8px;padding:12px 18px;border-bottom:1px solid var(--border);flex-wrap:wrap}
.ai-panel-suggestions button{background:var(--surface2);border:1px solid var(--border);border-radius:18px;padding:6px 14px;font-size:12px;color:var(--text2);cursor:pointer;font-family:inherit;transition:.15s;white-space:nowrap}
.ai-panel-suggestions button:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.ai-panel-messages{flex:1;padding:16px;display:flex;flex-direction:column;gap:12px;overflow-y:auto;min-height:80px}
.ai-msg{max-width:90%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.6}
.ai-msg.bot{background:var(--surface2);align-self:flex-start;border-bottom-left-radius:4px}
.ai-msg.bot b{color:var(--accent2)}
.ai-msg.bot .ai-result-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px 10px;margin:6px 0 2px;font-size:12px;line-height:1.5}
.ai-msg.bot .ai-result-card+.ai-result-card{margin-top:4px}
.ai-msg.bot .ai-result-label{font-size:10px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.ai-msg.user{background:var(--accent);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.ai-typing{display:flex;gap:4px;padding:10px 14px;align-self:flex-start}
.ai-typing span{width:6px;height:6px;border-radius:50%;background:var(--text2);animation:aiBounce .6s infinite alternate}
.ai-typing span:nth-child(2){animation-delay:.2s}
.ai-typing span:nth-child(3){animation-delay:.4s}
@keyframes aiBounce{to{opacity:.3;transform:translateY(-4px)}}
.ai-panel-input{display:flex;border-top:1px solid var(--border);padding:10px;gap:8px}
.ai-panel-input input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-size:13px;font-family:inherit;outline:none;transition:.15s}
.ai-panel-input input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(26,115,232,.1)}
.ai-panel-input button{background:linear-gradient(135deg,#1a73e8,#7c4dff);border:none;cursor:pointer;padding:0 14px;color:#fff;border-radius:8px;transition:.15s;display:grid;place-items:center}
.ai-panel-input button:hover{opacity:.9}

.crm-content{display:none;flex-direction:column;gap:20px;flex:1}
.crm-content.active{display:flex}

/* ── INBOX VIEW (Outlook-style) ── */
.inbox-view{display:none;flex-direction:column;flex:1;overflow:hidden;background:var(--surface);border-radius:12px;border:1px solid var(--border);box-shadow:0 1px 2px rgba(60,64,67,.08)}
.inbox-view.active{display:flex}
.inbox-toolbar{display:flex;align-items:center;gap:8px;padding:10px 16px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--surface)}
.inbox-toolbar h2{font-size:16px;font-weight:600;color:var(--text);margin:0;margin-right:auto}
.inbox-toolbar .inbox-count-label{font-size:12px;color:var(--text2);margin-right:8px}
.inbox-tb-btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:6px;border:1px solid var(--border);background:var(--surface);font-size:12px;color:var(--text2);cursor:pointer;transition:.15s;font-family:inherit}
.inbox-tb-btn:hover{background:var(--surface2);color:var(--text);border-color:var(--text2)}
.inbox-tb-btn.danger:hover{background:var(--red-bg);color:var(--red);border-color:var(--red)}
.inbox-tb-btn svg{width:14px;height:14px;flex-shrink:0}
.inbox-tb-divider{width:1px;height:24px;background:var(--border)}
.inbox-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);flex-shrink:0;padding:0 16px;background:var(--surface)}
.inbox-tab{padding:9px 16px;font-size:12px;font-weight:500;color:var(--text2);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;transition:.15s;font-family:inherit}
.inbox-tab:hover{color:var(--text)}
.inbox-tab.active{color:var(--accent2);border-bottom-color:var(--accent);font-weight:600}
.inbox-tab .tab-badge{background:var(--accent);color:#fff;border-radius:10px;padding:1px 6px;font-size:10px;font-weight:700;margin-left:5px}
.inbox-list{flex:1;overflow-y:auto}
.inbox-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text2);gap:10px;padding:60px 40px}
.inbox-empty svg{width:40px;height:40px;opacity:.3}
.inbox-empty p{font-size:14px;font-weight:500}
.inbox-empty span{font-size:12px;max-width:280px;text-align:center;line-height:1.5}
.inbox-date-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text2);padding:12px 16px 4px;position:sticky;top:0;background:var(--surface);z-index:1;border-bottom:1px solid var(--border)}
.inbox-row{display:flex;align-items:center;gap:0;padding:0;border-bottom:1px solid rgba(218,220,224,.5);cursor:pointer;transition:background .1s;position:relative;min-height:54px}
.inbox-row:hover{background:var(--surface2)}
.inbox-row.selected{background:rgba(26,115,232,.06)}
.inbox-row.unread{font-weight:600}
.inbox-row.unread::before{content:'';position:absolute;left:0;top:14px;bottom:14px;width:3px;background:var(--accent);border-radius:0 2px 2px 0}
.inbox-row .inbox-check{width:40px;display:grid;place-items:center;flex-shrink:0;padding:0 4px 0 12px}
.inbox-row .inbox-check input{width:15px;height:15px;cursor:pointer;accent-color:var(--accent)}
.inbox-row-avatar{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;font-size:12px;font-weight:600;color:#fff;flex-shrink:0;margin-right:10px}
.inbox-row-from{width:180px;min-width:120px;padding:8px 8px 8px 0;font-size:13px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:0}
.inbox-row-from .from-company{font-size:11px;color:var(--text2);font-weight:400;display:block;margin-top:1px}
.inbox-row-content{flex:1;min-width:0;padding:8px 12px;display:flex;flex-direction:column;gap:1px}
.inbox-row-subject{font-size:13px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.inbox-row-preview{font-size:12px;color:var(--text2);font-weight:400;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.inbox-row-meta{width:90px;flex-shrink:0;padding:8px 12px 8px 0;text-align:right;font-size:11px;color:var(--text2)}
.inbox-row-time{white-space:nowrap}
.inbox-row-actions{display:none;gap:2px;margin-top:4px}
.inbox-row:hover .inbox-row-actions{display:flex;justify-content:flex-end}
.inbox-row:hover .inbox-row-time{display:none}
.inbox-act{background:none;border:none;width:26px;height:26px;border-radius:6px;display:grid;place-items:center;cursor:pointer;color:var(--text2);transition:.12s}
.inbox-act:hover{background:var(--surface2);color:var(--text)}
.inbox-act.act-delete:hover{color:var(--red)}
.inbox-act.act-archive:hover{color:var(--green)}
.inbox-badge-new{background:#e8453c;color:#fff;font-size:10px;font-weight:700;padding:3px 8px;border-radius:10px;display:inline-flex;align-items:center}
.sidebar-item.inbox-item-nav{border:1px solid transparent;margin-bottom:4px}
.sidebar-item.inbox-item-nav.active{background:linear-gradient(135deg,rgba(91,156,246,.15),rgba(91,156,246,.08));border-color:rgba(91,156,246,.25)}

.ai-insight{background:linear-gradient(135deg,rgba(26,115,232,.06),rgba(26,115,232,.03));border:1px solid rgba(26,115,232,.15);border-radius:8px;padding:10px;margin-top:8px;display:flex;gap:8px}
.ai-insight svg{width:16px;height:16px;color:var(--accent2);flex-shrink:0;margin-top:2px}
.ai-insight p{font-size:12px;line-height:1.4;color:var(--text)}
.ai-insight .label{font-size:10px;font-weight:600;color:var(--accent2);margin-bottom:2px}


/* ── RESPONSIVE ── */
@media(max-width:900px){
  .sidebar{display:none}
  .stats{grid-template-columns:repeat(2,1fr)}
}
@media(max-width:600px){
  .stats{grid-template-columns:1fr}
  .search-box{width:100%}
  .global-search-wrap{margin:0 8px;max-width:none}
  .toolbar{flex-direction:column;align-items:stretch}
  .compose-box{width:100%;max-width:100%;border-radius:0;max-height:100vh}
  .ev-panel{width:100vw}
  .ev-subject{font-size:18px;padding:16px 16px 6px}
  .ev-sender-card{padding:10px 16px 12px}
  .ev-attachments{padding:10px 16px}
}
</style>
</head>
<body>

<!-- TOP BAR -->
<header class="topbar">
  <div class="logo">
    <svg viewBox="0 0 28 28" fill="none"><rect width="28" height="28" rx="7" fill="#1a73e8"/><path d="M8 14l4 4 8-8" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    Kennion CRM
  </div>
  <div class="global-search-wrap" id="globalSearchWrap">
    <div class="global-search-box">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" id="globalSearchInput" placeholder="Search companies, contacts..." autocomplete="off">
      <kbd class="global-search-kbd">/</kbd>
    </div>
    <div class="global-search-dropdown" id="globalSearchDropdown"></div>
  </div>
  <div class="topbar-actions" id="topbarActions">
    <button class="btn btn-ghost btn-sm" id="settingsBtn" onclick="openSettings()" style="display:none" title="Configure Azure App">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.32 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      Settings
    </button>
    <button class="btn btn-ms btn-sm" id="scanOutlookBtn" onclick="scanOutlookEmails()" style="display:none">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
      Sync Emails
    </button>
    <button class="btn btn-ghost btn-sm" id="exportBtn" onclick="exportCSV()" style="display:none">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Export CSV
    </button>
    <div class="user-pill" id="userPill" style="display:none">
      <span class="dot"></span>
      <span id="userName">user@outlook.com</span>
    </div>
    <button class="btn btn-ghost btn-sm" id="signOutBtn" onclick="signOut()" style="display:none">Sign Out</button>
  </div>
</header>

<div class="layout">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar" style="display:none">
    <div class="sidebar-collapse-row">
      <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
    </div>
    <div class="sidebar-item inbox-item-nav" id="inboxNavItem" onclick="showInbox()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/></svg>
      Inbox
      <span class="sidebar-badge inbox-badge-new" id="inboxCount" style="display:none"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:10px;height:10px;vertical-align:middle;margin-right:3px"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg><span id="inboxCountNum">0</span></span>
    </div>
    <div class="sidebar-item" id="proposalNavItem" onclick="showProposals()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
      Proposals
      <span class="sidebar-badge" id="proposalCount" style="background:#f5a623">0</span>
    </div>
    <div style="border-bottom:1px solid #2a2a3d;margin:8px 0"></div>
    <div class="sidebar-item active" data-group="segment" onclick="filterByStatus('all',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      All Companies
      <span class="sidebar-badge" id="companyCount">0</span>
    </div>
    <div class="sidebar-section">Segments</div>
    <div class="sidebar-item" data-group="segment" onclick="filterByStatus('Hot',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      Hot Leads
      <span class="sidebar-badge" id="hotCount" style="background:var(--green)">0</span>
    </div>
    <div class="sidebar-item" data-group="segment" onclick="filterByStatus('Warm',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      Warm Leads
      <span class="sidebar-badge" id="warmCount" style="background:var(--orange)">0</span>
    </div>
    <div class="sidebar-item" data-group="segment" onclick="filterByStatus('Cold',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 17.58A5 5 0 0018 8h-1.26A8 8 0 104 16.25"/><path d="M8 16h.01M8 20h.01M12 18h.01M12 22h.01M16 16h.01M16 20h.01"/></svg>
      Cold Leads
      <span class="sidebar-badge" id="coldCount" style="background:var(--blue)">0</span>
    </div>
    <div class="sidebar-section">Type</div>
    <div class="sidebar-item" data-group="type" onclick="filterByType('all',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3z"/><path d="M9 3v18M15 3v18M3 9h18M3 15h18"/></svg>
      All Types
      <span class="sidebar-badge" id="allTypesCount">0</span>
    </div>
    <div class="sidebar-item" data-group="type" onclick="filterByType('Lead',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
      Leads
      <span class="sidebar-badge" id="leadCount" style="background:var(--accent)">0</span>
    </div>
    <div class="sidebar-item" data-group="type" onclick="filterByType('Existing Client',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
      Existing Clients
      <span class="sidebar-badge" id="existingCount" style="background:var(--green)">0</span>
    </div>
    <div class="sidebar-item" data-group="type" onclick="filterByType('Old Client',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      Old Clients
      <span class="sidebar-badge" id="oldClientCount" style="background:var(--text3)">0</span>
    </div>
    <div class="sidebar-section">Manage</div>
    <div class="sidebar-item" id="addCompanyItem" onclick="showAddCompanyModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
      Add Company
    </div>
    <div class="sidebar-item" id="archivedViewItem" onclick="showArchivedView()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
      Archived
      <span class="sidebar-badge" id="archivedCount" style="background:#7a7a95">0</span>
    </div>
    <div class="sidebar-item" id="blockedViewItem" onclick="showBlockedView()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
      Blocked
      <span class="sidebar-badge" id="blockedCount" style="background:var(--red)">0</span>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">
    <!-- WELCOME / SIGN IN -->
    <div class="welcome-screen" id="welcomeScreen">
      <div class="welcome-card">
        <h1>Welcome to Kennion CRM</h1>
        <p class="subtitle">AI-powered CRM that scans your Outlook emails to automatically build your sales pipeline. Zero data entry.</p>

        <button class="ms-btn" onclick="signIn()">
          <svg viewBox="0 0 21 21"><rect x="1" y="1" width="9" height="9" fill="#f25022"/><rect x="11" y="1" width="9" height="9" fill="#7fba00"/><rect x="1" y="11" width="9" height="9" fill="#00a4ef"/><rect x="11" y="11" width="9" height="9" fill="#ffb900"/></svg>
          Sign in with Microsoft
        </button>

        <div class="welcome-features">
          <div class="welcome-feat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            <div><span class="feat-title">Email Scanning</span><span class="feat-desc">Reads your Outlook inbox automatically</span></div>
          </div>
          <div class="welcome-feat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/></svg>
            <div><span class="feat-title">Auto Companies</span><span class="feat-desc">Creates companies from email domains</span></div>
          </div>
          <div class="welcome-feat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
            <div><span class="feat-title">Email Tracking</span><span class="feat-desc">Sent vs received per company</span></div>
          </div>
          <div class="welcome-feat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            <div><span class="feat-title">AI Scoring</span><span class="feat-desc">Smart lead scoring from engagement</span></div>
          </div>
        </div>

        <p class="welcome-note">First time? You'll need an Azure App registration. Click the gear icon after sign-in to configure, or <a href="#" onclick="openSettings();return false" style="color:var(--accent2)">set it up now</a>.</p>
      </div>
    </div>

    <!-- CRM CONTENT (shown after sign-in) -->
    <div class="crm-content" id="crmContent">
      <!-- CONNECTED ACCOUNT BAR -->
      <div class="account-bar" id="accountBar" style="display:none">
        <div class="account-bar-left">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          <span class="account-email" id="accountEmail"></span>
          <span class="sync-badge" id="syncBadge">
            <span class="sync-dot"></span>
            <span id="syncBadgeText">Connected</span>
          </span>
        </div>
        <div class="account-bar-right">
          <span class="last-sync-text" id="lastSyncText"></span>
          <button class="btn btn-ghost btn-xs" id="accountSyncBtn" onclick="scanOutlookEmails()" title="Sync now">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
            Sync
          </button>
        </div>
      </div>

      <!-- STATS -->
      <div class="stats">
        <div class="stat-card">
          <span class="stat-label">Total Companies</span>
          <span class="stat-value" id="statCompanies">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Emails Sent</span>
          <span class="stat-value" id="statSent">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Emails Received</span>
          <span class="stat-value" id="statRecv">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Top Contacts</span>
          <span class="stat-value" id="statContacts">0</span>
        </div>
      </div>

      <!-- AI CHAT PANEL -->
      <div class="ai-panel" id="aiPanel">
        <div class="ai-panel-header">
          <span class="ai-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></span>
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:8px"><span class="ai-panel-title">Kennion AI</span><span class="dot"></span></div>
            <div class="ai-panel-subtitle">Search companies, contacts, emails &amp; insights</div>
          </div>
          <button class="ai-clear-btn" onclick="clearAIChat()">Clear</button>
        </div>
        <div class="ai-panel-suggestions" id="aiSuggestions">
          <button onclick="askAISuggestion('Who should I follow up with?')">Follow-ups</button>
          <button onclick="askAISuggestion('Show me hot leads')">Hot Leads</button>
          <button onclick="askAISuggestion('Show cold leads at risk')">At Risk</button>
          <button onclick="askAISuggestion('Give me a pipeline summary')">Summary</button>
          <button onclick="askAISuggestion('Search contacts at google')">Search Contacts</button>
          <button onclick="askAISuggestion('Find companies in technology')">By Industry</button>
        </div>
        <div class="ai-panel-messages" id="aiMessages">
          <div class="ai-msg bot">I can search your entire CRM — companies, contacts, emails, engagement scores, and enrichment data. Try asking me anything:<br><br>• <b>"Find contacts at Microsoft"</b><br>• <b>"Who has the highest engagement?"</b><br>• <b>"Show companies in healthcare"</b><br>• <b>"Search emails about proposal"</b><br>• <b>"Which leads went cold this month?"</b></div>
        </div>
        <div class="ai-panel-input">
          <input type="text" id="aiInput" placeholder="Search your CRM... ask anything" onkeydown="if(event.key==='Enter')sendAI()">
          <button onclick="sendAI()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
        </div>
      </div>

      <!-- TOOLBAR -->
      <div class="toolbar">
        <div class="toolbar-left">
          <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" id="searchInput" placeholder="Search companies, contacts...">
          </div>
        </div>
        <div class="toolbar-right">
          <button class="btn btn-ghost btn-sm" onclick="sortTable('sent')">Sort: Most Emails</button>
          <div class="col-mgr-wrap">
            <button class="btn btn-ghost btn-sm" onclick="toggleColumnManager()" id="colMgrBtn">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
              Columns
            </button>
            <div class="col-mgr-drop" id="colMgrDrop"></div>
          </div>
        </div>
      </div>

      <!-- TABLE -->
      <div class="table-wrap">
        <table>
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- INBOX VIEW -->
    <div class="inbox-view" id="inboxView">
      <div class="inbox-toolbar">
        <h2>Inbox</h2>
        <span class="inbox-count-label" id="inboxTopCount"></span>
        <button class="inbox-tb-btn" onclick="inboxArchiveSelected()" id="inboxArchiveBtn" style="display:none" title="Archive selected">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
          Archive
        </button>
        <button class="inbox-tb-btn danger" onclick="inboxDeleteSelected()" id="inboxDeleteBtn" style="display:none" title="Delete selected">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
          Delete
        </button>
        <span class="inbox-tb-divider"></span>
        <button class="inbox-tb-btn" onclick="refreshInbox()" title="Refresh">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
        </button>
      </div>
      <div class="inbox-tabs">
        <button class="inbox-tab active" onclick="switchInboxTab('all',this)">Focused <span class="tab-badge" id="inboxTabAll" style="display:none">0</span></button>
        <button class="inbox-tab" onclick="switchInboxTab('unread',this)">Unread <span class="tab-badge" id="inboxTabNew" style="display:none">0</span></button>
      </div>
      <div class="inbox-list" id="inboxList">
        <div class="inbox-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/></svg>
          <p>Your inbox is clear</p>
          <span>Emails from leads in your CRM will show here — only active emails from your Outlook inbox</span>
        </div>
      </div>
    </div>

    <!-- FULL-PAGE COMPANY DETAIL -->
    <div class="detail-page" id="detailPage">
      <div class="dp-topbar">
        <button class="dp-topbar-back" onclick="closePanel()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
          All Companies
        </button>
        <div class="dp-topbar-title" id="dpTopbarTitle"></div>
        <button class="dp-topbar-close" onclick="closePanel()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      </div>
      <div class="dp-body">
        <div class="dp-left">
          <div class="dp-left-head" id="dpLeftHead"></div>
          <div class="dp-left-contacts" id="dpLeftContacts"></div>
          <div class="dp-left-foot" id="dpLeftFoot"></div>
        </div>
        <div class="dp-right" id="dpRight">
          <div class="dp-right-empty" id="dpRightEmpty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
            <p>Select a contact to view their history</p>
          </div>
          <div class="dp-right-head" id="dpRightHead" style="display:none"></div>
          <div class="dp-right-tabs" id="dpRightTabs" style="display:none"></div>
          <div class="dp-right-timeline" id="dpTimeline" style="display:none"></div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- BULK ACTIONS BAR -->
<div class="bulk-bar" id="bulkBar">
  <span class="bulk-count" id="bulkCount">0 selected</span>
  <div class="bulk-sep"></div>
  <select class="cp-type-select" id="bulkTypeSelect" onchange="bulkSetType(this.value);this.selectedIndex=0" style="font-size:12px;padding:5px 10px">
    <option value="" disabled selected>Set Type...</option>
    <option value="Lead">Lead</option>
    <option value="Existing Client">Existing Client</option>
    <option value="Old Client">Old Client</option>
  </select>
  <div class="bulk-sep"></div>
  <button class="btn btn-ghost btn-sm" onclick="bulkStarSelected()" style="color:#f5a623;border-color:#f5a623">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
    Star
  </button>
  <button class="btn btn-ghost btn-sm" onclick="bulkArchiveSelected()">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
    Archive
  </button>
  <button class="btn btn-sm btn-danger" onclick="bulkBlockSelected()">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
    Block
  </button>
  <button class="btn btn-ghost btn-sm" onclick="clearSelection()">Cancel</button>
</div>

<!-- COMPOSE EMAIL MODAL -->
<!-- Outlook-style compose popup -->
<div class="compose-popup cp-normal" id="composePopup">
  <div class="compose-titlebar" id="composeTitlebar">
    <span class="cp-title" id="composeTitle">New Email</span>
    <button class="cp-btn" onclick="composeMinimize()" title="Minimize"><svg width="14" height="14" viewBox="0 0 14 14" fill="none"><line x1="2" y1="11" x2="12" y2="11" stroke="currentColor" stroke-width="1.6"/></svg></button>
    <button class="cp-btn" onclick="composeToggleMax()" id="composeMaxBtn" title="Maximize"><svg width="14" height="14" viewBox="0 0 14 14" fill="none"><rect x="2" y="2" width="10" height="10" rx="1.5" stroke="currentColor" stroke-width="1.4"/></svg></button>
    <button class="cp-btn cp-close" onclick="composeClose()" title="Close"><svg width="14" height="14" viewBox="0 0 14 14" fill="none"><line x1="3" y1="3" x2="11" y2="11" stroke="currentColor" stroke-width="1.6"/><line x1="11" y1="3" x2="3" y2="11" stroke="currentColor" stroke-width="1.6"/></svg></button>
  </div>
  <div class="compose-fields">
    <div class="compose-field"><label>To</label><input type="text" id="composeTo" readonly></div>
    <div class="compose-field"><label>Subject</label><input type="text" id="composeSubject" placeholder="Subject"></div>
  </div>
  <div class="compose-body">
    <textarea id="composeBody" placeholder="Write your message..."></textarea>
  </div>
  <div class="compose-footer">
    <span style="font-size:11px;color:var(--text2)" id="composeSendStatus"></span>
    <button class="btn-send" id="composeSendBtn" onclick="sendComposedEmail()">Send</button>
  </div>
</div>

<!-- EMAIL VIEWER — full-width slide-over panel -->
<div class="ev-overlay" id="emailViewerOverlay">
  <div class="ev-backdrop" onclick="closeEmailViewer()"></div>
  <div class="ev-panel" id="evPanel">
    <!-- Toolbar -->
    <div class="ev-toolbar">
      <button class="ev-back-btn" onclick="closeEmailViewer()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
      </button>
      <div class="ev-toolbar-actions">
        <button class="ev-action-btn" onclick="replyFromViewer()" title="Reply">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 00-4-4H4"/></svg>
          Reply
        </button>
        <button class="ev-action-btn" onclick="openInOutlook()" title="Open in Outlook">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Open in Outlook
        </button>
      </div>
    </div>

    <!-- Email content -->
    <div class="ev-scroll">
      <!-- Loading state -->
      <div class="ev-loading" id="evLoading"><div class="scan-spinner"></div> Loading email...</div>

      <!-- Subject -->
      <h1 class="ev-subject" id="evSubject"></h1>

      <!-- Sender card -->
      <div class="ev-sender-card">
        <div class="ev-avatar" id="evAvatar"></div>
        <div class="ev-sender-info">
          <div class="ev-from" id="evFrom"></div>
          <div class="ev-to" id="evTo"></div>
        </div>
        <div class="ev-date" id="evDate"></div>
      </div>

      <!-- Attachments -->
      <div class="ev-attachments" id="evAttachments" style="display:none"></div>

      <!-- Body -->
      <div class="ev-body-wrap">
        <iframe id="evBodyFrame" sandbox="allow-same-origin" class="ev-body-frame"></iframe>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <h2>Azure App Configuration</h2>
    <p>To connect your Outlook, you need a Microsoft Azure App Registration. This gives Kennion CRM permission to read your emails.</p>

    <div class="steps">
      <ol>
        <li>Go to <strong>portal.azure.com</strong> &rarr; <strong>Microsoft Entra ID</strong> &rarr; <strong>App registrations</strong></li>
        <li>Click <strong>New registration</strong>, name it "Kennion CRM"</li>
        <li>Set <strong>Redirect URI</strong> (SPA) to: <code id="redirectDisplay">https://sheph007-pixel.github.io/codex/</code></li>
        <li>Under <strong>API permissions</strong>, add: <code>Mail.Read</code>, <code>Mail.Send</code>, and <code>Files.ReadWrite.AppFolder</code> (Delegated)</li>
        <li>Click <strong>Grant admin consent</strong> (or have your admin do it)</li>
        <li>Copy the <strong>Application (client) ID</strong> and paste it below</li>
      </ol>
    </div>

    <label>Application (Client) ID</label>
    <input type="text" id="clientIdInput" placeholder="e.g. 12345678-abcd-1234-abcd-123456789abc">
    <p class="help-text">This is stored only in your browser's localStorage. Nothing is sent to any server.</p>

    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
      <label style="font-size:12px;color:var(--text2);margin-bottom:6px;display:block">Protected Domains &amp; Emails</label>
      <p class="help-text" style="margin-top:0;margin-bottom:8px">Domains and emails listed here will never appear in your CRM. Add multiple at once — one per line, or comma/space separated.</p>
      <div style="display:flex;gap:8px">
        <textarea id="blockDomainsInput" rows="3" placeholder="e.g. newsletter.com, noreply@company.com, spam.org" style="flex:1;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;font-family:inherit;outline:none;resize:vertical"></textarea>
        <button class="btn btn-primary" onclick="addBlockedDomainsFromInput()" style="align-self:flex-start;font-size:12px;white-space:nowrap">Block</button>
      </div>
      <div id="blockedDomainsList" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px"></div>
    </div>

    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
      <label style="font-size:12px;color:var(--text2);margin-bottom:6px;display:block">Cloud Sync</label>
      <p class="help-text" style="margin-top:0;margin-bottom:8px">Your data (contacts, blocked domains, settings) is automatically synced to your OneDrive so it's available on any device. You can also manually backup/restore.</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-ghost btn-sm" onclick="manualCloudSave()" id="cloudSaveBtn" style="font-size:12px">Save to Cloud Now</button>
        <button class="btn btn-ghost btn-sm" onclick="manualCloudRestore()" style="font-size:12px">Restore from Cloud</button>
        <button class="btn btn-ghost btn-sm" onclick="exportBackup()" style="font-size:12px">Export Backup File</button>
        <button class="btn btn-ghost btn-sm" onclick="document.getElementById('importBackupInput').click()" style="font-size:12px">Import Backup File</button>
        <input type="file" id="importBackupInput" accept=".json" style="display:none" onchange="importBackup(event)">
      </div>
      <p class="help-text" id="cloudSyncStatus" style="margin-top:6px"></p>
    </div>

    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
      <label style="font-size:12px;color:var(--text2);margin-bottom:6px;display:block">Data Management</label>
      <button class="btn btn-ghost" onclick="fullRescan()" style="color:var(--red);border-color:var(--red);font-size:12px">Reset &amp; Full Re-scan</button>
      <p class="help-text" style="margin-top:4px">Clears all cached data and re-scans every email from scratch.</p>
    </div>

    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeSettings()">Cancel</button>
      <button class="btn btn-primary" onclick="saveSettings()">Save & Connect</button>
    </div>
  </div>
</div>

<!-- ADD COMPANY MODAL -->
<div class="modal-overlay" id="addCompanyModal">
  <div class="modal" style="max-width:420px">
    <h2>Add Company</h2>
    <p style="color:var(--text2);font-size:13px;margin-bottom:16px">Manually add a company to your CRM pipeline.</p>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div>
        <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px">Company Name</label>
        <input type="text" id="addCompanyName" placeholder="e.g. Acme Corp" style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit">
      </div>
      <div>
        <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px">Domain</label>
        <input type="text" id="addCompanyDomain" placeholder="e.g. acme.com" style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit">
      </div>
      <div>
        <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px">Contact Email (optional)</label>
        <input type="text" id="addCompanyEmail" placeholder="e.g. john@acme.com" style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit">
      </div>
      <div>
        <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px">Type</label>
        <select id="addCompanyType" style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit">
          <option value="Lead">Lead</option>
          <option value="Existing Client">Existing Client</option>
          <option value="Old Client">Old Client</option>
        </select>
      </div>
    </div>
    <div class="modal-actions" style="margin-top:20px">
      <button class="btn btn-ghost" onclick="closeAddCompanyModal()">Cancel</button>
      <button class="btn btn-primary" onclick="addCompanyManually()">Add Company</button>
    </div>
  </div>
</div>

<script>
// ──────────────────────────────────────────────
// CONFIG & STATE
// ──────────────────────────────────────────────
const COLORS = ['#1a73e8','#1e8e3e','#e8710a','#d93025','#9334e6','#e37400','#0d652d','#185abc','#a142f4','#c5221f','#137333','#1967d2'];
const STATUS_CLASS = {Hot:'badge-hot',Warm:'badge-warm',Cold:'badge-cold'};
const SKIP_DOMAINS = new Set(['gmail.com','yahoo.com','hotmail.com','outlook.com','live.com','aol.com','icloud.com','me.com','mac.com','msn.com','googlemail.com','protonmail.com','proton.me','ymail.com','mail.com']);

let companies = [];
let domainMap = {};
let seenMsgIds = new Set(); // track processed email IDs to prevent double-counting
let lastScanTime = null;
let deltaLink = null; // Microsoft Graph delta sync token — tracks last sync position
let currentSort = {key:'sent',asc:false};
let currentFilter = 'all';
let currentTypeFilter = 'all';
let companyTypes = {}; // { "domain": "Lead" | "Existing Client" | "Old Client" }
let msalInstance = null;
let currentAccount = null;
let userEmail = '';
let isScanning = false;
let fullScanDone = false;
const AUTO_SYNC_INTERVAL = 5 * 60 * 1000; // 5 minutes
let autoSyncTimer = null;
let blockedDomains = new Set();
let starredCompanies = new Set();   // domains starred for Proposals
let archivedCompanies = new Set();  // domains archived
let selectedIds = new Set();
let starredContacts = {};  // { "domain": "email@example.com" }
let currentCompanyOverlay = null;  // company object for open overlay
let currentContactOverlay = null;  // { contact, company, domain }
let currentContactTab = 'all';
let contactTimelineCache = {};  // "email" -> [{type,subject,date,...}]

// ──────────────────────────────────────────────
// COLUMN CONFIGURATION (Attio-style)
// ──────────────────────────────────────────────
const BUILTIN_COLUMNS = [
  { id:'company', label:'Company', sortKey:'company', removable:false },
  { id:'contact', label:'Primary Contact', sortKey:'contact', removable:true },
  { id:'sent', label:'Sent', sortKey:'sent', removable:true },
  { id:'received', label:'Received', sortKey:'received', removable:true },
  { id:'emailFlow', label:'Email Ratio', sortKey:null, removable:true },
  { id:'status', label:'Status', sortKey:'status', removable:true },
  { id:'companyType', label:'Type', sortKey:'companyType', removable:true },
  { id:'score', label:'AI Score', sortKey:'score', removable:true },
  { id:'lastActivity', label:'Last Email', sortKey:'lastActivity', removable:true },
];

const AI_COLUMN_PRESETS = [
  { id:'ai_state', label:'State', enrich:'state' },
  { id:'ai_employees', label:'Employees', enrich:'employees' },
  { id:'ai_industry', label:'Industry', enrich:'industry' },
  { id:'ai_city', label:'City', enrich:'city' },
  { id:'ai_country', label:'Country', enrich:'country' },
  { id:'ai_founded', label:'Founded', enrich:'founded' },
  { id:'ai_type', label:'Type', enrich:'type' },
];

let columnConfig = [];   // [{ id, label, type:'builtin'|'custom'|'ai', visible, enrich? }]
let customColumnData = {};  // { domain: { colId: value, ... } }
let enrichmentCache = {};   // { domain: { state, employees, industry, ... } }
let enrichmentRunning = false;

function getDefaultColumns() {
  return BUILTIN_COLUMNS.map(c => ({ id: c.id, label: c.label, type: 'builtin', visible: true }));
}

function loadColumnConfig() {
  try {
    const raw = localStorage.getItem('kennion_columns');
    if (raw) {
      columnConfig = JSON.parse(raw);
      // Inject companyType column if missing (added after initial release)
      if (!columnConfig.find(c => c.id === 'companyType')) {
        const statusIdx = columnConfig.findIndex(c => c.id === 'status');
        const typeCol = { id: 'companyType', label: 'Type', type: 'builtin', visible: true };
        if (statusIdx >= 0) columnConfig.splice(statusIdx + 1, 0, typeCol);
        else columnConfig.push(typeCol);
        saveColumnConfig();
      }
      return;
    }
  } catch(e) {}
  columnConfig = getDefaultColumns();
}

function saveColumnConfig() {
  localStorage.setItem('kennion_columns', JSON.stringify(columnConfig));
  scheduleCloudSync();
}

function loadCustomColumnData() {
  try {
    const raw = localStorage.getItem('kennion_custom_data');
    if (raw) customColumnData = JSON.parse(raw);
  } catch(e) {}
}

function saveCustomColumnData() {
  localStorage.setItem('kennion_custom_data', JSON.stringify(customColumnData));
  scheduleCloudSync();
}

function loadEnrichmentCache() {
  try {
    const raw = localStorage.getItem('kennion_enrichment');
    if (raw) enrichmentCache = JSON.parse(raw);
  } catch(e) {}
}

function saveEnrichmentCache() {
  localStorage.setItem('kennion_enrichment', JSON.stringify(enrichmentCache));
}

function getVisibleColumns() {
  return columnConfig.filter(c => c.visible);
}

// ──────────────────────────────────────────────
// AI ENRICHMENT (Clearbit + heuristics)
// ──────────────────────────────────────────────
async function enrichDomain(domain) {
  // Re-enrich if state is missing (old cache before geo enrichment)
  if (enrichmentCache[domain] && enrichmentCache[domain].state) return enrichmentCache[domain];
  const result = enrichmentCache[domain] || {};
  try {
    // Use Clearbit Company API (free autocomplete endpoint)
    const query = domain.split('.')[0];
    const resp = await fetch('https://autocomplete.clearbit.com/v1/companies/suggest?query=' + encodeURIComponent(query));
    if (resp.ok) {
      const results = await resp.json();
      const match = results.find(r => r.domain === domain) || results.find(r => r.domain && r.domain.split('.')[0] === domain.split('.')[0]);
      if (match) {
        result._clearbit = match;
      }
    }
  } catch(e) {}

  // Heuristic enrichments
  const tld = domain.split('.').pop().toLowerCase();
  const sld = domain.split('.').slice(-2).join('.');
  const contactCount = domainMap[domain] ? Object.keys(domainMap[domain].contacts).length : 0;

  // Country from TLD
  const TLD_COUNTRY = {uk:'United Kingdom',de:'Germany',fr:'France',jp:'Japan',au:'Australia',ca:'Canada',br:'Brazil',in:'India',nl:'Netherlands',es:'Spain',it:'Italy',ch:'Switzerland',se:'Sweden',no:'Norway',dk:'Denmark',fi:'Finland',ie:'Ireland',nz:'New Zealand',sg:'Singapore',kr:'South Korea',mx:'Mexico',za:'South Africa',at:'Austria',be:'Belgium',pt:'Portugal',pl:'Poland',cz:'Czech Republic',il:'Israel',ae:'UAE',hk:'Hong Kong',tw:'Taiwan'};
  if (TLD_COUNTRY[tld]) {
    result.country = TLD_COUNTRY[tld];
  } else if (['com','org','net','io','co','ai','app','dev'].includes(tld)) {
    result.country = 'United States';
  }

  // Employee range from contact count heuristic
  if (contactCount >= 20) result.employees = '1,000+';
  else if (contactCount >= 10) result.employees = '200–1,000';
  else if (contactCount >= 5) result.employees = '50–200';
  else if (contactCount >= 2) result.employees = '10–50';
  else result.employees = '1–10';

  // Industry from domain keywords
  const name = domain.split('.')[0].toLowerCase();
  const IND_KEYWORDS = {tech:'Technology',soft:'Technology',dev:'Technology',code:'Technology',data:'Technology',cloud:'Technology',ai:'Technology',cyber:'Technology',health:'Healthcare',med:'Healthcare',pharma:'Healthcare',bio:'Healthcare',care:'Healthcare',bank:'Finance',capital:'Finance',invest:'Finance',financ:'Finance',insur:'Insurance',pay:'Finance',law:'Legal',legal:'Legal',consult:'Consulting',market:'Marketing',media:'Media',design:'Design',edu:'Education',learn:'Education',school:'Education',build:'Construction',real:'Real Estate',estate:'Real Estate',energy:'Energy',oil:'Energy',food:'Food & Beverage',travel:'Travel',hotel:'Hospitality',retail:'Retail',shop:'Retail',auto:'Automotive',logistic:'Logistics',ship:'Logistics',freight:'Logistics'};
  for (const [kw, ind] of Object.entries(IND_KEYWORDS)) {
    if (name.includes(kw)) { result.industry = ind; break; }
  }
  if (!result.industry) {
    if (tld === 'edu') result.industry = 'Education';
    else if (tld === 'gov') result.industry = 'Government';
    else if (tld === 'org') result.industry = 'Non-Profit';
    else if (['io','dev','app','ai'].includes(tld)) result.industry = 'Technology';
  }

  // Type
  if (tld === 'edu') result.type = 'Education';
  else if (tld === 'gov') result.type = 'Government';
  else if (tld === 'org') result.type = 'Non-Profit';
  else result.type = 'Company';

  // State & City — resolve domain IP then geolocate (free APIs, no keys)
  try {
    // Step 1: DNS resolve via Google DNS-over-HTTPS
    const dnsResp = await fetch('https://dns.google/resolve?name=' + encodeURIComponent(domain) + '&type=A');
    if (dnsResp.ok) {
      const dnsData = await dnsResp.json();
      const aRecord = dnsData.Answer && dnsData.Answer.find(a => a.type === 1);
      if (aRecord && aRecord.data) {
        // Step 2: Geolocate the IP via ipwho.is (free, HTTPS, no key)
        const geoResp = await fetch('https://ipwho.is/' + aRecord.data);
        if (geoResp.ok) {
          const geo = await geoResp.json();
          if (geo.success !== false) {
            if (geo.region) result.state = geo.region;
            if (geo.city) result.city = geo.city;
            if (geo.country && !result.country) result.country = geo.country;
          }
        }
      }
    }
  } catch(e3) {}

  enrichmentCache[domain] = result;
  return result;
}

async function runEnrichment() {
  if (enrichmentRunning) return;
  enrichmentRunning = true;
  const aiCols = columnConfig.filter(c => c.type === 'ai' && c.visible);
  if (aiCols.length === 0) { enrichmentRunning = false; return; }

  const domains = companies.map(c => c.domain).filter(d => !enrichmentCache[d] || !enrichmentCache[d].state);
  if (domains.length === 0) { enrichmentRunning = false; return; }

  // Process in batches of 5
  let changed = false;
  for (let i = 0; i < domains.length; i += 5) {
    const batch = domains.slice(i, i + 5);
    await Promise.all(batch.map(d => enrichDomain(d)));
    changed = true;
    if (i % 15 === 0 && changed) { renderTable(); }
  }
  saveEnrichmentCache();
  if (changed) renderTable();
  enrichmentRunning = false;
}

function getEnrichedValue(domain, enrichKey) {
  const data = enrichmentCache[domain];
  if (!data) return '';
  return data[enrichKey] || '';
}

function getCellValue(company, col) {
  if (col.type === 'builtin') return null; // handled specially in renderTable
  if (col.type === 'ai') {
    // Check manual override first
    if (customColumnData[company.domain] && customColumnData[company.domain][col.id] !== undefined) {
      return customColumnData[company.domain][col.id];
    }
    const preset = AI_COLUMN_PRESETS.find(p => p.id === col.id);
    return preset ? getEnrichedValue(company.domain, preset.enrich) : '';
  }
  if (col.type === 'custom') {
    return (customColumnData[company.domain] && customColumnData[company.domain][col.id]) || '';
  }
  return '';
}

// ──────────────────────────────────────────────
// CONTACT & COMPANY ENRICHMENT (photos, LinkedIn, titles)
// ──────────────────────────────────────────────
let contactEnrichment = {}; // { "email": { photo, title, linkedin, photoFailed } }
let companyLogoFailed = {}; // { "domain": true } — tracks failed logo loads

function loadContactEnrichment() {
  try {
    const raw = localStorage.getItem('kennion_contact_enrich');
    if (raw) contactEnrichment = JSON.parse(raw);
  } catch(e) {}
}

function saveContactEnrichment() {
  localStorage.setItem('kennion_contact_enrich', JSON.stringify(contactEnrichment));
}

// Company logo: Clearbit Logo API (free, no auth)
let logoFailedCache = {};
function loadLogoFailedCache() {
  try { const r = localStorage.getItem('kennion_logo_failed'); if (r) logoFailedCache = JSON.parse(r); } catch(e) {}
}
function saveLogoFailedCache() {
  localStorage.setItem('kennion_logo_failed', JSON.stringify(logoFailedCache));
}
function markLogoFailed(img, domain) {
  img.style.display = 'none';
  logoFailedCache[domain] = true;
  saveLogoFailedCache();
}
function companyLogoHTML(domain, color, name, size) {
  const sz = size || 32;
  const initial = name ? name[0].toUpperCase() : domain[0].toUpperCase();
  if (logoFailedCache[domain]) return initial;
  const imgSrc = 'https://logo.clearbit.com/' + encodeURIComponent(domain);
  return '<img src="' + imgSrc + '" alt="" loading="lazy" onerror="markLogoFailed(this,\'' + domain.replace(/'/g, "\\'") + '\')">' + initial;
}

// Contact photo: unavatar.io (aggregates Gravatar, Google, GitHub, Twitter)
function contactPhotoHTML(email, color, initials, size) {
  const sz = size || 26;
  const enrich = contactEnrichment[email.toLowerCase()];
  // If we know the photo failed, skip the img
  if (enrich && enrich.photoFailed) return esc(initials);
  const imgSrc = 'https://unavatar.io/' + encodeURIComponent(email.toLowerCase()) + '?fallback=false';
  return '<img src="' + imgSrc + '" alt="" loading="lazy" onerror="markPhotoFailed(this,\'' + email.toLowerCase().replace(/'/g, "\\'") + '\')">' + esc(initials);
}

function markPhotoFailed(img, email) {
  img.style.display = 'none';
  if (!contactEnrichment[email]) contactEnrichment[email] = {};
  contactEnrichment[email].photoFailed = true;
  saveContactEnrichment();
}

// LinkedIn search URL generators
function linkedInPersonURL(name, companyName) {
  const q = (name + (companyName ? ' ' + companyName : '')).trim();
  return 'https://www.linkedin.com/search/results/people/?keywords=' + encodeURIComponent(q);
}

function linkedInCompanyURL(domain) {
  // Try company name from domain prefix, or use known match
  const prefix = domain.split('.')[0];
  return 'https://www.linkedin.com/search/results/companies/?keywords=' + encodeURIComponent(prefix);
}

function linkedInIconSVG() {
  return '<svg viewBox="0 0 24 24" fill="#0a66c2"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>';
}

// Get or set contact title
function getContactTitle(email) {
  const e = contactEnrichment[email.toLowerCase()];
  return e && e.title ? e.title : '';
}

function setContactTitle(email, title) {
  if (!contactEnrichment[email.toLowerCase()]) contactEnrichment[email.toLowerCase()] = {};
  contactEnrichment[email.toLowerCase()].title = title;
  saveContactEnrichment();
}

// Get or set contact LinkedIn URL (manual override)
function getContactLinkedIn(email) {
  const e = contactEnrichment[email.toLowerCase()];
  return e && e.linkedin ? e.linkedin : '';
}

function setContactLinkedIn(email, url) {
  if (!contactEnrichment[email.toLowerCase()]) contactEnrichment[email.toLowerCase()] = {};
  contactEnrichment[email.toLowerCase()].linkedin = url;
  saveContactEnrichment();
}


// ──────────────────────────────────────────────
// COLUMN MANAGEMENT UI
// ──────────────────────────────────────────────
function toggleColumnManager() {
  const drop = document.getElementById('colMgrDrop');
  const isOpen = drop.classList.contains('open');
  drop.classList.toggle('open');
  if (!isOpen) renderColumnManager();
}

function renderColumnManager() {
  const drop = document.getElementById('colMgrDrop');
  let html = '<div class="col-mgr-section">Built-in Columns</div>';
  for (const col of columnConfig) {
    if (col.type === 'builtin') {
      const meta = BUILTIN_COLUMNS.find(b => b.id === col.id);
      const disabled = meta && !meta.removable ? ' disabled' : '';
      html += '<div class="col-mgr-item">' +
        '<input type="checkbox"' + (col.visible ? ' checked' : '') + disabled + ' onchange="toggleColumn(\'' + col.id + '\',this.checked)">' +
        '<span class="col-label" ondblclick="startRenameColumn(\'' + col.id + '\',this)">' + esc(col.label) + '</span>' +
      '</div>';
    }
  }

  const customCols = columnConfig.filter(c => c.type === 'ai' || c.type === 'custom');
  if (customCols.length > 0) {
    html += '<div class="col-mgr-section">Custom Columns</div>';
    for (const col of customCols) {
      html += '<div class="col-mgr-item">' +
        '<input type="checkbox"' + (col.visible ? ' checked' : '') + ' onchange="toggleColumn(\'' + col.id + '\',this.checked)">' +
        '<span class="col-label" ondblclick="startRenameColumn(\'' + col.id + '\',this)">' + esc(col.label) + '</span>' +
        '<span class="col-remove" onclick="removeColumn(\'' + col.id + '\')" title="Remove">&times;</span>' +
      '</div>';
    }
  }

  // AI preset chips
  const usedIds = new Set(columnConfig.map(c => c.id));
  const available = AI_COLUMN_PRESETS.filter(p => !usedIds.has(p.id));
  if (available.length > 0) {
    html += '<div class="col-mgr-section">Add AI Column</div>';
    html += '<div class="col-mgr-presets">';
    for (const p of available) {
      html += '<span class="col-preset-chip" onclick="addAIColumn(\'' + p.id + '\')">' + esc(p.label) + '</span>';
    }
    html += '</div>';
  }

  // Add blank custom column
  html += '<button class="col-mgr-add" onclick="addCustomColumn()">' +
    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>' +
    'Add custom column</button>';

  drop.innerHTML = html;
}

function toggleColumn(id, visible) {
  const col = columnConfig.find(c => c.id === id);
  if (col) { col.visible = visible; saveColumnConfig(); renderTableHeader(); renderTable(); }
}

function removeColumn(id) {
  columnConfig = columnConfig.filter(c => c.id !== id);
  // Clean up custom data for this column
  for (const domain of Object.keys(customColumnData)) {
    delete customColumnData[domain][id];
  }
  saveColumnConfig(); saveCustomColumnData();
  renderColumnManager(); renderTableHeader(); renderTable();
}

function addAIColumn(presetId) {
  const preset = AI_COLUMN_PRESETS.find(p => p.id === presetId);
  if (!preset) return;
  columnConfig.push({ id: preset.id, label: preset.label, type: 'ai', visible: true, enrich: preset.enrich });
  saveColumnConfig(); renderColumnManager(); renderTableHeader(); renderTable();
  // Start enrichment for this column
  runEnrichment();
}

function addCustomColumn() {
  const name = prompt('Column name:');
  if (!name || !name.trim()) return;
  const id = 'custom_' + Date.now();
  columnConfig.push({ id: id, label: name.trim(), type: 'custom', visible: true });
  saveColumnConfig(); renderColumnManager(); renderTableHeader(); renderTable();
}

function startRenameColumn(id, el) {
  const col = columnConfig.find(c => c.id === id);
  if (!col) return;
  const oldLabel = col.label;
  el.innerHTML = '<input class="col-rename-input" value="' + esc(oldLabel) + '">';
  const input = el.querySelector('input');
  input.focus();
  input.select();
  input.onblur = function() { finishRename(id, input.value, el); };
  input.onkeydown = function(e) {
    if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
    if (e.key === 'Escape') { el.textContent = oldLabel; }
  };
}

function finishRename(id, newLabel, el) {
  const col = columnConfig.find(c => c.id === id);
  if (col && newLabel.trim()) {
    col.label = newLabel.trim();
    saveColumnConfig();
    renderTableHeader();
  }
  el.textContent = col ? col.label : newLabel;
}

// Close column manager on outside click
document.addEventListener('click', function(e) {
  const drop = document.getElementById('colMgrDrop');
  if (drop && drop.classList.contains('open') && !e.target.closest('.col-mgr-wrap')) {
    drop.classList.remove('open');
  }
});

// ──────────────────────────────────────────────
// STARRED / PRIMARY CONTACTS PERSISTENCE
// ──────────────────────────────────────────────
function loadStarredContacts() {
  try {
    const raw = localStorage.getItem('relateflow_starred_contacts');
    starredContacts = raw ? JSON.parse(raw) : {};
  } catch(e) { starredContacts = {}; }
}

function saveStarredContacts() {
  localStorage.setItem('relateflow_starred_contacts', JSON.stringify(starredContacts));
  scheduleCloudSync();
}

function loadCompanyTypes() {
  try {
    const raw = localStorage.getItem('kennion_company_types');
    if (raw) companyTypes = JSON.parse(raw);
  } catch(e) { companyTypes = {}; }
}

function saveCompanyTypes() {
  localStorage.setItem('kennion_company_types', JSON.stringify(companyTypes));
  scheduleCloudSync();
}

function getCompanyType(domain) {
  return companyTypes[domain] || 'Lead';
}

function setCompanyType(domain, type) {
  companyTypes[domain] = type;
  saveCompanyTypes();
  updateTypeCounts();
  renderTable();
}

function getPrimaryContact(domain, contacts) {
  // If user has starred someone, use that
  if (starredContacts[domain]) {
    const starred = contacts.find(c => c.email === starredContacts[domain]);
    if (starred) return starred;
  }
  // Default: most interactions (already sorted by buildCompaniesFromDomainMap)
  return contacts[0];
}

// ──────────────────────────────────────────────
// BLOCKED DOMAINS PERSISTENCE (localStorage)
// ──────────────────────────────────────────────
function loadBlockedDomains() {
  try {
    const raw = localStorage.getItem('relateflow_blocked_domains');
    blockedDomains = raw ? new Set(JSON.parse(raw)) : new Set();
  } catch(e) { blockedDomains = new Set(); }
}

function saveBlockedDomains() {
  localStorage.setItem('relateflow_blocked_domains', JSON.stringify([...blockedDomains]));
  scheduleCloudSync();
}

function isBlockedDomain(domain) {
  return SKIP_DOMAINS.has(domain) || blockedDomains.has(domain);
}

// ──────────────────────────────────────────────
// STARRED COMPANIES (Proposals) PERSISTENCE
// ──────────────────────────────────────────────
function loadStarredCompanies() {
  try {
    const raw = localStorage.getItem('kennion_starred_companies');
    starredCompanies = raw ? new Set(JSON.parse(raw)) : new Set();
  } catch(e) { starredCompanies = new Set(); }
}
function saveStarredCompanies() {
  localStorage.setItem('kennion_starred_companies', JSON.stringify([...starredCompanies]));
  scheduleCloudSync();
}

// ──────────────────────────────────────────────
// ARCHIVED COMPANIES PERSISTENCE
// ──────────────────────────────────────────────
function loadArchivedCompanies() {
  try {
    const raw = localStorage.getItem('kennion_archived_companies');
    archivedCompanies = raw ? new Set(JSON.parse(raw)) : new Set();
  } catch(e) { archivedCompanies = new Set(); }
}
function saveArchivedCompanies() {
  localStorage.setItem('kennion_archived_companies', JSON.stringify([...archivedCompanies]));
  scheduleCloudSync();
}

// ──────────────────────────────────────────────
// SMART NAME FORMATTING
// ──────────────────────────────────────────────
const NAME_SMALL_WORDS = new Set(['a','an','the','and','but','or','for','nor','at','by','in','of','on','to','up','as','is','it']);

function titleCase(str) {
  if (!str) return '';
  return str.replace(/\w\S*/g, (word, index) => {
    if (index > 0 && NAME_SMALL_WORDS.has(word.toLowerCase())) return word.toLowerCase();
    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
  });
}

function formatContactName(rawName, email) {
  if (!rawName || rawName === email || rawName === email?.toLowerCase()) {
    // No real name — try to extract from email prefix
    if (!email) return 'Unknown';
    const prefix = email.split('@')[0];
    // Handle john.doe, john_doe, john-doe patterns
    const parts = prefix.split(/[._\-+]+/).filter(Boolean);
    if (parts.length >= 2 && parts.every(p => /^[a-z]+$/i.test(p))) {
      return parts.map(p => p.charAt(0).toUpperCase() + p.slice(1).toLowerCase()).join(' ');
    }
    return titleCase(prefix);
  }

  let name = rawName.trim();
  // Strip surrounding quotes
  name = name.replace(/^["']|["']$/g, '').trim();
  // Handle "Last, First" format
  if (/^[^,]+,\s*[^,]+$/.test(name)) {
    const [last, first] = name.split(',').map(s => s.trim());
    name = first + ' ' + last;
  }
  // If all uppercase or all lowercase, apply title case
  if (name === name.toUpperCase() || name === name.toLowerCase()) {
    name = titleCase(name);
  }
  // Handle mixed: only fix if first letter of each word is lowercase
  const words = name.split(/\s+/);
  name = words.map(w => {
    if (w.length <= 1) return w.toUpperCase();
    // Preserve intentional casing like "McDonald", "O'Brien", "MacLeod"
    if (/^(Mc|Mac|O')[A-Z]/.test(w)) return w;
    // If word is all-caps (initials like "CEO", "Jr", "III"), keep it
    if (w === w.toUpperCase() && w.length <= 4) return w;
    // If first char is lowercase, fix it
    if (w[0] === w[0].toLowerCase() && w[0] !== w[0].toUpperCase()) {
      return w.charAt(0).toUpperCase() + w.slice(1);
    }
    return w;
  }).join(' ');

  return name;
}

// ──────────────────────────────────────────────
// COMPANY NAME LOOKUP (Clearbit Autocomplete API)
// ──────────────────────────────────────────────
const companyNameCache = {};
let companyNameCacheDirty = false;

function loadCompanyNameCache() {
  try {
    const raw = localStorage.getItem('relateflow_company_names');
    if (raw) Object.assign(companyNameCache, JSON.parse(raw));
  } catch(e) {}
}

function saveCompanyNameCache() {
  if (!companyNameCacheDirty) return;
  try {
    localStorage.setItem('relateflow_company_names', JSON.stringify(companyNameCache));
    companyNameCacheDirty = false;
  } catch(e) {}
}

// Known brand corrections for common domains
const KNOWN_BRANDS = {
  'github.com':'GitHub','linkedin.com':'LinkedIn','youtube.com':'YouTube',
  'stackoverflow.com':'Stack Overflow','wordpress.com':'WordPress','javascript.com':'JavaScript',
  'salesforce.com':'Salesforce','hubspot.com':'HubSpot','mailchimp.com':'Mailchimp',
  'shopify.com':'Shopify','atlassian.com':'Atlassian','bitbucket.org':'Bitbucket',
  'microsoft.com':'Microsoft','apple.com':'Apple','amazon.com':'Amazon',
  'google.com':'Google','facebook.com':'Meta','twitter.com':'X (Twitter)',
  'netflix.com':'Netflix','uber.com':'Uber','airbnb.com':'Airbnb',
  'stripe.com':'Stripe','twilio.com':'Twilio','figma.com':'Figma',
  'notion.so':'Notion','slack.com':'Slack','zoom.us':'Zoom',
  'dropbox.com':'Dropbox','asana.com':'Asana','trello.com':'Trello',
  'intercom.io':'Intercom','zendesk.com':'Zendesk','freshdesk.com':'Freshdesk',
  'squarespace.com':'Squarespace','wix.com':'Wix','godaddy.com':'GoDaddy',
  'cloudflare.com':'Cloudflare','digitalocean.com':'DigitalOcean',
  'mongodb.com':'MongoDB','postgresql.org':'PostgreSQL','oracle.com':'Oracle',
  'ibm.com':'IBM','dell.com':'Dell','hp.com':'HP','intel.com':'Intel',
  'nvidia.com':'NVIDIA','amd.com':'AMD','cisco.com':'Cisco',
  'vmware.com':'VMware','redhat.com':'Red Hat','canonical.com':'Canonical',
  'paypal.com':'PayPal','jpmorgan.com':'JPMorgan','goldmansachs.com':'Goldman Sachs',
  'deloitte.com':'Deloitte','mckinsey.com':'McKinsey','bcg.com':'BCG',
  'pwc.com':'PwC','ey.com':'Ernst & Young','kpmg.com':'KPMG',
};

async function lookupCompanyName(domain) {
  // 1. Check cache
  if (companyNameCache[domain]) return companyNameCache[domain];
  // 2. Check known brands
  if (KNOWN_BRANDS[domain]) {
    companyNameCache[domain] = KNOWN_BRANDS[domain];
    companyNameCacheDirty = true;
    return KNOWN_BRANDS[domain];
  }
  // 3. Try Clearbit autocomplete API (free, no auth)
  try {
    const query = domain.split('.')[0];
    const resp = await fetch('https://autocomplete.clearbit.com/v1/companies/suggest?query=' + encodeURIComponent(query));
    if (resp.ok) {
      const results = await resp.json();
      // Find exact domain match
      const match = results.find(r => r.domain === domain);
      if (match && match.name) {
        companyNameCache[domain] = match.name;
        companyNameCacheDirty = true;
        return match.name;
      }
      // Fuzzy: if domain prefix matches closely
      const fuzzy = results.find(r => r.domain && r.domain.split('.')[0] === domain.split('.')[0]);
      if (fuzzy && fuzzy.name) {
        companyNameCache[domain] = fuzzy.name;
        companyNameCacheDirty = true;
        return fuzzy.name;
      }
    }
  } catch(e) { /* API unavailable — fall through to smart formatting */ }
  // 4. Fallback: smart title case from domain prefix
  const prefix = domain.split('.')[0];
  const formatted = titleCase(prefix.replace(/[-_]/g, ' '));
  companyNameCache[domain] = formatted;
  companyNameCacheDirty = true;
  return formatted;
}

// ──────────────────────────────────────────────
// INDEXEDDB PERSISTENCE
// ──────────────────────────────────────────────
const DB_NAME = 'relateflow';
const DB_VERSION = 1;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('domainData')) db.createObjectStore('domainData', { keyPath: 'domain' });
      if (!db.objectStoreNames.contains('meta')) db.createObjectStore('meta', { keyPath: 'key' });
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function persistData() {
  try {
    const db = await openDB();
    const tx = db.transaction(['domainData', 'meta'], 'readwrite');
    const domainStore = tx.objectStore('domainData');
    const metaStore = tx.objectStore('meta');
    domainStore.clear();
    for (const [domain, data] of Object.entries(domainMap)) {
      const rec = { domain, contacts: {}, sentIds: Array.from(data.sentIds), receivedIds: Array.from(data.receivedIds), lastDate: data.lastDate ? data.lastDate.toISOString() : null, lastSentDate: data.lastSentDate ? data.lastSentDate.toISOString() : null, lastReceivedDate: data.lastReceivedDate ? data.lastReceivedDate.toISOString() : null };
      for (const [email, c] of Object.entries(data.contacts)) {
        rec.contacts[email] = { name: c.name, email: c.email, sentIds: Array.from(c.sentIds), receivedIds: Array.from(c.receivedIds), lastDate: c.lastDate ? c.lastDate.toISOString() : null };
      }
      domainStore.put(rec);
    }
    metaStore.put({ key: 'lastScanTime', value: lastScanTime ? lastScanTime.toISOString() : null });
    metaStore.put({ key: 'userEmail', value: userEmail });
    metaStore.put({ key: 'fullScanDone', value: fullScanDone });
    metaStore.put({ key: 'seenMsgIds', value: Array.from(seenMsgIds) });
    metaStore.put({ key: 'deltaLink', value: deltaLink });
    await new Promise((res, rej) => { tx.oncomplete = res; tx.onerror = () => rej(tx.error); });
  } catch(e) { console.warn('Persist failed:', e); }
}

async function loadPersistedData() {
  try {
    const db = await openDB();
    const tx = db.transaction(['domainData', 'meta'], 'readonly');
    const ds = tx.objectStore('domainData');
    const ms = tx.objectStore('meta');
    const [domains, scanRec, emailRec, fullScanRec, seenRec, deltaRec] = await Promise.all([
      new Promise((r, j) => { const q = ds.getAll(); q.onsuccess = () => r(q.result); q.onerror = j; }),
      new Promise((r, j) => { const q = ms.get('lastScanTime'); q.onsuccess = () => r(q.result); q.onerror = j; }),
      new Promise((r, j) => { const q = ms.get('userEmail'); q.onsuccess = () => r(q.result); q.onerror = j; }),
      new Promise((r, j) => { const q = ms.get('fullScanDone'); q.onsuccess = () => r(q.result); q.onerror = j; }),
      new Promise((r, j) => { const q = ms.get('seenMsgIds'); q.onsuccess = () => r(q.result); q.onerror = j; }),
      new Promise((r, j) => { const q = ms.get('deltaLink'); q.onsuccess = () => r(q.result); q.onerror = j; }),
    ]);
    if (!domains || domains.length === 0) return null;
    if (emailRec?.value && emailRec.value !== userEmail) return null;
    const map = {};
    for (const d of domains) {
      const key = d.domain.toLowerCase();
      if (!map[key]) {
        map[key] = { contacts: {}, sentIds: new Set(), receivedIds: new Set(), lastDate: null, lastSentDate: null, lastReceivedDate: null };
      }
      const entry = map[key];
      // Restore Sets from arrays (new format) or rebuild from old counter format
      const dSentIds = Array.isArray(d.sentIds) ? d.sentIds : [];
      const dRecvIds = Array.isArray(d.receivedIds) ? d.receivedIds : [];
      for (const id of dSentIds) entry.sentIds.add(id);
      for (const id of dRecvIds) entry.receivedIds.add(id);
      if (d.lastDate) {
        const dt = new Date(d.lastDate);
        if (!entry.lastDate || dt > entry.lastDate) entry.lastDate = dt;
      }
      if (d.lastSentDate) {
        const sd = new Date(d.lastSentDate);
        if (!entry.lastSentDate || sd > entry.lastSentDate) entry.lastSentDate = sd;
      }
      if (d.lastReceivedDate) {
        const rd = new Date(d.lastReceivedDate);
        if (!entry.lastReceivedDate || rd > entry.lastReceivedDate) entry.lastReceivedDate = rd;
      }
      for (const [email, c] of Object.entries(d.contacts)) {
        const le = email.toLowerCase();
        if (!entry.contacts[le]) {
          const cSentIds = Array.isArray(c.sentIds) ? c.sentIds : [];
          const cRecvIds = Array.isArray(c.receivedIds) ? c.receivedIds : [];
          entry.contacts[le] = { name: c.name, email: le, sentIds: new Set(cSentIds), receivedIds: new Set(cRecvIds), lastDate: c.lastDate ? new Date(c.lastDate) : null };
        } else {
          const cSentIds = Array.isArray(c.sentIds) ? c.sentIds : [];
          const cRecvIds = Array.isArray(c.receivedIds) ? c.receivedIds : [];
          for (const id of cSentIds) entry.contacts[le].sentIds.add(id);
          for (const id of cRecvIds) entry.contacts[le].receivedIds.add(id);
          if (c.lastDate) {
            const cdt = new Date(c.lastDate);
            if (!entry.contacts[le].lastDate || cdt > entry.contacts[le].lastDate) entry.contacts[le].lastDate = cdt;
          }
        }
      }
    }
    const restoredSeenIds = seenRec?.value ? new Set(seenRec.value) : new Set();
    const restoredDeltaLink = deltaRec?.value || null;
    return { domainMap: map, lastScanTime: scanRec?.value ? new Date(scanRec.value) : null, fullScanDone: !!fullScanRec?.value, seenMsgIds: restoredSeenIds, deltaLink: restoredDeltaLink };
  } catch(e) { console.warn('Load failed:', e); return null; }
}

async function clearPersistedData() {
  try {
    const db = await openDB();
    const tx = db.transaction(['domainData', 'meta'], 'readwrite');
    tx.objectStore('domainData').clear();
    tx.objectStore('meta').clear();
    await new Promise(r => { tx.oncomplete = r; });
  } catch(e) { console.warn('Clear failed:', e); }
}

// ──────────────────────────────────────────────
// ONEDRIVE CLOUD SYNC
// Persists all user settings & contacts to OneDrive app folder
// so data roams across devices automatically.
// ──────────────────────────────────────────────
let cloudSyncInProgress = false;
let cloudSyncTimer = null;
const CLOUD_SYNC_FILE = 'kennion-crm-sync.json';

async function getCloudToken() {
  if (!msalInstance || !currentAccount) return null;
  try {
    const resp = await msalInstance.acquireTokenSilent({
      scopes: ['Files.ReadWrite.AppFolder'],
      account: currentAccount
    });
    return resp.accessToken;
  } catch(e) {
    try {
      const resp = await msalInstance.acquireTokenPopup({
        scopes: ['Files.ReadWrite.AppFolder']
      });
      currentAccount = resp.account;
      return resp.accessToken;
    } catch(e2) {
      console.warn('Cloud sync token failed:', e2);
      return null;
    }
  }
}

function gatherSyncPayload() {
  // Collect all localStorage settings
  const settings = {
    blocked_domains: [...blockedDomains],
    starred_contacts: starredContacts,
    starred_companies: [...starredCompanies],
    archived_companies: [...archivedCompanies],
    company_types: companyTypes,
    column_config: columnConfig,
    custom_column_data: customColumnData,
    company_names: companyNameCache,
    client_id: getClientId(),
  };

  // Collect IndexedDB domain data (already in memory)
  const domains = {};
  for (const [domain, data] of Object.entries(domainMap)) {
    domains[domain] = {
      contacts: {},
      sentIds: Array.from(data.sentIds || []),
      receivedIds: Array.from(data.receivedIds || []),
      lastDate: data.lastDate ? data.lastDate.toISOString() : null,
      lastSentDate: data.lastSentDate ? data.lastSentDate.toISOString() : null,
      lastReceivedDate: data.lastReceivedDate ? data.lastReceivedDate.toISOString() : null,
    };
    for (const [email, c] of Object.entries(data.contacts)) {
      domains[domain].contacts[email] = {
        name: c.name, email: c.email,
        sentIds: Array.from(c.sentIds || []),
        receivedIds: Array.from(c.receivedIds || []),
        lastDate: c.lastDate ? c.lastDate.toISOString() : null,
      };
    }
  }

  return {
    version: 2,
    syncedAt: new Date().toISOString(),
    userEmail: userEmail,
    settings: settings,
    domainData: domains,
    meta: {
      lastScanTime: lastScanTime ? lastScanTime.toISOString() : null,
      fullScanDone: fullScanDone,
      seenMsgIds: Array.from(seenMsgIds),
      deltaLink: deltaLink,
    }
  };
}

async function saveToCloud() {
  if (cloudSyncInProgress) return;
  if (!currentAccount || Object.keys(domainMap).length === 0) return;
  cloudSyncInProgress = true;
  try {
    const token = await getCloudToken();
    if (!token) return;
    const payload = gatherSyncPayload();
    const body = JSON.stringify(payload);
    const resp = await fetch(
      'https://graph.microsoft.com/v1.0/me/drive/special/approot:/' + CLOUD_SYNC_FILE + ':/content',
      { method: 'PUT', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: body }
    );
    if (resp.ok) {
      console.log('Cloud sync saved successfully (' + Math.round(body.length/1024) + ' KB)');
    } else {
      console.warn('Cloud sync save failed:', resp.status, await resp.text());
    }
  } catch(e) {
    console.warn('Cloud sync save error:', e);
  } finally {
    cloudSyncInProgress = false;
  }
}

async function loadFromCloud() {
  try {
    const token = await getCloudToken();
    if (!token) return null;
    const resp = await fetch(
      'https://graph.microsoft.com/v1.0/me/drive/special/approot:/' + CLOUD_SYNC_FILE + ':/content',
      { headers: { 'Authorization': 'Bearer ' + token } }
    );
    if (resp.status === 404) return null; // no cloud data yet
    if (!resp.ok) { console.warn('Cloud load failed:', resp.status); return null; }
    const data = await resp.json();
    if (data.version && data.settings) return data;
    return null;
  } catch(e) {
    console.warn('Cloud load error:', e);
    return null;
  }
}

function applyCloudData(data) {
  // Restore settings
  const s = data.settings;
  if (s.blocked_domains && s.blocked_domains.length > 0) {
    blockedDomains = new Set(s.blocked_domains);
    saveBlockedDomains();
  }
  if (s.starred_contacts && Object.keys(s.starred_contacts).length > 0) {
    starredContacts = s.starred_contacts;
    saveStarredContacts();
  }
  if (s.starred_companies && s.starred_companies.length > 0) {
    starredCompanies = new Set(s.starred_companies);
    saveStarredCompanies();
  }
  if (s.archived_companies && s.archived_companies.length > 0) {
    archivedCompanies = new Set(s.archived_companies);
    saveArchivedCompanies();
  }
  if (s.company_types && Object.keys(s.company_types).length > 0) {
    companyTypes = s.company_types;
    saveCompanyTypes();
  }
  if (s.column_config && s.column_config.length > 0) {
    columnConfig = s.column_config;
    saveColumnConfig();
  }
  if (s.custom_column_data && Object.keys(s.custom_column_data).length > 0) {
    customColumnData = s.custom_column_data;
    saveCustomColumnData();
  }
  if (s.company_names && Object.keys(s.company_names).length > 0) {
    Object.assign(companyNameCache, s.company_names);
    companyNameCacheDirty = true;
    saveCompanyNameCache();
  }
  if (s.client_id) {
    localStorage.setItem('relateflow_client_id', s.client_id);
  }

  // Restore domain/contact data
  if (data.domainData && Object.keys(data.domainData).length > 0) {
    for (const [domain, d] of Object.entries(data.domainData)) {
      const key = domain.toLowerCase();
      if (!domainMap[key]) {
        domainMap[key] = { contacts: {}, sentIds: new Set(), receivedIds: new Set(), lastDate: null, lastSentDate: null, lastReceivedDate: null };
      }
      const entry = domainMap[key];
      for (const id of (d.sentIds || [])) entry.sentIds.add(id);
      for (const id of (d.receivedIds || [])) entry.receivedIds.add(id);
      if (d.lastDate) { const dt = new Date(d.lastDate); if (!entry.lastDate || dt > entry.lastDate) entry.lastDate = dt; }
      if (d.lastSentDate) { const sd = new Date(d.lastSentDate); if (!entry.lastSentDate || sd > entry.lastSentDate) entry.lastSentDate = sd; }
      if (d.lastReceivedDate) { const rd = new Date(d.lastReceivedDate); if (!entry.lastReceivedDate || rd > entry.lastReceivedDate) entry.lastReceivedDate = rd; }
      for (const [email, c] of Object.entries(d.contacts || {})) {
        const le = email.toLowerCase();
        if (!entry.contacts[le]) {
          entry.contacts[le] = { name: c.name, email: le, sentIds: new Set(c.sentIds || []), receivedIds: new Set(c.receivedIds || []), lastDate: c.lastDate ? new Date(c.lastDate) : null };
        } else {
          for (const id of (c.sentIds || [])) entry.contacts[le].sentIds.add(id);
          for (const id of (c.receivedIds || [])) entry.contacts[le].receivedIds.add(id);
          if (c.lastDate) { const cdt = new Date(c.lastDate); if (!entry.contacts[le].lastDate || cdt > entry.contacts[le].lastDate) entry.contacts[le].lastDate = cdt; }
        }
      }
    }
  }

  // Restore meta
  if (data.meta) {
    if (data.meta.lastScanTime) lastScanTime = new Date(data.meta.lastScanTime);
    if (data.meta.fullScanDone) fullScanDone = data.meta.fullScanDone;
    if (data.meta.seenMsgIds) seenMsgIds = new Set(data.meta.seenMsgIds);
    if (data.meta.deltaLink) deltaLink = data.meta.deltaLink;
  }
}

// Debounced cloud save — triggers 30s after last change
function scheduleCloudSync() {
  if (!currentAccount) return;
  if (cloudSyncTimer) clearTimeout(cloudSyncTimer);
  cloudSyncTimer = setTimeout(() => { saveToCloud(); }, 30000);
}

// ──────────────────────────────────────────────
// MSAL SETUP
// ──────────────────────────────────────────────
const MSAL_CDN_URLS = [
  'https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js',
  'https://unpkg.com/@azure/msal-browser@2.38.3/lib/msal-browser.min.js',
  'https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js'
];

function loadScript(url) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = url;
    s.onload = resolve;
    s.onerror = () => reject(new Error('Failed to load: ' + url));
    document.head.appendChild(s);
  });
}

async function ensureMSALLoaded() {
  if (typeof msal !== 'undefined') return true;
  for (const url of MSAL_CDN_URLS) {
    try {
      await loadScript(url);
      if (typeof msal !== 'undefined') return true;
    } catch(e) {
      console.warn(e.message);
    }
  }
  return false;
}

function getClientId() {
  return localStorage.getItem('relateflow_client_id') || '';
}

async function initMSAL() {
  const clientId = getClientId();
  if (!clientId) return null;

  const loaded = await ensureMSALLoaded();
  if (!loaded) {
    alert('Could not load the Microsoft authentication library. Please check your internet connection or try disabling ad-blockers, then refresh the page.');
    return null;
  }

  const config = {
    auth: {
      clientId: clientId,
      authority: 'https://login.microsoftonline.com/common',
      redirectUri: window.location.origin + window.location.pathname,
    },
    cache: {
      cacheLocation: 'localStorage',
      storeAuthStateInCookie: false,
    }
  };
  try {
    msalInstance = new msal.PublicClientApplication(config);
    if (typeof msalInstance.initialize === 'function') {
      await msalInstance.initialize();
    }
    try { await msalInstance.handleRedirectPromise(); } catch(e) { console.warn('Redirect handle:', e); }
    return msalInstance;
  } catch(e) {
    console.error('MSAL init error:', e);
    alert('MSAL initialization failed: ' + e.message);
    msalInstance = null;
    return null;
  }
}

async function signIn() {
  if (!getClientId()) {
    openSettings();
    return;
  }
  if (!msalInstance) await initMSAL();
  if (!msalInstance) { alert('Could not initialize Microsoft authentication. Check your Client ID.'); openSettings(); return; }

  try {
    const resp = await msalInstance.loginPopup({
      scopes: ['Mail.Read','Mail.Send','User.Read','Files.ReadWrite.AppFolder'],
      prompt: 'select_account'
    });
    currentAccount = resp.account;
    userEmail = currentAccount.username;
    onSignedIn();
  } catch(e) {
    console.error('Sign-in error:', e);
    if (e.errorCode === 'user_cancelled') return;
    // If popup blocked, try redirect
    if (e.errorCode === 'popup_window_error' || e.errorCode === 'empty_window_error') {
      alert('Popup was blocked by your browser. Trying redirect login instead...');
      msalInstance.loginRedirect({ scopes: ['Mail.Read','Mail.Send','User.Read','Files.ReadWrite.AppFolder'] });
      return;
    }
    alert('Sign-in failed: ' + (e.errorCode || '') + ' — ' + (e.message || e));
  }
}

function signOut() {
  if (msalInstance && currentAccount) {
    msalInstance.logoutPopup({ account: currentAccount });
  }
  currentAccount = null;
  userEmail = '';
  companies = [];
  domainMap = {};
  seenMsgIds = new Set();
  deltaLink = null;
  lastScanTime = null;
  fullScanDone = false;
  isScanning = false;
  stopAutoSync();
  document.getElementById('accountBar').style.display = 'none';
  showWelcome();
}

async function getAccessToken() {
  if (!msalInstance || !currentAccount) throw new Error('Not signed in');
  try {
    const resp = await msalInstance.acquireTokenSilent({
      scopes: ['Mail.Read','Mail.Send','User.Read','Files.ReadWrite.AppFolder'],
      account: currentAccount
    });
    return resp.accessToken;
  } catch(e) {
    const resp = await msalInstance.acquireTokenPopup({
      scopes: ['Mail.Read','Mail.Send','User.Read','Files.ReadWrite.AppFolder']
    });
    currentAccount = resp.account;
    return resp.accessToken;
  }
}

// Build Graph API headers with Immutable IDs to prevent ID drift on email moves
function graphHeaders(token) {
  return { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json', 'Prefer': 'IdType="ImmutableId"' };
}

// ──────────────────────────────────────────────
// DOMAIN MAP HELPERS
// ──────────────────────────────────────────────
function getDomain(email) {
  if (!email) return null;
  const d = email.split('@')[1];
  return d ? d.toLowerCase() : null;
}

function ensureDomain(domain) {
  if (!domainMap[domain]) {
    domainMap[domain] = { contacts: {}, sentIds: new Set(), receivedIds: new Set(), lastDate: null, lastSentDate: null, lastReceivedDate: null };
  }
}

function ensureContact(domain, email, name) {
  ensureDomain(domain);
  const le = email.toLowerCase();
  const formatted = formatContactName(name, le);
  if (!domainMap[domain].contacts[le]) {
    domainMap[domain].contacts[le] = { name: formatted, email: le, sentIds: new Set(), receivedIds: new Set(), lastDate: null };
  } else {
    const existing = domainMap[domain].contacts[le].name;
    // Upgrade name if current one is just the email or worse quality
    if (existing === le || existing === email || (name && name !== email && existing === formatContactName(null, le))) {
      domainMap[domain].contacts[le].name = formatted;
    }
  }
}

function updateDate(obj, dateStr) {
  if (!dateStr) return;
  const d = new Date(dateStr);
  if (!obj.lastDate || d > obj.lastDate) obj.lastDate = d;
}

function updateDateField(obj, field, dateStr) {
  if (!dateStr) return;
  const d = new Date(dateStr);
  if (!obj[field] || d > obj[field]) obj[field] = d;
}

// ──────────────────────────────────────────────
// PROCESS EMAIL BATCH → UPDATE DOMAIN MAP
// ──────────────────────────────────────────────
function processEmailBatch(messages) {
  const myEmailLower = userEmail ? userEmail.toLowerCase() : '';
  const myDomain = userEmail ? getDomain(userEmail) : null;

  for (const msg of messages) {
    // Skip already-processed messages to prevent double-counting
    if (msg.id && seenMsgIds.has(msg.id)) continue;
    if (msg.id) seenMsgIds.add(msg.id);

    const fromEmail = msg.from?.emailAddress?.address?.toLowerCase() || '';
    const isSent = (fromEmail === myEmailLower);

    if (isSent) {
      // SENT email — add msg.id to Sets (duplicates are impossible)
      const recipients = [...(msg.toRecipients || []), ...(msg.ccRecipients || [])];
      for (const r of recipients) {
        const toEmail = r.emailAddress?.address;
        const toName = r.emailAddress?.name;
        if (!toEmail) continue;
        const domain = getDomain(toEmail);
        if (!domain || isBlockedDomain(domain) || domain === myDomain) continue;
        ensureContact(domain, toEmail, toName);
        const le = toEmail.toLowerCase();
        domainMap[domain].contacts[le].sentIds.add(msg.id);
        domainMap[domain].sentIds.add(msg.id);
        const sentDt = msg.sentDateTime || msg.receivedDateTime;
        updateDate(domainMap[domain], sentDt);
        updateDate(domainMap[domain].contacts[le], sentDt);
        updateDateField(domainMap[domain], 'lastSentDate', sentDt);
      }
    } else {
      // RECEIVED email — add msg.id to Sets
      const senderEmail = msg.from?.emailAddress?.address;
      const senderName = msg.from?.emailAddress?.name;
      if (!senderEmail) continue;
      const domain = getDomain(senderEmail);
      if (!domain || isBlockedDomain(domain) || domain === myDomain) continue;
      ensureContact(domain, senderEmail, senderName);
      const le = senderEmail.toLowerCase();
      domainMap[domain].contacts[le].receivedIds.add(msg.id);
      domainMap[domain].receivedIds.add(msg.id);
      updateDate(domainMap[domain], msg.receivedDateTime);
      updateDate(domainMap[domain].contacts[le], msg.receivedDateTime);
      updateDateField(domainMap[domain], 'lastReceivedDate', msg.receivedDateTime);
    }
  }
}

// Handle @removed items from delta sync — delete email ID from all Sets
function processRemovedEmail(msgId) {
  if (!msgId) return;
  seenMsgIds.delete(msgId);
  for (const data of Object.values(domainMap)) {
    data.sentIds.delete(msgId);
    data.receivedIds.delete(msgId);
    for (const ct of Object.values(data.contacts)) {
      ct.sentIds.delete(msgId);
      ct.receivedIds.delete(msgId);
    }
  }
}

// ──────────────────────────────────────────────
// BUILD COMPANIES FROM DOMAIN MAP
// (Selective contact creation — like Attio, only
//  domains you've actively emailed become records.
//  Spam, newsletters, and cold inbound are filtered.)
// ──────────────────────────────────────────────
function buildCompaniesFromDomainMap() {
  // Deduplicate domainMap keys by lowercase (merge any case-variant entries)
  const keys = Object.keys(domainMap);
  const seen = {};
  for (const k of keys) {
    const lk = k.toLowerCase();
    if (lk !== k) {
      // Merge into lowercase key
      if (!domainMap[lk]) { domainMap[lk] = domainMap[k]; }
      else {
        for (const id of domainMap[k].sentIds) domainMap[lk].sentIds.add(id);
        for (const id of domainMap[k].receivedIds) domainMap[lk].receivedIds.add(id);
        if (domainMap[k].lastDate && (!domainMap[lk].lastDate || domainMap[k].lastDate > domainMap[lk].lastDate)) domainMap[lk].lastDate = domainMap[k].lastDate;
        if (domainMap[k].lastSentDate && (!domainMap[lk].lastSentDate || domainMap[k].lastSentDate > domainMap[lk].lastSentDate)) domainMap[lk].lastSentDate = domainMap[k].lastSentDate;
        if (domainMap[k].lastReceivedDate && (!domainMap[lk].lastReceivedDate || domainMap[k].lastReceivedDate > domainMap[lk].lastReceivedDate)) domainMap[lk].lastReceivedDate = domainMap[k].lastReceivedDate;
        for (const [e, c] of Object.entries(domainMap[k].contacts)) {
          const le = e.toLowerCase();
          if (!domainMap[lk].contacts[le]) domainMap[lk].contacts[le] = c;
          else { for (const id of c.sentIds) domainMap[lk].contacts[le].sentIds.add(id); for (const id of c.receivedIds) domainMap[lk].contacts[le].receivedIds.add(id); }
        }
      }
      delete domainMap[k];
    }
  }

  companies = [];
  let id = 1;
  for (const [domain, data] of Object.entries(domainMap)) {
    // Skip blocked domains (including ones blocked after initial scan)
    if (isBlockedDomain(domain)) continue;

    const contactArr = Object.values(data.contacts);
    if (contactArr.length === 0) continue;

    // Per-contact counts from individual Sets
    for (const ct of contactArr) { ct.sent = ct.sentIds.size; ct.received = ct.receivedIds.size; }

    // Unique email counts (Set-based, for scoring — CC'd emails count once)
    const uniqueSent = data.sentIds.size;
    const uniqueReceived = data.receivedIds.size;

    // Display counts = sum of contacts (matches what user sees in contact cards)
    const domainSent = contactArr.reduce(function(s, ct) { return s + ct.sent; }, 0);
    const domainReceived = contactArr.reduce(function(s, ct) { return s + ct.received; }, 0);

    // SELECTIVE: only create company if user has sent at least 1 email to this domain
    if (uniqueSent === 0) continue;

    contactArr.sort((a, b) => (b.sent + b.received) - (a.sent + a.received));
    const primary = getPrimaryContact(domain, contactArr);
    const totalEmails = uniqueSent + uniqueReceived;

    // ── AI SEGMENT SCORING ──
    // Uses unique email counts so CC'd emails don't inflate scores
    const now = Date.now();
    const DAY = 86400000;
    const lastAny = data.lastDate ? data.lastDate.getTime() : 0;
    const lastSent = data.lastSentDate ? data.lastSentDate.getTime() : 0;
    const lastRecv = data.lastReceivedDate ? data.lastReceivedDate.getTime() : 0;
    const daysSinceAny = lastAny ? (now - lastAny) / DAY : 9999;
    const daysSinceSent = lastSent ? (now - lastSent) / DAY : 9999;
    const daysSinceRecv = lastRecv ? (now - lastRecv) / DAY : 9999;
    const hasTwoWay = uniqueSent > 0 && uniqueReceived > 0;

    let score = Math.min(99, Math.round(
      // Volume (up to 35 pts)
      Math.min(totalEmails * 1.2, 35) +
      // Two-way engagement (up to 20 pts)
      (hasTwoWay ? 12 + Math.min(Math.min(uniqueSent, uniqueReceived) * 2, 8) : 0) +
      // Recency (up to 25 pts)
      (daysSinceAny < 7 ? 25 : daysSinceAny < 30 ? 18 : daysSinceAny < 90 ? 10 : daysSinceAny < 180 ? 5 : 0) +
      // Contact diversity (up to 10 pts)
      Math.min(contactArr.length * 3, 10) +
      // Reply ratio bonus (up to 9 pts) — strong back-and-forth signals real engagement
      (hasTwoWay ? Math.min(Math.round(Math.min(uniqueReceived / uniqueSent, 1) * 9), 9) : 0)
    ));

    // ── AI STATUS DETERMINATION ──
    // Hot: Active two-way conversation, recent activity (last 30 days)
    // Warm: Two-way activity in last 90-180 days, some engagement
    // Cold: No inbound in 365+ days, or outbound-only with no replies
    let status = 'Cold';
    if (hasTwoWay && daysSinceRecv <= 30 && daysSinceAny <= 30) {
      // Two-way interaction with received email in last 30 days = Hot
      status = 'Hot';
    } else if (hasTwoWay && daysSinceRecv <= 180) {
      // Two-way interaction with received email in last 180 days = Warm
      status = 'Warm';
    }
    // Everything else stays Cold: outbound-only, no replies, or stale > 180 days

    // Use cached company name or smart fallback (async lookup happens separately)
    const companyName = companyNameCache[domain]
      || KNOWN_BRANDS[domain]
      || titleCase(domain.split('.')[0].replace(/[-_]/g, ' '));

    companies.push({
      id: id++,
      name: companyName,
      domain: domain,
      contact: primary.name,
      contactEmail: primary.email,
      sent: domainSent,
      received: domainReceived,
      status: status,
      score: score,
      lastDate: data.lastDate,
      lastActivity: data.lastDate ? timeAgo(data.lastDate) : 'unknown',
      allContacts: contactArr,
    });
  }

  companies.sort((a, b) => (b.sent + b.received) - (a.sent + a.received));
  companies.forEach((c, i) => c.id = i + 1);
}

// Async: look up real company names for any domains not yet in cache
let nameLookupsRunning = false;
async function resolveCompanyNames() {
  if (nameLookupsRunning) return;
  nameLookupsRunning = true;
  try {
    const uncached = companies.filter(c => !companyNameCache[c.domain]).map(c => c.domain);
    if (uncached.length === 0) return;

    // Batch lookups, 5 at a time to avoid rate limits
    for (let i = 0; i < uncached.length; i += 5) {
      const batch = uncached.slice(i, i + 5);
      await Promise.all(batch.map(d => lookupCompanyName(d)));

      // Update company names in-place and re-render
      let changed = false;
      for (const c of companies) {
        if (companyNameCache[c.domain] && c.name !== companyNameCache[c.domain]) {
          c.name = companyNameCache[c.domain];
          changed = true;
        }
      }
      if (changed) renderTable();
    }
    saveCompanyNameCache();
  } catch(e) {
    console.warn('Company name lookup error:', e);
  } finally {
    nameLookupsRunning = false;
  }
}

// ──────────────────────────────────────────────
// PROGRESSIVE EMAIL FETCH + PROCESS + RENDER
// (Data populates in the table as emails are scanned)
// ──────────────────────────────────────────────
let deltaSupported = true; // assume delta works until proven otherwise

async function fetchEmailsProgressively(token, useDelta) {
  const headers = graphHeaders(token);
  const MSG_SELECT = '$select=id,subject,from,toRecipients,ccRecipients,receivedDateTime,sentDateTime';

  // Decide URL: delta sync or fallback timestamp polling
  let url;
  let isDelta = false;

  if (deltaSupported && useDelta && deltaLink) {
    // Incremental delta: resume from where we left off
    url = deltaLink;
    isDelta = true;
  } else if (deltaSupported && !useDelta) {
    // Try initial delta scan
    url = 'https://graph.microsoft.com/v1.0/me/messages/delta?$top=200&' + MSG_SELECT;
    deltaLink = null;
    isDelta = true;
  } else {
    // Fallback: timestamp-based polling (delta not supported by this mailbox)
    url = 'https://graph.microsoft.com/v1.0/me/messages?$top=200&' + MSG_SELECT + '&$orderby=receivedDateTime desc';
    if (useDelta && lastScanTime) {
      url += '&$filter=receivedDateTime ge ' + lastScanTime.toISOString();
    }
  }

  let page = 0;
  let totalFetched = 0;
  let totalRemoved = 0;

  while (url) {
    page++;
    updateScanBanner('Scanning' + (useDelta ? ' changes' : ' all mail') + '... (' + totalFetched.toLocaleString() + ' emails, page ' + page + ')');

    // Fetch with 30s timeout and retry for transient errors
    let resp;
    const TRANSIENT_CODES = [429, 500, 502, 503, 504];
    const MAX_RETRIES = 3;
    for (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 30000);
      try {
        resp = await fetch(url, { headers, signal: controller.signal });
      } catch(e) {
        clearTimeout(timeout);
        if (e.name === 'AbortError') {
          if (attempt < MAX_RETRIES) {
            const wait = Math.pow(2, attempt + 1) * 1000;
            console.warn('Request timed out (attempt ' + (attempt + 1) + '/' + (MAX_RETRIES + 1) + '), retrying in ' + (wait / 1000) + 's...');
            updateScanBanner('Request timed out — retrying in ' + (wait / 1000) + 's...');
            await new Promise(r => setTimeout(r, wait));
            continue;
          }
          throw new Error('Request timed out after ' + (MAX_RETRIES + 1) + ' attempts — please try again later');
        }
        throw e;
      }
      clearTimeout(timeout);

      // Retry on transient server errors (429, 5xx) with exponential backoff
      if (TRANSIENT_CODES.includes(resp.status) && attempt < MAX_RETRIES) {
        const retryAfter = resp.headers.get('Retry-After');
        const wait = retryAfter ? parseInt(retryAfter, 10) * 1000 : Math.pow(2, attempt + 1) * 1000;
        console.warn('Graph API returned ' + resp.status + ' (attempt ' + (attempt + 1) + '/' + (MAX_RETRIES + 1) + '), retrying in ' + (wait / 1000) + 's...');
        updateScanBanner('Server busy (' + resp.status + ') — retrying in ' + (wait / 1000) + 's...');
        await new Promise(r => setTimeout(r, wait));
        continue;
      }
      break; // Success or non-transient error — exit retry loop
    }

    if (!resp.ok) {
      // Delta token expired/invalid (410 Gone or 404) — reset to full delta scan
      if (isDelta && (resp.status === 410 || resp.status === 404) && useDelta) {
        console.warn('Delta token expired (' + resp.status + '), resetting to full sync');
        deltaLink = null;
        url = 'https://graph.microsoft.com/v1.0/me/messages/delta?$top=200&' + MSG_SELECT;
        continue;
      }
      // Delta not supported (400 "Change tracking not supported") — fall back to timestamp polling
      if (isDelta && resp.status === 400) {
        const errText = await resp.text();
        if (errText.includes('Change tracking') || errText.includes('not supported') || errText.includes('delta')) {
          console.warn('Delta sync not supported by this mailbox, falling back to timestamp polling');
          deltaSupported = false;
          deltaLink = null;
          // Restart with standard messages endpoint
          url = 'https://graph.microsoft.com/v1.0/me/messages?$top=200&' + MSG_SELECT + '&$orderby=receivedDateTime desc';
          if (useDelta && lastScanTime) {
            url += '&$filter=receivedDateTime ge ' + lastScanTime.toISOString();
          }
          isDelta = false;
          page = 0;
          continue;
        }
        throw new Error('Graph API error: 400 — ' + errText);
      }
      const err = await resp.text();
      throw new Error('Graph API error: ' + resp.status + ' — ' + err);
    }
    const data = await resp.json();

    if (data.value && data.value.length > 0) {
      // Delta responses may include @removed items
      const regular = [];
      if (isDelta) {
        for (const item of data.value) {
          if (item['@removed']) {
            processRemovedEmail(item.id);
            totalRemoved++;
          } else {
            regular.push(item);
          }
        }
      } else {
        regular.push(...data.value);
      }

      if (regular.length > 0) {
        totalFetched += regular.length;
        processEmailBatch(regular);
      }

      // Throttle UI: only rebuild table every 5 pages (heavy DOM work)
      if (page === 1 || page % 5 === 0) {
        buildCompaniesFromDomainMap();
        renderTable();
        updateStats();
      }
      updateScanBanner('Scanning... ' + totalFetched.toLocaleString() + ' emails' + (totalRemoved > 0 ? ', ' + totalRemoved + ' removed' : '') + ' — ' + companies.length + ' companies');

      // Persist every 5 pages
      if (page === 1 || page % 5 === 0) {
        lastScanTime = new Date();
        persistData();
      }
    } else if (!isDelta) {
      // Non-delta: empty page means we're done (no nextLink expected)
      break;
    }

    // Delta: @odata.nextLink for pagination, @odata.deltaLink on final page
    // Standard: @odata.nextLink for pagination, null when done
    if (data['@odata.nextLink']) {
      url = data['@odata.nextLink'];
    } else {
      if (isDelta && data['@odata.deltaLink']) {
        deltaLink = data['@odata.deltaLink'];
      }
      url = null;
    }
  }

  // Final UI update
  buildCompaniesFromDomainMap();
  renderTable();
  updateStats();

  return totalFetched;
}

function timeAgo(date) {
  const now = Date.now();
  const diff = now - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  if (days < 7) return days + 'd ago';
  const weeks = Math.floor(days / 7);
  if (weeks < 4) return weeks + 'w ago';
  const months = Math.floor(days / 30);
  return months + 'mo ago';
}

// ──────────────────────────────────────────────
// OUTLOOK SCAN — Full first time, auto-sync after
// ──────────────────────────────────────────────
async function scanOutlookEmails(forceFullScan) {
  if (isScanning) return;
  isScanning = true;
  setSyncBadge('scanning');

  try {
    showScanBanner('Connecting to Microsoft Graph...');
    const token = await getAccessToken();

    // Decide: full scan or delta sync
    const needsFullScan = forceFullScan || !fullScanDone;
    let totalFetched;

    if (needsFullScan) {
      if (forceFullScan) { domainMap = {}; seenMsgIds = new Set(); deltaLink = null; }
      showScanBanner('Full scan — reading all emails' + (Object.keys(domainMap).length > 0 ? ' (resuming)' : '') + '...');
      totalFetched = await fetchEmailsProgressively(token, false); // full delta scan
      fullScanDone = true;
      updateScanBanner('Full scan complete! ' + totalFetched.toLocaleString() + ' emails processed, ' + companies.length + ' companies found');
    } else {
      showScanBanner('Syncing — checking for new emails...');
      totalFetched = await fetchEmailsProgressively(token, true); // incremental (delta or timestamp fallback)
      if (totalFetched > 0) {
        updateScanBanner('Synced ' + totalFetched.toLocaleString() + ' new emails — ' + companies.length + ' companies');
      } else {
        updateScanBanner('All caught up — no new emails');
      }
    }

    lastScanTime = new Date();
    await persistData();
    scheduleCloudSync(); // sync to OneDrive after scan completes
    setSyncBadge('synced', 'In Sync');
    updateLastSyncDisplay();

    resolveCompanyNames();
    runEnrichment();

    setTimeout(() => { hideScanBanner(); }, needsFullScan ? 4000 : 2000);

  } catch(e) {
    hideScanBanner();
    setSyncBadge('error', 'Sync Failed');
    console.error('Scan error:', e);
    // Show user-friendly message for common transient errors
    const msg = e.message || '';
    if (msg.includes('504') || msg.includes('502') || msg.includes('503') || msg.includes('timed out')) {
      alert('Email sync temporarily unavailable — Microsoft servers are slow or unreachable. Please try again in a few minutes.');
    } else if (msg.includes('429')) {
      alert('Too many requests — Microsoft is rate-limiting your account. Please wait a few minutes before syncing again.');
    } else if (msg.includes('Not signed in') || msg.includes('interaction_required')) {
      alert('Your session has expired. Please sign out and sign back in.');
    } else {
      alert('Email scan failed: ' + msg);
    }
  } finally {
    isScanning = false;
  }
}

// Full re-scan: clears everything and starts fresh
async function fullRescan() {
  domainMap = {};
  seenMsgIds = new Set();
  deltaLink = null;
  lastScanTime = null;
  fullScanDone = false;
  companies = [];
  await clearPersistedData();
  renderTable();
  updateStats();
  closeSettings();
  scanOutlookEmails(true);
}

// ──────────────────────────────────────────────
// ──────────────────────────────────────────────
// AUTO-SYNC — quiet background sync every 5 minutes
// ──────────────────────────────────────────────
function startAutoSync() {
  stopAutoSync();
  autoSyncTimer = setInterval(() => {
    if (!isScanning && fullScanDone && currentAccount) {
      scanOutlookEmails();
    }
  }, AUTO_SYNC_INTERVAL);
}
function stopAutoSync() {
  if (autoSyncTimer) { clearInterval(autoSyncTimer); autoSyncTimer = null; }
}

// Last sync display
function updateLastSyncDisplay() {
  const bar = document.getElementById('accountBar');
  if (!currentAccount) { bar.style.display = 'none'; return; }
  bar.style.display = 'flex';
  document.getElementById('accountEmail').textContent = userEmail || currentAccount.username || '';
  if (lastScanTime) {
    document.getElementById('lastSyncText').textContent =
      'Last synced ' + timeAgo(lastScanTime) + ' · ' +
      companies.length + ' companies';
  } else {
    document.getElementById('lastSyncText').textContent = 'Not yet synced';
  }
}
function setSyncBadge(state, text) {
  const badge = document.getElementById('syncBadge');
  badge.className = 'sync-badge' + (state === 'scanning' ? ' scanning' : state === 'error' ? ' error' : '');
  document.getElementById('syncBadgeText').textContent = text || (state === 'scanning' ? 'Syncing...' : state === 'error' ? 'Error' : 'In Sync');
}

// ──────────────────────────────────────────────
// UI STATE
// ──────────────────────────────────────────────
function showWelcome() {
  document.getElementById('welcomeScreen').style.display = 'flex';
  document.getElementById('crmContent').classList.remove('active');
  document.getElementById('sidebar').style.display = 'none';
  document.getElementById('scanOutlookBtn').style.display = 'none';
  document.getElementById('exportBtn').style.display = 'none';
  document.getElementById('userPill').style.display = 'none';
  document.getElementById('signOutBtn').style.display = 'none';
  document.getElementById('settingsBtn').style.display = 'none';
}

async function onSignedIn() {
  document.getElementById('welcomeScreen').style.display = 'none';
  document.getElementById('crmContent').classList.add('active');
  const sb = document.getElementById('sidebar');
  sb.style.display = 'flex';
  if (localStorage.getItem('relateflow_sidebar') === 'collapsed') {
    sb.classList.add('collapsed');
  } else {
    sb.classList.remove('collapsed');
  }
  document.getElementById('scanOutlookBtn').style.display = '';
  document.getElementById('exportBtn').style.display = '';
  document.getElementById('settingsBtn').style.display = '';
  document.getElementById('signOutBtn').style.display = '';
  document.getElementById('userPill').style.display = 'flex';
  document.getElementById('userName').textContent = userEmail;

  // Load cached data from IndexedDB — show instantly (no waiting for scan)
  const cached = await loadPersistedData();
  let hasLocalData = cached && cached.domainMap && Object.keys(cached.domainMap).length > 0;

  if (hasLocalData) {
    domainMap = cached.domainMap;
    lastScanTime = cached.lastScanTime;
    fullScanDone = cached.fullScanDone || false;
    deltaLink = cached.deltaLink || null;
    if (cached.seenMsgIds && cached.seenMsgIds.size > 0) {
      seenMsgIds = cached.seenMsgIds;
    } else {
      // Upgrade from old cache: no dedup tracking.
      // Force full rescan to rebuild with immutable IDs + delta sync.
      seenMsgIds = new Set();
      deltaLink = null;
      fullScanDone = false;
    }
    // Migration: if no deltaLink exists, old data used mutable IDs.
    // Force full rescan to rebuild with immutable IDs + delta sync.
    if (!deltaLink && fullScanDone) {
      seenMsgIds = new Set();
      for (const d of Object.values(domainMap)) {
        if (d.sentIds instanceof Set) d.sentIds.clear(); else d.sentIds = new Set();
        if (d.receivedIds instanceof Set) d.receivedIds.clear(); else d.receivedIds = new Set();
        for (const c of Object.values(d.contacts)) {
          if (c.sentIds instanceof Set) c.sentIds.clear(); else c.sentIds = new Set();
          if (c.receivedIds instanceof Set) c.receivedIds.clear(); else c.receivedIds = new Set();
        }
      }
      fullScanDone = false;
    }
    // Check if any domain still uses old counter format (no sentIds Set)
    const needsSetUpgrade = Object.values(domainMap).some(d => !(d.sentIds instanceof Set));
    if (needsSetUpgrade) {
      for (const d of Object.values(domainMap)) {
        if (!(d.sentIds instanceof Set)) d.sentIds = new Set();
        if (!(d.receivedIds instanceof Set)) d.receivedIds = new Set();
        for (const c of Object.values(d.contacts)) {
          if (!(c.sentIds instanceof Set)) c.sentIds = new Set();
          if (!(c.receivedIds instanceof Set)) c.receivedIds = new Set();
        }
      }
      fullScanDone = false;
      deltaLink = null;
    }
    buildCompaniesFromDomainMap();
    renderTableHeader();
    renderTable();
    updateStats();
    updateLastSyncDisplay();
    resolveCompanyNames();
    runEnrichment();
  }

  // If no local data, try restoring from OneDrive cloud sync
  if (!hasLocalData) {
    try {
      setSyncBadge('scanning', 'Restoring...');
      document.getElementById('lastSyncText').textContent = 'Checking cloud backup...';
      const cloudData = await loadFromCloud();
      if (cloudData && cloudData.domainData && Object.keys(cloudData.domainData).length > 0) {
        applyCloudData(cloudData);
        hasLocalData = Object.keys(domainMap).length > 0;
        if (hasLocalData) {
          buildCompaniesFromDomainMap();
          renderTableHeader();
          renderTable();
          updateStats();
          updateLastSyncDisplay();
          resolveCompanyNames();
          runEnrichment();
          // Also persist to local IndexedDB so it's cached locally too
          persistData();
          console.log('Restored ' + Object.keys(domainMap).length + ' domains from cloud backup');
        }
      }
    } catch(e) {
      console.warn('Cloud restore failed:', e);
    }
  }

  updateBlockedCount();
  updateLastSyncDisplay();

  // If we have cached data, show it instantly — sync in background
  // If no cached data (first time), run scan in foreground
  const hasCachedData = companies.length > 0;
  if (hasCachedData) {
    // Non-blocking: sync new emails quietly in background
    scanOutlookEmails();
  } else {
    // First time: must scan to have anything to show
    await scanOutlookEmails();
  }

  // Load inbox in background after data is ready
  setTimeout(() => refreshInbox(), 1000);

  // Keep data fresh automatically
  startAutoSync();
}

// Scan progress shown in the account bar
function showScanBanner(text) {
  setSyncBadge('scanning', 'Syncing...');
  document.getElementById('lastSyncText').textContent = text;
}
function updateScanBanner(text) {
  document.getElementById('lastSyncText').textContent = text;
}
function hideScanBanner() { updateLastSyncDisplay(); }

// ──────────────────────────────────────────────
// TABLE RENDERING (dynamic columns)
// ──────────────────────────────────────────────
const TABLE_PAGE_SIZE = 100;
let tableShowAll = false;

function renderTableHeader() {
  const cols = getVisibleColumns();
  let html = '<tr><th class="col-check"><input type="checkbox" class="row-checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)"></th>';
  for (const col of cols) {
    const meta = BUILTIN_COLUMNS.find(b => b.id === col.id);
    const sortKey = meta ? meta.sortKey : (col.type === 'ai' || col.type === 'custom' ? col.id : null);
    const sortAttr = sortKey ? ' onclick="sortTable(\'' + sortKey + '\')" style="cursor:pointer"' : '';
    const arrow = currentSort.key === sortKey ? (currentSort.asc ? ' &#9650;' : ' &#9660;') : '';
    html += '<th' + sortAttr + ' ondblclick="startRenameColumnHeader(\'' + col.id + '\',this)">' + esc(col.label) + arrow + '</th>';
  }
  html += '</tr>';
  document.getElementById('tableHead').innerHTML = html;
}

function startRenameColumnHeader(id, th) {
  const col = columnConfig.find(c => c.id === id);
  if (!col) return;
  const oldLabel = col.label;
  th.innerHTML = '<input class="col-rename-input" value="' + esc(oldLabel) + '" style="width:90%;font-size:11px">';
  const input = th.querySelector('input');
  input.focus();
  input.select();
  input.onclick = function(e) { e.stopPropagation(); };
  input.onblur = function() {
    if (input.value.trim()) { col.label = input.value.trim(); saveColumnConfig(); }
    renderTableHeader();
  };
  input.onkeydown = function(e) {
    if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
    if (e.key === 'Escape') { renderTableHeader(); }
  };
}

function buildCellHTML(col, c, color) {
  if (col.type === 'builtin') {
    switch (col.id) {
      case 'company':
        var isStarred = starredCompanies.has(c.domain);
        var starDSafe = c.domain.replace(/'/g, "\\'");
        return '<div class="company-cell">' +
          '<button class="row-star' + (isStarred ? ' active' : '') + '" onclick="event.stopPropagation();toggleCompanyStar(\'' + starDSafe + '\')" title="' + (isStarred ? 'Remove from Proposals' : 'Add to Proposals') + '">&#9733;</button>' +
          '<div class="company-logo" style="background:' + color + '">' + companyLogoHTML(c.domain, color, c.name) + '</div><div class="company-info"><span class="company-name">' + esc(c.name) + '</span><span class="company-domain">' + esc(c.domain) + '</span></div></div>';
      case 'contact':
        var initials = c.contact ? c.contact.split(' ').map(function(n){return n[0]}).join('').substring(0,2) : '';
        var ctTitle = getContactTitle(c.contactEmail || '');
        return '<div class="contact-cell"><div class="avatar" style="background:' + color + '">' + contactPhotoHTML(c.contactEmail || '', color, initials) + '</div><div><span class="contact-name">' + esc(c.contact) + '</span>' + (ctTitle ? '<div class="contact-title">' + esc(ctTitle) + '</div>' : '') + '</div></div>';
      case 'sent':
        return '<span style="color:var(--accent2);font-weight:600">' + c.sent + '</span>';
      case 'received':
        return '<span style="color:var(--green);font-weight:600">' + c.received + '</span>';
      case 'emailFlow':
        var total = c.sent + c.received;
        var sentPct = total ? (c.sent / total * 100) : 50;
        return '<div class="email-bar"><div class="bar-track"><div class="bar-sent" style="width:' + sentPct + '%"></div><div class="bar-recv" style="width:' + (100 - sentPct) + '%"></div></div></div>';
      case 'status':
        return '<span class="badge ' + STATUS_CLASS[c.status] + '">' + c.status + '</span>';
      case 'companyType':
        var cType = getCompanyType(c.domain);
        var typeClass = cType === 'Existing Client' ? 'badge-hot' : cType === 'Old Client' ? 'badge-cold' : 'badge-warm';
        var dSafe = c.domain.replace(/'/g, "\\'");
        return '<select class="cp-type-select" onclick="event.stopPropagation()" onchange="event.stopPropagation();setCompanyType(\'' + dSafe + '\',this.value)">' +
          '<option value="Lead"' + (cType === 'Lead' ? ' selected' : '') + '>Lead</option>' +
          '<option value="Existing Client"' + (cType === 'Existing Client' ? ' selected' : '') + '>Existing Client</option>' +
          '<option value="Old Client"' + (cType === 'Old Client' ? ' selected' : '') + '>Old Client</option>' +
        '</select>';
      case 'score':
        var scoreColor = c.score >= 75 ? '#1e8e3e' : c.score >= 50 ? '#e8710a' : '#d93025';
        return '<div class="ai-score"><div class="score-num" style="color:' + scoreColor + ';border-color:' + scoreColor + '">' + c.score + '</div></div>';
      case 'lastActivity':
        return '<span style="color:var(--text2)">' + esc(c.lastActivity) + '</span>';
      default: return '';
    }
  }
  // AI or custom column
  var val = getCellValue(c, col);
  return '<span class="cell-val">' + esc(val) + '</span>';
}

function renderTable() {
  // If showing archived view, use that renderer instead
  if (showingArchived) { showArchivedView(); return; }

  let data = [...companies];

  // Hide archived companies from normal views
  data = data.filter(c => !archivedCompanies.has(c.domain));

  // If showing proposals, only show starred companies
  if (showingProposals) {
    data = data.filter(c => starredCompanies.has(c.domain));
  }

  if (currentFilter !== 'all') data = data.filter(c => c.status === currentFilter);
  if (currentTypeFilter !== 'all') data = data.filter(c => getCompanyType(c.domain) === currentTypeFilter);
  const q = (document.getElementById('searchInput').value || '').toLowerCase();
  if (q) data = data.filter(c => {
    if (c.name.toLowerCase().includes(q) || c.contact.toLowerCase().includes(q) || c.domain.toLowerCase().includes(q)) return true;
    // Search custom/ai column values too
    for (const col of getVisibleColumns()) {
      if (col.type === 'ai' || col.type === 'custom') {
        var val = getCellValue(c, col);
        if (val && val.toLowerCase().includes(q)) return true;
      }
    }
    return false;
  });

  const {key, asc} = currentSort;
  data.sort((a,b) => {
    let va, vb;
    // Check if sorting by a custom/ai column
    const col = columnConfig.find(c => c.id === key);
    if (col && (col.type === 'ai' || col.type === 'custom')) {
      va = getCellValue(a, col) || '';
      vb = getCellValue(b, col) || '';
    } else if (key === 'companyType') {
      va = getCompanyType(a.domain);
      vb = getCompanyType(b.domain);
    } else {
      va = a[key]; vb = b[key];
    }
    if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb||'').toLowerCase(); }
    if (va < vb) return asc ? -1 : 1;
    if (va > vb) return asc ? 1 : -1;
    return 0;
  });

  const cols = getVisibleColumns();
  const colCount = cols.length + 1; // +1 for checkbox
  const tbody = document.getElementById('tableBody');
  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="' + colCount + '" style="text-align:center;padding:40px;color:var(--text2)">No companies found. Click "Sync Emails" to scan your Outlook.</td></tr>';
    updateBulkBar();
    return;
  }

  const totalCount = data.length;
  const visible = tableShowAll ? data : data.slice(0, TABLE_PAGE_SIZE);

  const rows = [];
  for (let i = 0; i < visible.length; i++) {
    const c = visible[i];
    const color = COLORS[c.id % COLORS.length];
    const sel = selectedIds.has(c.id);
    let row = '<tr' + (sel ? ' class="row-selected"' : '') + ' data-id="' + c.id + '">';
    row += '<td class="col-check"><input type="checkbox" class="row-checkbox"' + (sel ? ' checked' : '') + ' data-rid="' + c.id + '"></td>';
    for (const col of cols) {
      const isCustom = col.type === 'ai' || col.type === 'custom';
      row += '<td' + (isCustom ? ' class="custom-cell" data-col="' + col.id + '" data-domain="' + c.domain + '"' : '') + '>' + buildCellHTML(col, c, color) + '</td>';
    }
    row += '</tr>';
    rows.push(row);
  }

  if (!tableShowAll && totalCount > TABLE_PAGE_SIZE) {
    rows.push('<tr class="show-more-row" data-action="showmore"><td colspan="' + colCount + '">Show all ' + totalCount + ' companies (' + (totalCount - TABLE_PAGE_SIZE) + ' more)</td></tr>');
  }

  tbody.innerHTML = rows.join('');

  const selectAll = document.getElementById('selectAllCheckbox');
  if (selectAll) {
    const visibleIds = visible.map(c => c.id);
    const allChecked = visibleIds.length > 0 && visibleIds.every(id => selectedIds.has(id));
    const someChecked = visibleIds.some(id => selectedIds.has(id));
    selectAll.checked = allChecked;
    selectAll.indeterminate = someChecked && !allChecked;
  }

  updateBulkBar();
  document.getElementById('companyCount').textContent = companies.filter(c => !archivedCompanies.has(c.domain)).length;
}

function updateStats() {
  // Exclude archived from main stats
  const active = companies.filter(c => !archivedCompanies.has(c.domain));
  document.getElementById('statCompanies').textContent = active.length;
  document.getElementById('statSent').textContent = active.reduce((s,c) => s + c.sent, 0).toLocaleString();
  document.getElementById('statRecv').textContent = active.reduce((s,c) => s + c.received, 0).toLocaleString();
  document.getElementById('statContacts').textContent = active.reduce((s,c) => s + (c.allContacts?.length || 1), 0).toLocaleString();
  // Update segment counts in sidebar
  const hot = active.filter(c => c.status === 'Hot').length;
  const warm = active.filter(c => c.status === 'Warm').length;
  const cold = active.filter(c => c.status === 'Cold').length;
  document.getElementById('hotCount').textContent = hot;
  document.getElementById('warmCount').textContent = warm;
  document.getElementById('coldCount').textContent = cold;
  updateTypeCounts();
  updateProposalCount();
  updateArchivedCount();
}

function updateTypeCounts() {
  var leads = 0, existing = 0, old = 0;
  var active = companies.filter(function(c) { return !archivedCompanies.has(c.domain); });
  active.forEach(function(c) {
    var t = getCompanyType(c.domain);
    if (t === 'Existing Client') existing++;
    else if (t === 'Old Client') old++;
    else leads++;
  });
  var el;
  el = document.getElementById('allTypesCount'); if (el) el.textContent = active.length;
  el = document.getElementById('leadCount'); if (el) el.textContent = leads;
  el = document.getElementById('existingCount'); if (el) el.textContent = existing;
  el = document.getElementById('oldClientCount'); if (el) el.textContent = old;
}

function filterByType(type, el) {
  currentTypeFilter = type;
  tableShowAll = false;
  showingProposals = false;
  showingArchived = false;
  hideInbox();
  document.getElementById('crmContent').classList.add('active');
  document.getElementById('crmContent').style.display = '';
  document.getElementById('detailPage').classList.remove('active');
  document.querySelectorAll('.sidebar-item').forEach(e => e.classList.remove('active'));
  document.querySelectorAll('.sidebar-item[data-group="type"]').forEach(function(e) {
    e.classList.remove('active');
  });
  if (el) el.classList.add('active');
  clearSelection();
  renderTable();
}

function sortTable(key) {
  if (currentSort.key === key) currentSort.asc = !currentSort.asc;
  else { currentSort.key = key; currentSort.asc = key === 'company' || key === 'contact'; }
  renderTable();
}

function toggleSidebar() {
  const sb = document.getElementById('sidebar');
  sb.classList.toggle('collapsed');
  localStorage.setItem('relateflow_sidebar', sb.classList.contains('collapsed') ? 'collapsed' : '');
}

function filterByStatus(status, el) {
  currentFilter = status;
  tableShowAll = false;
  showingProposals = false;
  showingArchived = false;
  hideInbox();
  document.getElementById('crmContent').classList.add('active');
  document.getElementById('crmContent').style.display = '';
  document.getElementById('detailPage').classList.remove('active');
  document.querySelectorAll('.sidebar-item').forEach(e => e.classList.remove('active'));
  document.querySelectorAll('.sidebar-item[data-group="segment"]').forEach(e => e.classList.remove('active'));
  if (el) el.classList.add('active');
  clearSelection();
  renderTable();
}

// ──────────────────────────────────────────────
// SELECTION & BULK ACTIONS
// ──────────────────────────────────────────────
function toggleRowSelect(id, checked) {
  if (checked) selectedIds.add(id);
  else selectedIds.delete(id);
  renderTable();
}

function toggleSelectAll(checked) {
  // Get currently visible/filtered companies
  let data = [...companies];
  if (currentFilter !== 'all') data = data.filter(c => c.status === currentFilter);
  if (currentTypeFilter !== 'all') data = data.filter(c => getCompanyType(c.domain) === currentTypeFilter);
  const q = (document.getElementById('searchInput').value || '').toLowerCase();
  if (q) data = data.filter(c => c.name.toLowerCase().includes(q) || c.contact.toLowerCase().includes(q) || c.domain.toLowerCase().includes(q));

  if (checked) {
    data.forEach(c => selectedIds.add(c.id));
  } else {
    data.forEach(c => selectedIds.delete(c.id));
  }
  renderTable();
}

function clearSelection() {
  selectedIds.clear();
  const selectAll = document.getElementById('selectAllCheckbox');
  if (selectAll) { selectAll.checked = false; selectAll.indeterminate = false; }
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById('bulkBar');
  if (selectedIds.size > 0) {
    bar.classList.add('active');
    document.getElementById('bulkCount').textContent = selectedIds.size + ' selected';
  } else {
    bar.classList.remove('active');
  }
}

function bulkSetType(type) {
  if (!type) return;
  for (var id of selectedIds) {
    var c = companies.find(function(x) { return x.id === id; });
    if (c) companyTypes[c.domain] = type;
  }
  saveCompanyTypes();
  selectedIds.clear();
  updateTypeCounts();
  renderTable();
}

function bulkBlockSelected() {
  const domains = [];
  for (const id of selectedIds) {
    const c = companies.find(x => x.id === id);
    if (c) domains.push(c.domain);
  }
  if (domains.length === 0) return;
  const msg = domains.length === 1
    ? 'Block "' + domains[0] + '" from your system?'
    : 'Block ' + domains.length + ' domains from your system?\n\n' + domains.join(', ');
  if (!confirm(msg)) return;

  for (const d of domains) {
    blockedDomains.add(d.toLowerCase());
  }
  saveBlockedDomains();
  selectedIds.clear();
  buildCompaniesFromDomainMap();
  renderTable();
  updateStats();
  updateBlockedCount();
}

// ──────────────────────────────────────────────
// BLOCKED DOMAINS VIEW
// ──────────────────────────────────────────────
function updateBlockedCount() {
  const badge = document.getElementById('blockedCount');
  if (badge) badge.textContent = blockedDomains.size;
}

function showBlockedView() {
  showingProposals = false;
  showingArchived = false;
  hideInbox();
  document.getElementById('crmContent').classList.add('active');
  document.getElementById('crmContent').style.display = '';
  document.getElementById('detailPage').classList.remove('active');
  // Switch sidebar active
  document.querySelectorAll('.sidebar-item').forEach(e => e.classList.remove('active'));
  document.getElementById('blockedViewItem').classList.add('active');

  // Render blocked domains as a table in the main table body
  const tbody = document.getElementById('tableBody');
  const sorted = [...blockedDomains].sort();

  if (sorted.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text2)">No blocked domains. Domains you block will appear here.</td></tr>';
    return;
  }

  tbody.innerHTML = sorted.map(domain => {
    // Check if domain still has data in domainMap
    const data = domainMap[domain];
    const totalSent = data ? data.sentIds.size : 0;
    const totalRecv = data ? data.receivedIds.size : 0;
    const contactCount = data ? Object.keys(data.contacts).length : 0;

    return `<tr>
      <td class="col-check"></td>
      <td><div class="company-cell"><div class="company-logo" style="background:var(--red);opacity:.6">${domain[0].toUpperCase()}</div><div class="company-info"><span class="company-name" style="text-decoration:line-through;opacity:.6">${esc(domain.split('.')[0].charAt(0).toUpperCase() + domain.split('.')[0].slice(1))}</span><span class="company-domain">${esc(domain)}</span></div></div></td>
      <td colspan="5" style="color:var(--text2);font-size:12px">${totalSent} sent, ${totalRecv} received, ${contactCount} contact${contactCount !== 1 ? 's' : ''}</td>
      <td colspan="2" style="text-align:right">
        <button class="btn btn-ghost btn-sm" onclick="unblockDomain('${domain}')" style="font-size:11px;color:var(--green);border-color:var(--green)">Unblock</button>
      </td>
    </tr>`;
  }).join('');

  // Clear select-all since blocked view doesn't use checkboxes
  clearSelection();
}

function unblockDomain(domain) {
  blockedDomains.delete(domain);
  saveBlockedDomains();
  buildCompaniesFromDomainMap();
  updateStats();
  updateBlockedCount();
  showBlockedView(); // Re-render the blocked view
}

// ──────────────────────────────────────────────
// STARRED COMPANIES (Proposals)
// ──────────────────────────────────────────────
let showingProposals = false;

function toggleCompanyStar(domain) {
  if (starredCompanies.has(domain)) {
    starredCompanies.delete(domain);
  } else {
    starredCompanies.add(domain);
  }
  saveStarredCompanies();
  updateProposalCount();
  renderTable();
}

function showProposals() {
  showingProposals = true;
  showingArchived = false;
  currentFilter = 'all';
  currentTypeFilter = 'all';
  tableShowAll = false;
  hideInbox();
  document.getElementById('crmContent').classList.add('active');
  document.getElementById('crmContent').style.display = '';
  document.getElementById('detailPage').classList.remove('active');
  document.querySelectorAll('.sidebar-item').forEach(e => e.classList.remove('active'));
  document.getElementById('proposalNavItem').classList.add('active');
  clearSelection();
  renderTable();
}

function updateProposalCount() {
  const el = document.getElementById('proposalCount');
  if (el) el.textContent = starredCompanies.size;
}

// ──────────────────────────────────────────────
// ARCHIVED COMPANIES
// ──────────────────────────────────────────────
let showingArchived = false;

function archiveCompany(domain) {
  archivedCompanies.add(domain);
  starredCompanies.delete(domain); // unstar if starred
  saveArchivedCompanies();
  saveStarredCompanies();
  updateArchivedCount();
  updateProposalCount();
  buildCompaniesFromDomainMap();
  updateStats();
  renderTable();
}

function unarchiveCompany(domain) {
  archivedCompanies.delete(domain);
  saveArchivedCompanies();
  updateArchivedCount();
  buildCompaniesFromDomainMap();
  updateStats();
  showArchivedView();
}

function showArchivedView() {
  showingProposals = false;
  showingArchived = true;
  hideInbox();
  document.getElementById('crmContent').classList.add('active');
  document.getElementById('crmContent').style.display = '';
  document.getElementById('detailPage').classList.remove('active');
  document.querySelectorAll('.sidebar-item').forEach(e => e.classList.remove('active'));
  document.getElementById('archivedViewItem').classList.add('active');

  const tbody = document.getElementById('tableBody');
  const archivedDomains = [...archivedCompanies].sort();

  if (archivedDomains.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text2)">No archived companies. Companies you archive will appear here.</td></tr>';
    clearSelection();
    return;
  }

  tbody.innerHTML = archivedDomains.map(domain => {
    const data = domainMap[domain];
    const totalSent = data ? data.sentIds.size : 0;
    const totalRecv = data ? data.receivedIds.size : 0;
    const contactCount = data ? Object.keys(data.contacts).length : 0;
    const name = companyNameCache[domain] || KNOWN_BRANDS[domain] || titleCase(domain.split('.')[0].replace(/[-_]/g, ' '));

    return '<tr>' +
      '<td class="col-check"></td>' +
      '<td><div class="company-cell"><div class="company-logo" style="background:var(--text2);opacity:.6">' + domain[0].toUpperCase() + '</div><div class="company-info"><span class="company-name" style="opacity:.7">' + esc(name) + '</span><span class="company-domain">' + esc(domain) + '</span></div></div></td>' +
      '<td colspan="5" style="color:var(--text2);font-size:12px">' + totalSent + ' sent, ' + totalRecv + ' received, ' + contactCount + ' contact' + (contactCount !== 1 ? 's' : '') + '</td>' +
      '<td colspan="2" style="text-align:right">' +
        '<button class="btn btn-ghost btn-sm" onclick="unarchiveCompany(\'' + domain.replace(/'/g, "\\'") + '\')" style="font-size:11px;color:var(--green);border-color:var(--green)">Restore</button>' +
      '</td>' +
    '</tr>';
  }).join('');

  clearSelection();
}

function updateArchivedCount() {
  const el = document.getElementById('archivedCount');
  if (el) el.textContent = archivedCompanies.size;
}

function bulkArchiveSelected() {
  const domains = [];
  for (const id of selectedIds) {
    const c = companies.find(x => x.id === id);
    if (c) domains.push(c.domain);
  }
  if (domains.length === 0) return;
  const msg = domains.length === 1
    ? 'Archive "' + domains[0] + '"?'
    : 'Archive ' + domains.length + ' companies?';
  if (!confirm(msg)) return;

  for (const d of domains) {
    archivedCompanies.add(d.toLowerCase());
    starredCompanies.delete(d.toLowerCase());
  }
  saveArchivedCompanies();
  saveStarredCompanies();
  selectedIds.clear();
  buildCompaniesFromDomainMap();
  renderTable();
  updateStats();
  updateArchivedCount();
  updateProposalCount();
}

function bulkStarSelected() {
  for (const id of selectedIds) {
    const c = companies.find(x => x.id === id);
    if (c) starredCompanies.add(c.domain);
  }
  saveStarredCompanies();
  selectedIds.clear();
  updateProposalCount();
  renderTable();
}

// ──────────────────────────────────────────────
// ADD COMPANY MANUALLY
// ──────────────────────────────────────────────
function showAddCompanyModal() {
  document.getElementById('addCompanyModal').classList.add('active');
  document.getElementById('addCompanyName').value = '';
  document.getElementById('addCompanyDomain').value = '';
  document.getElementById('addCompanyEmail').value = '';
  document.getElementById('addCompanyType').value = 'Lead';
  setTimeout(() => document.getElementById('addCompanyName').focus(), 100);
}

function closeAddCompanyModal() {
  document.getElementById('addCompanyModal').classList.remove('active');
}

function addCompanyManually() {
  const name = document.getElementById('addCompanyName').value.trim();
  const domain = document.getElementById('addCompanyDomain').value.trim().toLowerCase().replace(/^https?:\/\//, '').replace(/^www\./, '').replace(/\/.*$/, '');
  const email = document.getElementById('addCompanyEmail').value.trim().toLowerCase();
  const type = document.getElementById('addCompanyType').value;

  if (!name || !domain) {
    alert('Company name and domain are required.');
    return;
  }
  if (domain.indexOf('.') === -1) {
    alert('Please enter a valid domain (e.g. acme.com).');
    return;
  }
  if (isBlockedDomain(domain)) {
    alert('This domain is currently blocked. Unblock it first.');
    return;
  }

  // Create entry in domainMap if it doesn't exist
  if (!domainMap[domain]) {
    domainMap[domain] = {
      contacts: {},
      sentIds: new Set(),
      receivedIds: new Set(),
      lastDate: new Date(),
      lastSentDate: new Date(),
      lastReceivedDate: null
    };
  }

  // Add a placeholder sent message so buildCompaniesFromDomainMap includes it
  const placeholderId = 'manual_' + domain + '_' + Date.now();
  domainMap[domain].sentIds.add(placeholderId);

  // Add contact if provided
  if (email) {
    const contactName = email.split('@')[0].replace(/[._-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    if (!domainMap[domain].contacts[email]) {
      domainMap[domain].contacts[email] = {
        name: contactName,
        email: email,
        sentIds: new Set([placeholderId]),
        receivedIds: new Set(),
        lastDate: new Date()
      };
    }
  } else {
    // Add a generic placeholder contact
    const placeholder = 'contact@' + domain;
    if (!domainMap[domain].contacts[placeholder]) {
      domainMap[domain].contacts[placeholder] = {
        name: name,
        email: placeholder,
        sentIds: new Set([placeholderId]),
        receivedIds: new Set(),
        lastDate: new Date()
      };
    }
  }

  // Cache the company name
  companyNameCache[domain] = name;
  companyNameCacheDirty = true;
  saveCompanyNameCache();

  // Set the type
  companyTypes[domain] = type;
  saveCompanyTypes();

  // Rebuild and render
  persistData();
  buildCompaniesFromDomainMap();
  updateStats();
  renderTable();
  closeAddCompanyModal();
  updateProposalCount();
  updateArchivedCount();
}

// ──────────────────────────────────────────────
// INLINE DETAIL PANEL — single page, no overlays
// States: 'company' (contacts list) or 'contact' (timeline)
// ──────────────────────────────────────────────
let panelState = null; // null | { view:'company', companyId } | { view:'contact', email, domain, companyId }

function openDetail(id) { showCompanyPanel(id); }

function showCompanyPanel(id) {
  const c = companies.find(x => x.id === id);
  if (!c) return;
  _prePanelView = document.getElementById('inboxView').classList.contains('active') ? 'inbox' : 'crm';
  currentCompanyOverlay = c;
  panelState = { view: 'company', companyId: id, selectedContact: null };
  const color = COLORS[c.id % COLORS.length];
  const contacts = c.allContacts || [];
  const sorted = [...contacts].sort((a, b) => (b.sent + b.received) - (a.sent + a.received));
  const primaryEmail = starredContacts[c.domain] || (sorted[0] ? sorted[0].email : '');

  // AI insight
  let insight = '';
  if (c.score >= 75) insight = 'High engagement. ' + (c.sent + c.received) + ' emails exchanged — consider scheduling a call.';
  else if (c.score >= 50) insight = 'Active relationship. ' + (c.received > c.sent ? 'Good responsiveness from them.' : 'You send more than they reply — try a new angle.');
  else if (c.score >= 30) insight = 'Early stage — only ' + (c.sent + c.received) + ' emails. Increase outreach to build momentum.';
  else insight = 'Going cold — last activity ' + c.lastActivity + '. Re-engage with a personalized message.';

  const circumference = 2 * Math.PI * 12;
  const offset = circumference - (c.score / 100) * circumference;
  const scoreColor = c.score >= 75 ? 'var(--green)' : c.score >= 50 ? 'var(--orange)' : 'var(--red)';

  // Topbar
  document.getElementById('dpTopbarTitle').textContent = c.name;

  // Left head: company info
  let headHtml = '<div class="dp-company-head">' +
    '<div class="dp-co-logo" style="background:' + color + '">' + companyLogoHTML(c.domain, color, c.name, 44) + '</div>' +
    '<div class="dp-co-info"><h2>' + esc(c.name) + '</h2><div class="dp-domain">' + esc(c.domain) + ' <a href="' + linkedInCompanyURL(c.domain) + '" target="_blank" class="linkedin-link" title="Find on LinkedIn">' + linkedInIconSVG() + '</a></div></div>' +
  '</div>';

  var currentType = getCompanyType(c.domain);
  var dSafeType = c.domain.replace(/'/g, "\\'");
  headHtml += '<div class="dp-co-meta">' +
    '<span class="badge ' + (STATUS_CLASS[c.status] || '') + '">' + c.status + '</span>' +
    '<select class="cp-type-select" onchange="setCompanyType(\'' + dSafeType + '\',this.value);showCompanyPanel(' + c.id + ')" title="Company type">' +
      '<option value="Lead"' + (currentType === 'Lead' ? ' selected' : '') + '>Lead</option>' +
      '<option value="Existing Client"' + (currentType === 'Existing Client' ? ' selected' : '') + '>Existing Client</option>' +
      '<option value="Old Client"' + (currentType === 'Old Client' ? ' selected' : '') + '>Old Client</option>' +
    '</select>' +
    '<div class="ai-score"><div class="score-ring" style="color:' + scoreColor + '"><svg viewBox="0 0 30 30"><circle class="track" cx="15" cy="15" r="12"/><circle class="fill" cx="15" cy="15" r="12" stroke="' + scoreColor + '" stroke-dasharray="' + circumference + '" stroke-dashoffset="' + offset + '"/></svg>' + c.score + '</div></div>' +
    '<span style="font-size:11px;color:var(--text2)">' + esc(c.lastActivity) + '</span>' +
  '</div>';

  headHtml += '<div class="dp-mini-stats">' +
    '<div class="dp-mini-stat"><span class="label">Sent</span><div class="value" style="color:var(--accent2)">' + c.sent + '</div></div>' +
    '<div class="dp-mini-stat"><span class="label">Received</span><div class="value" style="color:var(--green)">' + c.received + '</div></div>' +
    '<div class="dp-mini-stat"><span class="label">Total</span><div class="value">' + (c.sent + c.received) + '</div></div>' +
  '</div>';

  headHtml += '<div class="ai-insight" style="margin-bottom:0"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg><div><div class="label">AI Insight</div><p style="margin:0">' + esc(insight) + '</p></div></div>';

  // Company website link
  headHtml += '<div style="margin-top:10px"><a href="https://' + esc(c.domain) + '" target="_blank" rel="noopener" class="btn btn-ghost btn-sm" style="width:100%;justify-content:center;gap:6px">' +
    '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>' +
    esc(c.domain) + '</a></div>';

  document.getElementById('dpLeftHead').innerHTML = headHtml;

  // Left contacts list
  let ctHtml = '<div class="dp-section-title">Relationships <span class="cnt">' + sorted.length + '</span></div>';
  for (const ct of sorted) {
    const initials = ct.name.split(' ').map(function(n){return n[0]}).join('').substring(0, 2).toUpperCase();
    const total = ct.sent + ct.received;
    const isPrimary = ct.email === primaryEmail;
    const eSafe = ct.email.replace(/'/g, "\\'");
    const dSafe = c.domain.replace(/'/g, "\\'");

    const ctTitle = getContactTitle(ct.email);
    ctHtml += '<div class="dp-contact" data-email="' + esc(ct.email) + '" onclick="selectContact(\'' + eSafe + '\',\'' + dSafe + '\',' + c.id + ')">' +
      '<div class="dp-ct-avatar" style="background:' + color + '">' + contactPhotoHTML(ct.email, color, initials, 30) + '</div>' +
      '<div class="dp-ct-info">' +
        '<div class="dp-ct-name">' + esc(ct.name) + (isPrimary ? ' <span class="dp-primary-badge">Primary</span>' : '') + '</div>' +
        '<div class="dp-ct-email">' + esc(ct.email) + (ctTitle ? ' · ' + esc(ctTitle) : '') + '</div>' +
      '</div>' +
      '<div class="dp-ct-count"><span style="color:var(--accent2)">' + ct.sent + '</span><span style="color:var(--text3);margin:0 1px">/</span><span style="color:var(--green)">' + ct.received + '</span></div>' +
      '<button class="dp-star' + (isPrimary ? ' active' : '') + '" onclick="event.stopPropagation();toggleStar(\'' + dSafe + '\',\'' + eSafe + '\')" title="' + (isPrimary ? 'Primary' : 'Set primary') + '">&#9733;</button>' +
    '</div>';
  }
  document.getElementById('dpLeftContacts').innerHTML = ctHtml;

  // Left footer
  var dSafeF = c.domain.replace(/'/g, "\\'");
  var isStarredF = starredCompanies.has(c.domain);
  var isArchivedF = archivedCompanies.has(c.domain);
  document.getElementById('dpLeftFoot').innerHTML =
    '<div style="display:flex;flex-direction:column;gap:6px">' +
    '<button class="btn btn-ghost btn-sm" onclick="toggleCompanyStar(\'' + dSafeF + '\');showCompanyPanel(' + c.id + ')" style="color:#f5a623;border-color:#f5a623;font-size:11px;width:100%">' +
    '<svg width="12" height="12" viewBox="0 0 24 24" fill="' + (isStarredF ? '#f5a623' : 'none') + '" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> ' + (isStarredF ? 'Remove from Proposals' : 'Add to Proposals') + '</button>' +
    '<button class="btn btn-ghost btn-sm" onclick="if(confirm(\'Archive ' + esc(c.domain) + '?\'))archiveCompanyFromDetail(\'' + dSafeF + '\')" style="color:var(--text2);border-color:var(--border);font-size:11px;width:100%">' +
    '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg> Archive company</button>' +
    '<button class="btn btn-ghost btn-sm" onclick="if(confirm(\'Block ' + esc(c.domain) + '?\'))blockDomainFromDetail(\'' + dSafeF + '\')" style="color:var(--red);border-color:var(--red);font-size:11px;width:100%">' +
    '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg> Block domain</button>' +
    '</div>';

  // Reset right side to empty state
  document.getElementById('dpRightEmpty').style.display = 'flex';
  document.getElementById('dpRightHead').style.display = 'none';
  document.getElementById('dpRightTabs').style.display = 'none';
  document.getElementById('dpTimeline').style.display = 'none';

  // Show detail page, hide CRM table / inbox
  document.getElementById('crmContent').style.display = 'none';
  document.getElementById('inboxView').classList.remove('active');
  document.getElementById('detailPage').classList.add('active');

  // Auto-select first contact if available
  if (sorted.length > 0) {
    selectContact(sorted[0].email, c.domain, c.id);
  }
}

function selectContact(email, domain, companyId) {
  const data = domainMap[domain];
  if (!data) return;
  const ct = data.contacts[email.toLowerCase()];
  if (!ct) return;
  const c = companies.find(x => x.domain === domain);
  const color = COLORS[(c ? c.id : 0) % COLORS.length];
  currentContactOverlay = { contact: ct, company: c, domain: domain, email: email.toLowerCase() };
  if (panelState) panelState.selectedContact = email.toLowerCase();
  currentContactTab = 'all';
  closeInlineReply();

  // Highlight selected contact in left list
  document.querySelectorAll('#dpLeftContacts .dp-contact').forEach(function(el) {
    el.classList.toggle('selected', el.dataset.email === email.toLowerCase());
  });

  const initials = ct.name.split(' ').map(function(n){return n[0]}).join('').substring(0, 2).toUpperCase();
  const isPrimary = starredContacts[domain] === email.toLowerCase();
  const eSafe = ct.email.replace(/'/g, "\\'");

  const companyName = c ? c.name : domain;
  const ctTitle = getContactTitle(ct.email);
  const ctLinkedIn = getContactLinkedIn(ct.email) || linkedInPersonURL(ct.name, companyName);
  const titleESafe = ct.email.replace(/'/g, "\\'");

  // Right head
  let headHtml = '<div class="dp-ct-head">' +
    '<div class="dp-ct-big-avatar" style="background:' + color + '">' + contactPhotoHTML(ct.email, color, initials, 40) + '</div>' +
    '<div class="dp-ct-head-info">' +
      '<h2>' + esc(ct.name) + '</h2>' +
      '<div class="dp-ct-head-email">' + esc(ct.email) + '</div>' +
      '<div style="display:flex;align-items:center;gap:8px;margin-top:3px">' +
        '<span class="contact-title" contenteditable="true" style="min-width:60px;padding:1px 4px;border:1px solid transparent;border-radius:3px;cursor:text;font-size:11px;color:var(--text2)" ' +
          'onblur="setContactTitle(\'' + titleESafe + '\',this.textContent);this.style.borderColor=\'transparent\'" ' +
          'onfocus="this.style.borderColor=\'var(--border)\'" ' +
          'data-placeholder="Add title...">' + esc(ctTitle) + '</span>' +
        '<a href="' + ctLinkedIn + '" target="_blank" class="linkedin-link" title="LinkedIn profile">' + linkedInIconSVG() + ' LinkedIn</a>' +
      '</div>' +
    '</div>' +
    '<button class="dp-star' + (isPrimary ? ' active' : '') + '" onclick="toggleStarInPanel(\'' + domain.replace(/'/g, "\\'") + '\',\'' + email.toLowerCase().replace(/'/g, "\\'") + '\')" style="font-size:20px">&#9733;</button>' +
  '</div>';
  headHtml += '<div class="dp-ct-actions">' +
    '<button class="btn btn-primary btn-sm" onclick="openCompose(\'' + eSafe + '\',\'' + esc(ct.name) + '\',\'\',\'\')">' +
      '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> Email' +
    '</button>' +
  '</div>';
  headHtml += '<div class="dp-ct-stats-row">' +
    '<div class="dp-ct-stat"><b style="color:var(--accent2)">' + ct.sent + '</b>Sent</div>' +
    '<div class="dp-ct-stat"><b style="color:var(--green)">' + ct.received + '</b>Received</div>' +
    '<div class="dp-ct-stat"><b>' + (ct.lastDate ? timeAgo(ct.lastDate) : '—') + '</b>Last</div>' +
  '</div>';

  document.getElementById('dpRightHead').innerHTML = headHtml;

  // Right tabs
  document.getElementById('dpRightTabs').innerHTML =
    '<button class="dp-tab active" onclick="switchTab(\'all\',this)">All</button>' +
    '<button class="dp-tab" onclick="switchTab(\'sent\',this)">Sent</button>' +
    '<button class="dp-tab" onclick="switchTab(\'received\',this)">Received</button>' +
    '<button class="dp-tab" onclick="switchTab(\'meetings\',this)">Meetings</button>';

  // Show right side, hide empty state
  document.getElementById('dpRightEmpty').style.display = 'none';
  document.getElementById('dpRightHead').style.display = '';
  document.getElementById('dpRightTabs').style.display = '';
  document.getElementById('dpTimeline').style.display = '';
  document.getElementById('dpTimeline').innerHTML = '<div class="tl-loading"><div class="scan-spinner"></div>Loading...</div>';

  fetchContactTimeline(email.toLowerCase(), domain);
}

// Keep showContactPanel as alias for legacy calls
function showContactPanel(email, domain, companyId) {
  selectContact(email, domain, companyId);
}

let _prePanelView = 'crm'; // track which view was active before detail panel
function closePanel() {
  document.getElementById('detailPage').classList.remove('active');
  if (_prePanelView === 'inbox') {
    document.getElementById('crmContent').classList.remove('active');
    document.getElementById('inboxView').classList.add('active');
    document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
    document.getElementById('inboxNavItem').classList.add('active');
  } else {
    document.getElementById('crmContent').style.display = '';
  }
  panelState = null;
  currentCompanyOverlay = null;
  currentContactOverlay = null;
}

// Close with Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && document.getElementById('detailPage').classList.contains('active')) closePanel();
});

function toggleStar(domain, email) {
  if (starredContacts[domain] === email) {
    delete starredContacts[domain];
  } else {
    starredContacts[domain] = email;
  }
  saveStarredContacts();
  buildCompaniesFromDomainMap();
  renderTable();
  updateStats();
  // Re-render current panel state
  if (panelState && panelState.view === 'company') {
    const c = companies.find(x => x.domain === domain);
    if (c) showCompanyPanel(c.id);
  }
}

function toggleStarInPanel(domain, email) {
  toggleStar(domain, email);
  // If on contact view, refresh it
  if (panelState && panelState.view === 'contact') {
    showContactPanel(panelState.email, panelState.domain, panelState.companyId);
  }
}

function switchTab(tab, el) {
  currentContactTab = tab;
  document.querySelectorAll('.dp-tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  if (currentContactOverlay) renderTimeline(currentContactOverlay.email);
}

// ──────────────────────────────────────────────
// TIMELINE — fetch from Outlook and render inline
// ──────────────────────────────────────────────
async function fetchContactTimeline(email, domain) {
  const el = document.getElementById('dpTimeline');
  if (!el) return;
  el.innerHTML = '<div class="tl-loading"><div class="scan-spinner"></div>Loading activity from Outlook...</div>';

  if (contactTimelineCache[email] && contactTimelineCache[email].length > 0) {
    renderTimeline(email);
    return;
  }

  try {
    const token = await getAccessToken();
    const headers = graphHeaders(token);
    const items = [];
    const select = '$select=id,subject,from,toRecipients,receivedDateTime,sentDateTime,bodyPreview,conversationId,webLink';
    const top = '$top=75';

    // Use $search with "participants:" — this reliably finds ALL emails
    // involving this contact (both sent to and received from).
    // Note: $search cannot be combined with $orderby, so we sort client-side.
    const searchUrl = 'https://graph.microsoft.com/v1.0/me/messages?' + top + '&' + select +
      '&$search=' + encodeURIComponent('"participants:' + email + '"');
    const searchResp = await fetch(searchUrl, { headers });
    if (searchResp.ok) {
      const searchData = await searchResp.json();
      if (searchData.value) {
        const myLower = userEmail.toLowerCase();
        for (const m of searchData.value) {
          const fromAddr = (m.from?.emailAddress?.address || '').toLowerCase();
          const isSent = fromAddr === myLower;
          const isFromContact = fromAddr === email.toLowerCase();
          // Classify: sent by me, received from contact, or skip
          if (isSent) {
            items.push({ type: 'sent', subject: m.subject || '(no subject)', date: new Date(m.sentDateTime || m.receivedDateTime), preview: m.bodyPreview || '', id: m.id, conversationId: m.conversationId, webLink: m.webLink || '' });
          } else if (isFromContact) {
            items.push({ type: 'received', subject: m.subject || '(no subject)', date: new Date(m.receivedDateTime || m.sentDateTime), preview: m.bodyPreview || '', id: m.id, conversationId: m.conversationId, webLink: m.webLink || '' });
          }
        }
      }
    } else {
      // Fallback: try simple $filter on from address only (always works)
      console.warn('$search failed (' + searchResp.status + '), falling back to $filter');
      const filterUrl = 'https://graph.microsoft.com/v1.0/me/messages?' + top + '&' + select +
        '&$orderby=receivedDateTime desc&$filter=' + encodeURIComponent("from/emailAddress/address eq '" + email + "'");
      const filterResp = await fetch(filterUrl, { headers });
      if (filterResp.ok) {
        const filterData = await filterResp.json();
        if (filterData.value) {
          for (const m of filterData.value) {
            items.push({ type: 'received', subject: m.subject || '(no subject)', date: new Date(m.receivedDateTime || m.sentDateTime), preview: m.bodyPreview || '', id: m.id, conversationId: m.conversationId, webLink: m.webLink || '' });
          }
        }
      }
    }

    // Calendar events — wrapped in try/catch since Calendars.Read may not be granted
    try {
      const calUrl = 'https://graph.microsoft.com/v1.0/me/events?$top=20&$select=subject,start,end,attendees,isOnlineMeeting' +
        '&$search=' + encodeURIComponent('"' + email + '"');
      const calResp = await fetch(calUrl, { headers });
      if (calResp.ok) {
        const calData = await calResp.json();
        if (calData.value) for (const ev of calData.value) {
          items.push({ type: 'meeting', subject: ev.subject || 'Meeting', date: new Date(ev.start?.dateTime), preview: (ev.isOnlineMeeting ? 'Online' : 'In-person') + ' · ' + (ev.attendees?.length || 0) + ' attendees', id: ev.id });
        }
      }
    } catch(e) {}

    // Dedupe and sort by date descending
    const seen = new Set();
    const unique = [];
    for (const item of items) { if (!seen.has(item.id)) { seen.add(item.id); unique.push(item); } }
    unique.sort((a, b) => b.date - a.date);
    contactTimelineCache[email] = unique;
    renderTimeline(email);
  } catch(e) {
    console.error('Timeline fetch error:', e);
    if (el) el.innerHTML = '<div class="tl-empty">Could not load activity. ' + esc(e.message) + '</div>';
  }
}

function renderTimeline(email) {
  const el = document.getElementById('dpTimeline');
  if (!el) return;
  let items = contactTimelineCache[email] || [];

  if (currentContactTab === 'sent') items = items.filter(i => i.type === 'sent');
  else if (currentContactTab === 'received') items = items.filter(i => i.type === 'received');
  else if (currentContactTab === 'meetings') items = items.filter(i => i.type === 'meeting');

  if (items.length === 0) {
    const msgs = { all: 'No activity found.', sent: 'No sent emails.', received: 'No received emails.', meetings: 'No meetings found.' };
    el.innerHTML = '<div class="tl-empty">' + (msgs[currentContactTab] || msgs.all) + '</div>';
    return;
  }

  const groups = {};
  for (const item of items) { const key = formatDateGroup(item.date); if (!groups[key]) groups[key] = []; groups[key].push(item); }

  const svgSent = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>';
  const svgRecv = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>';
  const svgMeet = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>';

  let html = '<div class="tl-list">';
  for (const [dateLabel, groupItems] of Object.entries(groups)) {
    html += '<div class="tl-date-group"><div class="tl-date-label">' + esc(dateLabel) + '</div>';
    for (const item of groupItems) {
      const icon = item.type === 'meeting' ? svgMeet : item.type === 'sent' ? svgSent : svgRecv;
      const time = item.date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const replyBtn = item.type !== 'meeting'
        ? ' <button class="tl-reply-btn" onclick="event.stopPropagation();openReply(\'' + item.id.replace(/'/g, "\\'") + '\',\'' + (currentContactOverlay ? currentContactOverlay.email.replace(/'/g, "\\'") : '') + '\',\'' + esc(item.subject).replace(/'/g, "\\'") + '\')">Reply</button>'
        : '';
      const clickAttr = item.type !== 'meeting' ? ' onclick="openEmailViewer(\'' + item.id.replace(/'/g, "\\'") + '\')"' : '';
      html += '<div class="tl-item"' + clickAttr + ' title="View email">' +
        '<div class="tl-icon ' + item.type + '">' + icon + '</div>' +
        '<div class="tl-content"><div class="tl-subject">' + esc(item.subject) + '</div>' +
        (item.preview ? '<div class="tl-preview">' + esc(item.preview.substring(0, 100)) + '</div>' : '') +
        '</div>' +
        '<div style="display:flex;flex-direction:column;align-items:flex-end;gap:2px"><div class="tl-time">' + time + '</div>' + replyBtn + '</div>' +
      '</div>';
    }
    html += '</div>';
  }
  html += '</div>';
  el.innerHTML = html;
}

function formatDateGroup(date) {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
  const diff = Math.floor((today - d) / 86400000);
  if (diff === 0) return 'Today';
  if (diff === 1) return 'Yesterday';
  if (diff < 7) return date.toLocaleDateString([], { weekday: 'long' });
  return date.toLocaleDateString([], { month: 'long', day: 'numeric', year: now.getFullYear() !== date.getFullYear() ? 'numeric' : undefined });
}

// ──────────────────────────────────────────────
// EMAIL VIEWER — inline viewer for reading emails inside CRM
// ──────────────────────────────────────────────
let currentViewerMsgId = null;
let currentViewerWebLink = null;

async function openEmailViewer(messageId) {
  currentViewerMsgId = messageId;
  currentViewerWebLink = null;
  const overlay = document.getElementById('emailViewerOverlay');
  const loading = document.getElementById('evLoading');
  overlay.classList.add('active');
  loading.classList.add('active');
  document.getElementById('evSubject').textContent = '';
  document.getElementById('evFrom').innerHTML = '';
  document.getElementById('evTo').innerHTML = '';
  document.getElementById('evDate').textContent = '';
  document.getElementById('evAvatar').textContent = '';
  document.getElementById('evAttachments').style.display = 'none';
  document.getElementById('evBodyFrame').srcdoc = '';

  try {
    const token = await getAccessToken();
    const headers = graphHeaders(token);
    const resp = await fetch('https://graph.microsoft.com/v1.0/me/messages/' + messageId + '?$select=subject,from,toRecipients,ccRecipients,receivedDateTime,sentDateTime,body,hasAttachments,webLink', { headers });
    if (!resp.ok) throw new Error('Failed to load email (' + resp.status + ')');
    const msg = await resp.json();

    currentViewerWebLink = msg.webLink || null;

    // Subject
    document.getElementById('evSubject').textContent = msg.subject || '(no subject)';

    // Sender avatar + name
    const fromName = msg.from?.emailAddress?.name || '';
    const fromAddr = msg.from?.emailAddress?.address || '';
    const initials = fromName ? fromName.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase() : fromAddr.substring(0, 1).toUpperCase();
    document.getElementById('evAvatar').textContent = initials;
    document.getElementById('evFrom').innerHTML = esc(fromName || fromAddr) + (fromName ? ' <span>' + esc(fromAddr) + '</span>' : '');

    // To + CC
    const toNames = (msg.toRecipients || []).map(r => esc(r.emailAddress?.name || r.emailAddress?.address || '')).join(', ');
    const ccNames = (msg.ccRecipients || []).map(r => esc(r.emailAddress?.name || r.emailAddress?.address || '')).join(', ');
    let toHtml = 'to ' + toNames;
    if (ccNames) toHtml += ', <strong>CC:</strong> ' + ccNames;
    document.getElementById('evTo').innerHTML = toHtml;

    // Date
    const dt = new Date(msg.receivedDateTime || msg.sentDateTime);
    document.getElementById('evDate').textContent = dt.toLocaleString([], { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });

    // Body — render in sandboxed iframe with generous padding
    const bodyContent = msg.body?.content || '';
    const bodyType = msg.body?.contentType || 'text';
    const frame = document.getElementById('evBodyFrame');
    const baseStyle = 'body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-size:14px;color:#222;padding:24px 28px;margin:0;line-height:1.6;word-break:break-word}img{max-width:100%;height:auto}a{color:#1a73e8}pre,code{white-space:pre-wrap;word-break:break-all}blockquote{border-left:3px solid #ddd;margin:8px 0;padding:4px 12px;color:#555}';
    if (bodyType === 'html') {
      frame.srcdoc = '<html><head><style>' + baseStyle + '</style></head><body>' + bodyContent + '</body></html>';
    } else {
      frame.srcdoc = '<html><head><style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-size:14px;color:#222;padding:24px 28px;margin:0;white-space:pre-wrap;word-break:break-word;line-height:1.6}</style></head><body>' + esc(bodyContent) + '</body></html>';
    }

    // Attachments
    if (msg.hasAttachments) {
      loadAttachments(messageId, token);
    }

    loading.classList.remove('active');
  } catch(e) {
    loading.classList.remove('active');
    document.getElementById('evSubject').textContent = 'Error loading email';
    document.getElementById('evFrom').innerHTML = '<span style="color:var(--red)">' + esc(e.message) + '</span>';
    console.error('Email viewer error:', e);
  }
}

async function loadAttachments(messageId, token) {
  try {
    const resp = await fetch('https://graph.microsoft.com/v1.0/me/messages/' + messageId + '/attachments?$select=id,name,contentType,size', { headers: graphHeaders(token) });
    if (!resp.ok) return;
    const data = await resp.json();
    const atts = data.value || [];
    if (atts.length === 0) return;

    const el = document.getElementById('evAttachments');
    const clipSvg = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>';
    let html = '';
    for (const att of atts) {
      const sizeKB = Math.round((att.size || 0) / 1024);
      const sizeStr = sizeKB > 1024 ? (sizeKB / 1024).toFixed(1) + ' MB' : sizeKB + ' KB';
      html += '<a class="ev-att-chip" href="#" onclick="event.preventDefault();downloadAttachment(\'' + messageId + '\',\'' + att.id.replace(/'/g, "\\'") + '\',\'' + esc(att.name).replace(/'/g, "\\'") + '\')">' + clipSvg + ' ' + esc(att.name) + ' <span style="opacity:.6">(' + sizeStr + ')</span></a>';
    }
    el.innerHTML = html;
    el.style.display = 'flex';
  } catch(e) { console.warn('Attachment load error:', e); }
}

async function downloadAttachment(messageId, attachmentId, fileName) {
  try {
    const token = await getAccessToken();
    const resp = await fetch('https://graph.microsoft.com/v1.0/me/messages/' + messageId + '/attachments/' + attachmentId + '/$value', { headers: graphHeaders(token) });
    if (!resp.ok) throw new Error('Download failed');
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = fileName; a.click();
    URL.revokeObjectURL(url);
  } catch(e) { alert('Could not download attachment: ' + e.message); }
}

function closeEmailViewer() {
  document.getElementById('emailViewerOverlay').classList.remove('active');
  currentViewerMsgId = null;
  currentViewerWebLink = null;
}
document.addEventListener('keydown', e => { if (e.key === 'Escape' && currentViewerMsgId) closeEmailViewer(); });

function replyFromViewer() {
  if (!currentViewerMsgId) return;
  const subject = document.getElementById('evSubject').textContent || '';
  const contactEmail = currentContactOverlay ? currentContactOverlay.email : '';
  closeEmailViewer();
  openReply(currentViewerMsgId, contactEmail, subject);
}

function openInOutlook() {
  if (currentViewerWebLink) window.open(currentViewerWebLink, '_blank');
}

// ──────────────────────────────────────────────
// EMAIL COMPOSE & REPLY (via Graph API sendMail)
// ──────────────────────────────────────────────
let composeReplyToId = null;

// ── Outlook-style compose popup ──
var composePopupState = 'normal'; // 'normal', 'fullscreen', 'minimized'

function openCompose(toEmail, toName, subject, replyId) {
  composeReplyToId = replyId || null;
  document.getElementById('composeTo').value = toName ? toName + ' <' + toEmail + '>' : toEmail;
  document.getElementById('composeTo').dataset.email = toEmail;
  document.getElementById('composeSubject').value = subject || '';
  document.getElementById('composeBody').value = '';
  document.getElementById('composeSendStatus').textContent = '';
  document.getElementById('composeSendBtn').disabled = false;
  document.getElementById('composeTitle').textContent = replyId ? 'Reply' : 'New Email';
  composeSetState('normal');
  var popup = document.getElementById('composePopup');
  popup.classList.add('active');
  setTimeout(function() { document.getElementById(subject ? 'composeBody' : 'composeSubject').focus(); }, 100);
}

function openReply(messageId, toEmail, subject) {
  var reSubject = subject.startsWith('Re:') ? subject : 'Re: ' + subject;
  var ctName = currentContactOverlay ? currentContactOverlay.contact.name : '';
  openCompose(toEmail, ctName, reSubject, messageId);
}

function closeInlineReply() { composeClose(); }

function composeClose() {
  var popup = document.getElementById('composePopup');
  popup.classList.remove('active');
  composeReplyToId = null;
}

function composeMinimize() {
  composeSetState(composePopupState === 'minimized' ? 'normal' : 'minimized');
}

function composeToggleMax() {
  composeSetState(composePopupState === 'fullscreen' ? 'normal' : 'fullscreen');
}

function composeSetState(state) {
  composePopupState = state;
  var popup = document.getElementById('composePopup');
  popup.classList.remove('cp-normal', 'cp-fullscreen', 'cp-minimized');
  popup.classList.add('cp-' + state);
  // Update maximize button icon
  var maxBtn = document.getElementById('composeMaxBtn');
  if (state === 'fullscreen') {
    maxBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 14 14" fill="none"><rect x="4" y="1" width="9" height="9" rx="1.5" stroke="currentColor" stroke-width="1.4"/><rect x="1" y="4" width="9" height="9" rx="1.5" stroke="currentColor" stroke-width="1.4" fill="var(--surface)"/></svg>';
    maxBtn.title = 'Restore';
  } else {
    maxBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 14 14" fill="none"><rect x="2" y="2" width="10" height="10" rx="1.5" stroke="currentColor" stroke-width="1.4"/></svg>';
    maxBtn.title = 'Maximize';
  }
}

// Click minimized bar to restore
document.addEventListener('click', function(e) {
  if (composePopupState !== 'minimized') return;
  var titlebar = document.getElementById('composeTitlebar');
  if (titlebar && titlebar.contains(e.target) && !e.target.closest('.cp-btn')) {
    composeSetState('normal');
  }
});

async function sendComposedEmail() {
  var toEmail = document.getElementById('composeTo').dataset.email;
  var subject = document.getElementById('composeSubject').value.trim();
  var body = document.getElementById('composeBody').value.trim();
  if (!toEmail || !subject || !body) {
    document.getElementById('composeSendStatus').textContent = 'Please fill in subject and message.';
    document.getElementById('composeSendStatus').style.color = 'var(--red)';
    return;
  }

  var btn = document.getElementById('composeSendBtn');
  var status = document.getElementById('composeSendStatus');
  btn.disabled = true;
  status.textContent = 'Sending...';
  status.style.color = '';

  try {
    var token = await getAccessToken();
    var headers = graphHeaders(token);
    var message = { subject: subject, body: { contentType: 'Text', content: body }, toRecipients: [{ emailAddress: { address: toEmail } }] };
    var resp = await fetch('https://graph.microsoft.com/v1.0/me/sendMail', { method: 'POST', headers: headers, body: JSON.stringify({ message: message, saveToSentItems: true }) });
    if (!resp.ok) { var err = await resp.text(); throw new Error('Send failed: ' + resp.status + ' — ' + err); }

    status.textContent = 'Sent!';
    status.style.color = 'var(--green)';
    delete contactTimelineCache[toEmail.toLowerCase()];
    setTimeout(function() {
      composeClose();
      status.style.color = '';
      if (currentContactOverlay && currentContactOverlay.email) {
        fetchContactTimeline(currentContactOverlay.email, currentContactOverlay.domain || '');
      }
    }, 1000);
  } catch(e) {
    console.error('Send error:', e);
    status.textContent = 'Failed: ' + e.message;
    status.style.color = 'var(--red)';
    btn.disabled = false;
  }
}

// ──────────────────────────────────────────────
// SETTINGS
// ──────────────────────────────────────────────
function openSettings() {
  document.getElementById('settingsModal').classList.add('active');
  document.getElementById('clientIdInput').value = getClientId();
  document.getElementById('redirectDisplay').textContent = window.location.origin + window.location.pathname;
  renderBlockedDomainsList();
}

function closeSettings() {
  document.getElementById('settingsModal').classList.remove('active');
}

async function saveSettings() {
  const clientId = document.getElementById('clientIdInput').value.trim();
  if (!clientId) { alert('Please enter your Application (Client) ID'); return; }
  if (!/^[a-f0-9-]{36}$/i.test(clientId)) {
    if (!confirm('That doesn\'t look like a standard Azure Client ID (should be a UUID). Save anyway?')) return;
  }
  localStorage.setItem('relateflow_client_id', clientId);
  closeSettings();
  msalInstance = null;
  await initMSAL();
  await signIn();
}

// ──────────────────────────────────────────────
// CLOUD SYNC & BACKUP UI ACTIONS
// ──────────────────────────────────────────────
async function manualCloudSave() {
  const status = document.getElementById('cloudSyncStatus');
  const btn = document.getElementById('cloudSaveBtn');
  if (!currentAccount) { status.textContent = 'Sign in first to sync.'; return; }
  btn.disabled = true;
  status.textContent = 'Saving to OneDrive...';
  status.style.color = 'var(--text2)';
  try {
    await saveToCloud();
    status.textContent = 'Saved to OneDrive successfully!';
    status.style.color = 'var(--green)';
  } catch(e) {
    status.textContent = 'Save failed: ' + e.message;
    status.style.color = 'var(--red)';
  }
  btn.disabled = false;
}

async function manualCloudRestore() {
  const status = document.getElementById('cloudSyncStatus');
  if (!currentAccount) { status.textContent = 'Sign in first to restore.'; return; }
  if (!confirm('This will merge cloud data with your current local data. Continue?')) return;
  status.textContent = 'Restoring from OneDrive...';
  status.style.color = 'var(--text2)';
  try {
    const data = await loadFromCloud();
    if (!data) { status.textContent = 'No cloud backup found.'; status.style.color = 'var(--orange)'; return; }
    applyCloudData(data);
    buildCompaniesFromDomainMap();
    renderTableHeader();
    renderTable();
    updateStats();
    updateBlockedCount();
    persistData();
    status.textContent = 'Restored from cloud! (' + Object.keys(domainMap).length + ' domains, ' + blockedDomains.size + ' blocked)';
    status.style.color = 'var(--green)';
  } catch(e) {
    status.textContent = 'Restore failed: ' + e.message;
    status.style.color = 'var(--red)';
  }
}

function exportBackup() {
  const payload = gatherSyncPayload();
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'kennion-crm-backup-' + new Date().toISOString().slice(0, 10) + '.json';
  a.click();
  const status = document.getElementById('cloudSyncStatus');
  if (status) { status.textContent = 'Backup file downloaded.'; status.style.color = 'var(--green)'; }
}

function importBackup(event) {
  const file = event.target.files[0];
  if (!file) return;
  const status = document.getElementById('cloudSyncStatus');
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.version || !data.settings) { alert('Invalid backup file.'); return; }
      if (!confirm('This will merge the backup with your current data. Continue?')) return;
      applyCloudData(data);
      buildCompaniesFromDomainMap();
      renderTableHeader();
      renderTable();
      updateStats();
      updateBlockedCount();
      persistData();
      scheduleCloudSync();
      if (status) { status.textContent = 'Backup imported! (' + Object.keys(domainMap).length + ' domains)'; status.style.color = 'var(--green)'; }
    } catch(err) {
      alert('Failed to parse backup file: ' + err.message);
    }
  };
  reader.readAsText(file);
  event.target.value = ''; // reset file input
}

// ──────────────────────────────────────────────
// BLOCKED DOMAINS MANAGEMENT
// ──────────────────────────────────────────────
function addBlockedDomainsFromInput() {
  const input = document.getElementById('blockDomainsInput');
  const raw = input.value.trim();
  if (!raw) return;
  addBlockedDomains(raw);
  input.value = '';
}

function addBlockedDomains(raw) {
  // Parse: split on newlines, commas, spaces — extract domains
  const entries = raw.split(/[\n,;\s]+/).map(s => s.trim().toLowerCase()).filter(Boolean);
  let added = 0;
  for (const entry of entries) {
    // If it's an email address, extract domain
    const domain = entry.includes('@') ? entry.split('@')[1] : entry;
    if (domain && !SKIP_DOMAINS.has(domain) && !blockedDomains.has(domain)) {
      blockedDomains.add(domain);
      added++;
    }
  }
  if (added > 0) {
    saveBlockedDomains();
    // Rebuild companies to remove newly blocked domains
    buildCompaniesFromDomainMap();
    renderTable();
    updateStats();
    updateBlockedCount();
    renderBlockedDomainsList();
  }
}

function removeBlockedDomain(domain) {
  blockedDomains.delete(domain);
  saveBlockedDomains();
  // Rebuild companies — the unblocked domain may reappear
  buildCompaniesFromDomainMap();
  renderTable();
  updateStats();
  updateBlockedCount();
  renderBlockedDomainsList();
}

function blockDomainFromDetail(domain) {
  blockedDomains.add(domain.toLowerCase());
  saveBlockedDomains();
  buildCompaniesFromDomainMap();
  renderTable();
  updateStats();
  updateBlockedCount();
  closePanel();
}

function archiveCompanyFromDetail(domain) {
  archivedCompanies.add(domain.toLowerCase());
  starredCompanies.delete(domain.toLowerCase());
  saveArchivedCompanies();
  saveStarredCompanies();
  buildCompaniesFromDomainMap();
  renderTable();
  updateStats();
  updateArchivedCount();
  updateProposalCount();
  closePanel();
}

function renderBlockedDomainsList() {
  const container = document.getElementById('blockedDomainsList');
  if (!container) return;
  if (blockedDomains.size === 0) {
    container.innerHTML = '<span style="font-size:11px;color:var(--text2)">No blocked domains yet</span>';
    return;
  }
  const sorted = [...blockedDomains].sort();
  container.innerHTML = sorted.map(d =>
    `<span class="blocked-tag">${esc(d)}<button onclick="removeBlockedDomain('${d}')" title="Unblock">&times;</button></span>`
  ).join('');
}

// ──────────────────────────────────────────────
// EXPORT CSV
// ──────────────────────────────────────────────
function exportCSV() {
  const header = 'Company,Domain,Primary Contact,Contact Email,Sent,Received,Status,AI Score,Last Activity\n';
  const rows = companies.map(c =>
    `"${c.name}","${c.domain}","${c.contact}","${c.contactEmail}",${c.sent},${c.received},"${c.status}",${c.score},"${c.lastActivity}"`
  ).join('\n');
  const blob = new Blob([header + rows], {type: 'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'relateflow-export.csv';
  a.click();
}

// ──────────────────────────────────────────────
// INBOX — Outlook-style with real delete/archive
// ──────────────────────────────────────────────
let inboxEmails = [];
let inboxSelectedIds = new Set();
let inboxCurrentTab = 'all';
let inboxLoading = false;

function showInbox() {
  showingProposals = false;
  showingArchived = false;
  document.getElementById('crmContent').classList.remove('active');
  document.getElementById('inboxView').classList.add('active');
  const dp = document.getElementById('detailPage');
  if (dp) dp.classList.remove('active');
  document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
  document.getElementById('inboxNavItem').classList.add('active');
  if (!inboxEmails.length && !inboxLoading) refreshInbox();
  else renderInbox();
}

function hideInbox() {
  document.getElementById('inboxView').classList.remove('active');
  document.getElementById('inboxNavItem').classList.remove('active');
}

function switchInboxTab(tab, btn) {
  inboxCurrentTab = tab;
  inboxSelectedIds.clear();
  document.querySelectorAll('.inbox-tab').forEach(t => t.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderInbox();
}

async function refreshInbox() {
  if (inboxLoading) return;
  if (!currentAccount) return;
  inboxLoading = true;
  const list = document.getElementById('inboxList');
  list.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;gap:10px;padding:60px;color:var(--text2)"><div class="scan-spinner"></div> Loading inbox...</div>';

  try {
    const token = await getAccessToken();
    const headers = graphHeaders(token);
    const allEmails = [];
    // Fetch ONLY from Inbox folder (active emails, not archived/deleted)
    let url = 'https://graph.microsoft.com/v1.0/me/mailFolders/inbox/messages?$top=100&$orderby=receivedDateTime desc&$select=id,subject,from,toRecipients,receivedDateTime,bodyPreview,isRead,webLink,conversationId';
    let pages = 0;
    while (url && pages < 3) {
      const resp = await fetch(url, { headers });
      if (!resp.ok) break;
      const data = await resp.json();
      if (data.value) allEmails.push(...data.value);
      url = data['@odata.nextLink'] || null;
      pages++;
    }

    // Filter to only emails FROM known CRM leads/contacts
    const myLower = userEmail ? userEmail.toLowerCase() : '';
    const crmDomains = new Set(Object.keys(domainMap));
    inboxEmails = [];
    for (const msg of allEmails) {
      const fromAddr = (msg.from?.emailAddress?.address || '').toLowerCase();
      if (fromAddr === myLower) continue;
      const domain = getDomain(fromAddr);
      if (!domain || !crmDomains.has(domain)) continue;
      if (isBlockedDomain(domain)) continue;

      const company = companies.find(c => c.domain === domain);
      inboxEmails.push({
        id: msg.id,
        subject: msg.subject || '(no subject)',
        from: msg.from?.emailAddress?.name || fromAddr,
        fromEmail: fromAddr,
        domain: domain,
        companyName: company ? company.name : domain,
        companyId: company ? company.id : null,
        date: new Date(msg.receivedDateTime),
        preview: msg.bodyPreview || '',
        isRead: msg.isRead,
        webLink: msg.webLink || '',
        conversationId: msg.conversationId || ''
      });
    }
    inboxSelectedIds.clear();
    renderInbox();
    updateInboxBadge();
  } catch(e) {
    console.error('Inbox load error:', e);
    list.innerHTML = '<div class="inbox-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><p>Could not load inbox</p><span>' + esc(e.message) + '</span></div>';
  }
  inboxLoading = false;
}

function renderInbox() {
  const list = document.getElementById('inboxList');
  let items = [...inboxEmails];

  if (inboxCurrentTab === 'unread') items = items.filter(e => !e.isRead);

  // Update badges
  const unreadCount = inboxEmails.filter(e => !e.isRead).length;
  const allBadge = document.getElementById('inboxTabAll');
  const newBadge = document.getElementById('inboxTabNew');
  allBadge.textContent = inboxEmails.length;
  allBadge.style.display = inboxEmails.length ? '' : 'none';
  newBadge.textContent = unreadCount;
  newBadge.style.display = unreadCount ? '' : 'none';
  document.getElementById('inboxTopCount').textContent = inboxEmails.length + ' emails from leads';

  // Show/hide bulk action buttons
  const hasSelection = inboxSelectedIds.size > 0;
  document.getElementById('inboxArchiveBtn').style.display = hasSelection ? '' : 'none';
  document.getElementById('inboxDeleteBtn').style.display = hasSelection ? '' : 'none';

  if (!items.length) {
    list.innerHTML = `<div class="inbox-empty">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/></svg>
      <p>${inboxCurrentTab === 'unread' ? 'No unread emails' : 'Inbox is clear'}</p>
      <span>${inboxCurrentTab === 'unread' ? 'All caught up!' : 'Only active emails in your Outlook inbox from CRM leads appear here'}</span>
    </div>`;
    return;
  }

  // Group by date
  const groups = {};
  const today = new Date(); today.setHours(0,0,0,0);
  const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
  const weekAgo = new Date(today); weekAgo.setDate(weekAgo.getDate() - 7);

  for (const item of items) {
    const d = new Date(item.date); d.setHours(0,0,0,0);
    let label;
    if (d.getTime() === today.getTime()) label = 'Today';
    else if (d.getTime() === yesterday.getTime()) label = 'Yesterday';
    else if (d >= weekAgo) label = 'This Week';
    else label = d.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
    if (!groups[label]) groups[label] = [];
    groups[label].push(item);
  }

  let html = '';
  for (const [label, groupItems] of Object.entries(groups)) {
    html += `<div class="inbox-date-label">${esc(label)}</div>`;
    for (const item of groupItems) {
      const initials = item.from.split(/\s+/).map(w => w[0]).join('').substring(0, 2).toUpperCase();
      const colorIdx = Math.abs(item.fromEmail.split('').reduce((h, c) => (h * 31 + c.charCodeAt(0)) | 0, 0)) % COLORS.length;
      const isToday = new Date(item.date).setHours(0,0,0,0) === today.getTime();
      const timeStr = isToday
        ? item.date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        : item.date.toLocaleDateString([], { month: 'short', day: 'numeric' });
      const unread = !item.isRead ? ' unread' : '';
      const selected = inboxSelectedIds.has(item.id) ? ' selected' : '';
      const checked = inboxSelectedIds.has(item.id) ? ' checked' : '';
      const eid = item.id.replace(/'/g, "\\'");
      html += `<div class="inbox-row${unread}${selected}" data-id="${esc(item.id)}">
        <div class="inbox-check"><input type="checkbox"${checked} onclick="event.stopPropagation();inboxToggleSelect('${eid}',this.checked)"></div>
        <div class="inbox-row-avatar" style="background:${COLORS[colorIdx]}">${initials}</div>
        <div class="inbox-row-from" onclick="openEmailViewer('${eid}')">
          ${esc(item.from)}
          <span class="from-company">${esc(item.companyName)}</span>
        </div>
        <div class="inbox-row-content" onclick="openEmailViewer('${eid}')">
          <div class="inbox-row-subject">${esc(item.subject)}</div>
          <div class="inbox-row-preview">${esc(item.preview.substring(0, 140))}</div>
        </div>
        <div class="inbox-row-meta">
          <div class="inbox-row-time">${timeStr}</div>
          <div class="inbox-row-actions">
            <button class="inbox-act act-archive" onclick="event.stopPropagation();inboxArchiveOne('${eid}')" title="Archive">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
            </button>
            <button class="inbox-act act-delete" onclick="event.stopPropagation();inboxDeleteOne('${eid}')" title="Delete">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
            </button>
            <button class="inbox-act" onclick="event.stopPropagation();openCompose('${item.fromEmail.replace(/'/g, "\\'")}','${esc(item.from).replace(/'/g, "\\'")}','Re: ${esc(item.subject).replace(/'/g, "\\'")}')" title="Reply">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 00-4-4H4"/></svg>
            </button>
          </div>
        </div>
      </div>`;
    }
  }
  list.innerHTML = html;
}

// Selection
function inboxToggleSelect(msgId, checked) {
  if (checked) inboxSelectedIds.add(msgId);
  else inboxSelectedIds.delete(msgId);
  renderInbox();
}

// Archive — moves to Archive folder in Outlook
async function inboxArchiveOne(msgId) {
  const row = document.querySelector(`.inbox-row[data-id="${CSS.escape(msgId)}"]`);
  if (row) { row.style.opacity = '.3'; row.style.pointerEvents = 'none'; }
  try {
    const token = await getAccessToken();
    await fetch('https://graph.microsoft.com/v1.0/me/messages/' + msgId + '/move', {
      method: 'POST', headers: graphHeaders(token),
      body: JSON.stringify({ destinationId: 'archive' })
    });
    inboxEmails = inboxEmails.filter(e => e.id !== msgId);
    inboxSelectedIds.delete(msgId);
    renderInbox();
    updateInboxBadge();
  } catch(e) {
    console.error('Archive failed:', e);
    if (row) { row.style.opacity = ''; row.style.pointerEvents = ''; }
  }
}

async function inboxArchiveSelected() {
  const ids = [...inboxSelectedIds];
  if (!ids.length) return;
  try {
    const token = await getAccessToken();
    const headers = graphHeaders(token);
    await Promise.all(ids.map(id =>
      fetch('https://graph.microsoft.com/v1.0/me/messages/' + id + '/move', {
        method: 'POST', headers,
        body: JSON.stringify({ destinationId: 'archive' })
      })
    ));
    inboxEmails = inboxEmails.filter(e => !inboxSelectedIds.has(e.id));
    inboxSelectedIds.clear();
    renderInbox();
    updateInboxBadge();
  } catch(e) { console.error('Bulk archive failed:', e); }
}

// Delete — permanently deletes in Outlook
async function inboxDeleteOne(msgId) {
  const row = document.querySelector(`.inbox-row[data-id="${CSS.escape(msgId)}"]`);
  if (row) { row.style.opacity = '.3'; row.style.pointerEvents = 'none'; }
  try {
    const token = await getAccessToken();
    await fetch('https://graph.microsoft.com/v1.0/me/messages/' + msgId, {
      method: 'DELETE', headers: graphHeaders(token)
    });
    inboxEmails = inboxEmails.filter(e => e.id !== msgId);
    inboxSelectedIds.delete(msgId);
    renderInbox();
    updateInboxBadge();
  } catch(e) {
    console.error('Delete failed:', e);
    if (row) { row.style.opacity = ''; row.style.pointerEvents = ''; }
  }
}

async function inboxDeleteSelected() {
  const ids = [...inboxSelectedIds];
  if (!ids.length) return;
  try {
    const token = await getAccessToken();
    const headers = graphHeaders(token);
    await Promise.all(ids.map(id =>
      fetch('https://graph.microsoft.com/v1.0/me/messages/' + id, {
        method: 'DELETE', headers
      })
    ));
    inboxEmails = inboxEmails.filter(e => !inboxSelectedIds.has(e.id));
    inboxSelectedIds.clear();
    renderInbox();
    updateInboxBadge();
  } catch(e) { console.error('Bulk delete failed:', e); }
}

function updateInboxBadge() {
  const count = inboxEmails.filter(e => !e.isRead).length;
  const badge = document.getElementById('inboxCount');
  const numEl = document.getElementById('inboxCountNum');
  if (count > 0) {
    numEl.textContent = count > 99 ? '99+' : count;
    badge.style.display = '';
  } else {
    badge.style.display = 'none';
  }
}

// ──────────────────────────────────────────────
// AI CHAT — Full CRM Search & Intelligence
// ──────────────────────────────────────────────
function askAISuggestion(question) {
  document.getElementById('aiInput').value = question;
  sendAI();
}

function clearAIChat() {
  const msgs = document.getElementById('aiMessages');
  msgs.innerHTML = `<div class="ai-msg bot">I can search your entire CRM — companies, contacts, emails, engagement scores, and enrichment data. Ask me anything.</div>`;
  document.getElementById('aiSuggestions').style.display = 'flex';
}

function sendAI() {
  const input = document.getElementById('aiInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  const msgs = document.getElementById('aiMessages');
  // hide suggestions after first query
  document.getElementById('aiSuggestions').style.display = 'none';
  msgs.innerHTML += `<div class="ai-msg user">${esc(msg)}</div>`;
  // show typing indicator
  const typingId = 'typing-' + Date.now();
  msgs.innerHTML += `<div class="ai-typing" id="${typingId}"><span></span><span></span><span></span></div>`;
  msgs.scrollTop = msgs.scrollHeight;
  setTimeout(() => {
    const typing = document.getElementById(typingId);
    if (typing) typing.remove();
    msgs.innerHTML += `<div class="ai-msg bot">${generateAIReply(msg)}</div>`;
    msgs.scrollTop = msgs.scrollHeight;
  }, 500);
}

function _card(html) { return `<div class="ai-result-card">${html}</div>`; }
function _label(text) { return `<div class="ai-result-label">${text}</div>`; }
function _companyCard(c) {
  const enr = enrichmentCache[c.domain] || {};
  let meta = [enr.industry, enr.city, enr.country].filter(Boolean).join(', ');
  if (enr.employees) meta += (meta ? ' · ' : '') + enr.employees + ' employees';
  const type = getCompanyType(c.domain);
  return _card(
    `<b>${esc(c.name)}</b> <span style="color:var(--text2)">(${esc(c.domain)})</span><br>`
    + `${esc(c.contact)} · Score: <b>${c.score}</b> · ${c.status}${type !== 'Lead' ? ' · ' + type : ''}<br>`
    + `Sent: ${c.sent} · Received: ${c.received} · Last: ${c.lastActivity}`
    + (meta ? `<br><span style="color:var(--text2)">${esc(meta)}</span>` : '')
  );
}
function _contactCard(contact, domain) {
  const ce = contactEnrichment[contact.email] || {};
  let extra = ce.title ? esc(ce.title) : '';
  return _card(
    `<b>${esc(contact.name)}</b> &lt;${esc(contact.email)}&gt;<br>`
    + `Sent: ${contact.sent} · Received: ${contact.received}`
    + (contact.lastDate ? ` · Last: ${_timeAgo(contact.lastDate)}` : '')
    + (extra ? `<br><span style="color:var(--text2)">${extra}</span>` : '')
  );
}
function _timeAgo(d) {
  if (!d) return 'N/A';
  const date = d instanceof Date ? d : new Date(d);
  const diff = Date.now() - date.getTime();
  const days = Math.floor(diff / 86400000);
  if (days === 0) return 'today';
  if (days === 1) return 'yesterday';
  if (days < 30) return days + ' days ago';
  if (days < 365) return Math.floor(days / 30) + ' months ago';
  return Math.floor(days / 365) + ' years ago';
}

function _searchAllContacts(query) {
  const results = [];
  for (const domain in domainMap) {
    const dm = domainMap[domain];
    for (const email in dm.contacts) {
      const c = dm.contacts[email];
      if (c.name.toLowerCase().includes(query) || email.includes(query)) {
        results.push({...c, email, domain});
      }
    }
  }
  return results.sort((a, b) => (b.sent + b.received) - (a.sent + a.received));
}

function _searchTimeline(query) {
  const results = [];
  for (const email in contactTimelineCache) {
    const items = contactTimelineCache[email];
    for (const item of items) {
      if ((item.subject && item.subject.toLowerCase().includes(query)) ||
          (item.preview && item.preview.toLowerCase().includes(query))) {
        results.push({...item, contactEmail: email});
      }
    }
  }
  return results.sort((a, b) => new Date(b.date) - new Date(a.date));
}

function generateAIReply(msg) {
  const lower = msg.toLowerCase().trim();
  if (!companies.length) return 'No CRM data loaded yet. Please sync your emails first, then I can search everything for you.';

  // ── FOLLOW-UPS & REACH OUT ──
  if (/follow.?up|followup|reach out|re-engage|reconnect/i.test(lower)) {
    const targets = companies.filter(c => c.status === 'Cold' || c.status === 'Warm').sort((a,b) => b.score - a.score).slice(0, 7);
    if (!targets.length) return 'All your contacts look engaged! No immediate follow-ups needed right now.';
    return _label('Recommended Follow-ups') + targets.map(c => _companyCard(c)).join('');
  }

  // ── HOT LEADS / TOP / BEST ──
  if (/\b(hot|hottest)\b.*\b(lead|compan)|best.*(lead|engag|compan)|top.*(lead|engag|compan|score)|highest.*(score|engag)|most engaged/i.test(lower) || (lower.includes('hot') && lower.includes('lead'))) {
    const hot = companies.filter(c => c.status === 'Hot').sort((a,b) => b.score - a.score).slice(0, 8);
    if (!hot.length) return 'No hot leads yet. Keep emailing to build engagement!';
    return _label(`Hot Leads (${companies.filter(c=>c.status==='Hot').length} total)`) + hot.map(c => _companyCard(c)).join('');
  }

  // ── COLD / AT RISK ──
  if (/\bcold\b|at risk|losing|disengag|inactive|gone quiet|no reply|no response/i.test(lower)) {
    const cold = companies.filter(c => c.status === 'Cold').sort((a,b) => a.score - b.score).slice(0, 8);
    if (!cold.length) return 'No cold leads — all companies are engaged!';
    return _label(`At Risk — Cold Leads (${companies.filter(c=>c.status==='Cold').length} total)`) + cold.map(c => _companyCard(c)).join('');
  }

  // ── WARM LEADS ──
  if (/\bwarm\b/i.test(lower) && /lead|compan|list|show/i.test(lower)) {
    const warm = companies.filter(c => c.status === 'Warm').sort((a,b) => b.score - a.score).slice(0, 8);
    if (!warm.length) return 'No warm leads right now.';
    return _label(`Warm Leads (${companies.filter(c=>c.status==='Warm').length} total)`) + warm.map(c => _companyCard(c)).join('');
  }

  // ── PIPELINE SUMMARY / OVERVIEW / STATS ──
  if (/summary|overview|stats|pipeline|dashboard|report|how.*(doing|look|going)|breakdown/i.test(lower)) {
    const ts = companies.reduce((s,c) => s + c.sent, 0);
    const tr = companies.reduce((s,c) => s + c.received, 0);
    const hot = companies.filter(c => c.status === 'Hot');
    const warm = companies.filter(c => c.status === 'Warm');
    const cold = companies.filter(c => c.status === 'Cold');
    const leads = companies.filter(c => getCompanyType(c.domain) === 'Lead');
    const existing = companies.filter(c => getCompanyType(c.domain) === 'Existing Client');
    const avgScore = companies.length ? Math.round(companies.reduce((s,c) => s + c.score, 0) / companies.length) : 0;
    const totalContacts = companies.reduce((s,c) => s + (c.allContacts?.length || 1), 0);
    return _label('Pipeline Summary')
      + _card(
        `<b>${companies.length}</b> companies · <b>${totalContacts}</b> contacts<br>`
        + `<b>${ts.toLocaleString()}</b> sent · <b>${tr.toLocaleString()}</b> received · Avg score: <b>${avgScore}</b>`
      )
      + _card(
        `🔴 Hot: <b>${hot.length}</b> · 🟡 Warm: <b>${warm.length}</b> · 🔵 Cold: <b>${cold.length}</b><br>`
        + `Leads: <b>${leads.length}</b> · Existing Clients: <b>${existing.length}</b>`
      )
      + (hot.length ? _label('Top Performers') + hot.sort((a,b)=>b.score-a.score).slice(0,3).map(c => _companyCard(c)).join('') : '');
  }

  // ── SEARCH CONTACTS ──
  if (/\bcontact|who works|people at|person at|find.*@|search.*@/i.test(lower)) {
    // extract search term — strip command words
    const searchTerm = lower.replace(/\b(search|find|show|list|get|who|works|at|contacts?|people|person|for|me|the|all|in|from)\b/g, '').trim();
    if (searchTerm) {
      const results = _searchAllContacts(searchTerm);
      if (results.length) {
        return _label(`Contacts matching "${esc(searchTerm)}" (${results.length} found)`) + results.slice(0, 8).map(c => _contactCard(c, c.domain)).join('');
      }
    }
    // also check if a company name matches
    const companyMatch = companies.find(c => lower.includes(c.name.toLowerCase()) || lower.includes(c.domain.toLowerCase()));
    if (companyMatch && companyMatch.allContacts?.length) {
      return _label(`Contacts at ${esc(companyMatch.name)}`) + companyMatch.allContacts.slice(0, 10).map(c => _contactCard(c, companyMatch.domain)).join('');
    }
    return 'No contacts found matching that query. Try a name, email, or company domain.';
  }

  // ── SEARCH EMAILS / SUBJECTS ──
  if (/email.*about|search.*email|find.*email|subject.*about|mail.*about|email.*mention|email.*contain/i.test(lower)) {
    const searchTerm = lower.replace(/\b(search|find|show|list|get|emails?|about|subject|mail|mention|contain|containing|with|the|me|for|that|all)\b/g, '').trim();
    if (searchTerm && Object.keys(contactTimelineCache).length) {
      const results = _searchTimeline(searchTerm);
      if (results.length) {
        return _label(`Emails matching "${esc(searchTerm)}" (${results.length} found)`)
          + results.slice(0, 6).map(e => _card(
            `<b>${esc(e.subject || '(no subject)')}</b><br>`
            + `<span style="color:var(--text2)">${e.type === 'sent' ? 'Sent' : e.type === 'received' ? 'Received' : 'Meeting'} · ${_timeAgo(e.date)} · ${esc(e.contactEmail)}</span>`
            + (e.preview ? `<br><span style="color:var(--text2)">${esc(e.preview.substring(0, 120))}${e.preview.length > 120 ? '...' : ''}</span>` : '')
          )).join('');
      }
      return `No emails found matching "${esc(searchTerm)}". Note: I can only search emails that have been loaded in contact timelines. Open a company to load their emails first.`;
    }
    return 'Specify what to search for, e.g. "search emails about proposal". I search through loaded contact timelines.';
  }

  // ── SEARCH BY INDUSTRY ──
  if (/\bindustr|sector/i.test(lower) || /\b(in|from)\s+(tech|health|financ|educ|market|real estate|legal|consult|retail|manufactur|energy|media)/i.test(lower)) {
    const industryTerm = lower.replace(/\b(search|find|show|list|get|companies?|in|from|the|industry|sector|all|me|by)\b/g, '').trim();
    if (industryTerm) {
      const matches = companies.filter(c => {
        const enr = enrichmentCache[c.domain] || {};
        return enr.industry && enr.industry.toLowerCase().includes(industryTerm);
      }).sort((a,b) => b.score - a.score);
      if (matches.length) {
        return _label(`Companies in "${esc(industryTerm)}" (${matches.length} found)`) + matches.slice(0, 8).map(c => _companyCard(c)).join('');
      }
    }
    // list all industries
    const industries = {};
    companies.forEach(c => {
      const enr = enrichmentCache[c.domain] || {};
      if (enr.industry) industries[enr.industry] = (industries[enr.industry] || 0) + 1;
    });
    const indList = Object.entries(industries).sort((a,b) => b[1] - a[1]);
    if (indList.length) {
      return _label('Industries in Your CRM') + _card(indList.map(([ind, count]) => `<b>${esc(ind)}</b>: ${count} companies`).join('<br>'));
    }
    return 'No industry data available yet. Run AI enrichment to populate industry information.';
  }

  // ── SEARCH BY LOCATION ──
  if (/\b(city|country|state|location|based in|located|where|from)\b/i.test(lower) && !/email/i.test(lower)) {
    const locTerm = lower.replace(/\b(search|find|show|list|get|companies?|in|from|based|located|where|is|are|the|city|country|state|location|all|me|by)\b/g, '').trim();
    if (locTerm) {
      const matches = companies.filter(c => {
        const enr = enrichmentCache[c.domain] || {};
        return (enr.city && enr.city.toLowerCase().includes(locTerm))
          || (enr.country && enr.country.toLowerCase().includes(locTerm))
          || (enr.state && enr.state.toLowerCase().includes(locTerm));
      }).sort((a,b) => b.score - a.score);
      if (matches.length) {
        return _label(`Companies in "${esc(locTerm)}" (${matches.length} found)`) + matches.slice(0, 8).map(c => _companyCard(c)).join('');
      }
      return `No companies found in "${esc(locTerm)}". Try enriching your data or check the spelling.`;
    }
    // list locations
    const countries = {};
    companies.forEach(c => {
      const enr = enrichmentCache[c.domain] || {};
      if (enr.country) countries[enr.country] = (countries[enr.country] || 0) + 1;
    });
    const locList = Object.entries(countries).sort((a,b) => b[1] - a[1]);
    if (locList.length) {
      return _label('Company Locations') + _card(locList.map(([loc, count]) => `<b>${esc(loc)}</b>: ${count}`).join('<br>'));
    }
    return 'No location data available yet. Run AI enrichment to populate location information.';
  }

  // ── COMPANY TYPE QUERIES (Leads, Existing Clients, Old Clients) ──
  if (/\b(lead|existing client|old client|client type|company type)/i.test(lower)) {
    let typeFilter = 'Lead';
    if (/existing/i.test(lower)) typeFilter = 'Existing Client';
    else if (/old/i.test(lower)) typeFilter = 'Old Client';
    const matches = companies.filter(c => getCompanyType(c.domain) === typeFilter).sort((a,b) => b.score - a.score);
    if (!matches.length) return `No companies marked as "${typeFilter}".`;
    return _label(`${typeFilter}s (${matches.length} total)`) + matches.slice(0, 8).map(c => _companyCard(c)).join('');
  }

  // ── BLOCKED DOMAINS ──
  if (/\bblock/i.test(lower)) {
    const blocked = [...blockedDomains];
    if (!blocked.length) return 'No domains are currently blocked.';
    return _label(`Blocked Domains (${blocked.length})`) + _card(blocked.map(d => esc(d)).join('<br>'));
  }

  // ── MOST EMAILS / MOST ACTIVE / BIGGEST ──
  if (/most (email|active|messag)|biggest|largest|highest volume/i.test(lower)) {
    const sorted = [...companies].sort((a,b) => (b.sent + b.received) - (a.sent + a.received)).slice(0, 8);
    return _label('Most Active Companies (by email volume)') + sorted.map(c => _companyCard(c)).join('');
  }

  // ── RECENT ACTIVITY ──
  if (/recent|latest|newest|last (week|month|few)|this (week|month)/i.test(lower)) {
    const sorted = [...companies].sort((a,b) => new Date(b.lastDate) - new Date(a.lastDate)).slice(0, 8);
    return _label('Most Recent Activity') + sorted.map(c => _companyCard(c)).join('');
  }

  // ── SCORE-BASED QUERIES ──
  if (/score (above|over|greater|higher|more)|high score|top score/i.test(lower)) {
    const numMatch = lower.match(/\d+/);
    const threshold = numMatch ? parseInt(numMatch[0]) : 70;
    const matches = companies.filter(c => c.score >= threshold).sort((a,b) => b.score - a.score);
    if (!matches.length) return `No companies with a score above ${threshold}.`;
    return _label(`Companies with Score ≥ ${threshold} (${matches.length} found)`) + matches.slice(0, 8).map(c => _companyCard(c)).join('');
  }

  // ── COUNT / HOW MANY ──
  if (/how many|count|total number|number of/i.test(lower)) {
    const ts = companies.reduce((s,c) => s + c.sent, 0);
    const tr = companies.reduce((s,c) => s + c.received, 0);
    const totalContacts = companies.reduce((s,c) => s + (c.allContacts?.length || 1), 0);
    return _card(
      `<b>${companies.length}</b> companies<br>`
      + `<b>${totalContacts}</b> contacts<br>`
      + `<b>${(ts + tr).toLocaleString()}</b> total emails (${ts.toLocaleString()} sent, ${tr.toLocaleString()} received)<br>`
      + `<b>${companies.filter(c => c.status === 'Hot').length}</b> hot · <b>${companies.filter(c => c.status === 'Warm').length}</b> warm · <b>${companies.filter(c => c.status === 'Cold').length}</b> cold`
    );
  }

  // ── COMPANY LOOKUP (fuzzy match by name or domain) ──
  const companyMatch = companies.find(c =>
    lower.includes(c.name.toLowerCase()) || lower.includes(c.domain.toLowerCase())
  ) || companies.find(c =>
    c.name.toLowerCase().split(/\s+/).some(w => w.length > 2 && lower.includes(w))
    || c.domain.split('.')[0].length > 3 && lower.includes(c.domain.split('.')[0])
  );
  if (companyMatch) {
    const enr = enrichmentCache[companyMatch.domain] || {};
    let resp = _label(`Company Details — ${esc(companyMatch.name)}`) + _companyCard(companyMatch);
    // show all contacts
    if (companyMatch.allContacts?.length) {
      resp += _label(`Contacts (${companyMatch.allContacts.length})`)
        + companyMatch.allContacts.slice(0, 6).map(c => _contactCard(c, companyMatch.domain)).join('');
    }
    return resp;
  }

  // ── CONTACT LOOKUP (search by name/email across all domains) ──
  const contactResults = _searchAllContacts(lower.replace(/\b(search|find|show|who is|tell me about|look up)\b/g, '').trim());
  if (contactResults.length) {
    return _label(`Search Results (${contactResults.length} contacts)`) + contactResults.slice(0, 8).map(c => _contactCard(c, c.domain)).join('');
  }

  // ── GENERIC SEARCH across company names, domains, contacts ──
  const query = lower.replace(/\b(search|find|show|look|get|list|me|the|for|all|up)\b/g, '').trim();
  if (query.length >= 2) {
    const nameMatches = companies.filter(c =>
      c.name.toLowerCase().includes(query)
      || c.domain.includes(query)
      || c.contact.toLowerCase().includes(query)
      || c.contactEmail.includes(query)
    ).sort((a,b) => b.score - a.score);
    if (nameMatches.length) {
      return _label(`Search Results for "${esc(query)}" (${nameMatches.length} found)`) + nameMatches.slice(0, 8).map(c => _companyCard(c)).join('');
    }
  }

  // ── FALLBACK ──
  return `I searched across <b>${companies.length}</b> companies but couldn't find a match for that. Try:<br><br>`
    + `• <b>Search companies</b> — "find Acme Corp" or just type a name<br>`
    + `• <b>Search contacts</b> — "contacts at google" or "find John"<br>`
    + `• <b>Search emails</b> — "emails about proposal"<br>`
    + `• <b>Filter by status</b> — "hot leads", "cold leads", "warm leads"<br>`
    + `• <b>Filter by industry</b> — "companies in technology"<br>`
    + `• <b>Filter by location</b> — "companies in California"<br>`
    + `• <b>Analytics</b> — "pipeline summary", "most active", "how many"`;
}

const _escMap = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};
function esc(text) {
  if (!text) return '';
  return String(text).replace(/[&<>"']/g, c => _escMap[c]);
}

// ──────────────────────────────────────────────
// INIT — check for existing session
// ──────────────────────────────────────────────
(async function init() {
  loadBlockedDomains();
  loadStarredCompanies();
  loadArchivedCompanies();
  loadCompanyNameCache();
  loadStarredContacts();
  loadCompanyTypes();
  loadColumnConfig();
  loadCustomColumnData();
  loadEnrichmentCache();
  loadContactEnrichment();
  loadLogoFailedCache();
  renderTableHeader();
  if (getClientId()) {
    await initMSAL();
    if (msalInstance) {
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length > 0) {
        currentAccount = accounts[0];
        userEmail = currentAccount.username;
        await onSignedIn();
        return;
      }
    }
  }
  document.getElementById('settingsBtn').style.display = '';
  showWelcome();
})();

// Save data on page close/hide to prevent data loss
window.addEventListener('beforeunload', () => {
  if (currentAccount && Object.keys(domainMap).length > 0) {
    persistData();
  }
});
document.addEventListener('visibilitychange', () => {
  if (document.hidden && currentAccount && Object.keys(domainMap).length > 0) {
    persistData();
    // Fire cloud sync immediately if changes pending
    if (cloudSyncTimer) { clearTimeout(cloudSyncTimer); cloudSyncTimer = null; saveToCloud(); }
  }
});

// ──────────────────────────────────────────────
// EVENT DELEGATION — single listener on table body
// (Avoids hundreds of inline onclick handlers)
// ──────────────────────────────────────────────
document.getElementById('tableBody').addEventListener('click', function(e) {
  // "Show more" row
  const showMore = e.target.closest('[data-action="showmore"]');
  if (showMore) { tableShowAll = true; renderTable(); return; }
  // Inline editing for custom/AI cells
  if (e.target.closest('input.cell-edit')) return; // already editing
  const customCell = e.target.closest('td.custom-cell');
  if (customCell) {
    e.stopPropagation();
    startCellEdit(customCell);
    return;
  }
  // Checkbox handling
  const checkbox = e.target.closest('input.row-checkbox');
  if (checkbox) {
    e.stopPropagation();
    const rid = parseInt(checkbox.dataset.rid, 10);
    if (checkbox.checked) selectedIds.add(rid); else selectedIds.delete(rid);
    renderTable();
    return;
  }
  // Skip if clicking inside col-check area
  if (e.target.closest('.col-check')) return;
  // Row click → open detail
  const row = e.target.closest('tr[data-id]');
  if (row) openDetail(parseInt(row.dataset.id, 10));
});

function startCellEdit(td) {
  const colId = td.dataset.col;
  const domain = td.dataset.domain;
  if (!colId || !domain) return;
  const currentVal = (customColumnData[domain] && customColumnData[domain][colId]) || getCellValue({ domain: domain }, columnConfig.find(c => c.id === colId) || {}) || '';
  td.innerHTML = '<input class="cell-edit" value="' + esc(currentVal) + '">';
  const input = td.querySelector('input');
  input.focus();
  input.select();
  input.onblur = function() { finishCellEdit(td, colId, domain, input.value); };
  input.onkeydown = function(e) {
    if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
    if (e.key === 'Escape') { renderTable(); }
    e.stopPropagation();
  };
}

function finishCellEdit(td, colId, domain, value) {
  if (!customColumnData[domain]) customColumnData[domain] = {};
  customColumnData[domain][colId] = value.trim();
  saveCustomColumnData();
  // Update just this cell without full re-render
  td.innerHTML = '<span class="cell-val">' + esc(value.trim()) + '</span>';
}

// Debounced search input
let _searchTimer = null;
document.getElementById('searchInput').oninput = function() {
  clearTimeout(_searchTimer);
  tableShowAll = false;
  _searchTimer = setTimeout(renderTable, 150);
};

// ── GLOBAL SEARCH (Header Bar) ──
(function() {
  const input = document.getElementById('globalSearchInput');
  const dropdown = document.getElementById('globalSearchDropdown');
  const wrap = document.getElementById('globalSearchWrap');
  const kbd = wrap.querySelector('.global-search-kbd');
  let gsTimer = null;
  let gsActiveIdx = -1;
  let gsResults = [];

  // "/" keyboard shortcut to focus search
  document.addEventListener('keydown', function(e) {
    if (e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
      const tag = (e.target.tagName || '').toLowerCase();
      if (tag === 'input' || tag === 'textarea' || e.target.isContentEditable) return;
      e.preventDefault();
      input.focus();
    }
  });

  // Hide kbd hint when focused
  input.addEventListener('focus', function() { kbd.style.display = 'none'; });
  input.addEventListener('blur', function() {
    if (!input.value) kbd.style.display = '';
  });

  input.addEventListener('input', function() {
    clearTimeout(gsTimer);
    gsTimer = setTimeout(function() { runGlobalSearch(input.value.trim()); }, 120);
  });

  input.addEventListener('keydown', function(e) {
    if (!dropdown.classList.contains('open')) return;
    const items = dropdown.querySelectorAll('.gs-item');
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      gsActiveIdx = Math.min(gsActiveIdx + 1, items.length - 1);
      highlightItem(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      gsActiveIdx = Math.max(gsActiveIdx - 1, 0);
      highlightItem(items);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (gsActiveIdx >= 0 && items[gsActiveIdx]) items[gsActiveIdx].click();
    } else if (e.key === 'Escape') {
      closeDropdown();
      input.blur();
    }
  });

  // Close on outside click
  document.addEventListener('mousedown', function(e) {
    if (!wrap.contains(e.target)) closeDropdown();
  });

  function highlightItem(items) {
    items.forEach(function(el, i) { el.classList.toggle('gs-active', i === gsActiveIdx); });
    if (items[gsActiveIdx]) items[gsActiveIdx].scrollIntoView({ block: 'nearest' });
  }

  function closeDropdown() {
    dropdown.classList.remove('open');
    gsActiveIdx = -1;
  }

  function runGlobalSearch(query) {
    if (!query || query.length < 1) { closeDropdown(); dropdown.innerHTML = ''; return; }
    const q = query.toLowerCase();
    gsResults = [];
    gsActiveIdx = -1;
    let companyMatches = [];
    let contactMatches = [];

    // Search companies
    for (let i = 0; i < companies.length; i++) {
      const c = companies[i];
      if (c.name.toLowerCase().includes(q) || c.domain.toLowerCase().includes(q)) {
        companyMatches.push(c);
        if (companyMatches.length >= 5) break;
      }
    }

    // Search contacts
    for (const domain in domainMap) {
      const dm = domainMap[domain];
      for (const email in dm.contacts) {
        const ct = dm.contacts[email];
        if (ct.name.toLowerCase().includes(q) || email.includes(q)) {
          const comp = companies.find(function(x) { return x.domain === domain; });
          contactMatches.push({ name: ct.name, email: email, domain: domain, company: comp });
        }
        if (contactMatches.length >= 5) break;
      }
      if (contactMatches.length >= 5) break;
    }

    let html = '';

    if (companyMatches.length) {
      html += '<div class="gs-section">Companies</div>';
      companyMatches.forEach(function(c, idx) {
        const color = COLORS[c.id % COLORS.length];
        const initial = c.name.charAt(0).toUpperCase();
        const statusColor = c.status === 'Hot' ? 'var(--green)' : c.status === 'Warm' ? 'var(--orange)' : 'var(--blue)';
        html += '<div class="gs-item" data-type="company" data-id="' + c.id + '">' +
          '<div class="gs-avatar" style="background:' + color + '">' + esc(initial) + '</div>' +
          '<div class="gs-info"><div class="gs-name">' + esc(c.name) + '</div>' +
          '<div class="gs-meta">' + esc(c.domain) + ' &middot; ' + c.sent + ' sent, ' + c.received + ' received</div></div>' +
          '<span class="gs-tag" style="background:' + statusColor + ';color:#fff">' + esc(c.status) + '</span></div>';
      });
    }

    if (contactMatches.length) {
      html += '<div class="gs-section">Contacts</div>';
      contactMatches.forEach(function(ct) {
        const comp = ct.company;
        const color = comp ? COLORS[comp.id % COLORS.length] : '#666';
        const initial = ct.name.charAt(0).toUpperCase();
        const companyName = comp ? comp.name : ct.domain;
        html += '<div class="gs-item" data-type="contact" data-email="' + esc(ct.email) + '" data-domain="' + esc(ct.domain) + '" data-companyid="' + (comp ? comp.id : 0) + '">' +
          '<div class="gs-avatar" style="background:' + color + '">' + esc(initial) + '</div>' +
          '<div class="gs-info"><div class="gs-name">' + esc(ct.name) + '</div>' +
          '<div class="gs-meta">' + esc(ct.email) + ' &middot; ' + esc(companyName) + '</div></div></div>';
      });
    }

    if (!companyMatches.length && !contactMatches.length) {
      html = '<div class="gs-empty">No results for &ldquo;' + esc(query) + '&rdquo;</div>';
    }

    dropdown.innerHTML = html;
    dropdown.classList.add('open');

    // Click handlers for results
    dropdown.querySelectorAll('.gs-item').forEach(function(el) {
      el.addEventListener('mousedown', function(e) {
        e.preventDefault();
        const type = el.dataset.type;
        if (type === 'company') {
          showCompanyPanel(parseInt(el.dataset.id));
        } else if (type === 'contact') {
          const compId = parseInt(el.dataset.companyid);
          if (compId) showCompanyPanel(compId);
          setTimeout(function() {
            selectContact(el.dataset.email, el.dataset.domain, compId);
          }, 100);
        }
        input.value = '';
        closeDropdown();
        kbd.style.display = '';
      });
    });
  }
})();
</script>
</body>
</html>

